var e=require("util"),t=require("bl"),i=require("xtend"),n=require("./headers"),s=require("readable-stream").Writable,r=require("readable-stream").PassThrough,a=function(){},o=function(e){return(e&=511)&&512-e},h=function(e,t){this._parent=e,this.offset=t,r.call(this)};e.inherits(h,r),h.prototype.destroy=function(e){this._parent.destroy(e)};var _=function(e){if(!(this instanceof _))return new _(e);s.call(this,e),e=e||{},this._offset=0,this._buffer=t(),this._missing=0,this._partial=!1,this._onparse=a,this._header=null,this._stream=null,this._overflow=null,this._cb=null,this._locked=!1,this._destroyed=!1,this._pax=null,this._paxGlobal=null,this._gnuLongPath=null,this._gnuLongLinkPath=null;var r=this,l=r._buffer,u=function(){r._continue()},d=function(e){if(r._locked=!1,e)return r.destroy(e);r._stream||u()},p=function(){r._stream=null;var e=o(r._header.size);e?r._parse(e,c):r._parse(512,y),r._locked||u()},c=function(){r._buffer.consume(o(r._header.size)),r._parse(512,y),u()},f=function(){var e=r._header.size;r._paxGlobal=n.decodePax(l.slice(0,e)),l.consume(e),p()},g=function(){var e=r._header.size;r._pax=n.decodePax(l.slice(0,e)),r._paxGlobal&&(r._pax=i(r._paxGlobal,r._pax)),l.consume(e),p()},m=function(){var t=r._header.size;this._gnuLongPath=n.decodeLongPath(l.slice(0,t),e.filenameEncoding),l.consume(t),p()},v=function(){var t=r._header.size;this._gnuLongLinkPath=n.decodeLongPath(l.slice(0,t),e.filenameEncoding),l.consume(t),p()},y=function(){var t,i=r._offset;try{t=r._header=n.decode(l.slice(0,512),e.filenameEncoding)}catch(e){r.emit("error",e)}return l.consume(512),t?"gnu-long-path"===t.type?(r._parse(t.size,m),u(),void 0):"gnu-long-link-path"===t.type?(r._parse(t.size,v),u(),void 0):"pax-global-header"===t.type?(r._parse(t.size,f),u(),void 0):"pax-header"===t.type?(r._parse(t.size,g),u(),void 0):(r._gnuLongPath&&(t.name=r._gnuLongPath,r._gnuLongPath=null),r._gnuLongLinkPath&&(t.linkname=r._gnuLongLinkPath,r._gnuLongLinkPath=null),r._pax&&(r._header=t=function(e,t){return t.path&&(e.name=t.path),t.linkpath&&(e.linkname=t.linkpath),t.size&&(e.size=parseInt(t.size,10)),e.pax=t,e}(t,r._pax),r._pax=null),r._locked=!0,t.size&&"directory"!==t.type?(r._stream=new h(r,i),r.emit("entry",t,r._stream,d),r._parse(t.size,p),u(),void 0):(r._parse(512,y),r.emit("entry",t,function(e,t){var i=new h(e,t);return i.end(),i}(r,i),d),void 0)):(r._parse(512,y),u(),void 0)};this._onheader=y,this._parse(512,y)};e.inherits(_,s),_.prototype.destroy=function(e){this._destroyed||(this._destroyed=!0,e&&this.emit("error",e),this.emit("close"),this._stream&&this._stream.emit("close"))},_.prototype._parse=function(e,t){this._destroyed||(this._offset+=e,this._missing=e,t===this._onheader&&(this._partial=!1),this._onparse=t)},_.prototype._continue=function(){if(!this._destroyed){var e=this._cb;this._cb=a,this._overflow?this._write(this._overflow,void 0,e):e()}},_.prototype._write=function(e,t,i){if(!this._destroyed){var n=this._stream,s=this._buffer,r=this._missing;if(e.length&&(this._partial=!0),e.length<r)return this._missing-=e.length,this._overflow=null,n?n.write(e,i):(s.append(e),i());this._cb=i,this._missing=0;var a=null;e.length>r&&(a=e.slice(r),e=e.slice(0,r)),n?n.end(e):s.append(e),this._overflow=a,this._onparse()}},_.prototype._final=function(e){if(this._partial)return this.destroy(new Error("Unexpected end of data"));e()},module.exports=_;