var e=require("fs-constants"),t=require("end-of-stream"),i=require("util"),r=require("buffer-alloc"),n=require("to-buffer"),s=require("readable-stream").Readable,o=require("readable-stream").Writable,d=require("string_decoder").StringDecoder,a=require("./headers"),h=parseInt("755",8),u=parseInt("644",8),c=r(1024),f=function(){},l=function(e,t){(t&=511)&&e.push(c.slice(0,512-t))};var p=function(e){o.call(this),this.written=0,this._to=e,this._destroyed=!1};i.inherits(p,o),p.prototype._write=function(e,t,i){if(this.written+=e.length,this._to.push(e))return i();this._to._drain=i},p.prototype.destroy=function(){this._destroyed||(this._destroyed=!0,this.emit("close"))};var y=function(){o.call(this),this.linkname="",this._decoder=new d("utf-8"),this._destroyed=!1};i.inherits(y,o),y.prototype._write=function(e,t,i){this.linkname+=this._decoder.write(e),i()},y.prototype.destroy=function(){this._destroyed||(this._destroyed=!0,this.emit("close"))};var m=function(){o.call(this),this._destroyed=!1};i.inherits(m,o),m.prototype._write=function(e,t,i){i(new Error("No body allowed for this entry"))},m.prototype.destroy=function(){this._destroyed||(this._destroyed=!0,this.emit("close"))};var _=function(e){if(!(this instanceof _))return new _(e);s.call(this,e),this._drain=f,this._finalized=!1,this._finalizing=!1,this._destroyed=!1,this._stream=null};i.inherits(_,s),_.prototype.entry=function(i,r,s){if(this._stream)throw new Error("already piping an entry");if(!this._finalized&&!this._destroyed){"function"==typeof r&&(s=r,r=null),s||(s=f);var o=this;if(i.size&&"symlink"!==i.type||(i.size=0),i.type||(i.type=function(t){switch(t&e.S_IFMT){case e.S_IFBLK:return"block-device";case e.S_IFCHR:return"character-device";case e.S_IFDIR:return"directory";case e.S_IFIFO:return"fifo";case e.S_IFLNK:return"symlink"}return"file"}(i.mode)),i.mode||(i.mode="directory"===i.type?h:u),i.uid||(i.uid=0),i.gid||(i.gid=0),i.mtime||(i.mtime=new Date),"string"==typeof r&&(r=n(r)),Buffer.isBuffer(r))return i.size=r.length,this._encode(i),this.push(r),l(o,i.size),process.nextTick(s),new m;if("symlink"===i.type&&!i.linkname){var d=new y;return t(d,function(e){if(e)return o.destroy(),s(e);i.linkname=d.linkname,o._encode(i),s()}),d}if(this._encode(i),"file"!==i.type&&"contiguous-file"!==i.type)return process.nextTick(s),new m;var a=new p(this);return this._stream=a,t(a,function(e){return o._stream=null,e?(o.destroy(),s(e)):a.written!==i.size?(o.destroy(),s(new Error("size mismatch"))):(l(o,i.size),o._finalizing&&o.finalize(),s(),void 0)}),a}},_.prototype.finalize=function(){if(this._stream)return this._finalizing=!0,void 0;this._finalized||(this._finalized=!0,this.push(c),this.push(null))},_.prototype.destroy=function(e){this._destroyed||(this._destroyed=!0,e&&this.emit("error",e),this.emit("close"),this._stream&&this._stream.destroy&&this._stream.destroy())},_.prototype._encode=function(e){if(!e.pax){var t=a.encode(e);if(t)return this.push(t),void 0}this._encodePax(e)},_.prototype._encodePax=function(e){var t=a.encodePax({name:e.name,linkname:e.linkname,pax:e.pax}),i={name:"PaxHeader",mode:e.mode,uid:e.uid,gid:e.gid,size:t.length,mtime:e.mtime,type:"pax-header",linkname:e.linkname&&"PaxHeader",uname:e.uname,gname:e.gname,devmajor:e.devmajor,devminor:e.devminor};this.push(a.encode(i)),this.push(t),l(this,t.length),i.size=e.size,i.type=e.type,this.push(a.encode(i))},_.prototype._read=function(e){var t=this._drain;this._drain=f,t()},module.exports=_;