var e=require("to-buffer"),r=require("buffer-alloc"),n="0".charCodeAt(0),t=parseInt("7777",8),i=function(e,r,n,t){for(;n<t;n++)if(e[n]===r)return n;return t},a=function(e){for(var r=256,n=0;n<148;n++)r+=e[n];for(var t=156;t<512;t++)r+=e[t];return r},u=function(e,r){return(e=e.toString(8)).length>r?"7777777777777777777".slice(0,r)+" ":"0000000000000000000".slice(0,r-e.length)+e+" "};var o=function(e,r,n){if(128&(e=e.slice(r,r+n))[r=0])return function(e){var r;if(128===e[0])r=!0;else{if(255!==e[0])return null;r=!1}for(var n=!1,t=[],i=e.length-1;i>0;i--){var a=e[i];r?t.push(a):n&&0===a?t.push(0):n?(n=!1,t.push(256-a)):t.push(255-a)}var u=0,o=t.length;for(i=0;i<o;i++)u+=t[i]*Math.pow(256,i);return r?u:-1*u}(e);for(;r<e.length&&32===e[r];)r++;for(var t=function(e,r,n){return"number"!=typeof e?n:(e=~~e)>=r?r:e>=0?e:(e+=r)>=0?e:0}(i(e,32,r,e.length),e.length,e.length);r<t&&0===e[r];)r++;return t===r?0:parseInt(e.slice(r,t).toString(),8)},c=function(e,r,n,t){return e.slice(r,i(e,0,r,r+n)).toString(t)},l=function(e){var r=Buffer.byteLength(e),n=Math.floor(Math.log(r)/Math.log(10))+1;return r+n>=Math.pow(10,n)&&n++,r+n+e};exports.decodeLongPath=function(e,r){return c(e,0,e.length,r)},exports.encodePax=function(r){var n="";r.name&&(n+=l(" path="+r.name+"\n")),r.linkname&&(n+=l(" linkpath="+r.linkname+"\n"));var t=r.pax;if(t)for(var i in t)n+=l(" "+i+"="+t[i]+"\n");return e(n)},exports.decodePax=function(e){for(var r={};e.length;){for(var n=0;n<e.length&&32!==e[n];)n++;var t=parseInt(e.slice(0,n).toString(),10);if(!t)return r;var i=e.slice(n+1,t-1).toString(),a=i.indexOf("=");if(-1===a)return r;r[i.slice(0,a)]=i.slice(a+1),e=e.slice(t)}return r},exports.encode=function(e){var i=r(512),o=e.name,c="";if(5===e.typeflag&&"/"!==o[o.length-1]&&(o+="/"),Buffer.byteLength(o)!==o.length)return null;for(;Buffer.byteLength(o)>100;){var l=o.indexOf("/");if(-1===l)return null;c+=c?"/"+o.slice(0,l):o.slice(0,l),o=o.slice(l+1)}return Buffer.byteLength(o)>100||Buffer.byteLength(c)>155?null:e.linkname&&Buffer.byteLength(e.linkname)>100?null:(i.write(o),i.write(u(e.mode&t,6),100),i.write(u(e.uid,6),108),i.write(u(e.gid,6),116),i.write(u(e.size,11),124),i.write(u(e.mtime.getTime()/1e3|0,11),136),i[156]=n+function(e){switch(e){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72}return 0}(e.type),e.linkname&&i.write(e.linkname,157),i.write("ustar\x0000",257),e.uname&&i.write(e.uname,265),e.gname&&i.write(e.gname,297),i.write(u(e.devmajor||0,6),329),i.write(u(e.devminor||0,6),337),c&&i.write(c,345),i.write(u(a(i),6),148),i)},exports.decode=function(e,r){var t=0===e[156]?0:e[156]-n,i=c(e,0,100,r),u=o(e,100,8),l=o(e,108,8),f=o(e,116,8),s=o(e,124,12),h=o(e,136,12),g=function(e){switch(e){case 0:return"file";case 1:return"link";case 2:return"symlink";case 3:return"character-device";case 4:return"block-device";case 5:return"directory";case 6:return"fifo";case 7:return"contiguous-file";case 72:return"pax-header";case 55:return"pax-global-header";case 27:return"gnu-long-link-path";case 28:case 30:return"gnu-long-path"}return null}(t),d=0===e[157]?null:c(e,157,100,r),m=c(e,265,32),v=c(e,297,32),p=o(e,329,8),w=o(e,337,8);e[345]&&(i=c(e,345,155,r)+"/"+i),0===t&&i&&"/"===i[i.length-1]&&(t=5);var k=a(e);if(256===k)return null;if(k!==o(e,148,8))throw new Error("Invalid tar header. Maybe the tar is corrupted or it needs to be gunzipped?");return{name:i,mode:u,uid:l,gid:f,size:s,mtime:new Date(1e3*h),type:g,linkname:d,uname:m,gname:v,devmajor:p,devminor:w}};