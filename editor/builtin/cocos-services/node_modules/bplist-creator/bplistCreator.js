"use strict";var e=require("stream-buffers"),t=!1;function r(e){this.value=e}function n(e){if(e.bplistOverride)return[e];if(e instanceof Array)return function(e){t&&console.log("toEntriesArray");var r=[{type:"array",entries:[]}];return e.forEach(function(e){var t=n(e);r[0].entries.push(t[0]),r=r.concat(t)}),r}(e);if(e instanceof Buffer)return[{type:"data",value:e}];if(e instanceof r)return[{type:"double",value:e.value}];if("object"==typeof e)return e instanceof Date?[{type:"date",value:e}]:1==Object.keys(e).length&&"number"==typeof e.UID?[{type:"UID",value:e.UID}]:function(e){t&&console.log("toEntriesObject");var r=[{type:"dict",entryKeys:[],entryValues:[]}];return Object.keys(e).forEach(function(e){var t=n(e);r[0].entryKeys.push(t[0]),r=r.concat(t[0])}),Object.keys(e).forEach(function(t){var i=n(e[t]);r[0].entryValues.push(i[0]),r=r.concat(i)}),r}(e);if("string"==typeof e)return[{type:"string",value:e}];if("number"==typeof e)return[{type:"number",value:e}];if("boolean"==typeof e)return[{type:"boolean",value:e}];throw new Error("unhandled entry: "+e)}module.exports=function(r){var i=new e.WritableStreamBuffer;i.write(new Buffer("bplist00")),t&&console.log("create",require("util").inspect(r,!1,10)),r instanceof Array&&1===r.length&&(r=r[0]);var o=n(r);t&&console.log("entries",o);var a,u,l=function(e){if(e<256)return 1;if(e<65536)return 2;return 4}(o.length),f=[];return function(){var e={},t=0;o.forEach(function(r){r.id||("string"===r.type?!r.bplistOverride&&e.hasOwnProperty(r.value)?(r.type="stringref",r.id=e[r.value]):e[r.value]=r.id=t++:r.id=t++)}),o=o.filter(function(e){return"stringref"!==e.type})}(),o.forEach(function(e,r){f[r]=i.size(),e?function(e){switch(e.type){case"dict":(function(e){if(t){var r=e.entryKeys.map(function(e){return e.id}),n=e.entryValues.map(function(e){return e.id});console.log("0x"+i.size().toString(16),"writeDict","(id: "+e.id+")","(keys: "+r+")","(values: "+n+")")}g(13,e.entryKeys.length),e.entryKeys.forEach(function(e){y(e.id)}),e.entryValues.forEach(function(e){y(e.id)})})(e);break;case"number":case"double":(function(e){t&&console.log("0x"+i.size().toString(16),"writeNumber",e.value," (type: "+e.type+")","(id: "+e.id+")");"double"!==e.type&&parseFloat(e.value.toFixed())==e.value?e.value<0?(c(19),d(e.value,8)):e.value<=255?(c(16),d(e.value,1)):e.value<=65535?(c(17),d(e.value,2)):e.value<=4294967295?(c(18),d(e.value,4)):(c(19),d(e.value,8)):(c(35),v(e.value))})(e);break;case"UID":(function(e){t&&console.log("0x"+i.size().toString(16),"writeUID",e.value," (type: "+e.type+")","(id: "+e.id+")");g(8,0),y(e.value)})(e);break;case"array":(function(e){t&&console.log("0x"+i.size().toString(16),"writeArray (length: "+e.entries.length+")","(id: "+e.id+")");g(10,e.entries.length),e.entries.forEach(function(e){y(e.id)})})(e);break;case"boolean":(function(e){t&&console.log("0x"+i.size().toString(16),"writeBoolean",e.value,"(id: "+e.id+")");c(e.value?9:8)})(e);break;case"string":case"string-utf16":(function(e){t&&console.log("0x"+i.size().toString(16),"writeString",e.value,"(id: "+e.id+")");if("string-utf16"===e.type||function(e){return Buffer.byteLength(e,"utf8")!=e.length}(e.value)){var r=new Buffer(e.value,"ucs2");g(6,r.length/2);for(var n=0;n<r.length;n+=2){var o=r[n+0];r[n+0]=r[n+1],r[n+1]=o}i.write(r)}else{var a=new Buffer(e.value,"ascii");g(5,a.length),i.write(a)}})(e);break;case"date":(function(e){c(51),v(Date.parse(e.value)/1e3-978307200)})(e);break;case"data":(function(e){t&&console.log("0x"+i.size().toString(16),"writeData",e.value,"(id: "+e.id+")");g(4,e.value.length),i.write(e.value)})(e);break;default:throw new Error("unhandled entry type: "+e.type)}}(e):i.write(0)}),function(){t&&console.log("0x"+i.size().toString(16),"writeOffsetTable");u=i.size(),a=function(e){if(e<256)return 1;if(e<65536)return 2;if(e<4294967296)return 4;return 8}(u),f.forEach(function(e){d(e,a)})}(),function(){t&&console.log("0x"+i.size().toString(16),"writeTrailer");i.write(new Buffer([0,0,0,0,0,0])),t&&console.log("0x"+i.size().toString(16),"writeTrailer(offsetSizeInBytes):",a);c(a),t&&console.log("0x"+i.size().toString(16),"writeTrailer(offsetSizeInBytes):",l);c(l),t&&console.log("0x"+i.size().toString(16),"writeTrailer(number of objects):",o.length);s(o.length),t&&console.log("0x"+i.size().toString(16),"writeTrailer(top object)");s(0),t&&console.log("0x"+i.size().toString(16),"writeTrailer(offset table offset):",u);s(u)}(),i.getContents();function s(e){d(e,8)}function c(e){i.write(new Buffer([e]))}function v(e){var t=new Buffer(8);t.writeDoubleBE(e,0),i.write(t)}function g(e,t){t<15?c((e<<4)+t):t<256?(c(15+(e<<4)),c(16),d(t,1)):t<65536?(c(15+(e<<4)),c(17),d(t,2)):(c(15+(e<<4)),c(18),d(t,4))}function y(e){d(e,l)}function d(e,t){for(var r=new Buffer(t),n=0;t>4;)r[n++]=0,t--;for(var o=t-1;o>=0;o--)r[n++]=e>>8*o;i.write(r)}},module.exports.Real=r;