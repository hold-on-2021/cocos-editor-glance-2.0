var e=require("fs"),t=require("stream").Transform,r=require("stream").PassThrough,i=require("zlib"),n=require("util"),o=require("events").EventEmitter,s=require("buffer-crc32");function a(){this.outputStream=new r,this.entries=[],this.outputStreamCursor=0,this.ended=!1,this.allDone=!1,this.forceZip64Eocd=!1}exports.ZipFile=a,exports.dateToDosDateTime=U,n.inherits(a,o),a.prototype.addFile=function(t,r,i){var n=this;r=d(r,!1),null==i&&(i={});var o=new E(r,!1,i);n.entries.push(o),e.stat(t,function(r,s){return r?n.emit("error",r):s.isFile()?(o.uncompressedSize=s.size,null==i.mtime&&o.setLastModDate(s.mtime),null==i.mode&&o.setFileAttributesMode(s.mode),o.setFileDataPumpFunction(function(){var r=e.createReadStream(t);o.state=E.FILE_DATA_IN_PROGRESS,r.on("error",function(e){n.emit("error",e)}),c(n,o,r)}),f(n),void 0):n.emit("error",new Error("not a file: "+t))})},a.prototype.addReadStream=function(e,t,r){var i=this;t=d(t,!1),null==r&&(r={});var n=new E(t,!1,r);i.entries.push(n),n.setFileDataPumpFunction(function(){n.state=E.FILE_DATA_IN_PROGRESS,c(i,n,e)}),f(i)},a.prototype.addBuffer=function(e,t,r){var n=this;if(t=d(t,!1),e.length>1073741823)throw new Error("buffer too large: "+e.length+" > 1073741823");if(null==r&&(r={}),null!=r.size)throw new Error("options.size not allowed");var o=new E(t,!1,r);function a(e){o.compressedSize=e.length,o.setFileDataPumpFunction(function(){u(n,e),u(n,o.getDataDescriptor()),o.state=E.FILE_DATA_DONE,setImmediate(function(){f(n)})}),f(n)}o.uncompressedSize=e.length,o.crc32=s.unsigned(e),o.crcAndFileSizeKnown=!0,n.entries.push(o),o.compress?i.deflateRaw(e,function(e,t){a(t)}):a(e)},a.prototype.addEmptyDirectory=function(e,t){var r=this;if(e=d(e,!0),null==t&&(t={}),null!=t.size)throw new Error("options.size not allowed");if(null!=t.compress)throw new Error("options.compress not allowed");var i=new E(e,!0,t);r.entries.push(i),i.setFileDataPumpFunction(function(){u(r,i.getDataDescriptor()),i.state=E.FILE_DATA_DONE,f(r)}),f(r)};var l=T([80,75,5,6]);function u(e,t){e.outputStream.write(t),e.outputStreamCursor+=t.length}function c(e,t,n){var o=new _,s=new z,a=t.compress?new i.DeflateRaw:new r,l=new z;n.pipe(o).pipe(s).pipe(a).pipe(l).pipe(e.outputStream,{end:!1}),l.on("end",function(){if(t.crc32=o.crc32,null==t.uncompressedSize)t.uncompressedSize=s.byteCount;else if(t.uncompressedSize!==s.byteCount)return e.emit("error",new Error("file data stream has unexpected number of bytes"));t.compressedSize=l.byteCount,e.outputStreamCursor+=t.compressedSize,u(e,t.getDataDescriptor()),t.state=E.FILE_DATA_DONE,f(e)})}function f(e){if(!e.allDone){if(e.ended&&null!=e.finalSizeCallback){var t=function(e){for(var t=0,r=0,i=0;i<e.entries.length;i++){var n=e.entries[i];if(n.compress)return-1;if(n.state>=E.READY_TO_PUMP_FILE_DATA){if(null==n.uncompressedSize)return-1}else if(null==n.uncompressedSize)return null;n.relativeOffsetOfLocalHeader=t;var o=n.useZip64Format();t+=L+n.utf8FileName.length,t+=n.uncompressedSize,n.crcAndFileSizeKnown||(t+=o?g:S),r+=v+n.utf8FileName.length+n.fileComment.length,o&&(r+=D)}var s=0;(e.forceZip64Eocd||e.entries.length>=65535||r>=65535||t>=4294967295)&&(s+=h+m);return s+=p+e.comment.length,t+r+s}(e);null!=t&&(e.finalSizeCallback(t),e.finalSizeCallback=null)}var r=function(){for(var t=0;t<e.entries.length;t++){var r=e.entries[t];if(r.state<E.FILE_DATA_DONE)return r}return null}();if(null!=r){if(r.state<E.READY_TO_PUMP_FILE_DATA)return;if(r.state===E.FILE_DATA_IN_PROGRESS)return;r.relativeOffsetOfLocalHeader=e.outputStreamCursor;var i=r.getLocalFileHeader();u(e,i),r.doFileDataPump()}else e.ended&&(e.offsetOfStartOfCentralDirectory=e.outputStreamCursor,e.entries.forEach(function(t){var r=t.getCentralDirectoryRecord();u(e,r)}),u(e,function(e,t){var r=!1,i=e.entries.length;(e.forceZip64Eocd||e.entries.length>=65535)&&(i=65535,r=!0);var n=e.outputStreamCursor-e.offsetOfStartOfCentralDirectory,o=n;(e.forceZip64Eocd||n>=4294967295)&&(o=4294967295,r=!0);var s=e.offsetOfStartOfCentralDirectory;(e.forceZip64Eocd||e.offsetOfStartOfCentralDirectory>=4294967295)&&(s=4294967295,r=!0);if(t)return r?h+m+p:p;var a=O(p+e.comment.length);if(a.writeUInt32LE(101010256,0),a.writeUInt16LE(0,4),a.writeUInt16LE(0,6),a.writeUInt16LE(i,8),a.writeUInt16LE(i,10),a.writeUInt32LE(o,12),a.writeUInt32LE(s,16),a.writeUInt16LE(e.comment.length,20),e.comment.copy(a,22),!r)return a;var l=O(h);l.writeUInt32LE(101075792,0),A(l,h-12,4),l.writeUInt16LE(F,12),l.writeUInt16LE(I,14),l.writeUInt32LE(0,16),l.writeUInt32LE(0,20),A(l,e.entries.length,24),A(l,e.entries.length,32),A(l,n,40),A(l,e.offsetOfStartOfCentralDirectory,48);var u=O(m);return u.writeUInt32LE(117853008,0),u.writeUInt32LE(0,4),A(u,e.outputStreamCursor,8),u.writeUInt32LE(1,16),Buffer.concat([l,u,a])}(e)),e.outputStream.end(),e.allDone=!0)}}a.prototype.end=function(e,t){if("function"==typeof e&&(t=e,e=null),null==e&&(e={}),!this.ended){if(this.ended=!0,this.finalSizeCallback=t,this.forceZip64Eocd=!!e.forceZip64Format,e.comment){if("string"==typeof e.comment?this.comment=function(e){if(/^[\x20-\x7e]*$/.test(e))return T(e,"utf-8");if(null==C){C={};for(var t=0;t<y.length;t++)C[y[t]]=t}for(var r=O(e.length),t=0;t<e.length;t++){var i=C[e[t]];if(null==i)throw new Error("character not encodable in CP437: "+JSON.stringify(e[t]));r[t]=i}return r}(e.comment):this.comment=e.comment,this.comment.length>65535)throw new Error("comment is too large");if(M(this.comment,l))throw new Error("comment contains end of central directory record signature")}else this.comment=w;f(this)}};var h=56,m=20,p=22;function d(e,t){if(""===e)throw new Error("empty metadataPath");if(e=e.replace(/\\/g,"/"),/^[a-zA-Z]:/.test(e)||/^\//.test(e))throw new Error("absolute path: "+e);if(-1!==e.split("/").indexOf(".."))throw new Error("invalid relative path: "+e);var r=/\/$/.test(e);if(t)r||(e+="/");else if(r)throw new Error("file path cannot end with '/': "+e);return e}var w=O(0);function E(e,t,r){if(this.utf8FileName=T(e),this.utf8FileName.length>65535)throw new Error("utf8 file name too long. "+utf8FileName.length+" > 65535");if(this.isDirectory=t,this.state=E.WAITING_FOR_METADATA,this.setLastModDate(null!=r.mtime?r.mtime:new Date),null!=r.mode?this.setFileAttributesMode(r.mode):this.setFileAttributesMode(t?16893:33204),t?(this.crcAndFileSizeKnown=!0,this.crc32=0,this.uncompressedSize=0,this.compressedSize=0):(this.crcAndFileSizeKnown=!1,this.crc32=null,this.uncompressedSize=null,this.compressedSize=null,null!=r.size&&(this.uncompressedSize=r.size)),t?this.compress=!1:(this.compress=!0,null!=r.compress&&(this.compress=!!r.compress)),this.forceZip64Format=!!r.forceZip64Format,r.fileComment){if("string"==typeof r.fileComment?this.fileComment=T(r.fileComment,"utf-8"):this.fileComment=r.fileComment,this.fileComment.length>65535)throw new Error("fileComment is too large")}else this.fileComment=w}E.WAITING_FOR_METADATA=0,E.READY_TO_PUMP_FILE_DATA=1,E.FILE_DATA_IN_PROGRESS=2,E.FILE_DATA_DONE=3,E.prototype.setLastModDate=function(e){var t=U(e);this.lastModFileTime=t.time,this.lastModFileDate=t.date},E.prototype.setFileAttributesMode=function(e){if((65535&e)!==e)throw new Error("invalid mode. expected: 0 <= "+e+" <= 65535");this.externalFileAttributes=e<<16>>>0},E.prototype.setFileDataPumpFunction=function(e){this.doFileDataPump=e,this.state=E.READY_TO_PUMP_FILE_DATA},E.prototype.useZip64Format=function(){return this.forceZip64Format||null!=this.uncompressedSize&&this.uncompressedSize>4294967294||null!=this.compressedSize&&this.compressedSize>4294967294||null!=this.relativeOffsetOfLocalHeader&&this.relativeOffsetOfLocalHeader>4294967294};var L=30,I=45,F=831;E.prototype.getLocalFileHeader=function(){var e=0,t=0,r=0;this.crcAndFileSizeKnown&&(e=this.crc32,t=this.compressedSize,r=this.uncompressedSize);var i=O(L),n=2048;return this.crcAndFileSizeKnown||(n|=8),i.writeUInt32LE(67324752,0),i.writeUInt16LE(20,4),i.writeUInt16LE(n,6),i.writeUInt16LE(this.getCompressionMethod(),8),i.writeUInt16LE(this.lastModFileTime,10),i.writeUInt16LE(this.lastModFileDate,12),i.writeUInt32LE(e,14),i.writeUInt32LE(t,18),i.writeUInt32LE(r,22),i.writeUInt16LE(this.utf8FileName.length,26),i.writeUInt16LE(0,28),Buffer.concat([i,this.utf8FileName])};var S=16,g=24;E.prototype.getDataDescriptor=function(){return this.crcAndFileSizeKnown?w:this.useZip64Format()?((e=O(g)).writeUInt32LE(134695760,0),e.writeUInt32LE(this.crc32,4),A(e,this.compressedSize,8),A(e,this.uncompressedSize,16),e):((e=O(S)).writeUInt32LE(134695760,0),e.writeUInt32LE(this.crc32,4),e.writeUInt32LE(this.compressedSize,8),e.writeUInt32LE(this.uncompressedSize,12),e);var e};var v=46,D=28;function U(e){var t=0;t|=31&e.getDate(),t|=(e.getMonth()+1&15)<<5,t|=(e.getFullYear()-1980&127)<<9;var r=0;return r|=Math.floor(e.getSeconds()/2),r|=(63&e.getMinutes())<<5,{date:t,time:r|=(31&e.getHours())<<11}}function A(e,t,r){var i=Math.floor(t/4294967296),n=t%4294967296;e.writeUInt32LE(n,r),e.writeUInt32LE(i,r+4)}function z(e){t.call(this,e),this.byteCount=0}function _(e){t.call(this,e),this.crc32=0}E.prototype.getCentralDirectoryRecord=function(){var e=O(v),t=2048;this.crcAndFileSizeKnown||(t|=8);var r,i,n=this.compressedSize,o=this.uncompressedSize,s=this.relativeOffsetOfLocalHeader;return this.useZip64Format()?(n=4294967295,o=4294967295,s=4294967295,r=I,(i=O(D)).writeUInt16LE(1,0),i.writeUInt16LE(D-4,2),A(i,this.uncompressedSize,4),A(i,this.compressedSize,12),A(i,this.relativeOffsetOfLocalHeader,20)):(r=20,i=w),e.writeUInt32LE(33639248,0),e.writeUInt16LE(F,4),e.writeUInt16LE(r,6),e.writeUInt16LE(t,8),e.writeUInt16LE(this.getCompressionMethod(),10),e.writeUInt16LE(this.lastModFileTime,12),e.writeUInt16LE(this.lastModFileDate,14),e.writeUInt32LE(this.crc32,16),e.writeUInt32LE(n,20),e.writeUInt32LE(o,24),e.writeUInt16LE(this.utf8FileName.length,28),e.writeUInt16LE(i.length,30),e.writeUInt16LE(this.fileComment.length,32),e.writeUInt16LE(0,34),e.writeUInt16LE(0,36),e.writeUInt32LE(this.externalFileAttributes,38),e.writeUInt32LE(s,42),Buffer.concat([e,this.utf8FileName,i,this.fileComment])},E.prototype.getCompressionMethod=function(){return this.compress?8:0},n.inherits(z,t),z.prototype._transform=function(e,t,r){this.byteCount+=e.length,r(null,e)},n.inherits(_,t),_.prototype._transform=function(e,t,r){this.crc32=s.unsigned(e,this.crc32),r(null,e)};var y="\0☺☻♥♦♣♠•◘○◙♂♀♪♫☼►◄↕‼¶§▬↨↑↓→←∟↔▲▼ !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~⌂ÇüéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜ¢£¥₧ƒáíóúñÑªº¿⌐¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀αßΓπΣσµτΦΘΩδ∞φε∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■ ";if(256!==y.length)throw new Error("assertion failure");var C=null;function O(e){O=function(e){return Buffer.allocUnsafe(e)};try{return O(e)}catch(t){return(O=function(e){return new Buffer(e)})(e)}}function T(e,t){T=function(e,t){return Buffer.from(e,t)};try{return T(e,t)}catch(r){return(T=function(e,t){return new Buffer(e,t)})(e,t)}}function M(e,t){M=function(e,t){return e.includes(t)};try{return M(e,t)}catch(r){return(M=function(e,t){for(var r=0;r<=e.length-t.length;r++)for(var i=0;;i++){if(i===t.length)return!0;if(e[r+i]!==t[i])break}return!1})(e,t)}}