var e=require("util"),t=e.format,r=require("events").EventEmitter,o=require("path"),n=require("uuid"),a=require("child_process").fork,s=require("./pbxWriter"),u=require("./pbxFile"),p=require("fs"),c=require("./parser/pbxproj"),d=require("simple-plist"),h=/_comment$/;function l(e){if(!(this instanceof l))return new l(e);this.filepath=o.resolve(e)}function f(e){return{isa:"PBXFileReference",name:'"'+e.basename+'"',path:'"'+e.path.replace(/\\/g,"/")+'"',sourceTree:e.sourceTree,fileEncoding:e.fileEncoding,lastKnownFileType:e.lastKnownFileType,explicitFileType:e.explicitFileType,includeInIndex:e.includeInIndex}}function m(e){var t=Object.create(null);return t.value=e.fileRef,t.comment=e.basename,t}function b(e){var t=Object.create(null);return t.value=e.uuid,t.comment=P(e),t}function P(e){return t("%s in %s",e.basename,e.group)}function y(e,t){return v(e,t,"Plugins")}function g(e,t){return v(e,t,"Resources")}function v(e,t,i){var r=new RegExp("^"+i+"[\\\\/]");return t.pbxGroupByName(i).path&&(e.path=e.path.replace(r,"")),e}function x(e,t){var i=t.pbxGroupByName("Plugins"),r=i?i.path:null,n=o.dirname(e.path);return n="."==n?"":"/"+n,e.plugin&&r?'"\\"$(SRCROOT)/'+B(r)+'\\""':e.customFramework&&e.dirname?'"\\"'+e.dirname+'\\""':'"\\"$(SRCROOT)/'+t.productName+n+'\\""'}function F(e){var t=Object.keys(e),i={},r=0;for(r;r<t.length;r++)h.test(t[r])||(i[t[r]]=e[t[r]]);return i}function B(e){if(e)return e.replace(/^"(.*)"$/,"$1")}function S(e){return PRODUCTTYPE_BY_TARGETTYPE={application:"com.apple.product-type.application",app_extension:"com.apple.product-type.app-extension",bundle:"com.apple.product-type.bundle",command_line_tool:"com.apple.product-type.tool",dynamic_library:"com.apple.product-type.library.dynamic",framework:"com.apple.product-type.framework",static_library:"com.apple.product-type.library.static",unit_test_bundle:"com.apple.product-type.bundle.unit-test",watch_app:"com.apple.product-type.application.watchapp",watch_extension:"com.apple.product-type.watchkit-extension"},PRODUCTTYPE_BY_TARGETTYPE[e]}e.inherits(l,r),l.prototype.parse=function(e){return a(__dirname+"/parseJob.js",[this.filepath]).on("message",function(e){"SyntaxError"==e.name||e.code?this.emit("error",e):(this.hash=e,this.emit("end",null,e))}.bind(this)),e&&(this.on("error",e),this.on("end",e)),this},l.prototype.parseSync=function(){var e=p.readFileSync(this.filepath,"utf-8");return this.hash=c.parse(e),this},l.prototype.writeSync=function(){return this.writer=new s(this.hash),this.writer.writeSync()},l.prototype.allUuids=function(){var e,t=this.hash.project.objects,i=[];for(key in t)e=t[key],i=i.concat(Object.keys(e));return i=i.filter(function(e){return!h.test(e)&&24==e.length})},l.prototype.generateUuid=function(){var e=n.v4().replace(/-/g,"").substr(0,24).toUpperCase();return this.allUuids().indexOf(e)>=0?this.generateUuid():e},l.prototype.addPluginFile=function(e,t){var i=new u(e,t);return i.plugin=!0,y(i,this),this.hasFile(i.path)?null:(i.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(i),this.addToPluginsPbxGroup(i),i)},l.prototype.removePluginFile=function(e,t){var i=new u(e,t);return y(i,this),this.removeFromPbxFileReferenceSection(i),this.removeFromPluginsPbxGroup(i),i},l.prototype.addProductFile=function(e,t){var i=new u(e,t);return i.includeInIndex=0,i.fileRef=this.generateUuid(),i.target=t?t.target:void 0,i.group=t?t.group:void 0,i.uuid=this.generateUuid(),i.path=i.basename,this.addToPbxFileReferenceSection(i),this.addToProductsPbxGroup(i),i},l.prototype.removeProductFile=function(e,t){var i=new u(e,t);return this.removeFromProductsPbxGroup(i),i},l.prototype.addSourceFile=function(e,t,i){var r;return!!(r=i?this.addFile(e,i,t):this.addPluginFile(e,t))&&(r.target=t?t.target:void 0,r.uuid=this.generateUuid(),this.addToPbxBuildFileSection(r),this.addToPbxSourcesBuildPhase(r),r)},l.prototype.removeSourceFile=function(e,t,i){var r;return(r=i?this.removeFile(e,i,t):this.removePluginFile(e,t)).target=t?t.target:void 0,this.removeFromPbxBuildFileSection(r),this.removeFromPbxSourcesBuildPhase(r),r},l.prototype.addHeaderFile=function(e,t,i){return i?this.addFile(e,i,t):this.addPluginFile(e,t)},l.prototype.removeHeaderFile=function(e,t,i){return i?this.removeFile(e,i,t):this.removePluginFile(e,t)},l.prototype.addResourceFile=function(e,t,i){var r;if((t=t||{}).plugin){if(!(r=this.addPluginFile(e,t)))return!1}else if(r=new u(e,t),this.hasFile(r.path))return!1;return r.uuid=this.generateUuid(),r.target=t?t.target:void 0,t.plugin||(g(r,this),r.fileRef=this.generateUuid()),t.variantGroup||(this.addToPbxBuildFileSection(r),this.addToPbxResourcesBuildPhase(r)),t.plugin||(this.addToPbxFileReferenceSection(r),i?this.getPBXGroupByKey(i)?this.addToPbxGroup(r,i):this.getPBXVariantGroupByKey(i)&&this.addToPbxVariantGroup(r,i):this.addToResourcesPbxGroup(r)),r},l.prototype.removeResourceFile=function(e,t,i){var r=new u(e,t);return r.target=t?t.target:void 0,g(r,this),this.removeFromPbxBuildFileSection(r),this.removeFromPbxFileReferenceSection(r),i?this.getPBXGroupByKey(i)?this.removeFromPbxGroup(r,i):this.getPBXVariantGroupByKey(i)&&this.removeFromPbxVariantGroup(r,i):this.removeFromResourcesPbxGroup(r),this.removeFromPbxResourcesBuildPhase(r),r},l.prototype.addFramework=function(e,t){var i=t&&1==t.customFramework,r=!t||void 0==t.link||t.link,o=t&&t.embed;t&&delete t.embed;var n=new u(e,t);if(n.uuid=this.generateUuid(),n.fileRef=this.generateUuid(),n.target=t?t.target:void 0,this.hasFile(n.path))return!1;if(this.addToPbxBuildFileSection(n),this.addToPbxFileReferenceSection(n),this.addToFrameworksPbxGroup(n),r&&this.addToPbxFrameworksBuildPhase(n),i&&(this.addToFrameworkSearchPaths(n),o)){t.embed=o;var a=new u(e,t);return a.uuid=this.generateUuid(),a.fileRef=n.fileRef,this.addToPbxBuildFileSection(a),this.addToPbxEmbedFrameworksBuildPhase(a),a}return n},l.prototype.removeFramework=function(e,t){t&&t.embed;t&&delete t.embed;var i=new u(e,t);i.target=t?t.target:void 0,this.removeFromPbxBuildFileSection(i),this.removeFromPbxFileReferenceSection(i),this.removeFromFrameworksPbxGroup(i),this.removeFromPbxFrameworksBuildPhase(i),t&&t.customFramework&&this.removeFromFrameworkSearchPaths(i),(t=t||{}).embed=!0;var r=new u(e,t);return r.fileRef=i.fileRef,this.removeFromPbxBuildFileSection(r),this.removeFromPbxEmbedFrameworksBuildPhase(r),i},l.prototype.addCopyfile=function(e,t){var i=new u(e,t);return this.hasFile(i.path)&&(i=this.hasFile(i.path)),i.fileRef=i.uuid=this.generateUuid(),i.target=t?t.target:void 0,this.addToPbxBuildFileSection(i),this.addToPbxFileReferenceSection(i),this.addToPbxCopyfilesBuildPhase(i),i},l.prototype.pbxCopyfilesBuildPhaseObj=function(e){return this.buildPhaseObject("PBXCopyFilesBuildPhase","Copy Files",e)},l.prototype.addToPbxCopyfilesBuildPhase=function(e){this.buildPhaseObject("PBXCopyFilesBuildPhase","Copy Files",e.target).files.push(b(e))},l.prototype.removeCopyfile=function(e,t){var i=new u(e,t);return i.target=t?t.target:void 0,this.removeFromPbxBuildFileSection(i),this.removeFromPbxFileReferenceSection(i),this.removeFromPbxCopyfilesBuildPhase(i),i},l.prototype.removeFromPbxCopyfilesBuildPhase=function(e){var t=this.pbxCopyfilesBuildPhaseObj(e.target);for(i in t.files)if(t.files[i].comment==P(e)){t.files.splice(i,1);break}},l.prototype.addStaticLibrary=function(e,t){var i;if((t=t||{}).plugin){if(!(i=this.addPluginFile(e,t)))return!1}else if(i=new u(e,t),this.hasFile(i.path))return!1;return i.uuid=this.generateUuid(),i.target=t?t.target:void 0,t.plugin||(i.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(i)),this.addToPbxBuildFileSection(i),this.addToPbxFrameworksBuildPhase(i),this.addToLibrarySearchPaths(i),i},l.prototype.addToPbxBuildFileSection=function(e){var i=t("%s_comment",e.uuid);this.pbxBuildFileSection()[e.uuid]=function(e){var t=Object.create(null);t.isa="PBXBuildFile",t.fileRef=e.fileRef,t.fileRef_comment=e.basename,e.settings&&(t.settings=e.settings);return t}(e),this.pbxBuildFileSection()[i]=function(e){return P(e)}(e)},l.prototype.removeFromPbxBuildFileSection=function(e){var i;for(i in this.pbxBuildFileSection())this.pbxBuildFileSection()[i].fileRef_comment==e.basename&&(e.uuid=i,delete this.pbxBuildFileSection()[i]);var r=t("%s_comment",e.uuid);delete this.pbxBuildFileSection()[r]},l.prototype.addPbxGroup=function(e,i,r,o){var n=this.hash.project.objects.PBXGroup,a=this.generateUuid(),s=t("%s_comment",a),p={isa:"PBXGroup",children:[],name:i,path:r,sourceTree:o||'"<group>"'},c=this.pbxFileReferenceSection(),d={};for(var l in c)if(h.test(l)){var f=l.split(h)[0];d[c[f].path]={fileRef:f,basename:c[l]}}for(var b=0;b<e.length;b++){var P=e[b],y='"'+P+'"';if(d[P])p.children.push(m(d[P]));else if(d[y])p.children.push(m(d[y]));else{var g=new u(P);g.uuid=this.generateUuid(),g.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(g),this.addToPbxBuildFileSection(g),p.children.push(m(g))}}return n&&(n[a]=p,n[s]=i),{uuid:a,pbxGroup:p}},l.prototype.removePbxGroup=function(e){var t,i=this.hash.project.objects.PBXGroup;for(t in i)h.test(t)&&i[t]==e&&delete i[t.split(h)[0]]},l.prototype.addToPbxProjectSection=function(e){var t={value:e.uuid,comment:function(e){return e.name}(e.pbxNativeTarget)};this.pbxProjectSection()[this.getFirstProject().uuid].targets.push(t)},l.prototype.addToPbxNativeTargetSection=function(e){var i=t("%s_comment",e.uuid);this.pbxNativeTargetSection()[e.uuid]=e.pbxNativeTarget,this.pbxNativeTargetSection()[i]=e.pbxNativeTarget.name},l.prototype.addToPbxFileReferenceSection=function(e){var i=t("%s_comment",e.fileRef);this.pbxFileReferenceSection()[e.fileRef]=f(e),this.pbxFileReferenceSection()[i]=function(e){return e.basename||o.basename(e.path)}(e)},l.prototype.removeFromPbxFileReferenceSection=function(e){var i,r=f(e);for(i in this.pbxFileReferenceSection())if(this.pbxFileReferenceSection()[i].name==r.name||'"'+this.pbxFileReferenceSection()[i].name+'"'==r.name||this.pbxFileReferenceSection()[i].path==r.path||'"'+this.pbxFileReferenceSection()[i].path+'"'==r.path){e.fileRef=e.uuid=i,delete this.pbxFileReferenceSection()[i];break}var o=t("%s_comment",e.fileRef);return void 0!=this.pbxFileReferenceSection()[o]&&delete this.pbxFileReferenceSection()[o],e},l.prototype.addToXcVersionGroupSection=function(e){if(!e.models||!e.currentModel)throw new Error("Cannot create a XCVersionGroup section from not a data model document file");var i=t("%s_comment",e.fileRef);this.xcVersionGroupSection()[e.fileRef]||(this.xcVersionGroupSection()[e.fileRef]={isa:"XCVersionGroup",children:e.models.map(function(e){return e.fileRef}),currentVersion:e.currentModel.fileRef,name:o.basename(e.path),path:e.path,sourceTree:'"<group>"',versionGroupType:"wrapper.xcdatamodel"},this.xcVersionGroupSection()[i]=o.basename(e.path))},l.prototype.addToPluginsPbxGroup=function(e){var t=this.pbxGroupByName("Plugins");t?t.children.push(m(e)):this.addPbxGroup([e.path],"Plugins")},l.prototype.removeFromPluginsPbxGroup=function(e){if(!this.pbxGroupByName("Plugins"))return null;var t,i=this.pbxGroupByName("Plugins").children;for(t in i)if(m(e).value==i[t].value&&m(e).comment==i[t].comment){i.splice(t,1);break}},l.prototype.addToResourcesPbxGroup=function(e){var t=this.pbxGroupByName("Resources");t?t.children.push(m(e)):this.addPbxGroup([e.path],"Resources")},l.prototype.removeFromResourcesPbxGroup=function(e){if(!this.pbxGroupByName("Resources"))return null;var t,i=this.pbxGroupByName("Resources").children;for(t in i)if(m(e).value==i[t].value&&m(e).comment==i[t].comment){i.splice(t,1);break}},l.prototype.addToFrameworksPbxGroup=function(e){var t=this.pbxGroupByName("Frameworks");t?t.children.push(m(e)):this.addPbxGroup([e.path],"Frameworks")},l.prototype.removeFromFrameworksPbxGroup=function(e){if(!this.pbxGroupByName("Frameworks"))return null;var t=this.pbxGroupByName("Frameworks").children;for(i in t)if(m(e).value==t[i].value&&m(e).comment==t[i].comment){t.splice(i,1);break}},l.prototype.addToPbxEmbedFrameworksBuildPhase=function(e){var t=this.pbxEmbedFrameworksBuildPhaseObj(e.target);t&&t.files.push(b(e))},l.prototype.removeFromPbxEmbedFrameworksBuildPhase=function(e){var t=this.pbxEmbedFrameworksBuildPhaseObj(e.target);if(t){var r=[];for(i in t.files)t.files[i].comment!=P(e)&&r.push(t.files[i]);t.files=r}},l.prototype.addToProductsPbxGroup=function(e){var t=this.pbxGroupByName("Products");t?t.children.push(m(e)):this.addPbxGroup([e.path],"Products")},l.prototype.removeFromProductsPbxGroup=function(e){if(!this.pbxGroupByName("Products"))return null;var t,i=this.pbxGroupByName("Products").children;for(t in i)if(m(e).value==i[t].value&&m(e).comment==i[t].comment){i.splice(t,1);break}},l.prototype.addToPbxSourcesBuildPhase=function(e){this.pbxSourcesBuildPhaseObj(e.target).files.push(b(e))},l.prototype.removeFromPbxSourcesBuildPhase=function(e){var t,i=this.pbxSourcesBuildPhaseObj(e.target);for(t in i.files)if(i.files[t].comment==P(e)){i.files.splice(t,1);break}},l.prototype.addToPbxResourcesBuildPhase=function(e){this.pbxResourcesBuildPhaseObj(e.target).files.push(b(e))},l.prototype.removeFromPbxResourcesBuildPhase=function(e){var t,i=this.pbxResourcesBuildPhaseObj(e.target);for(t in i.files)if(i.files[t].comment==P(e)){i.files.splice(t,1);break}},l.prototype.addToPbxFrameworksBuildPhase=function(e){this.pbxFrameworksBuildPhaseObj(e.target).files.push(b(e))},l.prototype.removeFromPbxFrameworksBuildPhase=function(e){var t=this.pbxFrameworksBuildPhaseObj(e.target);for(i in t.files)if(t.files[i].comment==P(e)){t.files.splice(i,1);break}},l.prototype.addXCConfigurationList=function(e,i,r){for(var o=this.pbxXCBuildConfigurationSection(),n=this.pbxXCConfigurationList(),a=this.generateUuid(),s=t("%s_comment",a),u={isa:"XCConfigurationList",buildConfigurations:[],defaultConfigurationIsVisible:0,defaultConfigurationName:i},p=0;p<e.length;p++){var c=e[p],d=this.generateUuid(),h=t("%s_comment",d);o[d]=c,o[h]=c.name,u.buildConfigurations.push({value:d,comment:c.name})}return n&&(n[a]=u,n[s]=r),{uuid:a,xcConfigurationList:u}},l.prototype.addTargetDependency=function(e,i){if(e){var r=this.pbxNativeTargetSection();if(void 0===r[e])throw new Error("Invalid target: "+e);for(var o=0;o<i.length;o++){var n=i[o];if(void 0===r[n])throw new Error("Invalid target: "+n)}var a=this.hash.project.objects.PBXTargetDependency,s=this.hash.project.objects.PBXContainerItemProxy;for(o=0;o<i.length;o++){var u=i[o],p=t("%s_comment",u),c=this.generateUuid(),d=t("%s_comment",c),h=this.generateUuid(),l=t("%s_comment",h),f={isa:"PBXContainerItemProxy",containerPortal:this.hash.project.rootObject,containerPortal_comment:this.hash.project.rootObject_comment,proxyType:1,remoteGlobalIDString:u,remoteInfo:r[u].name},m={isa:"PBXTargetDependency",target:u,target_comment:r[p],targetProxy:h,targetProxy_comment:"PBXContainerItemProxy"};s&&a&&(s[h]=f,s[l]="PBXContainerItemProxy",a[c]=m,a[d]="PBXTargetDependency",r[e].dependencies.push({value:c,comment:"PBXTargetDependency"}))}return{uuid:e,target:r[e]}}},l.prototype.addBuildPhase=function(e,i,r,o,n,a){var s=this.pbxFileReferenceSection(),p=this.pbxBuildFileSection(),c=this.generateUuid(),d=o||this.getFirstTarget().uuid,l=t("%s_comment",c),f={isa:i,buildActionMask:2147483647,files:[],runOnlyForDeploymentPostprocessing:0},m={};for(var P in"PBXCopyFilesBuildPhase"===i?f=function(e,t,i,r){return e.name='"'+r+'"',e.dstPath=i||'""',e.dstSubfolderSpec={absolute_path:0,executables:6,frameworks:10,java_resources:15,plugins:13,products_directory:16,resources:7,shared_frameworks:11,shared_support:12,wrapper:1,xpc_services:0}[{application:"wrapper",app_extension:"plugins",bundle:"wrapper",command_line_tool:"wrapper",dynamic_library:"products_directory",framework:"shared_frameworks",frameworks:"frameworks",static_library:"products_directory",unit_test_bundle:"wrapper",watch_app:"wrapper",watch_extension:"plugins"}[t]],e}(f,n,a,r):"PBXShellScriptBuildPhase"===i&&(f=function(e,t,i){return e.name='"'+i+'"',e.inputPaths=t.inputPaths||[],e.outputPaths=t.outputPaths||[],e.shellPath=t.shellPath,e.shellScript='"'+t.shellScript.replace(/"/g,'\\"')+'"',e}(f,n,r)),this.hash.project.objects[i]||(this.hash.project.objects[i]=new Object),this.hash.project.objects[i][c]||(this.hash.project.objects[i][c]=f,this.hash.project.objects[i][l]=r),this.hash.project.objects.PBXNativeTarget[d].buildPhases&&this.hash.project.objects.PBXNativeTarget[d].buildPhases.push({value:c,comment:r}),p)if(h.test(P)){var y=P.split(h)[0],g=p[y];if(fileReference=s[g.fileRef],fileReference){var v=new u(fileReference.path);m[fileReference.path]={uuid:y,basename:v.basename,group:v.group}}}for(var x=0;x<e.length;x++){var F=e[x],B='"'+F+'"',S=new u(F);m[F]?f.files.push(b(m[F])):m[B]?f.files.push(b(m[B])):(S.uuid=this.generateUuid(),S.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(S),this.addToPbxBuildFileSection(S),f.files.push(b(S)))}return void 0,{uuid:c,buildPhase:f}},l.prototype.pbxProjectSection=function(){return this.hash.project.objects.PBXProject},l.prototype.pbxBuildFileSection=function(){return this.hash.project.objects.PBXBuildFile},l.prototype.pbxXCBuildConfigurationSection=function(){return this.hash.project.objects.XCBuildConfiguration},l.prototype.pbxFileReferenceSection=function(){return this.hash.project.objects.PBXFileReference},l.prototype.pbxNativeTargetSection=function(){return this.hash.project.objects.PBXNativeTarget},l.prototype.xcVersionGroupSection=function(){return"object"!=typeof this.hash.project.objects.XCVersionGroup&&(this.hash.project.objects.XCVersionGroup={}),this.hash.project.objects.XCVersionGroup},l.prototype.pbxXCConfigurationList=function(){return this.hash.project.objects.XCConfigurationList},l.prototype.pbxGroupByName=function(e){var t,i=this.hash.project.objects.PBXGroup;for(t in i)if(h.test(t)&&i[t]==e)return i[t.split(h)[0]];return null},l.prototype.pbxTargetByName=function(e){return this.pbxItemByComment(e,"PBXNativeTarget")},l.prototype.findTargetKey=function(e){var t=this.hash.project.objects.PBXNativeTarget;for(var i in t){if(!h.test(i))if(t[i].name===e)return i}return null},l.prototype.pbxItemByComment=function(e,t){var i,r=this.hash.project.objects[t];for(i in r)if(h.test(i)&&r[i]==e)return r[i.split(h)[0]];return null},l.prototype.pbxSourcesBuildPhaseObj=function(e){return this.buildPhaseObject("PBXSourcesBuildPhase","Sources",e)},l.prototype.pbxResourcesBuildPhaseObj=function(e){return this.buildPhaseObject("PBXResourcesBuildPhase","Resources",e)},l.prototype.pbxFrameworksBuildPhaseObj=function(e){return this.buildPhaseObject("PBXFrameworksBuildPhase","Frameworks",e)},l.prototype.pbxEmbedFrameworksBuildPhaseObj=function(e){return this.buildPhaseObject("PBXCopyFilesBuildPhase","Embed Frameworks",e)},l.prototype.buildPhase=function(e,t){if(t){var i=this.pbxNativeTargetSection();if(void 0===i[t])throw new Error("Invalid target: "+t);var r=i[t].buildPhases;for(var o in r){var n=r[o];if(n.comment==e)return n.value+"_comment"}}},l.prototype.buildPhaseObject=function(e,t,i){var r,o=this.hash.project.objects[e],n=this.buildPhase(t,i);for(r in o)if(h.test(r)&&(!n||n==r)&&o[r]==t)return o[r.split(h)[0]];return null},l.prototype.addBuildProperty=function(e,t,i){var r,o,n=F(this.pbxXCBuildConfigurationSection());for(r in n)o=n[r],i&&o.name!==i||(o.buildSettings[e]=t)},l.prototype.removeBuildProperty=function(e,t){var i,r,o=F(this.pbxXCBuildConfigurationSection());for(i in o)((r=o[i]).buildSettings[e]&&!t||r.name===t)&&delete r.buildSettings[e]},l.prototype.updateBuildProperty=function(e,t,i){var r=this.pbxXCBuildConfigurationSection();for(var o in r)if(!h.test(o)){var n=r[o];(i&&n.name===i||!i)&&(n.buildSettings[e]=t)}},l.prototype.updateProductName=function(e){this.updateBuildProperty("PRODUCT_NAME",'"'+e+'"')},l.prototype.removeFromFrameworkSearchPaths=function(e){var t,i,r,o=F(this.pbxXCBuildConfigurationSection()),n=x(e,this);for(t in o){if(B((i=o[t].buildSettings).PRODUCT_NAME)==this.productName)if((r=i.FRAMEWORK_SEARCH_PATHS)&&Array.isArray(r))r.filter(function(e){return e.indexOf(n)>-1}).forEach(function(e){var t=r.indexOf(e);r.splice(t,1)})}},l.prototype.addToFrameworkSearchPaths=function(e){var t,i,r=F(this.pbxXCBuildConfigurationSection());for(t in r)B((i=r[t].buildSettings).PRODUCT_NAME)==this.productName&&(i.FRAMEWORK_SEARCH_PATHS&&'"$(inherited)"'!==i.FRAMEWORK_SEARCH_PATHS||(i.FRAMEWORK_SEARCH_PATHS=['"$(inherited)"']),i.FRAMEWORK_SEARCH_PATHS.push(x(e,this)))},l.prototype.removeFromLibrarySearchPaths=function(e){var t,i,r,o=F(this.pbxXCBuildConfigurationSection()),n=x(e,this);for(t in o){if(B((i=o[t].buildSettings).PRODUCT_NAME)==this.productName)if((r=i.LIBRARY_SEARCH_PATHS)&&Array.isArray(r))r.filter(function(e){return e.indexOf(n)>-1}).forEach(function(e){var t=r.indexOf(e);r.splice(t,1)})}},l.prototype.addToLibrarySearchPaths=function(e){var t,i,r=F(this.pbxXCBuildConfigurationSection());for(t in r)B((i=r[t].buildSettings).PRODUCT_NAME)==this.productName&&(i.LIBRARY_SEARCH_PATHS&&'"$(inherited)"'!==i.LIBRARY_SEARCH_PATHS||(i.LIBRARY_SEARCH_PATHS=['"$(inherited)"']),"string"==typeof e?i.LIBRARY_SEARCH_PATHS.push(e):i.LIBRARY_SEARCH_PATHS.push(x(e,this)))},l.prototype.removeFromHeaderSearchPaths=function(e){var t,i,r=F(this.pbxXCBuildConfigurationSection()),o="HEADER_SEARCH_PATHS",n=x(e,this);for(t in r){if(B((i=r[t].buildSettings).PRODUCT_NAME)==this.productName)if(i[o])i[o].filter(function(e){return e.indexOf(n)>-1}).forEach(function(e){var t=i[o].indexOf(e);i[o].splice(t,1)})}},l.prototype.addToHeaderSearchPaths=function(e){var t,i,r=F(this.pbxXCBuildConfigurationSection());for(t in r)B((i=r[t].buildSettings).PRODUCT_NAME)==this.productName&&(i.HEADER_SEARCH_PATHS||(i.HEADER_SEARCH_PATHS=['"$(inherited)"']),"string"==typeof e?i.HEADER_SEARCH_PATHS.push(e):i.HEADER_SEARCH_PATHS.push(x(e,this)))},l.prototype.addToOtherLinkerFlags=function(e){var t,i,r=F(this.pbxXCBuildConfigurationSection());for(t in r)B((i=r[t].buildSettings).PRODUCT_NAME)==this.productName&&(i.OTHER_LDFLAGS&&'"$(inherited)"'!==i.OTHER_LDFLAGS||(i.OTHER_LDFLAGS=['"$(inherited)"']),i.OTHER_LDFLAGS.push(e))},l.prototype.removeFromOtherLinkerFlags=function(e){var t,i,r=F(this.pbxXCBuildConfigurationSection());for(t in r){if(B((i=r[t].buildSettings).PRODUCT_NAME)==this.productName)if(i.OTHER_LDFLAGS)i.OTHER_LDFLAGS.filter(function(t){return t.indexOf(e)>-1}).forEach(function(e){var t=i.OTHER_LDFLAGS.indexOf(e);i.OTHER_LDFLAGS.splice(t,1)})}},l.prototype.addToBuildSettings=function(e,t){var i,r=F(this.pbxXCBuildConfigurationSection());for(i in r)r[i].buildSettings[e]=t},l.prototype.removeFromBuildSettings=function(e){var t,i,r=F(this.pbxXCBuildConfigurationSection());for(t in r)(i=r[t].buildSettings)[e]&&delete i[e]},l.prototype.__defineGetter__("productName",function(){var e,t,i=F(this.pbxXCBuildConfigurationSection());for(e in i)if(t=i[e].buildSettings.PRODUCT_NAME)return B(t)}),l.prototype.hasFile=function(e){var t,i,r=F(this.pbxFileReferenceSection());for(i in r)if((t=r[i]).path==e||t.path=='"'+e+'"')return t;return!1},l.prototype.addTarget=function(e,t,i){var r=this.generateUuid(),n=t,a=i||e,s=e.trim();if(!s)throw new Error("Target name missing.");if(!n)throw new Error("Target type missing.");if(!S(n))throw new Error("Target type invalid: "+n);var u=[{name:"Debug",isa:"XCBuildConfiguration",buildSettings:{GCC_PREPROCESSOR_DEFINITIONS:['"DEBUG=1"','"$(inherited)"'],INFOPLIST_FILE:'"'+o.join(a,a+'-Info.plist"'),LD_RUNPATH_SEARCH_PATHS:'"$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks"',PRODUCT_NAME:'"'+s+'"',SKIP_INSTALL:"YES"}},{name:"Release",isa:"XCBuildConfiguration",buildSettings:{INFOPLIST_FILE:'"'+o.join(a,a+'-Info.plist"'),LD_RUNPATH_SEARCH_PATHS:'"$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks"',PRODUCT_NAME:'"'+s+'"',SKIP_INSTALL:"YES"}}],p=this.addXCConfigurationList(u,"Release",'Build configuration list for PBXNativeTarget "'+s+'"'),c=s,d=function(e){return FILETYPE_BY_PRODUCTTYPE={"com.apple.product-type.application":'"wrapper.application"',"com.apple.product-type.app-extension":'"wrapper.app-extension"',"com.apple.product-type.bundle":'"wrapper.plug-in"',"com.apple.product-type.tool":'"compiled.mach-o.dylib"',"com.apple.product-type.library.dynamic":'"compiled.mach-o.dylib"',"com.apple.product-type.framework":'"wrapper.framework"',"com.apple.product-type.library.static":'"archive.ar"',"com.apple.product-type.bundle.unit-test":'"wrapper.cfbundle"',"com.apple.product-type.application.watchapp":'"wrapper.application"',"com.apple.product-type.watchkit-extension":'"wrapper.app-extension"'},FILETYPE_BY_PRODUCTTYPE[e]}(S(n)),h=this.addProductFile(c,{group:"Copy Files",target:r,explicitFileType:d});h.basename;this.addToPbxBuildFileSection(h);var l={uuid:r,pbxNativeTarget:{isa:"PBXNativeTarget",name:'"'+s+'"',productName:'"'+s+'"',productReference:h.fileRef,productType:'"'+S(n)+'"',buildConfigurationList:p.uuid,buildPhases:[],buildRules:[],dependencies:[]}};return this.addToPbxNativeTargetSection(l),"app_extension"===n&&(this.addBuildPhase([],"PBXCopyFilesBuildPhase","Copy Files",this.getFirstTarget().uuid,n),this.addToPbxCopyfilesBuildPhase(h)),this.addToPbxProjectSection(l),this.addTargetDependency(this.getFirstTarget().uuid,[l.uuid]),l},l.prototype.getFirstProject=function(){var e=this.pbxProjectSection(),t=Object.keys(e)[0];return{uuid:t,firstProject:e[t]}},l.prototype.getFirstTarget=function(){var e=this.getFirstProject().firstProject.targets[0].value;return{uuid:e,firstTarget:this.pbxNativeTargetSection()[e]}},l.prototype.addToPbxGroupType=function(e,t,i){var r=this.getPBXGroupByKeyAndType(t,i);if(r&&void 0!==r.children)if("string"==typeof e){var o={value:e};this.getPBXGroupByKey(e)?o.comment=this.getPBXGroupByKey(e).name:this.getPBXVariantGroupByKey(e)&&(o.comment=this.getPBXVariantGroupByKey(e).name),r.children.push(o)}else r.children.push(m(e))},l.prototype.addToPbxVariantGroup=function(e,t){this.addToPbxGroupType(e,t,"PBXVariantGroup")},l.prototype.addToPbxGroup=function(e,t){this.addToPbxGroupType(e,t,"PBXGroup")},l.prototype.pbxCreateGroupWithType=function(e,t,i){var r={isa:'"'+i+'"',children:[],name:e,sourceTree:'"<group>"'};t&&(r.path=t);var o=this.generateUuid(),n=o+"_comment",a=this.hash.project.objects[i];return a||(a=this.hash.project.objects[i]=new Object),a[n]=e,a[o]=r,o},l.prototype.pbxCreateVariantGroup=function(e){return this.pbxCreateGroupWithType(e,void 0,"PBXVariantGroup")},l.prototype.pbxCreateGroup=function(e,t){return this.pbxCreateGroupWithType(e,t,"PBXGroup")},l.prototype.removeFromPbxGroupAndType=function(e,t,i){var r=this.getPBXGroupByKeyAndType(t,i);if(r){var o,n=r.children;for(o in n)if(m(e).value==n[o].value&&m(e).comment==n[o].comment){n.splice(o,1);break}}},l.prototype.removeFromPbxGroup=function(e,t){this.removeFromPbxGroupAndType(e,t,"PBXGroup")},l.prototype.removeFromPbxVariantGroup=function(e,t){this.removeFromPbxGroupAndType(e,t,"PBXVariantGroup")},l.prototype.getPBXGroupByKeyAndType=function(e,t){return this.hash.project.objects[t][e]},l.prototype.getPBXGroupByKey=function(e){return this.hash.project.objects.PBXGroup[e]},l.prototype.getPBXVariantGroupByKey=function(e){return this.hash.project.objects.PBXVariantGroup[e]},l.prototype.findPBXGroupKeyAndType=function(e,t){var i,r=this.hash.project.objects[t];for(var o in r)if(!h.test(o)){var n=r[o];if(e&&e.path&&e.name){if(e.path===n.path&&e.name===n.name){i=o;break}}else if(e&&e.path){if(e.path===n.path){i=o;break}}else if(e&&e.name&&e.name===n.name){i=o;break}}return i},l.prototype.findPBXGroupKey=function(e){return this.findPBXGroupKeyAndType(e,"PBXGroup")},l.prototype.findPBXVariantGroupKey=function(e){return this.findPBXGroupKeyAndType(e,"PBXVariantGroup")},l.prototype.addLocalizationVariantGroup=function(e){var t=this.pbxCreateVariantGroup(e),i=this.findPBXGroupKey({name:"Resources"});this.addToPbxGroup(t,i);var r={uuid:this.generateUuid(),fileRef:t,basename:e};return this.addToPbxBuildFileSection(r),this.addToPbxResourcesBuildPhase(r),r},l.prototype.addKnownRegion=function(e){this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions||(this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions=[]),this.hasKnownRegion(e)||this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions.push(e)},l.prototype.removeKnownRegion=function(e){var t=this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions;if(t){for(var i=0;i<t.length;i++)if(t[i]===e){t.splice(i,1);break}this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions=t}},l.prototype.hasKnownRegion=function(e){var t=this.pbxProjectSection()[this.getFirstProject().uuid].knownRegions;if(t)for(var i in t)if(t[i]===e)return!0;return!1},l.prototype.getPBXObject=function(e){return this.hash.project.objects[e]},l.prototype.addFile=function(e,t,i){var r=new u(e,i);return this.hasFile(r.path)?null:(r.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(r),this.getPBXGroupByKey(t)?this.addToPbxGroup(r,t):this.getPBXVariantGroupByKey(t)&&this.addToPbxVariantGroup(r,t),r)},l.prototype.removeFile=function(e,t,i){var r=new u(e,i);return this.removeFromPbxFileReferenceSection(r),this.getPBXGroupByKey(t)?this.removeFromPbxGroup(r,t):this.getPBXVariantGroupByKey(t)&&this.removeFromPbxVariantGroup(r,t),r},l.prototype.getBuildProperty=function(e,t){var i,r=this.pbxXCBuildConfigurationSection();for(var o in r)if(!h.test(o)){var n=r[o];(t&&n.name===t||void 0===t)&&void 0!==n.buildSettings[e]&&(i=n.buildSettings[e])}return i},l.prototype.getBuildConfigByName=function(e){var t={},i=this.pbxXCBuildConfigurationSection();for(var r in i)if(!h.test(r)){var o=i[r];o.name===e&&(t[r]=o)}return t},l.prototype.addDataModelDocument=function(e,t,i){t||(t="Resources"),this.getPBXGroupByKey(t)||(t=this.findPBXGroupKey({name:t}));var r,n=new u(e,i);if(!n||this.hasFile(n.path))return null;if(n.fileRef=this.generateUuid(),this.addToPbxGroup(n,t),!n)return!1;n.target=i?i.target:void 0,n.uuid=this.generateUuid(),this.addToPbxBuildFileSection(n),this.addToPbxSourcesBuildPhase(n),n.models=[];var a=p.readdirSync(n.path);for(var s in a){var c=a[s],h=o.join(e,c);if(".xccurrentversion"!=c){var l=new u(h);l.fileRef=this.generateUuid(),this.addToPbxFileReferenceSection(l),n.models.push(l),r&&r===c&&(n.currentModel=l)}else r=d.readFileSync(h)._XCCurrentVersionName}return n.currentModel||(n.currentModel=n.models[0]),this.addToXcVersionGroupSection(n),n},l.prototype.addTargetAttribute=function(e,t,i){var r=this.getFirstProject().firstProject.attributes;void 0===r.TargetAttributes&&(r.TargetAttributes={}),i=i||this.getFirstTarget(),void 0===r.TargetAttributes[i.uuid]&&(r.TargetAttributes[i.uuid]={}),r.TargetAttributes[i.uuid][e]=t},l.prototype.removeTargetAttribute=function(e,t){var i=this.getFirstProject().firstProject.attributes;t=t||this.getFirstTarget(),i.TargetAttributes&&i.TargetAttributes[t.uuid]&&delete i.TargetAttributes[t.uuid][e]},module.exports=l;