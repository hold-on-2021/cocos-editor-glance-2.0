require("util");var e=require("fs"),i=require("path"),n=require("events");function t(n,r,l){l||(l=r,r={}),l.files||(l.files={}),l.pending||(l.pending=0),l.pending+=1,e.stat(n,function(o,f){if(o)return l(o);l.files[n]=f,e.readdir(n,function(o,f){if(o)return"EACCES"===o.code&&r.ignoreUnreadableDir?l():l(o);l.pending-=1,f.forEach(function(o,f){o=i.join(n,o),l.pending+=1,e.stat(o,function(e,n){var f=!1,a=!1;if(e){if("ENOENT"!==e.code&&"EPERM"!==e.code&&r.ignoreNotPermitted)return l(e);f=!0}if(l.pending-=1,a=0===l.pending,!f){if(r.ignoreDotFiles&&"."===i.basename(o)[0])return a&&l(null,l.files);if(r.filter&&!r.filter(o,n))return a&&l(null,l.files);l.files[o]=n,!n.isDirectory()||r.ignoreDirectoryPattern&&r.ignoreDirectoryPattern.test(o)||t(o,r,l),(a=0===l.pending)&&l(null,l.files)}})}),0===l.pending&&l(null,l.files)}),0===l.pending&&l(null,l.files)})}var r=Object.create(null);exports.watchTree=function(n,l,o){o||(o=l,l={}),t(n,l,function(t,f){if(t)throw t;var a=function(n){var t={};l.interval&&(t.interval=1e3*l.interval),e.watchFile(n,t,function(t,r){f[n]&&!f[n].isDirectory()&&0!==t.nlink&&f[n].mtime.getTime()==t.mtime.getTime()||(f[n]=t,f[n].isDirectory()?e.readdir(n,function(t,r){t||r.forEach(function(t){var r=i.join(n,t);f[r]||!0===l.ignoreDotFiles&&"."==t[0]||e.stat(r,function(e,i){l.filter&&!l.filter(r,i)||(o(r,i,null),f[r]=i,a(r))})})}):o(n,t,r),0===t.nlink&&(delete f[n],e.unwatchFile(n)))})};for(var c in a(n),f)a(c);r[n]=f,o(f,null,null)})},exports.unwatchTree=function(i){r[i]&&(Object.keys(r[i]).forEach(e.unwatchFile),r[i]=!1)},exports.createMonitor=function(e,i,t){t||(t=i,i={});var r=new n.EventEmitter;r.stop=exports.unwatchTree.bind(null,e);var l={file:null,action:null,stat:null};exports.watchTree(e,i,function(e,i,n){if("object"==typeof e&&null==n&&null===i)return r.files=e,t(r);if(!n&&(l.file!=e||"created"!=l.action))return l={file:e,action:"created",stat:i},r.emit("created",e,i);if(i&&0===i.nlink&&(l.file!=e||"removed"!=l.action))return l={file:e,action:"removed",stat:i},r.emit("removed",e,i);if(null===l.file)return r.emit("changed",e,i,n);try{if(l.stat.mtime.getTime()!==i.mtime.getTime())return r.emit("changed",e,i,n)}catch(t){return r.emit("changed",e,i,n)}})},exports.walk=t;