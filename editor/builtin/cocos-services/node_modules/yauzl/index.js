var e=require("fs"),r=require("zlib"),t=require("fd-slicer"),n=require("buffer-crc32"),i=require("util"),o=require("events").EventEmitter,s=require("stream").Transform,a=require("stream").PassThrough,l=require("stream").Writable;function d(r,n,i){"function"==typeof n&&(i=n,n=null),null==n&&(n={}),null==n.autoClose&&(n.autoClose=!1),null==n.lazyEntries&&(n.lazyEntries=!1),null==n.decodeStrings&&(n.decodeStrings=!0),null==n.validateEntrySizes&&(n.validateEntrySizes=!0),null==n.strictFileNames&&(n.strictFileNames=!1),null==i&&(i=C),e.fstat(r,function(e,o){if(e)return i(e);u(t.createFromFd(r,{autoClose:!0}),o.size,n,i)})}function u(e,r,t,n){"function"==typeof t&&(n=t,t=null),null==t&&(t={}),null==t.autoClose&&(t.autoClose=!0),null==t.lazyEntries&&(t.lazyEntries=!1),null==t.decodeStrings&&(t.decodeStrings=!0);var i=!!t.decodeStrings;if(null==t.validateEntrySizes&&(t.validateEntrySizes=!0),null==t.strictFileNames&&(t.strictFileNames=!1),null==n&&(n=C),"number"!=typeof r)throw new Error("expected totalSize parameter to be a number");if(r>Number.MAX_SAFE_INTEGER)throw new Error("zip file too large. only file sizes up to 2^52 are supported due to JavaScript's Number type being an IEEE 754 double.");e.ref();var o=Math.min(65557,r),s=z(o),a=r-s.length;y(e,s,0,o,a,function(l){if(l)return n(l);for(var d=o-22;d>=0;d-=1)if(101010256===s.readUInt32LE(d)){var u=s.slice(d),c=u.readUInt16LE(4);if(0!==c)return n(new Error("multi-disk zip files are not supported: found disk number: "+c));var p=u.readUInt16LE(10),m=u.readUInt32LE(16),E=u.readUInt16LE(20),h=u.length-22;if(E!==h)return n(new Error("invalid comment length. expected: "+h+". found: "+E));var v=i?L(u,22,u.length,!1):u.slice(22);if(65535!==p&&4294967295!==m)return n(null,new f(e,m,r,p,v,t.autoClose,t.lazyEntries,i,t.validateEntrySizes,t.strictFileNames));var g=z(20),w=a+d-g.length;return y(e,g,0,g.length,w,function(o){if(o)return n(o);if(117853008!==g.readUInt32LE(0))return n(new Error("invalid zip64 end of central directory locator signature"));var s=x(g,8),a=z(56);y(e,a,0,a.length,s,function(o){return o?n(o):101075792!==a.readUInt32LE(0)?n(new Error("invalid zip64 end of central directory record signature")):(p=x(a,32),m=x(a,48),n(null,new f(e,m,r,p,v,t.autoClose,t.lazyEntries,i,t.validateEntrySizes,t.strictFileNames)))})}),void 0}n(new Error("end of central directory record signature not found"))})}function f(e,r,t,n,i,s,a,l,d,u){var f=this;o.call(f),f.reader=e,f.reader.on("error",function(e){p(f,e)}),f.reader.once("close",function(){f.emit("close")}),f.readEntryCursor=r,f.fileSize=t,f.entryCount=n,f.comment=i,f.entriesRead=0,f.autoClose=!!s,f.lazyEntries=!!a,f.decodeStrings=!!l,f.validateEntrySizes=!!d,f.strictFileNames=!!u,f.isOpen=!0,f.emittedError=!1,f.lazyEntries||f._readEntry()}function c(e,r){e.autoClose&&e.close(),p(e,r)}function p(e,r){e.emittedError||(e.emittedError=!0,e.emit("error",r))}function m(){}function E(e,r){return new Date(1980+(e>>9&127),(e>>5&15)-1,31&e,r>>11&31,r>>5&63,2*(31&r),0)}function h(e){return-1!==e.indexOf("\\")?"invalid characters in fileName: "+e:/^[a-zA-Z]:/.test(e)||/^\//.test(e)?"absolute path: "+e:-1!==e.split("/").indexOf("..")?"invalid relative path: "+e:null}function y(e,r,t,n,i,o){if(0===n)return setImmediate(function(){o(null,z(0))});e.read(r,t,n,i,function(e,r){return e?o(e):r<n?o(new Error("unexpected EOF")):(o(),void 0)})}function v(e){s.call(this),this.actualByteCount=0,this.expectedByteCount=e}function g(){o.call(this),this.refCount=0}function w(e){a.call(this),this.context=e,this.context.ref(),this.unreffedYet=!1}exports.open=function(r,t,n){"function"==typeof t&&(n=t,t=null);null==t&&(t={});null==t.autoClose&&(t.autoClose=!0);null==t.lazyEntries&&(t.lazyEntries=!1);null==t.decodeStrings&&(t.decodeStrings=!0);null==t.validateEntrySizes&&(t.validateEntrySizes=!0);null==t.strictFileNames&&(t.strictFileNames=!1);null==n&&(n=C);e.open(r,"r",function(r,i){if(r)return n(r);d(i,t,function(r,t){r&&e.close(i,C),n(r,t)})})},exports.fromFd=d,exports.fromBuffer=function(e,r,n){"function"==typeof r&&(n=r,r=null);null==r&&(r={});r.autoClose=!1,null==r.lazyEntries&&(r.lazyEntries=!1);null==r.decodeStrings&&(r.decodeStrings=!0);null==r.validateEntrySizes&&(r.validateEntrySizes=!0);null==r.strictFileNames&&(r.strictFileNames=!1);u(t.createFromBuffer(e,{maxChunkSize:65536}),e.length,r,n)},exports.fromRandomAccessReader=u,exports.dosDateTimeToDate=E,exports.validateFileName=h,exports.ZipFile=f,exports.Entry=m,exports.RandomAccessReader=g,i.inherits(f,o),f.prototype.close=function(){this.isOpen&&(this.isOpen=!1,this.reader.unref())},f.prototype.readEntry=function(){if(!this.lazyEntries)throw new Error("readEntry() called without lazyEntries:true");this._readEntry()},f.prototype._readEntry=function(){var e=this;if(e.entryCount===e.entriesRead)return setImmediate(function(){e.autoClose&&e.close(),e.emittedError||e.emit("end")}),void 0;if(!e.emittedError){var r=z(46);y(e.reader,r,0,r.length,e.readEntryCursor,function(t){if(t)return c(e,t);if(!e.emittedError){var i=new m,o=r.readUInt32LE(0);if(33639248!==o)return c(e,new Error("invalid central directory file header signature: 0x"+o.toString(16)));if(i.versionMadeBy=r.readUInt16LE(4),i.versionNeededToExtract=r.readUInt16LE(6),i.generalPurposeBitFlag=r.readUInt16LE(8),i.compressionMethod=r.readUInt16LE(10),i.lastModFileTime=r.readUInt16LE(12),i.lastModFileDate=r.readUInt16LE(14),i.crc32=r.readUInt32LE(16),i.compressedSize=r.readUInt32LE(20),i.uncompressedSize=r.readUInt32LE(24),i.fileNameLength=r.readUInt16LE(28),i.extraFieldLength=r.readUInt16LE(30),i.fileCommentLength=r.readUInt16LE(32),i.internalFileAttributes=r.readUInt16LE(36),i.externalFileAttributes=r.readUInt32LE(38),i.relativeOffsetOfLocalHeader=r.readUInt32LE(42),64&i.generalPurposeBitFlag)return c(e,new Error("strong encryption is not supported"));e.readEntryCursor+=46,r=z(i.fileNameLength+i.extraFieldLength+i.fileCommentLength),y(e.reader,r,0,r.length,e.readEntryCursor,function(t){if(t)return c(e,t);if(!e.emittedError){var o=0!=(2048&i.generalPurposeBitFlag);i.fileName=e.decodeStrings?L(r,0,i.fileNameLength,o):r.slice(0,i.fileNameLength);var s=i.fileNameLength+i.extraFieldLength,a=r.slice(i.fileNameLength,s);i.extraFields=[];for(var l=0;l<a.length-3;){var d=a.readUInt16LE(l+0),u=a.readUInt16LE(l+2),f=l+4,p=f+u;if(p>a.length)return c(e,new Error("extra field length exceeds extra field buffer size"));var m=z(u);a.copy(m,0,f,p),i.extraFields.push({id:d,data:m}),l=p}if(i.fileComment=e.decodeStrings?L(r,s,s+i.fileCommentLength,o):r.slice(s,s+i.fileCommentLength),i.comment=i.fileComment,e.readEntryCursor+=r.length,e.entriesRead+=1,4294967295===i.uncompressedSize||4294967295===i.compressedSize||4294967295===i.relativeOffsetOfLocalHeader){var E=null;for(l=0;l<i.extraFields.length;l++){if(1===(v=i.extraFields[l]).id){E=v.data;break}}if(null==E)return c(e,new Error("expected zip64 extended information extra field"));var y=0;if(4294967295===i.uncompressedSize){if(y+8>E.length)return c(e,new Error("zip64 extended information extra field does not include uncompressed size"));i.uncompressedSize=x(E,y),y+=8}if(4294967295===i.compressedSize){if(y+8>E.length)return c(e,new Error("zip64 extended information extra field does not include compressed size"));i.compressedSize=x(E,y),y+=8}if(4294967295===i.relativeOffsetOfLocalHeader){if(y+8>E.length)return c(e,new Error("zip64 extended information extra field does not include relative header offset"));i.relativeOffsetOfLocalHeader=x(E,y),y+=8}}if(e.decodeStrings)for(l=0;l<i.extraFields.length;l++){var v;if(28789===(v=i.extraFields[l]).id){if(v.data.length<6)continue;if(1!==v.data.readUInt8(0))continue;var g=v.data.readUInt32LE(1);if(n.unsigned(r.slice(0,i.fileNameLength))!==g)continue;i.fileName=L(v.data,5,v.data.length,!0);break}}if(e.validateEntrySizes&&0===i.compressionMethod){var w=i.uncompressedSize;if(i.isEncrypted()&&(w+=12),i.compressedSize!==w){var S="compressed/uncompressed size mismatch for stored file: "+i.compressedSize+" != "+i.uncompressedSize;return c(e,new Error(S))}}if(e.decodeStrings){e.strictFileNames||(i.fileName=i.fileName.replace(/\\/g,"/"));var C=h(i.fileName,e.validateFileNameOptions);if(null!=C)return c(e,new Error(C))}e.emit("entry",i),e.lazyEntries||e._readEntry()}})}})}},f.prototype.openReadStream=function(e,t,n){var i=this,o=0,s=e.compressedSize;if(null==n)n=t,t={};else{if(null!=t.decrypt){if(!e.isEncrypted())throw new Error("options.decrypt can only be specified for encrypted entries");if(!1!==t.decrypt)throw new Error("invalid options.decrypt value: "+t.decrypt);if(e.isCompressed()&&!1!==t.decompress)throw new Error("entry is encrypted and compressed, and options.decompress !== false")}if(null!=t.decompress){if(!e.isCompressed())throw new Error("options.decompress can only be specified for compressed entries");if(!1!==t.decompress&&!0!==t.decompress)throw new Error("invalid options.decompress value: "+t.decompress)}if(null!=t.start||null!=t.end){if(e.isCompressed()&&!1!==t.decompress)throw new Error("start/end range not allowed for compressed entry without options.decompress === false");if(e.isEncrypted()&&!1!==t.decrypt)throw new Error("start/end range not allowed for encrypted entry without options.decrypt === false")}if(null!=t.start){if((o=t.start)<0)throw new Error("options.start < 0");if(o>e.compressedSize)throw new Error("options.start > entry.compressedSize")}if(null!=t.end){if((s=t.end)<0)throw new Error("options.end < 0");if(s>e.compressedSize)throw new Error("options.end > entry.compressedSize");if(s<o)throw new Error("options.end < options.start")}}if(!i.isOpen)return n(new Error("closed"));if(e.isEncrypted()&&!1!==t.decrypt)return n(new Error("entry is encrypted, and options.decrypt !== false"));i.reader.ref();var a=z(30);y(i.reader,a,0,a.length,e.relativeOffsetOfLocalHeader,function(l){try{if(l)return n(l);var d=a.readUInt32LE(0);if(67324752!==d)return n(new Error("invalid local file header signature: 0x"+d.toString(16)));var u,f=a.readUInt16LE(26),c=a.readUInt16LE(28),p=e.relativeOffsetOfLocalHeader+a.length+f+c;if(0===e.compressionMethod)u=!1;else{if(8!==e.compressionMethod)return n(new Error("unsupported compression method: "+e.compressionMethod));u=null==t.decompress||t.decompress}var m=p,E=m+e.compressedSize;if(0!==e.compressedSize&&E>i.fileSize)return n(new Error("file data overflows file bounds: "+m+" + "+e.compressedSize+" > "+i.fileSize));var h=i.reader.createReadStream({start:m+o,end:m+s}),y=h;if(u){var g=!1,w=r.createInflateRaw();h.on("error",function(e){setImmediate(function(){g||w.emit("error",e)})}),h.pipe(w),i.validateEntrySizes?(y=new v(e.uncompressedSize),w.on("error",function(e){setImmediate(function(){g||y.emit("error",e)})}),w.pipe(y)):y=w,y.destroy=function(){g=!0,w!==y&&w.unpipe(y),h.unpipe(w),h.destroy()}}n(null,y)}finally{i.reader.unref()}})},m.prototype.getLastModDate=function(){return E(this.lastModFileDate,this.lastModFileTime)},m.prototype.isEncrypted=function(){return 0!=(1&this.generalPurposeBitFlag)},m.prototype.isCompressed=function(){return 8===this.compressionMethod},i.inherits(v,s),v.prototype._transform=function(e,r,t){if(this.actualByteCount+=e.length,this.actualByteCount>this.expectedByteCount){var n="too many bytes in the stream. expected "+this.expectedByteCount+". got at least "+this.actualByteCount;return t(new Error(n))}t(null,e)},v.prototype._flush=function(e){if(this.actualByteCount<this.expectedByteCount){var r="not enough bytes in the stream. expected "+this.expectedByteCount+". got only "+this.actualByteCount;return e(new Error(r))}e()},i.inherits(g,o),g.prototype.ref=function(){this.refCount+=1},g.prototype.unref=function(){var e=this;if(e.refCount-=1,!(e.refCount>0)){if(e.refCount<0)throw new Error("invalid unref");e.close(function(r){if(r)return e.emit("error",r);e.emit("close")})}},g.prototype.createReadStream=function(e){var r=e.start,t=e.end;if(r===t){var n=new a;return setImmediate(function(){n.end()}),n}var i=this._readStreamForRange(r,t),o=!1,s=new w(this);i.on("error",function(e){setImmediate(function(){o||s.emit("error",e)})}),s.destroy=function(){i.unpipe(s),s.unref(),i.destroy()};var l=new v(t-r);return s.on("error",function(e){setImmediate(function(){o||l.emit("error",e)})}),l.destroy=function(){o=!0,s.unpipe(l),s.destroy()},i.pipe(s).pipe(l)},g.prototype._readStreamForRange=function(e,r){throw new Error("not implemented")},g.prototype.read=function(e,r,t,n,i){var o=this.createReadStream({start:n,end:n+t}),s=new l,a=0;s._write=function(t,n,i){t.copy(e,r+a,0,t.length),a+=t.length,i()},s.on("finish",i),o.on("error",function(e){i(e)}),o.pipe(s)},g.prototype.close=function(e){setImmediate(e)},i.inherits(w,a),w.prototype._flush=function(e){this.unref(),e()},w.prototype.unref=function(e){this.unreffedYet||(this.unreffedYet=!0,this.context.unref())};var z,S="\0☺☻♥♦♣♠•◘○◙♂♀♪♫☼►◄↕‼¶§▬↨↑↓→←∟↔▲▼ !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~⌂ÇüéâäàåçêëèïîìÄÅÉæÆôöòûùÿÖÜ¢£¥₧ƒáíóúñÑªº¿⌐¬½¼¡«»░▒▓│┤╡╢╖╕╣║╗╝╜╛┐└┴┬├─┼╞╟╚╔╩╦╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀αßΓπΣσµτΦΘΩδ∞φε∩≡±≥≤⌠⌡÷≈°∙·√ⁿ²■ ";function L(e,r,t,n){if(n)return e.toString("utf8",r,t);for(var i="",o=r;o<t;o++)i+=S[e[o]];return i}function x(e,r){var t=e.readUInt32LE(r);return 4294967296*e.readUInt32LE(r+4)+t}function C(e){if(e)throw e}z="function"==typeof Buffer.allocUnsafe?function(e){return Buffer.allocUnsafe(e)}:function(e){return new Buffer(e)};