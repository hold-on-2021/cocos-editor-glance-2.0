"use strict";var t=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const e=t(require("fs")),i=t(require("path")),a=t(require("del")),s=t(require("make-dir")),r=require("../utils"),n=require("../error");var o;(function(t){t[t.File=0]="File",t[t.JavaFile=1]="JavaFile"})(o=exports.CodeType||(exports.CodeType={}));exports.FunctionPacker=class{constructor(t,e,a,s){this.name=e,this.root=t,this.ignore=a,this.funcPath=i.default.resolve(i.default.join(t,e)),this.incrementalPath=s}validPath(t){if(!e.default.existsSync(t))throw new n.CloudBaseError(`file not exist on ${t}`,{code:"FILE_NOT_FOUND"})}async getFileCode(){this.validPath(this.funcPath),this.tmpPath=i.default.join(this.root,".cloudbase_tmp"),this.funcDistPath=i.default.join(this.tmpPath,this.name),this.clean(),await s.default(this.funcDistPath);const t=i.default.resolve(this.funcDistPath,"dist.zip"),a={dirPath:this.funcPath,outputPath:t,ignore:this.ignore};this.incrementalPath&&(a.pattern=this.incrementalPath),await r.zipDir(a);const n=e.default.readFileSync(t).toString("base64");return await this.clean(),n}getJavaFileCode(){const{funcPath:t}=this,i=e.default.existsSync(`${t}.jar`),a=e.default.existsSync(`${t}.zip`);if(!i&&!a)return null;const s=i?`${t}.jar`:`${t}.zip`;return e.default.readFileSync(s).toString("base64")}async build(t){if(t===o.JavaFile)try{return await this.getJavaFileCode()}catch(t){throw this.clean(),new n.CloudBaseError(`函数代码打包失败：${t.message}`,{code:t.code})}if(t===o.File)try{return await this.getFileCode()}catch(t){throw this.clean(),new n.CloudBaseError(`函数代码打包失败：${t.message}`,{code:t.code})}}async clean(){this.funcDistPath&&a.default.sync([this.funcDistPath],{force:!0}),this.tmpPath&&a.default.sync([this.tmpPath],{force:!0})}};