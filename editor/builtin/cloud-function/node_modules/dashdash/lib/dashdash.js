var r=require("assert-plus"),n=require("util").format,e=require("fs"),o=require("path");!0;console.warn;function t(r){if(!r)return r;var n={};return Object.keys(r).forEach(function(e){n[e]=r[e]}),n}function a(r){for(var n="",e=0;e<r;e++)n+=" ";return n}function i(n,e,o){return null===n||void 0===n?a(e):"number"==typeof n?a(n):"string"==typeof n?n:(r.fail('invalid "'+o+'": not a string or number: '+n),void 0)}function s(r){return r.replace(/-/g,"_")}function p(r,n,e){return Boolean(e)}function l(n,e,o){return r.string(o,"arg"),o}function g(e,o,t){r.string(t,"arg");var a=Number(t);if(isNaN(a))throw new Error(n('arg for "%s" is not a number: "%s"',o,t));return a}function u(e,o,t){r.string(t,"arg");var a=Number(t);if(!/^[0-9-]+$/.test(t)||isNaN(a))throw new Error(n('arg for "%s" is not an integer: "%s"',o,t));return a}function f(e,o,t){r.string(t,"arg");var a=Number(t);if(!/^[0-9]+$/.test(t)||isNaN(a)||0===a)throw new Error(n('arg for "%s" is not a positive integer: "%s"',o,t));return a}function h(e,o,t){var a;if(r.string(t,"arg"),/^\d+$/.test(t))a=new Date(1e3*Number(t));else{if(!/^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}:\d{2}(\.\d+)?Z?)?$/i.test(t))throw new Error(n('arg for "%s" is not a valid date format: "%s"',o,t));a=new Date(t)}if("Invalid Date"===a.toString())throw new Error(n('arg for "%s" is an invalid date: "%s"',o,t));return a}var c={bool:{takesArg:!1,parseArg:p},string:{takesArg:!0,helpArg:"ARG",parseArg:l},number:{takesArg:!0,helpArg:"NUM",parseArg:g},integer:{takesArg:!0,helpArg:"INT",parseArg:u},positiveInteger:{takesArg:!0,helpArg:"INT",parseArg:f},date:{takesArg:!0,helpArg:"DATE",parseArg:h},arrayOfBool:{takesArg:!1,array:!0,parseArg:p},arrayOfString:{takesArg:!0,helpArg:"ARG",array:!0,parseArg:l},arrayOfNumber:{takesArg:!0,helpArg:"NUM",array:!0,parseArg:g},arrayOfInteger:{takesArg:!0,helpArg:"INT",array:!0,parseArg:u},arrayOfPositiveInteger:{takesArg:!0,helpArg:"INT",array:!0,parseArg:f},arrayOfDate:{takesArg:!0,helpArg:"INT",array:!0,parseArg:h}};function d(e){r.object(e,"config"),r.arrayOfObject(e.options,"config.options"),r.optionalBool(e.interspersed,"config.interspersed");var o=this;this.interspersed=void 0===e.interspersed||e.interspersed,this.allowUnknown=void 0!==e.allowUnknown&&e.allowUnknown,this.options=e.options.map(function(r){return t(r)}),this.optionFromName={},this.optionFromEnv={};for(var a=0;a<this.options.length;a++){var i=this.options[a];if(void 0===i.group||null===i.group){r.ok(c[i.type],n('invalid config.options.%d.type: "%s" in %j',a,i.type,i)),r.optionalString(i.name,n("config.options.%d.name",a)),r.optionalArrayOfString(i.names,n("config.options.%d.names",a)),r.ok((i.name||i.names)&&!(i.name&&i.names),n('exactly one of "name" or "names" required: %j',i)),r.optionalString(i.help,n("config.options.%d.help",a));var p=i.env||[];"string"==typeof p&&(p=[p]),r.optionalArrayOfString(p,n("config.options.%d.env",a)),r.optionalString(i.helpGroup,n("config.options.%d.helpGroup",a)),r.optionalBool(i.helpWrap,n("config.options.%d.helpWrap",a)),r.optionalBool(i.hidden,n("config.options.%d.hidden",a)),i.name?i.names=[i.name]:r.string(i.names[0],n("config.options.%d.names is empty",a)),i.key=s(i.names[0]),i.names.forEach(function(r){if(o.optionFromName[r])throw new Error(n('option name collision: "%s" used in %j and %j',r,o.optionFromName[r],i));o.optionFromName[r]=i}),p.forEach(function(r){if(o.optionFromEnv[r])throw new Error(n('option env collision: "%s" used in %j and %j',r,o.optionFromEnv[r],i));o.optionFromEnv[r]=i})}else r.optionalString(i.group,n("config.options.%d.group",a))}}d.prototype.optionTakesArg=function(r){return c[r.type].takesArg},d.prototype.parse=function(e){var o=this;Array.isArray(arguments[0])&&(e={argv:arguments[0],slice:arguments[1]}),r.optionalObject(e,"inputs"),e||(e={}),r.optionalArrayOfString(e.argv,"inputs.argv");var t=e.argv||process.argv,a=void 0!==e.slice?e.slice:2,i=t.slice(a),s=e.env||process.env,p={},l=[];function g(r,n,e,o,t){var a=c[r.type],i=a.parseArg(r,n,o);if(a.array)if(p[e]||(p[e]=[]),a.arrayFlatten&&Array.isArray(i))for(var s=0;s<i.length;s++)p[e].push(i[s]);else p[e].push(i);else p[e]=i;var g={key:e,value:i,from:t};l.push(g)}var u=[],f=0;r:for(;f<i.length;){var h=i[f];if("--"===h){f++;break}if("--"===h.slice(0,2)){var d=null,v=(k=h.slice(2)).indexOf("=");if(-1!==v&&(d=k.slice(v+1),k=k.slice(0,v)),E=this.optionFromName[k]){var m=this.optionTakesArg(E);if(null!==d&&!m)throw new Error(n('argument given to "--%s" option that does not take one: "%s"',k,h));if(m)if(null!==d)g(E,"--"+k,E.key,d,"argv");else{if(f+1>=i.length)throw new Error(n('do not have enough args for "--%s" option',k));g(E,"--"+k,E.key,i[f+1],"argv"),f++}else g(E,"--"+k,E.key,!0,"argv")}else{if(!this.allowUnknown)throw new Error(n('unknown option: "--%s"',k));if(!this.interspersed)break r;u.push(h)}}else if("-"===h[0]&&h.length>1){for(var y=1,A=!0;y<h.length;){var k=h[y];if(!(E=this.optionFromName[k])){if(A=!1,this.allowUnknown){if(this.interspersed){u.push(h);break}break r}throw h.length>2?new Error(n('unknown option: "-%s" in "%s" group',k,h)):new Error(n('unknown option: "-%s"',k))}if(this.optionTakesArg(E))break;y++}for(y=1;A&&y<h.length;){k=h[y],d=h.slice(y+1);var E=this.optionFromName[k];if(m=this.optionTakesArg(E)){if(d){g(E,"-"+k,E.key,d,"argv");break}if(f+1>=i.length)throw new Error(n('do not have enough args for "-%s" option',k));g(E,"-"+k,E.key,i[f+1],"argv"),f++;break}g(E,"-"+k,E.key,!0,"argv"),y++}}else{if(!this.interspersed)break r;u.push(h)}f++}return u=u.concat(i.slice(f)),Object.keys(this.optionFromEnv).forEach(function(r){var n=s[r];if(void 0!==n){var e=o.optionFromEnv[r];if(void 0===p[e.key])o.optionTakesArg(e)?g(e,r,e.key,n,"env"):""!==n&&g(e,r,e.key,"0"!==n,"env")}}),this.options.forEach(function(r){void 0===p[r.key]&&(void 0!==r.default?p[r.key]=r.default:r.type&&void 0!==c[r.type].default&&(p[r.key]=c[r.type].default))}),p._order=l,p._args=u,p},d.prototype.help=function(e){e=e||{},r.object(e,"config");var o=i(e.indent,4,"config.indent"),t=i(e.headingIndent,Math.round(o.length/2),"config.headingIndent");r.optionalString(e.nameSort,"config.nameSort");var s=e.nameSort||"length";r.ok(~["length","none"].indexOf(s),'invalid "config.nameSort"'),r.optionalNumber(e.maxCol,"config.maxCol"),r.optionalNumber(e.maxHelpCol,"config.maxHelpCol"),r.optionalNumber(e.minHelpCol,"config.minHelpCol"),r.optionalNumber(e.helpCol,"config.helpCol"),r.optionalBool(e.includeEnv,"config.includeEnv"),r.optionalBool(e.includeDefault,"config.includeDefault"),r.optionalBool(e.helpWrap,"config.helpWrap");var p=e.maxCol||80,l=e.minHelpCol||20,g=e.maxHelpCol||40,u=[],f=0;this.options.forEach(function(r){if(!r.hidden){if(void 0!==r.group&&null!==r.group)return u.push(null),void 0;var n=c[r.type],e=r.helpArg||n.helpArg||"ARG",o="",t=r.names.slice();"length"===s&&t.sort(function(r,n){return r.length<n.length?-1:n.length<r.length?1:0}),t.forEach(function(r,t){t>0&&(o+=", "),1===r.length?(o+="-"+r,n.takesArg&&(o+=" "+e)):(o+="--"+r,n.takesArg&&(o+="="+e))}),f=Math.max(f,o.length),u.push(o)}});var h=e.helpCol;h||(h=f+o.length+2,h=Math.min(Math.max(h,l),g));var d=-1;this.options.forEach(function(r){if(!r.hidden){if(d++,void 0!==r.group&&null!==r.group)return""===r.group?u[d]="":u[d]=(0===d?"":"\n")+t+r.group+":",void 0;var i;e.includeDefault&&(void 0!==r.default?i=n("Default: %j",r.default):r.type&&void 0!==c[r.type].default&&(i=n("Default: %j",c[r.type].default)));var s=u[d]=o+u[d];if(r.help||e.includeEnv&&r.env||i){var l=h-s.length;s+=l>=0?a(l):"\n"+a(h);var g="";if(r.env&&r.env.length&&e.includeEnv){g+="Environment: ";var f=c[r.type],v=r.helpArg||f.helpArg||"ARG";g+=(Array.isArray(r.env)?r.env:[r.env]).map(function(r){return f.takesArg?r+"="+v:r+"=1"}).join(", ")}var m=(r.help||"").trim();if(!1!==r.helpWrap&&!1!==e.helpWrap)m.length&&!~".!?\"'".indexOf(m.slice(-1))&&(m+="."),m.length&&(m+=" "),m+=g,i&&(g&&(m+=". "),m+=i),s+=function(r,n){var e=[],o="";return r.trim().split(/\s+/).forEach(function(r){var t=o.length+r.length;o.length>0&&(t+=1),t>n&&(e.push(o),o=""),o.length>0&&(o+=" "),o+=r}),e.push(o),e}(m,p-h).join("\n"+a(h));else{var y=m.split("\n").filter(function(r){return r.length});""!==g&&y.push(g),i&&y.push(i),s+=y.join("\n"+a(h))}u[d]=s}}});var v="";return u.length>0&&(v=u.join("\n")+"\n"),v},d.prototype.bashCompletion=function(n){return r.object(n,"args"),r.string(n.name,"args.name"),r.optionalString(n.specExtra,"args.specExtra"),r.optionalArrayOfString(n.argtypes,"args.argtypes"),y({name:n.name,specExtra:n.specExtra,argtypes:n.argtypes,options:this.options})};const v=o.join(__dirname,"../etc/dashdash.bash_completion.in");function m(e){r.object(e,"args"),r.object(e.options,"args.options"),r.optionalString(e.context,"args.context"),r.optionalBool(e.includeHidden,"args.includeHidden"),r.optionalArrayOfString(e.argtypes,"args.argtypes");var o=e.context||"",t=void 0!==e.includeHidden&&e.includeHidden,a=[],i=[],s=[],p=[];return(e.options||[]).forEach(function(r){if(void 0===r.group||null===r.group){var n=r.names||[r.name],e=A(r.type);if(e.takesArg){var o=r.completionType||e.completionType||r.type;n.forEach(function(n){1===n.length?(!t&&r.hidden||i.push("-"+n),p.push("-"+n+"="+o)):(!t&&r.hidden||s.push("--"+n),p.push("--"+n+"="+o))})}else n.forEach(function(n){!t&&r.hidden||(1===n.length?i.push("-"+n):s.push("--"+n))})}}),a.push(n('local cmd%s_shortopts="%s"',o,i.sort().join(" "))),a.push(n('local cmd%s_longopts="%s"',o,s.sort().join(" "))),a.push(n('local cmd%s_optargs="%s"',o,p.sort().join(" "))),e.argtypes&&a.push(n('local cmd%s_argtypes="%s"',o,e.argtypes.join(" "))),a.join("\n")}function y(n){r.object(n,"args"),r.object(n.options,"args.options"),r.string(n.name,"args.name"),r.optionalString(n.specExtra,"args.specExtra"),r.optionalArrayOfString(n.argtypes,"args.argtypes");var o={name:n.name,date:new Date,spec:m({options:n.options,argtypes:n.argtypes})};return n.specExtra&&(o.spec+="\n\n"+n.specExtra),function(r,n){return r.replace(/{{([a-zA-Z]+)}}/g,function(r,e){return n.hasOwnProperty(e)?n[e]:r})}(e.readFileSync(v,"utf8"),o)}function A(n){return r.string(n,"name"),c[n]}module.exports={createParser:function(r){return new d(r)},Parser:d,parse:function(n){r.object(n,"config"),r.optionalArrayOfString(n.argv,"config.argv"),r.optionalObject(n.env,"config.env");var e=(n=t(n)).argv;delete n.argv;var o=n.env;return delete n.env,new d(n).parse({argv:e,env:o})},addOptionType:function(n){r.object(n,"optionType"),r.string(n.name,"optionType.name"),r.bool(n.takesArg,"optionType.takesArg"),n.takesArg&&r.string(n.helpArg,"optionType.helpArg"),r.func(n.parseArg,"optionType.parseArg"),r.optionalBool(n.array,"optionType.array"),r.optionalBool(n.arrayFlatten,"optionType.arrayFlatten"),c[n.name]={takesArg:n.takesArg,helpArg:n.helpArg,parseArg:n.parseArg,array:n.array,arrayFlatten:n.arrayFlatten,default:n.default}},getOptionType:A,synopsisFromOpt:function(n){if(r.object(n,"o"),n.hasOwnProperty("group"))return null;var e=n.names||[n.name],o=A(n.type),t=n.helpArg||o&&o.helpArg||"ARG",a=[];return e.forEach(function(r){var n=(1===r.length?"-":"--")+r;o&&o.takesArg&&(n+=1===r.length?" "+t:"="+t),a.push(n)}),"[ "+a.join(" | ")+" ]"},BASH_COMPLETION_TEMPLATE_PATH:v,bashCompletionFromOptions:y,bashCompletionSpecFromOptions:m,parseBool:p,parseString:l,parseNumber:g,parseInteger:u,parsePositiveInteger:f,parseDate:h};