module.exports={bufferSplit:function(r,t){e.buffer(r),e.string(t);for(var n=[],o=0,a=0,i=0;i<r.length;++i)if(r[i]===t.charCodeAt(a)?++a:a=r[i]===t.charCodeAt(0)?1:0,a>=t.length){var c=i+1;n.push(r.slice(o,c-a)),o=c,a=0}o<=r.length&&n.push(r.slice(o,r.length));return n},addRSAMissing:function(r){e.object(r),f(r,t,[1,1]);var n,o=new s(r.part.d.data);if(!r.part.dmodp){var a=new s(r.part.p.data),i=o.mod(a.subtract(1));n=m(i),r.part.dmodp={name:"dmodp",data:n},r.parts.push(r.part.dmodp)}if(!r.part.dmodq){var c=new s(r.part.q.data),u=o.mod(c.subtract(1));n=m(u),r.part.dmodq={name:"dmodq",data:n},r.parts.push(r.part.dmodq)}},calculateDSAPublic:function(r,t,n){return e.buffer(r),e.buffer(t),e.buffer(n),r=new s(r),t=new s(t),n=new s(n),m(r.modPow(n,t))},calculateED25519Public:function(t){e.buffer(t);var n=u.sign.keyPair.fromSeed(new Uint8Array(t));return r.from(n.publicKey)},calculateX25519Public:function(t){e.buffer(t);var n=u.box.keyPair.fromSeed(new Uint8Array(t));return r.from(n.publicKey)},mpNormalize:d,mpDenormalize:function(r){e.buffer(r);for(;r.length>1&&0===r[0];)r=r.slice(1);return r},ecNormalize:function(t,n){if(e.buffer(t),0===t[0]&&4===t[1])return n?t:t.slice(1);if(4===t[0]){if(!n)return t}else{for(;0===t[0];)t=t.slice(1);if(2===t[0]||3===t[0])throw new Error("Compressed elliptic curve points are not supported");if(4!==t[0])throw new Error("Not a valid elliptic curve point");if(!n)return t}var o=r.alloc(t.length+1);return o[0]=0,t.copy(o,1),o},countZeros:function(e){var r=0,t=8;for(;r<e.length;){var n=1<<t;if((e[r]&n)===n)break;--t<0&&(r++,t=8)}return 8*r+(8-t)-1},assertCompatible:f,isCompatible:function(e,r,t){if(null===e||"object"!=typeof e)return!1;void 0===t&&(t=r.prototype._sshpkApiVersion);if(e instanceof r&&r.prototype._sshpkApiVersion[0]==t[0])return!0;var n=Object.getPrototypeOf(e),o=0;for(;n.constructor.name!==r.name;)if(!(n=Object.getPrototypeOf(n))||++o>p)return!1;if(n.constructor.name!==r.name)return!1;var a=n._sshpkApiVersion;void 0===a&&(a=r._oldVersionDetect(e));return!(a[0]!=t[0]||a[1]<t[1])},opensslKeyDeriv:function(t,n,a,i){e.buffer(n,"salt"),e.buffer(a,"passphrase"),e.number(i,"iteration count");var c,s,u,p=l[t];e.object(p,"supported cipher"),n=n.slice(0,b);var f=r.alloc(0);for(;f.length<p.key+p.iv;){u=[],s&&u.push(s),u.push(a),u.push(n),c=r.concat(u);for(var d=0;d<i;++d)c=o.createHash("md5").update(c).digest();f=r.concat([f,c]),s=c}return{key:f.slice(0,p.key),iv:f.slice(p.key,p.key+p.iv)}},opensshCipherInfo:function(e){var r={};switch(e){case"3des-cbc":r.keySize=24,r.blockSize=8,r.opensslName="des-ede3-cbc";break;case"blowfish-cbc":r.keySize=16,r.blockSize=8,r.opensslName="bf-cbc";break;case"aes128-cbc":case"aes128-ctr":case"aes128-gcm@openssh.com":r.keySize=16,r.blockSize=16,r.opensslName="aes-128-"+e.slice(7,10);break;case"aes192-cbc":case"aes192-ctr":case"aes192-gcm@openssh.com":r.keySize=24,r.blockSize=16,r.opensslName="aes-192-"+e.slice(7,10);break;case"aes256-cbc":case"aes256-ctr":case"aes256-gcm@openssh.com":r.keySize=32,r.blockSize=16,r.opensslName="aes-256-"+e.slice(7,10);break;default:throw new Error('Unsupported openssl cipher "'+e+'"')}return r},publicFromPrivateECDSA:function(t,o){e.string(t,"curveName"),e.buffer(o);var i=a.curves[t],u=new s(i.p),p=new s(i.a),f=new s(i.b),l=new c.ECCurveFp(u,p,f),b=l.decodePointHex(i.G.toString("hex")),m=new s(d(o)),v=b.multiply(m);v=r.from(l.encodePointHex(v),"hex");var h=[];return h.push({name:"curve",data:r.from(t)}),h.push({name:"Q",data:v}),new n({type:"ecdsa",curve:l,parts:h})},zeroPadToLength:function(t,n){e.buffer(t),e.number(n);for(;t.length>n;)e.equal(t[0],0),t=t.slice(1);for(;t.length<n;){var o=r.alloc(t.length+1);o[0]=0,t.copy(o,1),t=o}return t},writeBitString:function(e,t,n){void 0===n&&(n=i.Ber.BitString);var o=r.alloc(t.length+1);o[0]=0,t.copy(o,1),e.writeBuffer(o,n)},readBitString:function(r,t){void 0===t&&(t=i.Ber.BitString);var n=r.readString(t,!0);return e.strictEqual(n[0],0,"bit strings with unused bits are not supported (0x"+n[0].toString(16)+")"),n.slice(1)},pbkdf2:function(e,t,n,a,i){var c=r.alloc(t.length+4);t.copy(c);var s=0,u=[],p=1;for(;s<a;){var f=l(p++);s+=f.length,u.push(f)}return r.concat(u).slice(0,a);function l(r){c.writeUInt32BE(r,c.length-4);var t=o.createHmac(e,i);t.update(c);for(var a=t.digest(),s=a,u=1;u++<n;){(t=o.createHmac(e,i)).update(s),s=t.digest();for(var p=0;p<a.length;++p)a[p]^=s[p]}return a}}};var e=require("assert-plus"),r=require("safer-buffer").Buffer,t=require("./private-key"),n=require("./key"),o=require("crypto"),a=require("./algs"),i=require("asn1"),c=require("ecc-jsbn/lib/ec"),s=require("jsbn").BigInteger,u=require("tweetnacl"),p=3;function f(r,t,n,o){if(void 0===o&&(o="object"),e.ok(r,o+" must not be null"),e.object(r,o+" must be an object"),void 0===n&&(n=t.prototype._sshpkApiVersion),!(r instanceof t&&t.prototype._sshpkApiVersion[0]==n[0])){for(var a=Object.getPrototypeOf(r),i=0;a.constructor.name!==t.name;)a=Object.getPrototypeOf(a),e.ok(a&&++i<=p,o+" must be a "+t.name+" instance");e.strictEqual(a.constructor.name,t.name,o+" must be a "+t.name+" instance");var c=a._sshpkApiVersion;void 0===c&&(c=t._oldVersionDetect(r)),e.ok(c[0]==n[0]&&c[1]>=n[1],o+" must be compatible with "+t.name+" klass version "+n[0]+"."+n[1])}}var l={"des-ede3-cbc":{key:24,iv:8},"aes-128-cbc":{key:16,iv:16},"aes-256-cbc":{key:32,iv:16}},b=8;function d(t){for(e.buffer(t);t.length>1&&0===t[0]&&0==(128&t[1]);)t=t.slice(1);if(128==(128&t[0])){var n=r.alloc(t.length+1);n[0]=0,t.copy(n,1),t=n}return t}function m(e){var t=r.from(e.toByteArray());return t=d(t)}