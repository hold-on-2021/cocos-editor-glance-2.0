module.exports=m;var t,e=require("assert-plus"),r=require("./algs"),i=require("crypto"),s=require("./fingerprint"),o=require("./signature"),a=require("./dhe").DiffieHellman,n=require("./errors"),h=require("./utils"),f=require("./private-key");try{t=require("./ed-compat")}catch(t){}var p=n.InvalidAlgorithmError,c=n.KeyParseError,u={};function m(t){e.object(t,"options"),e.arrayOfObject(t.parts,"options.parts"),e.string(t.type,"options.type"),e.optionalString(t.comment,"options.comment");var i=r.info[t.type];if("object"!=typeof i)throw new p(t.type);for(var s,o={},a=0;a<t.parts.length;++a){var n=t.parts[a];o[n.name]=n}if(this.type=t.type,this.parts=t.parts,this.part=o,this.comment=void 0,this.source=t.source,this._rfc4253Cache=t._rfc4253Cache,this._hashCache={},this.curve=void 0,"ecdsa"===this.type){var f=this.part.curve.data.toString();this.curve=f,s=r.curves[f].size}else if("ed25519"===this.type||"curve25519"===this.type)s=256,this.curve="curve25519";else{var c=this.part[i.sizePart];s=8*(s=c.data.length)-h.countZeros(c.data)}this.size=s}u.auto=require("./formats/auto"),u.pem=require("./formats/pem"),u.pkcs1=require("./formats/pkcs1"),u.pkcs8=require("./formats/pkcs8"),u.rfc4253=require("./formats/rfc4253"),u.ssh=require("./formats/ssh"),u["ssh-private"]=require("./formats/ssh-private"),u.openssh=u["ssh-private"],u.dnssec=require("./formats/dnssec"),u.putty=require("./formats/putty"),u.ppk=u.putty,m.formats=u,m.prototype.toBuffer=function(t,r){return void 0===t&&(t="ssh"),e.string(t,"format"),e.object(u[t],"formats[format]"),e.optionalObject(r,"options"),"rfc4253"===t?(void 0===this._rfc4253Cache&&(this._rfc4253Cache=u.rfc4253.write(this)),this._rfc4253Cache):u[t].write(this,r)},m.prototype.toString=function(t,e){return this.toBuffer(t,e).toString()},m.prototype.hash=function(t,s){if(e.string(t,"algorithm"),e.optionalString(s,"type"),void 0===s&&(s="ssh"),t=t.toLowerCase(),void 0===r.hashAlgs[t])throw new p(t);var o,a=t+"||"+s;if(this._hashCache[a])return this._hashCache[a];if("ssh"===s)o=this.toBuffer("rfc4253");else{if("spki"!==s)throw new Error("Hash type "+s+" not supported");o=u.pkcs8.pkcs8ToBuffer(this)}var n=i.createHash(t).update(o).digest();return this._hashCache[a]=n,n},m.prototype.fingerprint=function(t,r){void 0===t&&(t="sha256"),void 0===r&&(r="ssh"),e.string(t,"algorithm"),e.string(r,"type");var i={type:"key",hash:this.hash(t,r),algorithm:t,hashType:r};return new s(i)},m.prototype.defaultHashAlgorithm=function(){var t="sha1";return"rsa"===this.type&&(t="sha256"),"dsa"===this.type&&this.size>1024&&(t="sha256"),"ed25519"===this.type&&(t="sha512"),"ecdsa"===this.type&&(t=this.size<=256?"sha256":this.size<=384?"sha384":"sha512"),t},m.prototype.createVerify=function(r){if(void 0===r&&(r=this.defaultHashAlgorithm()),e.string(r,"hash algorithm"),"ed25519"===this.type&&void 0!==t)return new t.Verifier(this,r);if("curve25519"===this.type)throw new Error("Curve25519 keys are not suitable for signing or verification");var s,a,n;try{a=r.toUpperCase(),s=i.createVerify(a)}catch(t){n=t}(void 0===s||n instanceof Error&&n.message.match(/Unknown message digest/))&&(a="RSA-",a+=r.toUpperCase(),s=i.createVerify(a)),e.ok(s,"failed to create verifier");var h=s.verify.bind(s),f=this.toBuffer("pkcs8"),p=this.curve,c=this;return s.verify=function(t,e){if(o.isSignature(t,[2,0]))return t.type===c.type&&((!t.hashAlgorithm||t.hashAlgorithm===r)&&((!t.curve||"ecdsa"!==c.type||t.curve===p)&&h(f,t.toBuffer("asn1"))));if("string"==typeof t||Buffer.isBuffer(t))return h(f,t,e);throw o.isSignature(t,[1,0])?new Error("signature was created by too old a version of sshpk and cannot be verified"):new TypeError("signature must be a string, Buffer, or Signature object")},s},m.prototype.createDiffieHellman=function(){if("rsa"===this.type)throw new Error("RSA keys do not support Diffie-Hellman");return new a(this)},m.prototype.createDH=m.prototype.createDiffieHellman,m.parse=function(t,r,i){"string"!=typeof t&&e.buffer(t,"data"),void 0===r&&(r="auto"),e.string(r,"format"),"string"==typeof i&&(i={filename:i}),e.optionalObject(i,"options"),void 0===i&&(i={}),e.optionalString(i.filename,"options.filename"),void 0===i.filename&&(i.filename="(unnamed)"),e.object(u[r],"formats[format]");try{var s=u[r].read(t,i);return s instanceof f&&(s=s.toPublic()),s.comment||(s.comment=i.filename),s}catch(t){if("KeyEncryptedError"===t.name)throw t;throw new c(i.filename,r,t)}},m.isKey=function(t,e){return h.isCompatible(t,m,e)},m.prototype._sshpkApiVersion=[1,7],m._oldVersionDetect=function(t){return e.func(t.toBuffer),e.func(t.fingerprint),t.createDH?[1,4]:t.defaultHashAlgorithm?[1,3]:t.formats.auto?[1,2]:t.formats.pkcs1?[1,1]:[1,0]};