module.exports=c;var e=require("assert-plus"),t=require("safer-buffer").Buffer,i=require("./algs"),r=require("crypto"),s=require("./fingerprint"),o=(require("./signature"),require("./errors")),n=(require("util"),require("./utils")),a=require("./key"),u=require("./private-key"),p=require("./identity"),l={};l.openssh=require("./formats/openssh-cert"),l.x509=require("./formats/x509"),l.pem=require("./formats/x509-pem");var f=o.CertificateParseError,h=o.InvalidAlgorithmError;function c(t){e.object(t,"options"),e.arrayOfObject(t.subjects,"options.subjects"),n.assertCompatible(t.subjects[0],p,[1,0],"options.subjects"),n.assertCompatible(t.subjectKey,a,[1,0],"options.subjectKey"),n.assertCompatible(t.issuer,p,[1,0],"options.issuer"),void 0!==t.issuerKey&&n.assertCompatible(t.issuerKey,a,[1,0],"options.issuerKey"),e.object(t.signatures,"options.signatures"),e.buffer(t.serial,"options.serial"),e.date(t.validFrom,"options.validFrom"),e.date(t.validUntil,"optons.validUntil"),e.optionalArrayOfString(t.purposes,"options.purposes"),this._hashCache={},this.subjects=t.subjects,this.issuer=t.issuer,this.subjectKey=t.subjectKey,this.issuerKey=t.issuerKey,this.signatures=t.signatures,this.serial=t.serial,this.validFrom=t.validFrom,this.validUntil=t.validUntil,this.purposes=t.purposes}c.formats=l,c.prototype.toBuffer=function(t,i){return void 0===t&&(t="x509"),e.string(t,"format"),e.object(l[t],"formats[format]"),e.optionalObject(i,"options"),l[t].write(this,i)},c.prototype.toString=function(e,t){return void 0===e&&(e="pem"),this.toBuffer(e,t).toString()},c.prototype.fingerprint=function(t){void 0===t&&(t="sha256"),e.string(t,"algorithm");var i={type:"certificate",hash:this.hash(t),algorithm:t};return new s(i)},c.prototype.hash=function(t){if(e.string(t,"algorithm"),t=t.toLowerCase(),void 0===i.hashAlgs[t])throw new h(t);if(this._hashCache[t])return this._hashCache[t];var s=r.createHash(t).update(this.toBuffer("x509")).digest();return this._hashCache[t]=s,s},c.prototype.isExpired=function(e){return void 0===e&&(e=new Date),!(e.getTime()>=this.validFrom.getTime()&&e.getTime()<this.validUntil.getTime())},c.prototype.isSignedBy=function(e){return n.assertCompatible(e,c,[1,0],"issuer"),!!this.issuer.equals(e.subjects[0])&&(!(this.issuer.purposes&&this.issuer.purposes.length>0&&-1===this.issuer.purposes.indexOf("ca"))&&this.isSignedByKey(e.subjectKey))},c.prototype.getExtension=function(t){return e.string(t,"keyOrOid"),this.getExtensions().filter(function(e){return"x509"===e.format?e.oid===t:"openssh"===e.format&&e.name===t})[0]},c.prototype.getExtensions=function(){var e=[],t=this.signatures.x509;t&&t.extras&&t.extras.exts&&t.extras.exts.forEach(function(t){t.format="x509",e.push(t)});var i=this.signatures.openssh;return i&&i.exts&&i.exts.forEach(function(t){t.format="openssh",e.push(t)}),e},c.prototype.isSignedByKey=function(e){if(n.assertCompatible(e,a,[1,2],"issuerKey"),void 0!==this.issuerKey)return this.issuerKey.fingerprint("sha512").matches(e);var t=Object.keys(this.signatures)[0],i=l[t].verify(this,e);return i&&(this.issuerKey=e),i},c.prototype.signWith=function(e){n.assertCompatible(e,u,[1,2],"key");for(var t=Object.keys(l),i=!1,r=0;r<t.length;++r){if("pem"!==t[r])!0===l[t[r]].sign(this,e)&&(i=!0)}if(!i)throw new Error("Failed to sign the certificate for any available certificate formats")},c.createSelfSigned=function(i,r,s){var o;o=Array.isArray(i)?i:[i],e.arrayOfObject(o),o.forEach(function(e){n.assertCompatible(e,p,[1,0],"subject")}),n.assertCompatible(r,u,[1,2],"private key"),e.optionalObject(s,"options"),void 0===s&&(s={}),e.optionalObject(s.validFrom,"options.validFrom"),e.optionalObject(s.validUntil,"options.validUntil");var a=s.validFrom,l=s.validUntil;if(void 0===a&&(a=new Date),void 0===l){e.optionalNumber(s.lifetime,"options.lifetime");var f=s.lifetime;void 0===f&&(f=31536e4),(l=new Date).setTime(l.getTime()+1e3*f)}e.optionalBuffer(s.serial,"options.serial");var h=s.serial;void 0===h&&(h=t.from("0000000000000001","hex"));var d=s.purposes;if(void 0===d&&(d=[]),-1===d.indexOf("signature")&&d.push("signature"),-1===d.indexOf("ca")&&d.push("ca"),-1===d.indexOf("crl")&&d.push("crl"),d.length<=3){var m=o.filter(function(e){return"host"===e.type}),v=o.filter(function(e){return"user"===e.type});m.length>0&&-1===d.indexOf("serverAuth")&&d.push("serverAuth"),v.length>0&&-1===d.indexOf("clientAuth")&&d.push("clientAuth"),(v.length>0||m.length>0)&&(-1===d.indexOf("keyAgreement")&&d.push("keyAgreement"),"rsa"===r.type&&-1===d.indexOf("encryption")&&d.push("encryption"))}var y=new c({subjects:o,issuer:o[0],subjectKey:r.toPublic(),issuerKey:r.toPublic(),signatures:{},serial:h,validFrom:a,validUntil:l,purposes:d});return y.signWith(r),y},c.create=function(i,r,s,o,l){var f;f=Array.isArray(i)?i:[i],e.arrayOfObject(f),f.forEach(function(e){n.assertCompatible(e,p,[1,0],"subject")}),n.assertCompatible(r,a,[1,0],"key"),u.isPrivateKey(r)&&(r=r.toPublic()),n.assertCompatible(s,p,[1,0],"issuer"),n.assertCompatible(o,u,[1,2],"issuer key"),e.optionalObject(l,"options"),void 0===l&&(l={}),e.optionalObject(l.validFrom,"options.validFrom"),e.optionalObject(l.validUntil,"options.validUntil");var h=l.validFrom,d=l.validUntil;if(void 0===h&&(h=new Date),void 0===d){e.optionalNumber(l.lifetime,"options.lifetime");var m=l.lifetime;void 0===m&&(m=31536e4),(d=new Date).setTime(d.getTime()+1e3*m)}e.optionalBuffer(l.serial,"options.serial");var v=l.serial;void 0===v&&(v=t.from("0000000000000001","hex"));var y=l.purposes;void 0===y&&(y=[]),-1===y.indexOf("signature")&&y.push("signature"),!0===l.ca&&(-1===y.indexOf("ca")&&y.push("ca"),-1===y.indexOf("crl")&&y.push("crl"));var g=f.filter(function(e){return"host"===e.type}),b=f.filter(function(e){return"user"===e.type});g.length>0&&-1===y.indexOf("serverAuth")&&y.push("serverAuth"),b.length>0&&-1===y.indexOf("clientAuth")&&y.push("clientAuth"),(b.length>0||g.length>0)&&(-1===y.indexOf("keyAgreement")&&y.push("keyAgreement"),"rsa"===r.type&&-1===y.indexOf("encryption")&&y.push("encryption"));var x=new c({subjects:f,issuer:s,subjectKey:r,issuerKey:o.toPublic(),signatures:{},serial:v,validFrom:h,validUntil:d,purposes:y});return x.signWith(o),x},c.parse=function(t,i,r){"string"!=typeof t&&e.buffer(t,"data"),void 0===i&&(i="auto"),e.string(i,"format"),"string"==typeof r&&(r={filename:r}),e.optionalObject(r,"options"),void 0===r&&(r={}),e.optionalString(r.filename,"options.filename"),void 0===r.filename&&(r.filename="(unnamed)"),e.object(l[i],"formats[format]");try{return l[i].read(t,r)}catch(e){throw new f(r.filename,i,e)}},c.isCertificate=function(e,t){return n.isCompatible(e,c,t)},c.prototype._sshpkApiVersion=[1,1],c._oldVersionDetect=function(e){return[1,0]};