module.exports={read:function(c,l){"string"==typeof c&&(c=t.from(c,"binary"));e.buffer(c,"buf");var g=new r.BerReader(c);if(g.readSequence(),Math.abs(g.length-g.remain)>1)throw new Error("DER sequence does not contain whole byte stream");var p=g.offset;g.readSequence();var h=g.offset+g.length,v=h;if(g.peek()===o(0)){g.readSequence(o(0));var S=g.readInt();e.ok(S<=3,"only x.509 versions up to v3 supported")}var m={signatures:{}},x=m.signatures.x509={};x.extras={},m.serial=function(t,s){return e.strictEqual(t.peek(),r.Ber.Integer,s+" is not an Integer"),a.mpNormalize(t.readString(r.Ber.Integer,!0))}(g,"serial"),g.readSequence();var B=g.offset+g.length,y=g.readOID();if(void 0===f[y])throw new Error("unknown signature algorithm "+y);g._offset=B,m.issuer=s.parseAsn1(g),g.readSequence(),m.validFrom=d(g),m.validUntil=d(g),m.subjects=[s.parseAsn1(g)],g.readSequence(),B=g.offset+g.length,m.subjectKey=u.readPkcs8(void 0,"public",g),g._offset=B,g.peek()===o(1)&&(g.readSequence(o(1)),x.extras.issuerUniqueID=c.slice(g.offset,g.offset+g.length),g._offset+=g.length);g.peek()===o(2)&&(g.readSequence(o(2)),x.extras.subjectUniqueID=c.slice(g.offset,g.offset+g.length),g._offset+=g.length);if(g.peek()===o(3)){g.readSequence(o(3));var b=g.offset+g.length;for(g.readSequence();g.offset<b;)q(m,c,g);e.strictEqual(g.offset,b)}e.strictEqual(g.offset,h),g.readSequence(),B=g.offset+g.length;var w=g.readOID(),I=f[w];if(void 0===I)throw new Error("unknown signature algorithm "+w);g._offset=B;var U=g.readString(r.Ber.BitString,!0);0===U[0]&&(U=U.slice(1));var k=I.split("-");return x.signature=n.parse(U,k[0],"asn1"),x.signature.hashAlgorithm=k[1],x.algo=I,x.cache=c.slice(p,v),new i(m)},verify:function(t,a){var s=t.signatures.x509;e.object(s,"x509 signature");var n=s.algo.split("-");if(n[0]!==a.type)return!1;var i=s.cache;if(void 0===i){var u=new r.BerWriter;y(t,u),i=u.buffer}var o=a.createVerify(n[1]);return o.write(i),o.verify(s.signature)},sign:function(e,t){void 0===e.signatures.x509&&(e.signatures.x509={});var a=e.signatures.x509;if(a.algo=t.type+"-"+t.defaultHashAlgorithm(),void 0===f[a.algo])return!1;var s=new r.BerWriter;y(e,s);var n=s.buffer;a.cache=n;var i=t.createSign();return i.write(n),e.signatures.x509.signature=i.sign(),!0},signAsync:function(e,t,a){void 0===e.signatures.x509&&(e.signatures.x509={});var s=e.signatures.x509,n=new r.BerWriter;y(e,n);var i=n.buffer;s.cache=i,t(i,function(e,r){return e?(a(e),void 0):(s.algo=r.type+"-"+r.hashAlgorithm,void 0===f[s.algo]?(a(new Error('Invalid signing algorithm "'+s.algo+'"')),void 0):(s.signature=r,a(),void 0))})},write:function(a,s){var n=a.signatures.x509;e.object(n,"x509 signature");var i=new r.BerWriter;i.startSequence(),n.cache?(i._ensure(n.cache.length),n.cache.copy(i._buf,i._offset),i._offset+=n.cache.length):y(a,i);i.startSequence(),i.writeOID(f[n.algo]),n.algo.match(/^rsa-/)&&i.writeNull();i.endSequence();var u=n.signature.toBuffer("asn1"),o=t.alloc(u.length+1);return o[0]=0,u.copy(o,1),i.writeBuffer(o,r.Ber.BitString),i.endSequence(),i.buffer}};var e=require("assert-plus"),r=require("asn1"),t=require("safer-buffer").Buffer,a=(require("../algs"),require("../utils")),s=(require("../key"),require("../private-key"),require("./pem"),require("../identity")),n=require("../signature"),i=require("../certificate"),u=require("./pkcs8");function o(e){return r.Ber.Context|r.Ber.Constructor|e}function c(e){return r.Ber.Context|e}var f={"rsa-md5":"1.2.840.113549.1.1.4","rsa-sha1":"1.2.840.113549.1.1.5","rsa-sha256":"1.2.840.113549.1.1.11","rsa-sha384":"1.2.840.113549.1.1.12","rsa-sha512":"1.2.840.113549.1.1.13","dsa-sha1":"1.2.840.10040.4.3","dsa-sha256":"2.16.840.1.101.3.4.3.2","ecdsa-sha1":"1.2.840.10045.4.1","ecdsa-sha256":"1.2.840.10045.4.3.2","ecdsa-sha384":"1.2.840.10045.4.3.3","ecdsa-sha512":"1.2.840.10045.4.3.4","ed25519-sha512":"1.3.101.112"};Object.keys(f).forEach(function(e){f[f[e]]=e}),f["1.3.14.3.2.3"]="rsa-md5",f["1.3.14.3.2.29"]="rsa-sha1";var l={issuerKeyId:"2.5.29.35",altName:"2.5.29.17",basicConstraints:"2.5.29.19",keyUsage:"2.5.29.15",extKeyUsage:"2.5.29.37"};function d(t){if(t.peek()===r.Ber.UTCTime)return function(r){var t=r.match(m);e.ok(t,"timestamps must be in UTC");var a=new Date,s=a.getUTCFullYear(),n=100*Math.floor(s/100),i=parseInt(t[1],10);i+=s%100<50&&i>=60?n-1:n;a.setUTCFullYear(i,parseInt(t[2],10)-1,parseInt(t[3],10)),a.setUTCHours(parseInt(t[4],10),parseInt(t[5],10)),t[6]&&t[6].length>0&&a.setUTCSeconds(parseInt(t[6],10));return a}(t.readString(r.Ber.UTCTime));if(t.peek()===r.Ber.GeneralizedTime)return function(r){var t=r.match(x);e.ok(t);var a=new Date;a.setUTCFullYear(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10)),a.setUTCHours(parseInt(t[4],10),parseInt(t[5],10)),t[6]&&t[6].length>0&&a.setUTCSeconds(parseInt(t[6],10));return a}(t.readString(r.Ber.GeneralizedTime));throw new Error("Unsupported date format")}function g(e,t){t.getUTCFullYear()>=2050||t.getUTCFullYear()<1950?e.writeString(function(e){var r="";return r+=B(e.getUTCFullYear(),4),r+=B(e.getUTCMonth()+1),r+=B(e.getUTCDate()),r+=B(e.getUTCHours()),r+=B(e.getUTCMinutes()),r+=B(e.getUTCSeconds()),r+="Z"}(t),r.Ber.GeneralizedTime):e.writeString(function(e){var r="";return r+=B(e.getUTCFullYear()%100),r+=B(e.getUTCMonth()+1),r+=B(e.getUTCDate()),r+=B(e.getUTCHours()),r+=B(e.getUTCMinutes()),r+=B(e.getUTCSeconds()),r+="Z"}(t),r.Ber.UTCTime)}var p={OtherName:o(0),RFC822Name:c(1),DNSName:c(2),X400Address:o(3),DirectoryName:o(4),EDIPartyName:o(5),URI:c(6),IPAddress:c(7),OID:c(8)},h={serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",joyentDocker:"1.3.6.1.4.1.38678.1.4.1",joyentCmon:"1.3.6.1.4.1.38678.1.4.2"},v={};Object.keys(h).forEach(function(e){v[h[e]]=e});var S=["signature","identity","keyEncryption","encryption","keyAgreement","ca","crl"];function q(e,t,a){a.readSequence();var n,i,u=a.offset+a.length,o=a.readOID(),c=e.signatures.x509;switch(c.extras.exts||(c.extras.exts=[]),a.peek()===r.Ber.Boolean&&(i=a.readBoolean()),o){case l.basicConstraints:a.readSequence(r.Ber.OctetString),a.readSequence();var f=a.offset+a.length,d=!1;a.peek()===r.Ber.Boolean&&(d=a.readBoolean()),void 0===e.purposes&&(e.purposes=[]),!0===d&&e.purposes.push("ca");var g={oid:o,critical:i};a.offset<f&&a.peek()===r.Ber.Integer&&(g.pathLen=a.readInt()),c.extras.exts.push(g);break;case l.extKeyUsage:a.readSequence(r.Ber.OctetString),a.readSequence(),void 0===e.purposes&&(e.purposes=[]);for(var h=a.offset+a.length;a.offset<h;){var q=a.readOID();e.purposes.push(v[q]||q)}-1!==e.purposes.indexOf("serverAuth")&&-1===e.purposes.indexOf("clientAuth")?e.subjects.forEach(function(e){"host"!==e.type&&(e.type="host",e.hostname=e.uid||e.email||e.components[0].value)}):-1!==e.purposes.indexOf("clientAuth")&&-1===e.purposes.indexOf("serverAuth")&&e.subjects.forEach(function(e){"user"!==e.type&&(e.type="user",e.uid=e.hostname||e.email||e.components[0].value)}),c.extras.exts.push({oid:o,critical:i});break;case l.keyUsage:a.readSequence(r.Ber.OctetString);var m=a.readString(r.Ber.BitString,!0);(function(e,r){for(var t=8*(e.length-1)-e[0],a={},s=0;s<t;++s){var n=1+Math.floor(s/8),i=7-s%8,u=1<<i,o=0!=(e[n]&u),c=r[s];o&&"string"==typeof c&&(a[c]=!0)}return Object.keys(a)})(m,S).forEach(function(r){void 0===e.purposes&&(e.purposes=[]),-1===e.purposes.indexOf(r)&&e.purposes.push(r)}),c.extras.exts.push({oid:o,critical:i,bits:m});break;case l.altName:a.readSequence(r.Ber.OctetString),a.readSequence();for(var x=a.offset+a.length;a.offset<x;)switch(a.peek()){case p.OtherName:case p.EDIPartyName:a.readSequence(),a._offset+=a.length;break;case p.OID:a.readOID(p.OID);break;case p.RFC822Name:var B=a.readString(p.RFC822Name);n=s.forEmail(B),e.subjects[0].equals(n)||e.subjects.push(n);break;case p.DirectoryName:a.readSequence(p.DirectoryName),n=s.parseAsn1(a),e.subjects[0].equals(n)||e.subjects.push(n);break;case p.DNSName:var y=a.readString(p.DNSName);n=s.forHost(y),e.subjects[0].equals(n)||e.subjects.push(n);break;default:a.readString(a.peek())}c.extras.exts.push({oid:o,critical:i});break;default:c.extras.exts.push({oid:o,critical:i,data:a.readString(r.Ber.OctetString,!0)})}a._offset=u}var m=/^([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;var x=/^([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function B(e,r){void 0===r&&(r=2);for(var t=""+e;t.length<r;)t="0"+t;return t}function y(t,s){var n=t.signatures.x509;e.object(n,"x509 signature"),s.startSequence(),s.startSequence(o(0)),s.writeInt(2),s.endSequence(),s.writeBuffer(a.mpNormalize(t.serial),r.Ber.Integer),s.startSequence(),s.writeOID(f[n.algo]),n.algo.match(/^rsa-/)&&s.writeNull(),s.endSequence(),t.issuer.toAsn1(s),s.startSequence(),g(s,t.validFrom),g(s,t.validUntil),s.endSequence();var i=t.subjects[0],d=t.subjects.slice(1);if(i.toAsn1(s),u.writePkcs8(s,t.subjectKey),n.extras&&n.extras.issuerUniqueID&&s.writeBuffer(n.extras.issuerUniqueID,o(1)),n.extras&&n.extras.subjectUniqueID&&s.writeBuffer(n.extras.subjectUniqueID,o(2)),d.length>0||"host"===i.type||void 0!==t.purposes&&t.purposes.length>0||n.extras&&n.extras.exts){s.startSequence(o(3)),s.startSequence();var v=[];void 0!==t.purposes&&t.purposes.length>0&&(v.push({oid:l.basicConstraints,critical:!0}),v.push({oid:l.keyUsage,critical:!0}),v.push({oid:l.extKeyUsage,critical:!0})),v.push({oid:l.altName}),n.extras&&n.extras.exts&&(v=n.extras.exts);for(var q=0;q<v.length;++q){if(s.startSequence(),s.writeOID(v[q].oid),void 0!==v[q].critical&&s.writeBoolean(v[q].critical),v[q].oid===l.altName){s.startSequence(r.Ber.OctetString),s.startSequence(),"host"===i.type&&s.writeString(i.hostname,c(2));for(var m=0;m<d.length;++m)"host"===d[m].type?s.writeString(d[m].hostname,p.DNSName):"email"===d[m].type?s.writeString(d[m].email,p.RFC822Name):(s.startSequence(p.DirectoryName),d[m].toAsn1(s),s.endSequence());s.endSequence(),s.endSequence()}else if(v[q].oid===l.basicConstraints){s.startSequence(r.Ber.OctetString),s.startSequence();var x=-1!==t.purposes.indexOf("ca"),B=v[q].pathLen;s.writeBoolean(x),void 0!==B&&s.writeInt(B),s.endSequence(),s.endSequence()}else if(v[q].oid===l.extKeyUsage)s.startSequence(r.Ber.OctetString),s.startSequence(),t.purposes.forEach(function(e){if("ca"!==e&&-1===S.indexOf(e)){var r=e;void 0!==h[e]&&(r=h[e]),s.writeOID(r)}}),s.endSequence(),s.endSequence();else if(v[q].oid===l.keyUsage){if(s.startSequence(r.Ber.OctetString),void 0!==v[q].bits)s.writeBuffer(v[q].bits,r.Ber.BitString);else{var y=b(t.purposes,S);s.writeBuffer(y,r.Ber.BitString)}s.endSequence()}else s.writeBuffer(v[q].data,r.Ber.OctetString);s.endSequence()}s.endSequence(),s.endSequence()}s.endSequence()}function b(e,r){var a=r.length,s=Math.ceil(a/8),n=8*s-a,i=t.alloc(1+s);i[0]=n;for(var u=0;u<a;++u){var o=1+Math.floor(u/8),c=1<<7-u%8,f=r[u];if(void 0!==f)-1!==e.indexOf(f)&&(i[o]|=c)}return i}