module.exports={read:function(e,r){n.isBuffer(e)&&(e=e.toString("ascii"));var t=e.trim().split(/[ \t\n]+/g);if(t.length<2||t.length>3)throw new Error("Not a valid SSH certificate line");var s=t[0],a=t[1];return p(a=n.from(a,"base64"),s)},verify:function(e,r){return!1},sign:function(e,r){void 0===e.signatures.openssh&&(e.signatures.openssh={});try{var t=w(e,!0)}catch(r){return delete e.signatures.openssh,!1}var n=e.signatures.openssh,s=void 0;"rsa"!==r.type&&"dsa"!==r.type||(s="sha1");var a=r.createSign(s);return a.write(t),n.signature=a.sign(),!0},signAsync:function(e,r,t){void 0===e.signatures.openssh&&(e.signatures.openssh={});try{var n=w(e,!0)}catch(r){return delete e.signatures.openssh,t(r),void 0}var s=e.signatures.openssh;r(n,function(e,r){if(e)return t(e),void 0;try{r.toBuffer("ssh")}catch(e){return t(e),void 0}s.signature=r,t()})},write:function(e,r){void 0===r&&(r={});var t=w(e),n=y(e.subjectKey)+" "+t.toString("base64");r.comment&&(n=n+" "+r.comment);return n},fromBuffer:p,toBuffer:w};var e=require("assert-plus"),r=require("../ssh-buffer"),t=require("crypto"),n=require("safer-buffer").Buffer,s=require("../algs"),a=require("../key"),i=(require("../private-key"),require("../identity")),u=require("./rfc4253"),o=require("../signature"),f=require("../utils"),c=require("../certificate");var d={user:1,host:2};Object.keys(d).forEach(function(e){d[d[e]]=e});var h=/^ecdsa-sha2-([^@-]+)-cert-v01@openssh.com$/;function p(t,n,p){var g=new r({buffer:t}),w=g.readString();if(void 0!==n&&w!==n)throw new Error("SSH certificate algorithm mismatch");void 0===n&&(n=w);var y={signatures:{}};y.signatures.openssh={},y.signatures.openssh.nonce=g.readBuffer();var l={},m=l.parts=[];l.type=function(e){if("ssh-rsa-cert-v01@openssh.com"===e)return"rsa";if("ssh-dss-cert-v01@openssh.com"===e)return"dsa";if(e.match(h))return"ecdsa";if("ssh-ed25519-cert-v01@openssh.com"===e)return"ed25519";throw new Error("Unsupported cert type "+e)}(n);for(var B=s.info[l.type].parts.length;m.length<B;)m.push(g.readPart());e.ok(m.length>=1,"key must have at least one part");var b=s.info[l.type];if("ecdsa"===l.type){var E=h.exec(n);e.ok(null!==E),e.strictEqual(E[1],m[0].data.toString())}for(var S=0;S<b.parts.length;++S)if(m[S].name=b.parts[S],"curve"!==m[S].name&&!1!==b.normalize){var I=m[S];I.data=f.mpNormalize(I.data)}y.subjectKey=new a(l),y.serial=g.readInt64();var q=d[g.readInt()];e.string(q,"valid cert type"),y.signatures.openssh.keyId=g.readString();for(var j=[],k=g.readBuffer(),U=new r({buffer:k});!U.atEnd();)j.push(U.readString());0===j.length&&(j=["*"]),y.subjects=j.map(function(e){if("user"===q)return i.forUser(e);if("host"===q)return i.forHost(e);throw new Error("Unknown identity type "+q)}),y.validFrom=v(g.readInt64()),y.validUntil=v(g.readInt64());for(var K,x=[],H=new r({buffer:g.readBuffer()});!H.atEnd();)(K={critical:!0}).name=H.readString(),K.data=H.readBuffer(),x.push(K);for(H=new r({buffer:g.readBuffer()});!H.atEnd();)(K={critical:!1}).name=H.readString(),K.data=H.readBuffer(),x.push(K);y.signatures.openssh.exts=x,g.readBuffer();var M=g.readBuffer();y.issuerKey=u.read(M),y.issuer=i.forHost("**");var z=g.readBuffer();return y.signatures.openssh.signature=o.parse(z,y.issuerKey.type,"ssh"),void 0!==p&&(p.remainder=g.remainder(),p.consumed=g._offset),new c(y)}function v(e){var r=4294967296*e.readUInt32BE(0);r+=e.readUInt32BE(4);var t=new Date;return t.setTime(1e3*r),t.sourceInt64=e,t}function g(e){if(void 0!==e.sourceInt64)return e.sourceInt64;var r=Math.round(e.getTime()/1e3),t=Math.floor(r/4294967296),s=Math.floor(r%4294967296),a=n.alloc(8);return a.writeUInt32BE(t,0),a.writeUInt32BE(s,4),a}function w(a,i){e.object(a.signatures.openssh,"signature for openssh format");var o=a.signatures.openssh;void 0===o.nonce&&(o.nonce=t.randomBytes(16));var f=new r({});f.writeString(y(a.subjectKey)),f.writeBuffer(o.nonce);var c=a.subjectKey;s.info[c.type].parts.forEach(function(e){f.writePart(c.part[e])}),f.writeInt64(a.serial);var h=a.subjects[0].type;e.notStrictEqual(h,"unknown"),a.subjects.forEach(function(r){e.strictEqual(r.type,h)}),h=d[h],f.writeInt(h),void 0===o.keyId&&(o.keyId=a.subjects[0].type+"_"+(a.subjects[0].uid||a.subjects[0].hostname)),f.writeString(o.keyId);var p=new r({});a.subjects.forEach(function(e){h===d.host?p.writeString(e.hostname):h===d.user&&p.writeString(e.uid)}),f.writeBuffer(p.toBuffer()),f.writeInt64(g(a.validFrom)),f.writeInt64(g(a.validUntil));var v=o.exts;void 0===v&&(v=[]);var w=new r({});return v.forEach(function(e){!0===e.critical&&(w.writeString(e.name),w.writeBuffer(e.data))}),f.writeBuffer(w.toBuffer()),w=new r({}),v.forEach(function(e){!0!==e.critical&&(w.writeString(e.name),w.writeBuffer(e.data))}),f.writeBuffer(w.toBuffer()),f.writeBuffer(n.alloc(0)),p=u.write(a.issuerKey),f.writeBuffer(p),i||f.writeBuffer(o.signature.toBuffer("ssh")),f.toBuffer()}function y(e){if("rsa"===e.type)return"ssh-rsa-cert-v01@openssh.com";if("dsa"===e.type)return"ssh-dss-cert-v01@openssh.com";if("ecdsa"===e.type)return"ecdsa-sha2-"+e.curve+"-cert-v01@openssh.com";if("ed25519"===e.type)return"ssh-ed25519-cert-v01@openssh.com";throw new Error("Unsupported key type "+e.type)}