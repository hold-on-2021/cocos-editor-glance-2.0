module.exports=l;var e=require("assert-plus"),r=require("safer-buffer").Buffer,t=require("./algs"),i=require("crypto"),o=(require("./fingerprint"),require("./signature")),n=require("./errors"),a=require("util"),s=require("./utils"),p=require("./dhe"),u=p.generateECDSA,c=p.generateED25519,f=require("./ed-compat"),h=require("tweetnacl"),m=require("./key"),y=(n.InvalidAlgorithmError,n.KeyParseError),d=(n.KeyEncryptedError,{});function l(r){e.object(r,"options"),m.call(this,r),this._pubCache=void 0}d.auto=require("./formats/auto"),d.pem=require("./formats/pem"),d.pkcs1=require("./formats/pkcs1"),d.pkcs8=require("./formats/pkcs8"),d.rfc4253=require("./formats/rfc4253"),d["ssh-private"]=require("./formats/ssh-private"),d.openssh=d["ssh-private"],d.ssh=d["ssh-private"],d.dnssec=require("./formats/dnssec"),a.inherits(l,m),l.formats=d,l.prototype.toBuffer=function(r,t){return void 0===r&&(r="pkcs1"),e.string(r,"format"),e.object(d[r],"formats[format]"),e.optionalObject(t,"options"),d[r].write(this,t)},l.prototype.hash=function(e,r){return this.toPublic().hash(e,r)},l.prototype.fingerprint=function(e,r){return this.toPublic().fingerprint(e,r)},l.prototype.toPublic=function(){if(this._pubCache)return this._pubCache;for(var e=t.info[this.type],r=[],i=0;i<e.parts.length;++i){var o=e.parts[i];r.push(this.part[o])}return this._pubCache=new m({type:this.type,source:this,parts:r}),this.comment&&(this._pubCache.comment=this.comment),this._pubCache},l.prototype.derive=function(t){var i,o,n;if(e.string(t,"type"),"ed25519"===this.type&&"curve25519"===t)return 0===(i=this.part.k.data)[0]&&(i=i.slice(1)),n=h.box.keyPair.fromSecretKey(new Uint8Array(i)),o=r.from(n.publicKey),new l({type:"curve25519",parts:[{name:"A",data:s.mpNormalize(o)},{name:"k",data:s.mpNormalize(i)}]});if("curve25519"===this.type&&"ed25519"===t)return 0===(i=this.part.k.data)[0]&&(i=i.slice(1)),n=h.sign.keyPair.fromSeed(new Uint8Array(i)),o=r.from(n.publicKey),new l({type:"ed25519",parts:[{name:"A",data:s.mpNormalize(o)},{name:"k",data:s.mpNormalize(i)}]});throw new Error("Key derivation not supported from "+this.type+" to "+t)},l.prototype.createVerify=function(e){return this.toPublic().createVerify(e)},l.prototype.createSign=function(t){if(void 0===t&&(t=this.defaultHashAlgorithm()),e.string(t,"hash algorithm"),"ed25519"===this.type&&void 0!==f)return new f.Signer(this,t);if("curve25519"===this.type)throw new Error("Curve25519 keys are not suitable for signing or verification");var n,a,s;try{a=t.toUpperCase(),n=i.createSign(a)}catch(e){s=e}(void 0===n||s instanceof Error&&s.message.match(/Unknown message digest/))&&(a="RSA-",a+=t.toUpperCase(),n=i.createSign(a)),e.ok(n,"failed to create verifier");var p=n.sign.bind(n),u=this.toBuffer("pkcs1"),c=this.type,h=this.curve;return n.sign=function(){var e=p(u);return"string"==typeof e&&(e=r.from(e,"binary")),(e=o.parse(e,c,"asn1")).hashAlgorithm=t,e.curve=h,e},n},l.parse=function(r,t,i){"string"!=typeof r&&e.buffer(r,"data"),void 0===t&&(t="auto"),e.string(t,"format"),"string"==typeof i&&(i={filename:i}),e.optionalObject(i,"options"),void 0===i&&(i={}),e.optionalString(i.filename,"options.filename"),void 0===i.filename&&(i.filename="(unnamed)"),e.object(d[t],"formats[format]");try{var o=d[t].read(r,i);return e.ok(o instanceof l,"key is not a private key"),o.comment||(o.comment=i.filename),o}catch(e){if("KeyEncryptedError"===e.name)throw e;throw new y(i.filename,t,e)}},l.isPrivateKey=function(e,r){return s.isCompatible(e,l,r)},l.generate=function(r,t){switch(void 0===t&&(t={}),e.object(t,"options"),r){case"ecdsa":return void 0===t.curve&&(t.curve="nistp256"),e.string(t.curve,"options.curve"),u(t.curve);case"ed25519":return c();default:throw new Error('Key generation not supported with key type "'+r+'"')}},l.prototype._sshpkApiVersion=[1,6],l._oldVersionDetect=function(r){return e.func(r.toPublic),e.func(r.createSign),r.derive?[1,3]:r.defaultHashAlgorithm?[1,2]:r.formats.auto?[1,1]:[1,0]};