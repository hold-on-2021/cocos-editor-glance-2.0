module.exports=u;var e=require("assert-plus"),t=(require("./algs"),require("crypto"),require("./fingerprint"),require("./signature"),require("./errors"),require("util"),require("./utils")),n=require("asn1"),o=require("safer-buffer").Buffer,r=/^([*]|[a-z0-9][a-z0-9\-]{0,62})(?:\.([*]|[a-z0-9][a-z0-9\-]{0,62}))*$/i,i={cn:"2.5.4.3",o:"2.5.4.10",ou:"2.5.4.11",l:"2.5.4.7",s:"2.5.4.8",c:"2.5.4.6",sn:"2.5.4.4",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",street:"2.5.4.9",x500UniqueIdentifier:"2.5.4.45",role:"2.5.4.72",telephoneNumber:"2.5.4.20",description:"2.5.4.13",dc:"0.9.2342.19200300.100.1.25",uid:"0.9.2342.19200300.100.1.1",mail:"0.9.2342.19200300.100.1.3",title:"2.5.4.12",gn:"2.5.4.42",initials:"2.5.4.43",pseudonym:"2.5.4.65",emailAddress:"1.2.840.113549.1.9.1"},s={};function u(t){var n=this;if(e.object(t,"options"),e.arrayOfObject(t.components,"options.components"),this.components=t.components,this.componentLookup={},this.components.forEach(function(e){e.name&&!e.oid&&(e.oid=i[e.name]),e.oid&&!e.name&&(e.name=s[e.oid]),void 0===n.componentLookup[e.name]&&(n.componentLookup[e.name]=[]),n.componentLookup[e.name].push(e)}),this.componentLookup.cn&&this.componentLookup.cn.length>0&&(this.cn=this.componentLookup.cn[0].value),e.optionalString(t.type,"options.type"),void 0===t.type)1===this.components.length&&this.componentLookup.cn&&1===this.componentLookup.cn.length&&this.componentLookup.cn[0].value.match(r)?(this.type="host",this.hostname=this.componentLookup.cn[0].value):this.componentLookup.dc&&this.components.length===this.componentLookup.dc.length?(this.type="host",this.hostname=this.componentLookup.dc.map(function(e){return e.value}).join(".")):this.componentLookup.uid&&this.components.length===this.componentLookup.uid.length?(this.type="user",this.uid=this.componentLookup.uid[0].value):this.componentLookup.cn&&1===this.componentLookup.cn.length&&this.componentLookup.cn[0].value.match(r)?(this.type="host",this.hostname=this.componentLookup.cn[0].value):this.componentLookup.uid&&1===this.componentLookup.uid.length?(this.type="user",this.uid=this.componentLookup.uid[0].value):this.componentLookup.mail&&1===this.componentLookup.mail.length?(this.type="email",this.email=this.componentLookup.mail[0].value):this.componentLookup.cn&&1===this.componentLookup.cn.length?(this.type="user",this.uid=this.componentLookup.cn[0].value):this.type="unknown";else if(this.type=t.type,"host"===this.type)this.hostname=t.hostname;else if("user"===this.type)this.uid=t.uid;else{if("email"!==this.type)throw new Error("Unknown type "+this.type);this.email=t.email}}Object.keys(i).forEach(function(e){s[i[e]]=e}),u.prototype.toString=function(){return this.components.map(function(e){var t=e.name.toUpperCase();t=t.replace(/=/g,"\\=");var n=e.value;return t+"="+(n=n.replace(/,/g,"\\,"))}).join(", ")},u.prototype.get=function(t,n){e.string(t,"name");var o=this.componentLookup[t];if(void 0!==o&&0!==o.length){if(!n&&o.length>1)throw new Error("Multiple values for attribute "+t);return n?o.map(function(e){return e.value}):o[0].value}},u.prototype.toArray=function(e){return this.components.map(function(e){return{name:e.name,value:e.value}})};var a=/[^a-zA-Z0-9 '(),+.\/:=?-]/,p=/[^\x00-\x7f]/;function c(e,t){if("**"===e||"**"===t)return!0;var n=e.split("."),o=t.split(".");if(n.length!==o.length)return!1;for(var r=0;r<n.length;++r)if("*"!==n[r]&&"*"!==o[r]&&n[r]!==o[r])return!1;return!0}u.prototype.toAsn1=function(e,t){e.startSequence(t),this.components.forEach(function(t){if(e.startSequence(n.Ber.Constructor|n.Ber.Set),e.startSequence(),e.writeOID(t.oid),t.asn1type===n.Ber.Utf8String||t.value.match(p)){var r=o.from(t.value,"utf8");e.writeBuffer(r,n.Ber.Utf8String)}else if(t.asn1type===n.Ber.IA5String||t.value.match(a))e.writeString(t.value,n.Ber.IA5String);else{var i=n.Ber.PrintableString;void 0!==t.asn1type&&(i=t.asn1type),e.writeString(t.value,i)}e.endSequence(),e.endSequence()}),e.endSequence()},u.prototype.equals=function(e){if(!u.isIdentity(e,[1,0]))return!1;if(e.components.length!==this.components.length)return!1;for(var t=0;t<this.components.length;++t){if(this.components[t].oid!==e.components[t].oid)return!1;if(!c(this.components[t].value,e.components[t].value))return!1}return!0},u.forHost=function(t){return e.string(t,"hostname"),new u({type:"host",hostname:t,components:[{name:"cn",value:t}]})},u.forUser=function(t){return e.string(t,"uid"),new u({type:"user",uid:t,components:[{name:"uid",value:t}]})},u.forEmail=function(t){return e.string(t,"email"),new u({type:"email",email:t,components:[{name:"mail",value:t}]})},u.parseDN=function(t){e.string(t,"dn");for(var n=[""],o=0,r=t;r.length>0;){var i;if(null!==(i=/^,/.exec(r)))n[++o]="",r=r.slice(i[0].length);else if(null!==(i=/^\\,/.exec(r)))n[o]+=",",r=r.slice(i[0].length);else if(null!==(i=/^\\./.exec(r)))n[o]+=i[0],r=r.slice(i[0].length);else{if(null===(i=/^[^\\,]+/.exec(r)))throw new Error("Failed to parse DN");n[o]+=i[0],r=r.slice(i[0].length)}}return new u({components:n.map(function(e){for(var t=(e=e.trim()).indexOf("=");t>0&&"\\"===e.charAt(t-1);)t=e.indexOf("=",t+1);if(-1===t)throw new Error("Failed to parse DN");return{name:e.slice(0,t).toLowerCase().replace(/\\=/g,"="),value:e.slice(t+1)}})})},u.fromArray=function(t){return e.arrayOfObject(t,"components"),t.forEach(function(t){if(e.object(t,"component"),e.string(t.name,"component.name"),!o.isBuffer(t.value)&&"string"!=typeof t.value)throw new Error("Invalid component value")}),new u({components:t})},u.parseAsn1=function(e,t){var o=[];e.readSequence(t);for(var r=e.offset+e.length;e.offset<r;){e.readSequence(n.Ber.Constructor|n.Ber.Set);var i=e.offset+e.length;e.readSequence();var s,a=e.readOID(),p=e.peek();switch(p){case n.Ber.PrintableString:case n.Ber.IA5String:case n.Ber.OctetString:case n.Ber.T61String:s=e.readString(p);break;case n.Ber.Utf8String:s=(s=e.readString(p,!0)).toString("utf8");break;case n.Ber.CharacterString:case n.Ber.BMPString:s=(s=e.readString(p,!0)).toString("utf16le");break;default:throw new Error("Unknown asn1 type "+p)}o.push({oid:a,asn1type:p,value:s}),e._offset=i}return e._offset=r,new u({components:o})},u.isIdentity=function(e,n){return t.isCompatible(e,u,n)},u.prototype._sshpkApiVersion=[1,0],u._oldVersionDetect=function(e){return[1,0]};