var e=require("assert-plus"),a=require("util"),r=require("./utils"),t=(r.HASH_ALGOS,r.PK_ALGOS,r.HttpSignatureError),s=r.InvalidAlgorithmError,i=r.validateAlgorithm,o=0,n=1,h=0,d=1,m=2,w=3;function l(e){t.call(this,e,l)}function c(e){t.call(this,e,c)}function p(e){t.call(this,e,p)}function g(e){t.call(this,e,g)}function f(e){t.call(this,e,f)}a.inherits(l,t),a.inherits(c,t),a.inherits(p,t),a.inherits(g,t),a.inherits(f,t),module.exports={parseRequest:function(a,r){e.object(a,"request"),e.object(a.headers,"request.headers"),void 0===r&&(r={}),void 0===r.headers&&(r.headers=[a.headers["x-date"]?"x-date":"date"]),e.object(r,"options"),e.arrayOfString(r.headers,"options.headers"),e.optionalFinite(r.clockSkew,"options.clockSkew");var t=r.authorizationHeaderName||"authorization";if(!a.headers[t])throw new g("no "+t+" header present in the request");r.clockSkew=r.clockSkew||300;var u,k=0,b=o,S=h,v="",q="",x={scheme:"",params:{},signingString:""},A=a.headers[t];for(k=0;k<A.length;k++){var I=A.charAt(k);switch(Number(b)){case o:" "!==I?x.scheme+=I:b=n;break;case n:switch(Number(S)){case h:var y=I.charCodeAt(0);if(y>=65&&y<=90||y>=97&&y<=122)v+=I;else{if("="!==I)throw new c("bad param format");if(0===v.length)throw new c("bad param format");S=d}break;case d:if('"'!==I)throw new c("bad param format");q="",S=m;break;case m:'"'===I?(x.params[v]=q,S=w):q+=I;break;case w:if(","!==I)throw new c("bad param format");v="",S=h;break;default:throw new Error("Invalid substate")}break;default:throw new Error("Invalid substate")}}if(x.params.headers&&""!==x.params.headers?x.params.headers=x.params.headers.split(" "):a.headers["x-date"]?x.params.headers=["x-date"]:x.params.headers=["date"],!x.scheme||"Signature"!==x.scheme)throw new c('scheme was not "Signature"');if(!x.params.keyId)throw new c("keyId was not specified");if(!x.params.algorithm)throw new c("algorithm was not specified");if(!x.params.signature)throw new c("signature was not specified");x.params.algorithm=x.params.algorithm.toLowerCase();try{i(x.params.algorithm)}catch(e){throw e instanceof s?new p(x.params.algorithm+" is not supported"):e}for(k=0;k<x.params.headers.length;k++){var C=x.params.headers[k].toLowerCase();if(x.params.headers[k]=C,"request-line"===C){if(r.strict)throw new f("request-line is not a valid header with strict parsing enabled.");x.signingString+=a.method+" "+a.url+" HTTP/"+a.httpVersion}else if("(request-target)"===C)x.signingString+="(request-target): "+a.method.toLowerCase()+" "+a.url;else{var L=a.headers[C];if(void 0===L)throw new g(C+" was not in the request");x.signingString+=C+": "+L}k+1<x.params.headers.length&&(x.signingString+="\n")}if(a.headers.date||a.headers["x-date"]){u=a.headers["x-date"]?new Date(a.headers["x-date"]):new Date(a.headers.date);var E=new Date,H=Math.abs(E.getTime()-u.getTime());if(H>1e3*r.clockSkew)throw new l("clock skew of "+H/1e3+"s was greater than "+r.clockSkew+"s")}if(r.headers.forEach(function(e){if(x.params.headers.indexOf(e.toLowerCase())<0)throw new g(e+" was not a signed header")}),r.algorithms&&-1===r.algorithms.indexOf(x.params.algorithm))throw new p(x.params.algorithm+" is not a supported algorithm");return x.algorithm=x.params.algorithm.toUpperCase(),x.keyId=x.params.keyId,x}};