"use strict";var e=require("url"),t=require("tunnel-agent"),r=["accept","accept-charset","accept-encoding","accept-language","accept-ranges","cache-control","content-encoding","content-language","content-location","content-md5","content-range","content-type","connection","date","expect","max-forwards","pragma","referer","te","user-agent","via"],o=["proxy-authorization"];function n(e){this.request=e,this.proxyHeaderWhiteList=r,this.proxyHeaderExclusiveList=[],void 0!==e.tunnel&&(this.tunnelOverride=e.tunnel)}n.prototype.isEnabled=function(){var e=this.request;return void 0!==this.tunnelOverride?this.tunnelOverride:"https:"===e.uri.protocol},n.prototype.setup=function(r){var n=this.request;if(r=r||{},"string"==typeof n.proxy&&(n.proxy=e.parse(n.proxy)),!n.proxy||!n.tunnel)return!1;r.proxyHeaderWhiteList&&(this.proxyHeaderWhiteList=r.proxyHeaderWhiteList),r.proxyHeaderExclusiveList&&(this.proxyHeaderExclusiveList=r.proxyHeaderExclusiveList);var i=this.proxyHeaderExclusiveList.concat(o),s=this.proxyHeaderWhiteList.concat(i),a=function(e,t){var r=t.reduce(function(e,t){return e[t.toLowerCase()]=!0,e},{});return Object.keys(e).filter(function(e){return r[e.toLowerCase()]}).reduce(function(t,r){return t[r]=e[r],t},{})}(n.headers,s);a.host=function(e){var t=e.port,r=e.protocol,o=e.hostname+":";return o+=t||("https:"===r?"443":"80")}(n.uri),i.forEach(n.removeHeader,n);var c=function(e){var r=function(e,t){return["https:"===e.protocol?"https":"http","https:"===t.protocol?"Https":"Http"].join("Over")}(e.uri,e.proxy);return t[r]}(n),u=function(e,t){var r=e.proxy;return{proxy:{host:r.hostname,port:+r.port,proxyAuth:r.auth,headers:t},headers:e.headers,ca:e.ca,cert:e.cert,key:e.key,passphrase:e.passphrase,pfx:e.pfx,ciphers:e.ciphers,rejectUnauthorized:e.rejectUnauthorized,secureOptions:e.secureOptions,secureProtocol:e.secureProtocol}}(n,a);return n.agent=c(u),!0},n.defaultProxyHeaderWhiteList=r,n.defaultProxyHeaderExclusiveList=o,exports.Tunnel=n;