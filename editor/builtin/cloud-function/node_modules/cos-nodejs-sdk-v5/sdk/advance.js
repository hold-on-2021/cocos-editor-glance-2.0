var e,t=require("fs"),i=require("./async"),n=require("./event").EventProxy,o=require("./util");var a={},r="cos_sdk_upload_cache";function l(){var t=this.options.UploadIdCacheLimit;if(!e){if(t)try{e=JSON.parse(o.localStorage.getItem(r))||[]}catch(e){}e||(e=[])}}function s(t){l.call(this),delete a[t];for(var i=e.length-1;i>=0;i--)e[i][1]===t&&e.splice(i,1);var n=this.options.UploadIdCacheLimit;e.length>n&&e.splice(n),n&&setTimeout(function(){try{e.length?o.localStorage.setItem(r,JSON.stringify(e)):o.localStorage.removeItem(r)}catch(e){}})}function u(t){l.call(this);for(var i=[],n=0;n<e.length;n++)e[n][0]===t&&i.push(e[n][1]);return i.length?i:null}function c(e,t){var i=this,n=[],o={Bucket:e.Bucket,Region:e.Region,Prefix:e.Key},a=function(){i.multipartList(o,function(e,i){if(e)return t(e);n.push.apply(n,i.Upload||[]),"true"===i.IsTruncated?(o.KeyMarker=i.NextKeyMarker,o.UploadIdMarker=i.NextUploadIdMarker,a()):t(null,{UploadList:n})})};a()}function d(e,t){var i=this,n=[],o={Bucket:e.Bucket,Region:e.Region,Key:e.Key,UploadId:e.UploadId},a=function(){i.multipartListPart(o,function(e,i){if(e)return t(e);n.push.apply(n,i.Part||[]),"true"===i.IsTruncated?(o.PartNumberMarker=i.NextPartNumberMarker,a()):t(null,{PartList:n})})};a()}var p={sliceUploadFile:function(t,p){var f,g,h=this,y=new n,_=t.TaskId,m=t.Bucket,k=t.Region,S=t.Key,v=t.FilePath,U=t.ChunkSize||t.SliceSize||h.options.ChunkSize,I=t.AsyncLimit,P=t.StorageClass||"Standard",R=t.ServerSideEncryption,C=t.onHashProgress;y.on("error",function(e){if(h._isRunningTask(_))return p(e)}),y.on("upload_complete",function(e){p(null,e)}),y.on("upload_slice_complete",function(e){(function(e,t){var n=e.Bucket,o=e.Region,a=e.Key,r=e.UploadId,l=e.SliceList,s=this,u=this.options.ChunkRetryTimes+1,c=l.map(function(e){return{PartNumber:e.PartNumber,ETag:e.ETag}});i.retry(u,function(e){s.multipartComplete({Bucket:n,Region:o,Key:a,UploadId:r,Parts:c},e)},function(e,i){t(e,i)})}).call(h,{Bucket:m,Region:k,Key:S,UploadId:e.UploadId,SliceList:e.SliceList},function(t,i){if(h._isRunningTask(_)){if(delete a[e.UploadId],t)return g(null,!0),y.emit("error",t);g({loaded:f,total:f},!0),s.call(h,e.UploadId),y.emit("upload_complete",i)}})}),y.on("get_upload_data_finish",function(n){var s=o.getFileUUID(t.FileStat,t.ChunkSize);s&&function(t,i,n){l.call(this);for(var a=(t=t||"").substr(0,t.indexOf("-")+1),s=e.length-1;s>=0;s--){var u=e[s];u[0]===t&&u[1]===i?e.splice(s,1):t!==u[0]&&0===u[0].indexOf(a)&&e.splice(s,1)}e.unshift([t,i]);var c=this.options.UploadIdCacheLimit;e.length>c&&e.splice(c),c&&setTimeout(function(){try{o.localStorage.setItem(r,JSON.stringify(e))}catch(e){}})}.call(h,s,n.UploadId),a[n.UploadId]=!0,_&&h.on("inner-kill-task",function(e){e.TaskId===_&&"canceled"===e.toState&&delete a[n.UploadId]}),g(null,!0),function(e,t){var n=this,a=e.TaskId,r=e.Bucket,l=e.Region,s=e.Key,u=e.UploadData,c=e.FileSize,d=e.SliceSize,p=Math.min(e.AsyncLimit||n.options.ChunkParallelLimit||1,256),f=e.FilePath,g=Math.ceil(c/d),h=0,y=e.ServerSideEncryption,_=o.filter(u.PartList,function(e){return e.Uploaded&&(h+=e.PartNumber>=g&&c%d||d),!e.Uploaded}),m=e.onProgress;i.eachLimit(_,p,function(e,t){if(n._isRunningTask(a)){var p=e.PartNumber,g=Math.min(c,e.PartNumber*d)-(e.PartNumber-1)*d,_=0;(function(e,t){var n=this,a=e.TaskId,r=e.Bucket,l=e.Region,s=e.Key,u=e.FileSize,c=e.FilePath,d=1*e.PartNumber,p=e.SliceSize,f=e.ServerSideEncryption,g=e.UploadData,h=n.options.ChunkRetryTimes+1,y=p*(d-1),_=p,m=y+p;m>u&&(_=(m=u)-y),o.fileSlice(c,y,m,function(u){o.getFileMd5(u,function(u,p){var k=p?o.binaryBase64(p):"",S=g.PartList[d-1];i.retry(h,function(t){n._isRunningTask(a)&&o.fileSlice(c,y,m,function(i){n.multipartUpload({TaskId:a,Bucket:r,Region:l,Key:s,ContentLength:_,PartNumber:d,UploadId:g.UploadId,ServerSideEncryption:f,Body:i,onProgress:e.onProgress,ContentMD5:k},function(e,i){if(n._isRunningTask(a))return e?t(e):(S.Uploaded=!0,t(null,i))})})},function(e,i){if(n._isRunningTask(a))return t(e,i)})})})}).call(n,{TaskId:a,Bucket:r,Region:l,Key:s,SliceSize:d,FileSize:c,PartNumber:p,ServerSideEncryption:y,FilePath:f,UploadData:u,onProgress:function(e){h+=e.loaded-_,_=e.loaded,m({loaded:h,total:c})}},function(i,r){n._isRunningTask(a)&&(!o.isBrowser||i||r.ETag||(i='get ETag error, please add "ETag" to CORS ExposeHeader setting.'),i?h-=_:(h+=g-_,e.ETag=r.ETag),t(i||null,r))})}},function(e){if(n._isRunningTask(a))return e?t(e):(t(null,{UploadId:u.UploadId,SliceList:u.PartList}),void 0)})}.call(h,{TaskId:_,Bucket:m,Region:k,Key:S,FilePath:v,FileSize:f,SliceSize:U,AsyncLimit:I,ServerSideEncryption:R,UploadData:n,onProgress:g},function(e,t){if(h._isRunningTask(_))return e?(g(null,!0),y.emit("error",e)):(y.emit("upload_slice_complete",t),void 0)})}),y.on("get_file_size_finish",function(){if(g=o.throttleOnProgress.call(h,f,t.onProgress),t.UploadData.UploadId)y.emit("get_upload_data_finish",t.UploadData);else{var e=o.extend({TaskId:_,Bucket:m,Region:k,Key:S,Headers:t.Headers,StorageClass:P,FilePath:v,FileSize:f,SliceSize:U,onHashProgress:C},t);(function(e,t){var r=e.TaskId,l=e.Bucket,p=e.Region,f=e.Key,g=e.StorageClass,h=this,y={},_=e.FileSize,m=e.SliceSize,k=Math.ceil(_/m),S=0,v=o.throttleOnProgress.call(h,_,e.onHashProgress),U=function(t,i){var n=t.length;if(0===n)return i(null,!0);if(n>k)return i(null,!1);if(n>1){var a=Math.max(t[0].Size,t[1].Size);if(a!==m)return i(null,!1)}var r=function(a){if(a<n){var l=t[a];(function(t,i){var n=m*(t-1),a=Math.min(n+m,_),r=a-n;y[t]?i(null,{PartNumber:t,ETag:y[t],Size:r}):o.fileSlice(e.FilePath,n,a,function(e){o.getFileMd5(e,function(e,n){if(e)return i(e);var o='"'+n+'"';y[t]=o,1,S+=r,i(e,{PartNumber:t,ETag:o,Size:r}),v({loaded:S,total:_})})})})(l.PartNumber,function(e,t){t&&t.ETag===l.ETag&&t.Size===l.Size?r(a+1):i(null,!1)})}else i(null,!0)};r(0)},I=new n;I.on("error",function(e){if(h._isRunningTask(r))return t(e)}),I.on("upload_id_ready",function(e){var i={},n=[];o.each(e.PartList,function(e){i[e.PartNumber]=e});for(var a=1;a<=k;a++){var r=i[a];r?(r.PartNumber=a,r.Uploaded=!0):r={PartNumber:a,ETag:null,Uploaded:!1},n.push(r)}e.PartList=n,t(null,e)}),I.on("no_available_upload_id",function(){if(h._isRunningTask(r)){var i=o.extend({Bucket:l,Region:p,Key:f,Headers:o.clone(e.Headers),StorageClass:g},e);h.multipartInit(i,function(e,i){if(h._isRunningTask(r)){if(e)return I.emit("error",e);var n=i.UploadId;if(!n)return t({Message:"no upload id"});I.emit("upload_id_ready",{UploadId:n,PartList:[]})}})}}),I.on("has_upload_id",function(e){e=e.reverse(),i.eachLimit(e,1,function(e,t){if(h._isRunningTask(r))return a[e]?(t(),void 0):(d.call(h,{Bucket:l,Region:p,Key:f,UploadId:e},function(i,n){if(h._isRunningTask(r)){if(i)return s.call(h,e),I.emit("error",i);var o=n.PartList;o.forEach(function(e){e.PartNumber*=1,e.Size*=1,e.ETag=e.ETag||""}),U(o,function(i,n){if(h._isRunningTask(r))return i?I.emit("error",i):(n?t({UploadId:e,PartList:o}):t(),void 0)})}}),void 0)},function(e){h._isRunningTask(r)&&(v(null,!0),e&&e.UploadId?I.emit("upload_id_ready",e):I.emit("no_available_upload_id"))})}),I.on("seek_local_avail_upload_id",function(t){var i,n=o.getFileUUID(e.FileStat,e.ChunkSize);if(n&&(i=u.call(h,n))){var c=function(e){if(e>=i.length)return I.emit("has_upload_id",t),void 0;var n=i[e];return o.isInArray(t,n)?a[n]?(c(e+1),void 0):(d.call(h,{Bucket:l,Region:p,Key:f,UploadId:n},function(t,i){h._isRunningTask(r)&&(t?(s.call(h,n),c(e+1)):I.emit("upload_id_ready",{UploadId:n,PartList:i.PartList}))}),void 0):(s.call(h,n),c(e+1),void 0)};c(0)}else I.emit("has_upload_id",t)}),I.on("get_remote_upload_id_list",function(t){c.call(h,{Bucket:l,Region:p,Key:f},function(t,i){if(h._isRunningTask(r)){if(t)return I.emit("error",t);var n=o.filter(i.UploadList,function(e){return e.Key===f&&(!g||e.StorageClass.toUpperCase()===g.toUpperCase())}).reverse().map(function(e){return e.UploadId||e.UploadID});if(n.length)I.emit("seek_local_avail_upload_id",n);else{var a,l=o.getFileUUID(e.FileStat,e.ChunkSize);l&&(a=u.call(h,l))&&o.each(a,function(e){s.call(h,e)}),I.emit("no_available_upload_id")}}})}),I.emit("get_remote_upload_id_list")}).call(h,e,function(e,i){if(h._isRunningTask(_)){if(e)return y.emit("error",e);t.UploadData.UploadId=i.UploadId,t.UploadData.PartList=i.PartList,y.emit("get_upload_data_finish",t.UploadData)}})}}),f=t.ContentLength,delete t.ContentLength,!t.Headers&&(t.Headers={}),o.each(t.Headers,function(e,i){"content-length"===i.toLowerCase()&&delete t.Headers[i]}),function(){for(var e=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,5120],i=1048576,n=0;n<e.length&&!(f/(i=1024*e[n]*1024)<=h.options.MaxPartNumber);n++);t.ChunkSize=t.SliceSize=U=Math.max(U,i)}(),0===f?(t.Body="",t.ContentLength=0,t.SkipTask=!0,h.putObject(t,function(e,t){if(e)return p(e);p(null,t)})):y.emit("get_file_size_finish")},abortUploadTask:function(e,t){var o=e.Bucket,a=e.Region,r=e.Key,l=e.UploadId,s=e.Level||"task",u=e.AsyncLimit,d=this,p=new n;if(p.on("error",function(e){return t(e)}),p.on("get_abort_array",function(n){(function(e,t){var n=e.Bucket,o=e.Region,a=e.Key,r=e.AbortArray,l=e.AsyncLimit||1,s=this,u=0,c=new Array(r.length);i.eachLimit(r,l,function(t,i){var r=u;if(a&&a!==t.Key)return c[r]={error:{KeyNotMatch:!0}},i(null),void 0;var l=t.UploadId||t.UploadID;s.multipartAbort({Bucket:n,Region:o,Key:t.Key,Headers:e.Headers,UploadId:l},function(e,a){var s={Bucket:n,Region:o,Key:t.Key,UploadId:l};c[r]={error:e,task:s},i(null)}),u++},function(e){if(e)return t(e);for(var i=[],n=[],o=0,a=c.length;o<a;o++){var r=c[o];r.task&&(r.error?n.push(r.task):i.push(r.task))}return t(null,{successList:i,errorList:n})})}).call(d,{Bucket:o,Region:a,Key:r,Headers:e.Headers,AsyncLimit:u,AbortArray:n},function(e,i){if(e)return t(e);t(null,i)})}),"bucket"===s)c.call(d,{Bucket:o,Region:a},function(e,i){if(e)return t(e);p.emit("get_abort_array",i.UploadList||[])});else if("file"===s){if(!r)return t({error:"abort_upload_task_no_key"});c.call(d,{Bucket:o,Region:a,Key:r},function(e,i){if(e)return t(e);p.emit("get_abort_array",i.UploadList||[])})}else{if("task"!==s)return t({error:"abort_unknown_level"});if(!l)return t({error:"abort_upload_task_no_id"});if(!r)return t({error:"abort_upload_task_no_key"});p.emit("get_abort_array",[{Key:r,UploadId:l}])}},uploadFiles:function(e,i){var n=this,a=void 0===e.SliceSize?n.options.SliceSize:e.SliceSize,r=0,l=0,s=o.throttleOnProgress.call(n,l,e.onProgress),u=e.files.length,c=e.onFileFinish,d=Array(u),p=function(e,t,n){s(null,!0),c&&c(e,t,n),d[n.Index]={options:n,error:e,data:t},--u<=0&&i&&i(null,{files:d})},f=[],g=e.files.length;o.each(e.files,function(e,i){t.stat(e.FilePath,function(u,c){var d=e.ContentLength=c.size||0,h={Index:i,TaskId:""};r+=d,o.each(e,function(e,t){"object"!=typeof e&&"function"!=typeof e&&(h[t]=e)});var y=e.onTaskReady;e.onTaskReady=function(e){h.TaskId=e,y&&y(e)};var _=0,m=e.onProgress;e.onProgress=function(e){l=l-_+e.loaded,_=e.loaded,m&&m(e),s({loaded:l,total:r})};var k=e.onFileFinish,S=d>=a?"sliceUploadFile":"putObject";"putObject"===S&&(e.Body=t.createReadStream(e.FilePath),e.Body.isSdkCreated=!0),f.push({api:S,params:e,callback:function(e,t){k&&k(e,t),p&&p(e,t,h)}}),0==--g&&n._addTasks(f)})})},sliceCopyFile:function(e,t){var a=new n,r=this,l=e.Bucket,s=e.Region,u=e.Key,c=e.CopySource,d=c.match(/^([^.]+-\d+)\.cos(v6)?\.([^.]+)\.[^/]+\/(.+)$/);if(!d)return t({error:"CopySource format error"}),void 0;var p=d[1],f=d[3],g=decodeURIComponent(d[4]),h=void 0===e.CopySliceSize?r.options.CopySliceSize:e.CopySliceSize;h=Math.max(0,h);var y,_,m=e.CopyChunkSize||this.options.CopyChunkSize,k=this.options.CopyChunkParallelLimit,S=0;a.on("copy_slice_complete",function(e){r.multipartComplete({Bucket:l,Region:s,Key:u,UploadId:e.UploadId,Parts:e.PartList},function(e,i){if(e)return _(null,!0),t(e);_({loaded:y,total:y},!0),t(null,i)})}),a.on("get_copy_data_finish",function(e){i.eachLimit(e.PartList,k,function(t,n){var o=t.PartNumber,a=t.CopySourceRange,d=t.end-t.start,p=0;(function(e,t){var n=e.TaskId,o=e.Bucket,a=e.Region,r=e.Key,l=e.CopySource,s=e.UploadId,u=1*e.PartNumber,c=e.CopySourceRange,d=this.options.ChunkRetryTimes+1,p=this;i.retry(d,function(t){p.uploadPartCopy({TaskId:n,Bucket:o,Region:a,Key:r,CopySource:l,UploadId:s,PartNumber:u,CopySourceRange:c,onProgress:e.onProgress},function(e,i){t(e||null,i)})},function(e,i){return t(e,i)})}).call(r,{Bucket:l,Region:s,Key:u,CopySource:c,UploadId:e.UploadId,PartNumber:o,CopySourceRange:a,onProgress:function(e){S+=e.loaded-p,p=e.loaded,_({loaded:S,total:y})}},function(e,i){if(e)return n(e);_({loaded:S,total:y}),S+=d-p,t.ETag=i.ETag,n(e||null,i)})},function(i){if(i)return _(null,!0),t(i);a.emit("copy_slice_complete",e)})}),a.on("get_file_size_finish",function(i){var n;if(function(){for(var t=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,5120],i=1048576,n=0;n<t.length&&!(y/(i=1024*t[n]*1024)<=r.options.MaxPartNumber);n++);e.ChunkSize=m=Math.max(m,i);for(var o=Math.ceil(y/m),a=[],l=1;l<=o;l++){var s=(l-1)*m,u=l*m<y?l*m-1:y-1,c={PartNumber:l,start:s,end:u,CopySourceRange:"bytes="+s+"-"+u};a.push(c)}e.PartList=a}(),(n="Replaced"===e.Headers["x-cos-metadata-directive"]?e.Headers:i)["x-cos-storage-class"]=e.Headers["x-cos-storage-class"]||i["x-cos-storage-class"],n=o.clearKey(n),"ARCHIVE"===i["x-cos-storage-class"]){var c=i["x-cos-restore"];if(!c||'ongoing-request="true"'===c)return t({error:"Unrestored archive object is not allowed to be copied"}),void 0}delete n["x-cos-copy-source"],delete n["x-cos-metadata-directive"],delete n["x-cos-copy-source-If-Modified-Since"],delete n["x-cos-copy-source-If-Unmodified-Since"],delete n["x-cos-copy-source-If-Match"],delete n["x-cos-copy-source-If-None-Match"],r.multipartInit({Bucket:l,Region:s,Key:u,Headers:n},function(i,n){if(i)return t(i);e.UploadId=n.UploadId,a.emit("get_copy_data_finish",e)})}),r.headObject({Bucket:p,Region:f,Key:g},function(i,n){if(i)return i.statusCode&&404===i.statusCode?t({ErrorStatus:g+" Not Exist"}):t(i),void 0;if(void 0===(y=e.FileSize=n.headers["content-length"])||!y)return t({error:'get Content-Length error, please add "Content-Length" to CORS ExposeHeader setting.'}),void 0;if(_=o.throttleOnProgress.call(r,y,e.onProgress),y<=h)e.Headers["x-cos-metadata-directive"]||(e.Headers["x-cos-metadata-directive"]="Copy"),r.putObjectCopy(e,function(e,i){if(e)return _(null,!0),t(e);_({loaded:y,total:y},!0),t(e,i)});else{var l=n.headers,s={"Cache-Control":l["cache-control"],"Content-Disposition":l["content-disposition"],"Content-Encoding":l["content-encoding"],"Content-Type":l["content-type"],Expires:l.expires,"x-cos-storage-class":l["x-cos-storage-class"]};o.each(l,function(e,t){0===t.indexOf("x-cos-meta-")&&t.length>"x-cos-meta-".length&&(s[t]=e)}),a.emit("get_file_size_finish",s)}})}};module.exports.init=function(e,t){t.transferToTaskMethod(p,"sliceUploadFile"),o.each(p,function(t,i){e.prototype[i]=o.apiWrapper(i,t)})};