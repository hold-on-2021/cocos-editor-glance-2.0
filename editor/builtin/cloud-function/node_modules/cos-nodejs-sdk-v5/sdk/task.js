var e=require("./util"),a={};module.exports.transferToTaskMethod=function(e,t){a[t]=e[t],e[t]=function(e,n){e.SkipTask?a[t].call(this,e,n):this._addTask(t,e,n)}},module.exports.init=function(t){var n=[],s={},i=0,r=0,o=function(e){var a={id:e.id,Bucket:e.Bucket,Region:e.Region,Key:e.Key,FilePath:e.FilePath,state:e.state,loaded:e.loaded,size:e.size,speed:e.speed,percent:e.percent,hashPercent:e.hashPercent,error:e.error};return e.FilePath&&(a.FilePath=e.FilePath),a},d=function(){var a,s=function(){a=0,t.emit("task-list-update",{list:e.map(n,o)}),t.emit("list-update",{list:e.map(n,o)})};return function(){a||(a=setTimeout(s))}}(),c=function(){if(!(n.length<=t.options.UploadQueueSize)){for(var e=0;e<r&&e<n.length&&n.length>t.options.UploadQueueSize;){var a="waiting"===n[e].state||"checking"===n[e].state||"uploading"===n[e].state;n[e]&&a?e++:(s[n[e].id]&&delete s[n[e].id],n.splice(e,1),r--)}d()}},l=function(){if(!(i>=t.options.FileParallelLimit)){for(;n[r]&&"waiting"!==n[r].state;)r++;if(!(r>=n.length)){var s=n[r];r++,i++,s.state="checking",s.params.onTaskStart&&s.params.onTaskStart(o(s)),!s.params.UploadData&&(s.params.UploadData={});var u=e.formatParams(s.api,s.params);a[s.api].call(t,u,function(e,a){t._isRunningTask(s.id)&&("checking"!==s.state&&"uploading"!==s.state||(s.state=e?"error":"success",e&&(s.error=e),i--,d(),l(),s.callback&&s.callback(e,a),"success"===s.state&&(s.params&&(delete s.params.UploadData,delete s.params.Body,delete s.params),delete s.callback)),c())}),d(),setTimeout(l)}}},u=function(e,a){var n=s[e];if(n){var r=n&&"waiting"===n.state,o=n&&("checking"===n.state||"uploading"===n.state);if("canceled"===a&&"canceled"!==n.state||"paused"===a&&r||"paused"===a&&o){if("paused"===a&&n.params.Body&&"function"==typeof n.params.Body.pipe)return console.error("stream not support pause"),void 0;n.state=a,t.emit("inner-kill-task",{TaskId:e,toState:a}),d(),o&&(i--,l()),"canceled"===a&&(n.params&&(delete n.params.UploadData,delete n.params.Body,delete n.params),delete n.callback)}c()}};t._addTasks=function(a){e.each(a,function(e){t._addTask(e.api,e.params,e.callback,!0)}),d()};var p=!0;t._addTask=function(a,i,r,o){i=e.formatParams(a,i);var u=e.uuid();i.TaskId=u,i.onTaskReady&&i.onTaskReady(u),i.TaskReady&&(i.TaskReady(u),p&&console.warn('warning: Param "TaskReady" has been deprecated. Please use "onTaskReady" instead.'),p=!1);var k={params:i,callback:r,api:a,index:n.length,id:u,Bucket:i.Bucket,Region:i.Region,Key:i.Key,FilePath:i.FilePath||"",state:"waiting",loaded:0,size:0,speed:0,percent:0,hashPercent:0,error:null},g=i.onHashProgress;i.onHashProgress=function(e){t._isRunningTask(k.id)&&(k.hashPercent=e.percent,g&&g(e),d())};var f=i.onProgress;return i.onProgress=function(e){t._isRunningTask(k.id)&&("checking"===k.state&&(k.state="uploading"),k.loaded=e.loaded,k.speed=e.speed,k.percent=e.percent,f&&f(e),d())},e.getFileSize(a,i,function(e,a){if(e)return r(e),void 0;s[u]=k,n.push(k),k.size=a,!o&&d(),l(),c()}),u},t._isRunningTask=function(e){var a=s[e];return!(!a||"checking"!==a.state&&"uploading"!==a.state)},t.getTaskList=function(){return e.map(n,o)},t.cancelTask=function(e){u(e,"canceled")},t.pauseTask=function(e){u(e,"paused")},t.restartTask=function(e){var a=s[e];!a||"paused"!==a.state&&"error"!==a.state||(a.state="waiting",d(),r=Math.min(r,a.index),l())},t.isUploadRunning=function(){return i||r<n.length}};