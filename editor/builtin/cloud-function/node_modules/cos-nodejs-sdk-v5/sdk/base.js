var e=require("../package.json"),t=require("request"),o=require("mime-types"),n=require("./util"),s=require("fs");function r(e){var t={GrantFullControl:[],GrantWrite:[],GrantRead:[],GrantReadAcp:[],GrantWriteAcp:[],ACL:""},o={FULL_CONTROL:"GrantFullControl",WRITE:"GrantWrite",READ:"GrantRead",READ_ACP:"GrantReadAcp",WRITE_ACP:"GrantWriteAcp"},s=e.AccessControlList.Grant;s&&(s=n.isArray(s)?s:[s]);var r={READ:0,WRITE:0,FULL_CONTROL:0};return s.length&&n.each(s,function(n){"qcs::cam::anyone:anyone"===n.Grantee.ID||"http://cam.qcloud.com/groups/global/AllUsers"===n.Grantee.URI?r[n.Permission]=1:n.Grantee.ID!==e.Owner.ID&&t[o[n.Permission]].push('id="'+n.Grantee.ID+'"')}),r.FULL_CONTROL||r.WRITE&&r.READ?t.ACL="public-read-write":r.READ?t.ACL="public-read":t.ACL="private",n.each(o,function(e){t[e]=a(t[e].join(","))}),t}function a(e){var t,o,n=e.split(","),s={};for(t=0;t<n.length;)s[o=n[t].trim()]?n.splice(t,1):(s[o]=!0,n[t]=o,t++);return n.join(",")}function i(e){var t=e.bucket,o=t.substr(0,t.lastIndexOf("-")),s=t.substr(t.lastIndexOf("-")+1),r=e.domain,a=e.region,i=e.object,c=e.protocol||(n.isBrowser&&"http:"===location.protocol?"http:":"https:");r||(r=["cn-south","cn-south-2","cn-north","cn-east","cn-southwest","sg"].indexOf(a)>-1?"{Region}.myqcloud.com":"cos.{Region}.myqcloud.com",e.ForcePathStyle||(r="{Bucket}."+r)),r=(r=r.replace(/\{\{AppId\}\}/gi,s).replace(/\{\{Bucket\}\}/gi,o).replace(/\{\{Region\}\}/gi,a).replace(/\{\{.*?\}\}/gi,"")).replace(/\{AppId\}/gi,s).replace(/\{BucketName\}/gi,o).replace(/\{Bucket\}/gi,t).replace(/\{Region\}/gi,a).replace(/\{.*?\}/gi,""),/^[a-zA-Z]+:\/\//.test(r)||(r=c+"//"+r),"/"===r.slice(-1)&&(r=r.slice(0,-1));var u=r;return e.ForcePathStyle&&(u+="/"+t),u+="/",i&&(u+=n.camSafeUrlEncode(i).replace(/%2F/g,"/")),e.isLocation&&(u=u.replace(/^https?:\/\//,"")),u}function c(e,t){var o=n.clone(e.Headers);delete o["Content-Type"],delete o["Cache-Control"],n.each(o,function(e,t){""===e&&delete o[t]});var s=function(e){var o=!1,n=e.Authorization;if(n)if(n.indexOf(" ")>-1)o=!1;else if(n.indexOf("q-sign-algorithm=")>-1&&n.indexOf("q-ak=")>-1&&n.indexOf("q-sign-time=")>-1&&n.indexOf("q-key-time=")>-1&&n.indexOf("q-url-param-list=")>-1)o=!0;else try{(n=atob(n)).indexOf("a=")>-1&&n.indexOf("k=")>-1&&n.indexOf("t=")>-1&&n.indexOf("r=")>-1&&n.indexOf("b=")>-1&&(o=!0)}catch(e){}o?t&&t(null,e):t&&t("authorization error")},r=this,a=e.Bucket||"",i=e.Region||"",c=e.Key||"";r.options.ForcePathStyle&&a&&(c=a+"/"+c);var u="/"+c,d={},l=e.Scope;if(!l){var h=e.Action||"",p=e.ResourceKey||e.Key||"";l=e.Scope||[{action:h,bucket:a,region:i,prefix:p}]}var f=n.md5(JSON.stringify(l));r._StsCache=r._StsCache||[],function(){var e,t;for(e=r._StsCache.length-1;e>=0;e--){t=r._StsCache[e];var o=Math.round(n.getSkewTime(r.options.SystemClockOffset)/1e3)+30;if(t.StartTime&&o<t.StartTime||o>=t.ExpiredTime)r._StsCache.splice(e,1);else if(!t.ScopeLimit||t.ScopeLimit&&t.ScopeKey===f){d=t;break}}}();var C=function(){var t=d.StartTime&&d.ExpiredTime?d.StartTime+";"+d.ExpiredTime:"",a={Authorization:n.getAuth({SecretId:d.TmpSecretId,SecretKey:d.TmpSecretKey,Method:e.Method,Pathname:u,Query:e.Query,Headers:o,Expires:e.Expires,UseRawKey:r.options.UseRawKey,SystemClockOffset:r.options.SystemClockOffset,KeyTime:t}),XCosSecurityToken:d.XCosSecurityToken||"",Token:d.Token||"",ClientIP:d.ClientIP||"",ClientUA:d.ClientUA||""};s(a)};if(d.ExpiredTime&&d.ExpiredTime-n.getSkewTime(r.options.SystemClockOffset)/1e3>60)C();else if(r.options.getAuthorization)r.options.getAuthorization.call(r,{Bucket:a,Region:i,Method:e.Method,Key:c,Pathname:u,Query:e.Query,Headers:o,Scope:l},function(e){"string"==typeof e&&(e={Authorization:e}),e.TmpSecretId&&e.TmpSecretKey&&e.XCosSecurityToken&&e.ExpiredTime?((d=e||{}).Scope=l,d.ScopeKey=f,r._StsCache.push(d),C()):s(e)});else{if(!r.options.getSTS)return function(){var t={Authorization:n.getAuth({SecretId:e.SecretId||r.options.SecretId,SecretKey:e.SecretKey||r.options.SecretKey,Method:e.Method,Pathname:u,Query:e.Query,Headers:o,Expires:e.Expires,UseRawKey:r.options.UseRawKey,SystemClockOffset:r.options.SystemClockOffset}),XCosSecurityToken:r.options.XCosSecurityToken};return s(t),t}();r.options.getSTS.call(r,{Bucket:a,Region:i},function(e){(d=e||{}).Scope=l,d.ScopeKey=f,d.TmpSecretId=d.SecretId,d.TmpSecretKey=d.SecretKey,r._StsCache.push(d),C()})}return""}function u(s,r){var a=this;!s.headers&&(s.headers={}),s.headers["User-Agent"]=a.options.UserAgent||"cos-nodejs-sdk-v5-"+e.version,!s.qs&&(s.qs={}),s.VersionId&&(s.qs.versionId=s.VersionId),s.qs=n.clearKey(s.qs),s.headers&&(s.headers=n.clearKey(s.headers)),s.qs&&(s.qs=n.clearKey(s.qs));var u=n.clone(s.qs);s.action&&(u[s.action]="");var d=function(e){var l=a.options.SystemClockOffset;c.call(a,{Bucket:s.Bucket||"",Region:s.Region||"",Method:s.method,Key:s.Key,Query:u,Headers:s.headers,Action:s.Action,ResourceKey:s.ResourceKey,Scope:s.Scope},function(c,u){if(c)return r(c),void 0;s.AuthData=u,function(e,s){var r=this,a=e.TaskId;if(a&&!r._isRunningTask(a))return;var c,u=e.Bucket,d=e.Region,l=e.Key,h=e.method||"GET",p=e.url,f=e.body,C=e.json,g=e.rawBody;e.FilePath;f&&"function"==typeof f.pipe&&(c=f,f=null);p=p||i({ForcePathStyle:r.options.ForcePathStyle,protocol:r.options.Protocol,domain:r.options.Domain,bucket:u,region:d,object:l}),e.action&&(p=p+"?"+e.action);var y={method:h,url:p,headers:e.headers,qs:e.qs,body:f,json:C};y.headers.Authorization=e.AuthData.Authorization,e.AuthData.Token&&(y.headers.token=e.AuthData.Token),e.AuthData.ClientIP&&(y.headers.clientIP=e.AuthData.ClientIP),e.AuthData.ClientUA&&(y.headers.clientUA=e.AuthData.ClientUA),e.AuthData.XCosSecurityToken&&(y.headers["x-cos-security-token"]=e.AuthData.XCosSecurityToken),y.headers&&(y.headers=n.clearKey(y.headers)),y=n.clearKey(y);var m=this.options.Ip;m&&(y.url=y.url.replace(/^(https?:\/\/)([^\/]+)/,function(e,t,o){return y.headers.Host=o,t+m}));!0!==this.options.StrictSsl&&(y.strictSSL=this.options.StrictSsl);this.options.Proxy&&(y.proxy=this.options.Proxy);this.options.Timeout&&(y.timeout=this.options.Timeout);this.options.KeepAlive&&(y.forever=!0);if(c){var k=!1;n.each(y.headers,function(e,t){"content-type"===t.toLowerCase()&&(k=!0)}),!k&&c.readable&&c.path&&c.mode&&!o.lookup(c.path)&&(y.headers["Content-Type"]="application/octet-stream")}r.emit("before-send",y);var R,B,A=t(y),v=function(e,t){if(a&&r.off("inner-kill-task",b),!B){B=!0;var o={};R&&R.statusCode&&(o.statusCode=R.statusCode),R&&R.headers&&(o.headers=R.headers),e?(e=n.extend(e||{},o),s(e,null)):(t=n.extend(t||{},o),s(null,t)),A&&(A.removeAllListeners&&A.removeAllListeners(),A=null)}},S=function(e){try{C=n.xml2json(e)||{}}catch(t){C=e||{}}return C},T=function(){try{Object.defineProperty(A.req.connection,"_lastBytesWritten",{enumerable:!0,configurable:!0,writable:!0,value:A.req.connection.bytesWritten})}catch(e){}};A.on("error",function(e){T(),v({error:e})}),A.on("response",function(t){R=t;var o=t.headers["content-length"]||0,n=[],s=t.statusCode,r=2===Math.floor(s/100);if(r&&e.outputStream)A.on("end",function(){v(null,{})});else if(o>=process.binding("buffer").kMaxLength&&"HEAD"!==y.method)v({error:"file size large than "+process.binding("buffer").kMaxLength+', please use "Output" Stream to getObject.'});else{A.on("data",function(e){n.push(e)}),A.on("end",function(){var e;try{var o=Buffer.concat(n)}catch(e){return v({error:e}),void 0}var s=o.toString();r?g?v(null,{body:o}):o.length?(e=S(o.toString()))&&e.Error?v({error:e.Error}):v(null,e):v(null,{}):(s&&(e=S(s)),v({error:e&&e.Error||t.statusMessage||"statusCode error"}));n=null})}});var b=function(e){e.TaskId===a&&(c&&c.isSdkCreated&&c.close&&c.close(),A&&A.abort&&A.abort(),r.off("inner-kill-task",b))};if(a&&r.on("inner-kill-task",b),A.once("end",function(){T()}),e.onProgress&&"function"==typeof e.onProgress){var P=y.headers["Content-Length"],x=Date.now(),O=0;A.on("drain",function(){var t=Date.now(),o=0;try{o=A.req.connection.bytesWritten-A.req._header.length-(A.req.connection._lastBytesWritten||0)}catch(e){}var n=P,s=parseInt((o-O)/((t-x)/1e3)*100)/100,r=n?parseInt(o/n*100)/100:0;x=t,O=o,e.onProgress({loaded:o,total:n,speed:s,percent:r})})}if(e.onDownloadProgress&&"function"==typeof e.onDownloadProgress){var x=Date.now(),O=0,E=0,D=0;A.on("response",function(t){D=t.headers["content-length"],A.on("data",function(t){E+=t.length;var o=Date.now(),n=parseInt((E-O)/((o-x)/1e3)*100)/100,s=D?parseInt(E/D*100)/100:0;x=o,O=E,e.onDownloadProgress({loaded:E,total:D,speed:n,percent:s})})})}c&&(c.on("error",function(e){A&&A.abort&&A.abort(),v(e)}),c.pipe(A));e.outputStream&&(e.outputStream.on("error",function(e){A&&A.abort&&A.abort(),v(e)}),A.pipe(e.outputStream));return A}.call(a,s,function(t,o){t&&e<2&&(l!==a.options.SystemClockOffset||function(e){var t=!1,o=!1,s=e.headers&&(e.headers.date||e.headers.Date)||e.error&&e.error.ServerTime;try{var r=e.error.Code,a=e.error.Message;("RequestTimeTooSkewed"===r||"AccessDenied"===r&&"Request has expired"===a)&&(o=!0)}catch(e){}if(e)if(o&&s){var i=Date.parse(s);this.options.CorrectClockSkew&&Math.abs(n.getSkewTime(this.options.SystemClockOffset)-i)>=3e4&&(console.error("error: Local time is too skewed."),this.options.SystemClockOffset=i-Date.now(),t=!0)}else 5===Math.round(e.statusCode/100)&&(t=!0);return t}.call(a,t))?(s.headers&&(delete s.headers.Authorization,delete s.headers.token,delete s.headers.clientIP,delete s.headers.clientUA,delete s.headers["x-cos-security-token"]),d(e+1)):r(t,o)})})};d(1)}var d={getService:function(e,t){"function"==typeof e&&(t=e,e={});var o=this.options.Protocol||(n.isBrowser&&"http:"===location.protocol?"http:":"https:"),s=this.options.ServiceDomain,r=e.AppId||this.options.appId,a=e.Region;s?(s=s.replace(/\{\{AppId\}\}/gi,r||"").replace(/\{\{Region\}\}/gi,a||"").replace(/\{\{.*?\}\}/gi,""),/^[a-zA-Z]+:\/\//.test(s)||(s=o+"//"+s),"/"===s.slice(-1)&&(s=s.slice(0,-1))):s=a?o+"//cos."+a+".myqcloud.com":o+"//service.cos.myqcloud.com",u.call(this,{Action:"name/cos:GetService",url:s,method:"GET",headers:e.Headers},function(e,o){if(e)return t(e);var s=o&&o.ListAllMyBucketsResult&&o.ListAllMyBucketsResult.Buckets&&o.ListAllMyBucketsResult.Buckets.Bucket||[];s=n.isArray(s)?s:[s];var r=o&&o.ListAllMyBucketsResult&&o.ListAllMyBucketsResult.Owner||{};t(null,{Buckets:s,Owner:r,statusCode:o.statusCode,headers:o.headers})})},putBucket:function(e,t){var o=this;u.call(this,{Action:"name/cos:PutBucket",method:"PUT",Bucket:e.Bucket,Region:e.Region,headers:e.Headers},function(n,s){if(n)return t(n);var r=i({protocol:o.options.Protocol,domain:o.options.Domain,bucket:e.Bucket,region:e.Region,isLocation:!0});t(null,{Location:r,statusCode:s.statusCode,headers:s.headers})})},headBucket:function(e,t){u.call(this,{Action:"name/cos:HeadBucket",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,method:"HEAD"},function(e,o){t(e,o)})},getBucket:function(e,t){var o={};o.prefix=e.Prefix||"",o.delimiter=e.Delimiter,o.marker=e.Marker,o["max-keys"]=e.MaxKeys,o["encoding-type"]=e.EncodingType,u.call(this,{Action:"name/cos:GetBucket",ResourceKey:o.prefix,method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,qs:o},function(e,o){if(e)return t(e);var s=o.ListBucketResult||{},r=s.Contents||[],a=s.CommonPrefixes||[];r=n.isArray(r)?r:[r],a=n.isArray(a)?a:[a];var i=n.clone(s);n.extend(i,{Contents:r,CommonPrefixes:a,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},deleteBucket:function(e,t){u.call(this,{Action:"name/cos:DeleteBucket",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,method:"DELETE"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketAcl:function(e,t){var o=e.Headers,s="";if(e.AccessControlPolicy){var r=n.clone(e.AccessControlPolicy||{}),i=r.Grants||r.Grant;i=n.isArray(i)?i:[i],delete r.Grant,delete r.Grants,r.AccessControlList={Grant:i},s=n.json2xml({AccessControlPolicy:r}),o["Content-Type"]="application/xml",o["Content-MD5"]=n.binaryBase64(n.md5(s))}n.each(o,function(e,t){0===t.indexOf("x-cos-grant-")&&(o[t]=a(o[t]))}),u.call(this,{Action:"name/cos:PutBucketACL",method:"PUT",Bucket:e.Bucket,Region:e.Region,headers:o,action:"acl",body:s},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},getBucketAcl:function(e,t){u.call(this,{Action:"name/cos:GetBucketACL",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"acl"},function(e,o){if(e)return t(e);var s=o.AccessControlPolicy||{},a=s.Owner||{},i=s.AccessControlList.Grant||[];i=n.isArray(i)?i:[i];var c=r(s);o.headers&&o.headers["x-cos-acl"]&&(c.ACL=o.headers["x-cos-acl"]),c=n.extend(c,{Owner:a,Grants:i,statusCode:o.statusCode,headers:o.headers}),t(null,c)})},putBucketCors:function(e,t){var o=(e.CORSConfiguration||{}).CORSRules||e.CORSRules||[];o=n.clone(n.isArray(o)?o:[o]),n.each(o,function(e){n.each(["AllowedOrigin","AllowedHeader","AllowedMethod","ExposeHeader"],function(t,o){var s=t+"s",r=e[s]||e[t]||[];delete e[s],e[t]=n.isArray(r)?r:[r]})});var s=n.json2xml({CORSConfiguration:{CORSRule:o}}),r=e.Headers;r["Content-Type"]="application/xml",r["Content-MD5"]=n.binaryBase64(n.md5(s)),u.call(this,{Action:"name/cos:PutBucketCORS",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:s,action:"cors",headers:r},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},getBucketCors:function(e,t){u.call(this,{Action:"name/cos:GetBucketCORS",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"cors"},function(e,o){if(e)if(404===e.statusCode&&e.error&&"NoSuchCORSConfiguration"===e.error.Code){var s={CORSRules:[],statusCode:e.statusCode};e.headers&&(s.headers=e.headers),t(null,s)}else t(e);else{var r=o.CORSConfiguration||{},a=r.CORSRules||r.CORSRule||[];a=n.clone(n.isArray(a)?a:[a]),n.each(a,function(e){n.each(["AllowedOrigin","AllowedHeader","AllowedMethod","ExposeHeader"],function(t,o){var s=t+"s",r=e[s]||e[t]||[];delete e[t],e[s]=n.isArray(r)?r:[r]})}),t(null,{CORSRules:a,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketCors:function(e,t){u.call(this,{Action:"name/cos:DeleteBucketCORS",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"cors"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode||e.statusCode,headers:o.headers}),void 0)})},getBucketLocation:function(e,t){u.call(this,{Action:"name/cos:GetBucketLocation",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"location"},function(e,o){if(e)return t(e);t(null,o)})},getBucketPolicy:function(e,t){u.call(this,{Action:"name/cos:GetBucketPolicy",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"policy",rawBody:!0},function(e,o){if(e)return e.statusCode&&403===e.statusCode?t({ErrorStatus:"Access Denied"}):e.statusCode&&405===e.statusCode?t({ErrorStatus:"Method Not Allowed"}):e.statusCode&&404===e.statusCode?t({ErrorStatus:"Policy Not Found"}):t(e);var n={};try{n=JSON.parse(o.body)}catch(e){}t(null,{Policy:n,statusCode:o.statusCode,headers:o.headers})})},putBucketPolicy:function(e,t){var o=e.Policy,s=o;try{"string"==typeof o?o=JSON.parse(s):s=JSON.stringify(o)}catch(e){t({error:"Policy format error"})}var r=e.Headers;r["Content-Type"]="application/json",r["Content-MD5"]=n.binaryBase64(n.md5(s)),u.call(this,{Action:"name/cos:PutBucketPolicy",method:"PUT",Bucket:e.Bucket,Region:e.Region,action:"policy",body:n.isBrowser?s:o,headers:r,json:!0},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},deleteBucketPolicy:function(e,t){u.call(this,{Action:"name/cos:DeleteBucketPolicy",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"policy"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode||e.statusCode,headers:o.headers}),void 0)})},putBucketTagging:function(e,t){var o=e.Tagging||{},s=o.TagSet||o.Tags||e.Tags||[];s=n.clone(n.isArray(s)?s:[s]);var r=n.json2xml({Tagging:{TagSet:{Tag:s}}}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=n.binaryBase64(n.md5(r)),u.call(this,{Action:"name/cos:PutBucketTagging",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:r,action:"tagging",headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketTagging:function(e,t){u.call(this,{Action:"name/cos:GetBucketTagging",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"tagging"},function(e,o){if(e)if(404!==e.statusCode||!e.error||"Not Found"!==e.error&&"NoSuchTagSet"!==e.error.Code)t(e);else{var s={Tags:[],statusCode:e.statusCode};e.headers&&(s.headers=e.headers),t(null,s)}else{var r=[];try{r=o.Tagging.TagSet.Tag||[]}catch(e){}r=n.clone(n.isArray(r)?r:[r]),t(null,{Tags:r,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketTagging:function(e,t){u.call(this,{Action:"name/cos:DeleteBucketTagging",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"tagging"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketLifecycle:function(e,t){var o=(e.LifecycleConfiguration||{}).Rules||e.Rules||[];o=n.clone(o);var s=n.json2xml({LifecycleConfiguration:{Rule:o}}),r=e.Headers;r["Content-Type"]="application/xml",r["Content-MD5"]=n.binaryBase64(n.md5(s)),u.call(this,{Action:"name/cos:PutBucketLifecycle",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:s,action:"lifecycle",headers:r},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketLifecycle:function(e,t){u.call(this,{Action:"name/cos:GetBucketLifecycle",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"lifecycle"},function(e,o){if(e)if(404===e.statusCode&&e.error&&"NoSuchLifecycleConfiguration"===e.error.Code){var s={Rules:[],statusCode:e.statusCode};e.headers&&(s.headers=e.headers),t(null,s)}else t(e);else{var r=[];try{r=o.LifecycleConfiguration.Rule||[]}catch(e){}r=n.clone(n.isArray(r)?r:[r]),t(null,{Rules:r,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketLifecycle:function(e,t){u.call(this,{Action:"name/cos:DeleteBucketLifecycle",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"lifecycle"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketVersioning:function(e,t){if(!e.VersioningConfiguration)return t({error:"missing param VersioningConfiguration"}),void 0;var o=e.VersioningConfiguration||{},s=n.json2xml({VersioningConfiguration:o}),r=e.Headers;r["Content-Type"]="application/xml",r["Content-MD5"]=n.binaryBase64(n.md5(s)),u.call(this,{Action:"name/cos:PutBucketVersioning",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:s,action:"versioning",headers:r},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketVersioning:function(e,t){u.call(this,{Action:"name/cos:GetBucketVersioning",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"versioning"},function(e,o){e||!o.VersioningConfiguration&&(o.VersioningConfiguration={}),t(e,o)})},putBucketReplication:function(e,t){var o=n.clone(e.ReplicationConfiguration),s=n.json2xml({ReplicationConfiguration:o});s=(s=s.replace(/<(\/?)Rules>/gi,"<$1Rule>")).replace(/<(\/?)Tags>/gi,"<$1Tag>");var r=e.Headers;r["Content-Type"]="application/xml",r["Content-MD5"]=n.binaryBase64(n.md5(s)),u.call(this,{Action:"name/cos:PutBucketReplication",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:s,action:"replication",headers:r},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketReplication:function(e,t){u.call(this,{Action:"name/cos:GetBucketReplication",method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"replication"},function(e,o){if(e)if(404!==e.statusCode||!e.error||"Not Found"!==e.error&&"ReplicationConfigurationnotFoundError"!==e.error.Code)t(e);else{var n={ReplicationConfiguration:{Rules:[]},statusCode:e.statusCode};e.headers&&(n.headers=e.headers),t(null,n)}else e||!o.ReplicationConfiguration&&(o.ReplicationConfiguration={}),o.ReplicationConfiguration.Rule&&(o.ReplicationConfiguration.Rules=o.ReplicationConfiguration.Rule,delete o.ReplicationConfiguration.Rule),t(e,o)})},deleteBucketReplication:function(e,t){u.call(this,{Action:"name/cos:DeleteBucketReplication",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"replication"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketWebsite:function(e,t){if(!e.WebsiteConfiguration)return t({error:"missing param WebsiteConfiguration"}),void 0;var o=n.clone(e.WebsiteConfiguration||{}),s=o.RoutingRules||o.RoutingRule||[];s=n.isArray(s)?s:[s],delete o.RoutingRule,delete o.RoutingRules,s.length&&(o.RoutingRules={RoutingRule:s});var r=n.json2xml({WebsiteConfiguration:o}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=n.binaryBase64(n.md5(r)),u.call(this,{Action:"name/cos:PutBucketWebsite",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:r,action:"website",headers:a},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketWebsite:function(e,t){u.call(this,{Action:"name/cos:GetBucketWebsite",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"website"},function(e,o){if(e)if(404===e.statusCode&&"NoSuchWebsiteConfiguration"===e.error.Code){var s={WebsiteConfiguration:{},statusCode:e.statusCode};e.headers&&(s.headers=e.headers),t(null,s)}else t(e);else{var r=o.WebsiteConfiguration||{};if(r.RoutingRules){var a=n.clone(r.RoutingRules.RoutingRule||[]);a=n.makeArray(a),r.RoutingRules=a}t(null,{WebsiteConfiguration:r,statusCode:o.statusCode,headers:o.headers})}})},deleteBucketWebsite:function(e,t){u.call(this,{Action:"name/cos:DeleteBucketWebsite",method:"DELETE",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,action:"website"},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},putBucketReferer:function(e,t){if(!e.RefererConfiguration)return t({error:"missing param RefererConfiguration"}),void 0;var o=n.clone(e.RefererConfiguration||{}),s=o.DomainList||{},r=s.Domains||s.Domain||[];(r=n.isArray(r)?r:[r]).length&&(o.DomainList={Domain:r});var a=n.json2xml({RefererConfiguration:o}),i=e.Headers;i["Content-Type"]="application/xml",i["Content-MD5"]=n.binaryBase64(n.md5(a)),u.call(this,{Action:"name/cos:PutBucketReferer",method:"PUT",Bucket:e.Bucket,Region:e.Region,body:a,action:"referer",headers:i},function(e,o){return e&&204===e.statusCode?t(null,{statusCode:e.statusCode}):e?t(e):(t(null,{statusCode:o.statusCode,headers:o.headers}),void 0)})},getBucketReferer:function(e,t){u.call(this,{Action:"name/cos:GetBucketReferer",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"referer"},function(e,o){if(e)if(404===e.statusCode&&"NoSuchRefererConfiguration"===e.error.Code){var s={WebsiteConfiguration:{},statusCode:e.statusCode};e.headers&&(s.headers=e.headers),t(null,s)}else t(e);else{var r=o.RefererConfiguration||{};if(r.DomainList){var a=n.clone(r.DomainList.Domain||[]);a=n.makeArray(a),r.DomainList={Domains:a}}t(null,{RefererConfiguration:r,statusCode:o.statusCode,headers:o.headers})}})},getObject:function(e,t){var o,r={};r["response-content-type"]=e.ResponseContentType,r["response-content-language"]=e.ResponseContentLanguage,r["response-expires"]=e.ResponseExpires,r["response-cache-control"]=e.ResponseCacheControl,r["response-content-disposition"]=e.ResponseContentDisposition,r["response-content-encoding"]=e.ResponseContentEncoding;var a=this,i=e.Output;i&&"string"==typeof i?(i=s.createWriteStream(i),o="stream"):o=i&&"function"==typeof i.pipe?"stream":"buffer";var c=e.onProgress,d=function(){var e,t=Date.now(),o=0,n=0,s=0,r=function(){if(e=0,c&&"function"==typeof c){var r=Date.now(),a=parseInt((n-o)/((r-t)/1e3)*100)/100||0,i=parseInt(n/s*100)/100||0;t=r,o=n;try{c({loaded:n,total:s,speed:a,percent:i})}catch(e){}}};return function(t,o){if(t&&t.loaded&&(n=t.loaded,s=t.total),o)clearTimeout(e),r();else{if(e)return;e=setTimeout(r,a.options.ProgressInterval||1e3)}}}();u.call(this,{Action:"name/cos:GetObject",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,headers:e.Headers,qs:r,rawBody:!0,outputStream:i,onDownloadProgress:d},function(s,r){if(d(null,!0),s){var a=s.statusCode;return e.Headers["If-Modified-Since"]&&a&&304===a?t(null,{NotModified:!0}):t(s)}var i={};r.body&&("buffer"===o?i.Body=Buffer.from(r.body):"string"===o&&(i.Body=r.body)),r.headers&&r.headers.etag&&(i.ETag=r.headers&&r.headers.etag),n.extend(i,{statusCode:r.statusCode,headers:r.headers}),t(null,i)})},headObject:function(e,t){u.call(this,{Action:"name/cos:HeadObject",method:"HEAD",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,headers:e.Headers},function(o,n){if(o){var s=o.statusCode;return e.Headers["If-Modified-Since"]&&s&&304===s?t(null,{NotModified:!0,statusCode:s}):t(o)}n.headers&&n.headers.etag&&(n.ETag=n.headers&&n.headers.etag),t(null,n)})},listObjectVersions:function(e,t){var o={};o.prefix=e.Prefix||"",o.delimiter=e.Delimiter,o["key-marker"]=e.KeyMarker,o["version-id-marker"]=e.VersionIdMarker,o["max-keys"]=e.MaxKeys,o["encoding-type"]=e.EncodingType,u.call(this,{Action:"name/cos:GetBucketObjectVersions",ResourceKey:o.prefix,method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,qs:o,action:"versions"},function(e,o){if(e)return t(e);var s=o.ListVersionsResult||{},r=s.DeleteMarker||[];r=n.isArray(r)?r:[r];var a=s.Version||[];a=n.isArray(a)?a:[a];var i=n.clone(s);delete i.DeleteMarker,delete i.Version,n.extend(i,{DeleteMarkers:r,Versions:a,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},putObject:function(e,t){var o=this,s=e.ContentLength,r=n.throttleOnProgress.call(o,s,e.onProgress);n.getBodyMd5(o.options.UploadCheckContentMd5,e.Body,function(a){a&&(e.Headers["Content-MD5"]=n.binaryBase64(a)),void 0!==e.ContentLength&&(e.Headers["Content-Length"]=e.ContentLength),r(null,!0),u.call(o,{Action:"name/cos:PutObject",TaskId:e.TaskId,method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,body:e.Body,onProgress:r},function(n,a){if(n)return r(null,!0),t(n);if(r({loaded:s,total:s},!0),a){var c=i({ForcePathStyle:o.options.ForcePathStyle,protocol:o.options.Protocol,domain:o.options.Domain,bucket:e.Bucket,region:e.Region,object:e.Key}),u={Location:c=c.substr(c.indexOf("://")+3),statusCode:a.statusCode,headers:a.headers};return a.headers&&a.headers.etag&&(u.ETag=a.headers.etag),t(null,u)}t(null,a)})})},deleteObject:function(e,t){u.call(this,{Action:"name/cos:DeleteObject",method:"DELETE",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,VersionId:e.VersionId},function(e,o){if(e){var n=e.statusCode;return n&&204===n?t(null,{statusCode:n}):n&&404===n?t(null,{BucketNotFound:!0,statusCode:n}):t(e)}t(null,{statusCode:o.statusCode,headers:o.headers})})},getObjectAcl:function(e,t){u.call(this,{Action:"name/cos:GetObjectACL",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,action:"acl"},function(e,o){if(e)return t(e);var s=o.AccessControlPolicy||{},a=s.Owner||{},i=s.AccessControlList&&s.AccessControlList.Grant||[];i=n.isArray(i)?i:[i];var c=r(s);o.headers&&o.headers["x-cos-acl"]&&(c.ACL=o.headers["x-cos-acl"]),c=n.extend(c,{Owner:a,Grants:i,statusCode:o.statusCode,headers:o.headers}),t(null,c)})},putObjectAcl:function(e,t){var o=e.Headers,s="";if(e.AccessControlPolicy){var r=n.clone(e.AccessControlPolicy||{}),i=r.Grants||r.Grant;i=n.isArray(i)?i:[i],delete r.Grant,delete r.Grants,r.AccessControlList={Grant:i},s=n.json2xml({AccessControlPolicy:r}),o["Content-Type"]="application/xml",o["Content-MD5"]=n.binaryBase64(n.md5(s))}n.each(o,function(e,t){0===t.indexOf("x-cos-grant-")&&(o[t]=a(o[t]))}),u.call(this,{Action:"name/cos:PutObjectACL",method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,action:"acl",headers:o,body:s},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},optionsObject:function(e,t){var o=e.Headers;o.Origin=e.Origin,o["Access-Control-Request-Method"]=e.AccessControlRequestMethod,o["Access-Control-Request-Headers"]=e.AccessControlRequestHeaders,u.call(this,{Action:"name/cos:OptionsObject",method:"OPTIONS",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:o},function(e,o){if(e)return e.statusCode&&403===e.statusCode?t(null,{OptionsForbidden:!0,statusCode:e.statusCode}):t(e);var n=o.headers||{};t(null,{AccessControlAllowOrigin:n["access-control-allow-origin"],AccessControlAllowMethods:n["access-control-allow-methods"],AccessControlAllowHeaders:n["access-control-allow-headers"],AccessControlExposeHeaders:n["access-control-expose-headers"],AccessControlMaxAge:n["access-control-max-age"],statusCode:o.statusCode,headers:o.headers})})},putObjectCopy:function(e,t){var o=e.Headers;!o["Cache-Control"]&&(o["Cache-Control"]="");var s=(e.CopySource||"").match(/^([^.]+-\d+)\.cos(v6)?\.([^.]+)\.[^/]+\/(.+)$/);if(!s)return t({error:"CopySource format error"}),void 0;var r=s[1],a=s[3],i=decodeURIComponent(s[4]);u.call(this,{Scope:[{action:"name/cos:GetObject",bucket:r,region:a,prefix:i},{action:"name/cos:PutObject",bucket:e.Bucket,region:e.Region,prefix:e.Key}],method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,headers:e.Headers},function(e,o){if(e)return t(e);var s=n.clone(o.CopyObjectResult||{});n.extend(s,{statusCode:o.statusCode,headers:o.headers}),t(null,s)})},deleteMultipleObject:function(e,t){var o=e.Objects||[],s=e.Quiet;o=n.isArray(o)?o:[o];var r=n.json2xml({Delete:{Object:o,Quiet:s||!1}}),a=e.Headers;a["Content-Type"]="application/xml",a["Content-MD5"]=n.binaryBase64(n.md5(r));var i=n.map(o,function(t){return{action:"name/cos:DeleteObject",bucket:e.Bucket,region:e.Region,prefix:t.Key}});u.call(this,{Scope:i,method:"POST",Bucket:e.Bucket,Region:e.Region,body:r,action:"delete",headers:a},function(e,o){if(e)return t(e);var s=o.DeleteResult||{},r=s.Deleted||[],a=s.Error||[];r=n.isArray(r)?r:[r],a=n.isArray(a)?a:[a];var i=n.clone(s);n.extend(i,{Error:a,Deleted:r,statusCode:o.statusCode,headers:o.headers}),t(null,i)})},restoreObject:function(e,t){var o=e.Headers;if(!e.RestoreRequest)return t({error:"missing param RestoreRequest"}),void 0;var s=e.RestoreRequest||{},r=n.json2xml({RestoreRequest:s});o["Content-Type"]="application/xml",o["Content-MD5"]=n.binaryBase64(n.md5(r)),u.call(this,{Action:"name/cos:RestoreObject",method:"POST",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,body:r,action:"restore",headers:o},function(e,o){t(e,o)})},uploadPartCopy:function(e,t){var o=(e.CopySource||"").match(/^([^.]+-\d+)\.cos(v6)?\.([^.]+)\.[^/]+\/(.+)$/);if(!o)return t({error:"CopySource format error"}),void 0;var s=o[1],r=o[3],a=decodeURIComponent(o[4]);u.call(this,{Scope:[{action:"name/cos:GetObject",bucket:s,region:r,prefix:a},{action:"name/cos:PutObject",bucket:e.Bucket,region:e.Region,prefix:e.Key}],method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,VersionId:e.VersionId,qs:{partNumber:e.PartNumber,uploadId:e.UploadId},headers:e.Headers},function(e,o){if(e)return t(e);var s=n.clone(o.CopyPartResult||{});n.extend(s,{statusCode:o.statusCode,headers:o.headers}),t(null,s)})},multipartInit:function(e,t){var o=e.Headers;!o["Cache-Control"]&&(o["Cache-Control"]=""),u.call(this,{Action:"name/cos:InitiateMultipartUpload",method:"POST",Bucket:e.Bucket,Region:e.Region,Key:e.Key,action:"uploads",headers:e.Headers},function(e,o){return e?t(e):(o=n.clone(o||{}))&&o.InitiateMultipartUploadResult?t(null,n.extend(o.InitiateMultipartUploadResult,{statusCode:o.statusCode,headers:o.headers})):(t(null,o),void 0)})},multipartUpload:function(e,t){var o=this;n.getFileSize("multipartUpload",e,function(){n.getBodyMd5(o.options.UploadCheckContentMd5,e.Body,function(s){s&&(e.Headers["Content-MD5"]=n.binaryBase64(s)),u.call(o,{Action:"name/cos:UploadPart",TaskId:e.TaskId,method:"PUT",Bucket:e.Bucket,Region:e.Region,Key:e.Key,qs:{partNumber:e.PartNumber,uploadId:e.UploadId},headers:e.Headers,onProgress:e.onProgress,body:e.Body||null},function(e,o){if(e)return t(e);o.headers=o.headers||{},t(null,{ETag:o.headers.etag||"",statusCode:o.statusCode,headers:o.headers})})})})},multipartComplete:function(e,t){for(var o=this,s=e.UploadId,r=e.Parts,a=0,c=r.length;a<c;a++)0!==r[a].ETag.indexOf('"')&&(r[a].ETag='"'+r[a].ETag+'"');var d=n.json2xml({CompleteMultipartUpload:{Part:r}}),l=e.Headers;l["Content-Type"]="application/xml",l["Content-MD5"]=n.binaryBase64(n.md5(d)),u.call(this,{Action:"name/cos:CompleteMultipartUpload",method:"POST",Bucket:e.Bucket,Region:e.Region,Key:e.Key,qs:{uploadId:s},body:d,headers:l},function(s,r){if(s)return t(s);var a=i({ForcePathStyle:o.options.ForcePathStyle,protocol:o.options.Protocol,domain:o.options.Domain,bucket:e.Bucket,region:e.Region,object:e.Key,isLocation:!0}),c=r.CompleteMultipartUploadResult||{},u=n.extend(c,{Location:a,statusCode:r.statusCode,headers:r.headers});t(null,u)})},multipartList:function(e,t){var o={};o.delimiter=e.Delimiter,o["encoding-type"]=e.EncodingType,o.prefix=e.Prefix||"",o["max-uploads"]=e.MaxUploads,o["key-marker"]=e.KeyMarker,o["upload-id-marker"]=e.UploadIdMarker,o=n.clearKey(o),u.call(this,{Action:"name/cos:ListMultipartUploads",ResourceKey:o.prefix,method:"GET",Bucket:e.Bucket,Region:e.Region,headers:e.Headers,qs:o,action:"uploads"},function(e,o){if(e)return t(e);if(o&&o.ListMultipartUploadsResult){var s=o.ListMultipartUploadsResult.Upload||[],r=o.ListMultipartUploadsResult.CommonPrefixes||[];r=n.isArray(r)?r:[r],s=n.isArray(s)?s:[s],o.ListMultipartUploadsResult.Upload=s,o.ListMultipartUploadsResult.CommonPrefixes=r}var a=n.clone(o.ListMultipartUploadsResult||{});n.extend(a,{statusCode:o.statusCode,headers:o.headers}),t(null,a)})},multipartListPart:function(e,t){var o={};o.uploadId=e.UploadId,o["encoding-type"]=e.EncodingType,o["max-parts"]=e.MaxParts,o["part-number-marker"]=e.PartNumberMarker,u.call(this,{Action:"name/cos:ListParts",method:"GET",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,qs:o},function(e,o){if(e)return t(e);var s=o.ListPartsResult||{},r=s.Part||[];r=n.isArray(r)?r:[r],s.Part=r;var a=n.clone(s);n.extend(a,{statusCode:o.statusCode,headers:o.headers}),t(null,a)})},multipartAbort:function(e,t){var o={};o.uploadId=e.UploadId,u.call(this,{Action:"name/cos:AbortMultipartUpload",method:"DELETE",Bucket:e.Bucket,Region:e.Region,Key:e.Key,headers:e.Headers,qs:o},function(e,o){if(e)return t(e);t(null,{statusCode:o.statusCode,headers:o.headers})})},getObjectUrl:function(e,t){var o=i({ForcePathStyle:this.options.ForcePathStyle,protocol:e.Protocol||this.options.Protocol,domain:this.options.Domain,bucket:e.Bucket,region:e.Region,object:e.Key});if(void 0!==e.Sign&&!e.Sign)return t(null,{Url:o}),o;var n=c.call(this,{Action:"PUT"===(e.Method||"").toUpperCase()?"name/cos:PutObject":"name/cos:GetObject",Bucket:e.Bucket||"",Region:e.Region||"",Method:e.Method||"get",Key:e.Key,Expires:e.Expires},function(e,n){if(t){if(e)return t(e),void 0;var s=o;s+="?"+(n.Authorization.indexOf("q-signature")>-1?n.Authorization:"sign="+encodeURIComponent(n.Authorization)),n.XCosSecurityToken&&(s+="&x-cos-security-token="+n.XCosSecurityToken),n.ClientIP&&(s+="&clientIP="+n.ClientIP),n.ClientUA&&(s+="&clientUA="+n.ClientUA),n.Token&&(s+="&token="+n.Token),setTimeout(function(){t(null,{Url:s})})}});return n?o+"?"+n.Authorization+(n.XCosSecurityToken?"&x-cos-security-token="+n.XCosSecurityToken:""):o},getAuth:function(e){return n.getAuth({SecretId:e.SecretId||this.options.SecretId||"",SecretKey:e.SecretKey||this.options.SecretKey||"",Method:e.Method,Key:e.Key,Query:e.Query,Headers:e.Headers,Expires:e.Expires,UseRawKey:this.options.UseRawKey,SystemClockOffset:this.options.SystemClockOffset})},getV4Auth:function(e){return n.getV4Auth({SecretId:e.SecretId||this.options.SecretId||"",SecretKey:e.SecretKey||this.options.SecretKey||"",Bucket:e.Bucket,Key:e.Key,Expires:e.Expires})}};module.exports.init=function(e,t){t.transferToTaskMethod(d,"putObject"),n.each(d,function(t,o){e.prototype[o]=n.apiWrapper(o,t),function(e,t,o){n.each(["Cors","Acl"],function(s){if(e.slice(-s.length)===s){var r=e.slice(0,-s.length)+s.toUpperCase(),a=n.apiWrapper(e,t),i=!1;o[r]=function(){!i&&console.warn("warning: cos."+r+" has been deprecated. Please Use cos."+e+" instead."),i=!0,a.apply(this,arguments)}}})}(o,t,e.prototype)})};