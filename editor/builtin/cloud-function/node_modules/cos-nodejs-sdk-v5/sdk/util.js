"use strict";var e,t=require("fs"),r=require("crypto"),n=require("configstore"),o=require("xml2js"),i=new o.Parser({explicitArray:!1,ignoreAttrs:!0}),a=new o.Builder;function s(e){return encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")}var c=function(){},u=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&void 0!==e[r]&&null!==e[r]&&(t[r]=e[r]);return t};function f(e){return"string"==typeof e?""+e:h(e,function(e){return"object"==typeof e?f(e):e})}function d(e,t){return l(t,function(r,n){e[n]=t[n]}),e}function p(e){return e instanceof Array}function l(e,t){for(var r in e)e.hasOwnProperty(r)&&t(e[r],r)}function h(e,t){var r=p(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(r[n]=t(e[n],n));return r}var g=function(e,t){if(t=d({},t),"getAuth"!==e&&"getV4Auth"!==e&&"getObjectUrl"!==e){var r=t.Headers||{};if(t&&"object"==typeof t){(function(){for(var e in t)t.hasOwnProperty(e)&&e.indexOf("x-cos-")>-1&&(r[e]=t[e])})();y.each({"x-cos-mfa":"MFA","Content-MD5":"ContentMD5","Content-Length":"ContentLength","Content-Type":"ContentType",Expect:"Expect",Expires:"Expires","Cache-Control":"CacheControl","Content-Disposition":"ContentDisposition","Content-Encoding":"ContentEncoding",Range:"Range","If-Modified-Since":"IfModifiedSince","If-Unmodified-Since":"IfUnmodifiedSince","If-Match":"IfMatch","If-None-Match":"IfNoneMatch","x-cos-copy-source":"CopySource","x-cos-copy-source-Range":"CopySourceRange","x-cos-metadata-directive":"MetadataDirective","x-cos-copy-source-If-Modified-Since":"CopySourceIfModifiedSince","x-cos-copy-source-If-Unmodified-Since":"CopySourceIfUnmodifiedSince","x-cos-copy-source-If-Match":"CopySourceIfMatch","x-cos-copy-source-If-None-Match":"CopySourceIfNoneMatch","x-cos-acl":"ACL","x-cos-grant-read":"GrantRead","x-cos-grant-write":"GrantWrite","x-cos-grant-full-control":"GrantFullControl","x-cos-grant-read-acp":"GrantReadAcp","x-cos-grant-write-acp":"GrantWriteAcp","x-cos-storage-class":"StorageClass","x-cos-server-side-encryption-customer-algorithm":"SSECustomerAlgorithm","x-cos-server-side-encryption-customer-key":"SSECustomerKey","x-cos-server-side-encryption-customer-key-MD5":"SSECustomerKeyMD5","x-cos-server-side-encryption":"ServerSideEncryption","x-cos-server-side-encryption-cos-kms-key-id":"SSEKMSKeyId","x-cos-server-side-encryption-context":"SSEContext"},function(e,n){void 0!==t[e]&&(r[n]=t[e])}),t.Headers=u(r)}}return t},m=function(e){return Date.now()+(e||0)},y={noop:c,formatParams:g,apiWrapper:function(e,t){return function(r,n){"function"==typeof r&&(n=r,r={}),r=g(e,r);var o=function(e){return e&&e.headers&&(e.headers["x-cos-version-id"]&&(e.VersionId=e.headers["x-cos-version-id"]),e.headers["x-cos-delete-marker"]&&(e.DeleteMarker=e.headers["x-cos-delete-marker"])),e},i=function(e,t){n&&n(o(e),o(t))};if("getService"!==e&&"abortUploadTask"!==e){var a;if(a=function(e,t){var r=t.Bucket,n=t.Region,o=t.Key;if(e.indexOf("Bucket")>-1||"deleteMultipleObject"===e||"multipartList"===e||"listObjectVersions"===e){if(!r)return"Bucket";if(!n)return"Region"}else if(e.indexOf("Object")>-1||e.indexOf("multipart")>-1||"sliceUploadFile"===e||"abortUploadTask"===e){if(!r)return"Bucket";if(!n)return"Region";if(!o)return"Key"}return!1}(e,r))return i({error:"missing param "+a}),void 0;if(r.Region){if(r.Region.indexOf("cos.")>-1)return i({error:'param Region should not be start with "cos."'}),void 0;if(!/^([a-z\d-]+)$/.test(r.Region))return i({error:"Region format error."}),void 0;this.options.CompatibilityMode||-1!==r.Region.indexOf("-")||"yfb"===r.Region||"default"===r.Region||console.warn("warning: param Region format error, find help here: https://cloud.tencent.com/document/product/436/6224")}if(r.Bucket){if(!/^([a-z\d-]+)-(\d+)$/.test(r.Bucket))if(r.AppId)r.Bucket=r.Bucket+"-"+r.AppId;else{if(!this.options.AppId)return i({error:'Bucket should format as "test-1250000000".'}),void 0;r.Bucket=r.Bucket+"-"+this.options.AppId}r.AppId&&(console.warn('warning: AppId has been deprecated, Please put it at the end of parameter Bucket(E.g Bucket:"test-1250000000" ).'),delete r.AppId)}!this.options.UseRawKey&&r.Key&&"/"===r.Key.substr(0,1)&&(r.Key=r.Key.substr(1))}var s=t.call(this,r,i);if("getAuth"===e||"getV4Auth"===e||"getObjectUrl"===e)return s}},xml2json:function(e){var t={};return i.parseString(e,function(e,r){t=r}),t},json2xml:function(e){return a.buildObject(e)},md5:function(e,t){return r.createHash("md5").update(e).digest(t||"hex")},clearKey:u,getFileMd5:function(e,t){var n=r.createHash("md5");e.on("data",function(e){n.update(e)}),e.on("error",function(e){t(e)}),e.on("end",function(){var e=n.digest("hex");t(null,e)})},binaryBase64:function(e){var t,r,n,o=[];for(t=0,r=e.length/2;t<r;t++)n=parseInt(e[2*t]+e[2*t+1],16),o.push(n);return Buffer.from(o).toString("base64")},extend:d,isArray:p,isInArray:function(e,t){for(var r=!1,n=0;n<e.length;n++)if(t===e[n]){r=!0;break}return r},makeArray:function(e){return p(e)?e:[e]},each:l,map:h,filter:function(e,t){var r=p(e),n=r?[]:{};for(var o in e)e.hasOwnProperty(o)&&t(e[o],o)&&(r?n.push(e[o]):n[o]=e[o]);return n},clone:f,uuid:function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},camSafeUrlEncode:s,throttleOnProgress:function(e,t){var r,n,o=this,i=0,a=0,s=Date.now();function c(){if(n=0,t&&"function"==typeof t){r=Date.now();var o,c=Math.max(0,Math.round((a-i)/((r-s)/1e3)*100)/100);o=0===a&&0===e?1:Math.round(a/e*100)/100||0,s=r,i=a;try{t({loaded:a,total:e,speed:c,percent:o})}catch(e){}}}return function(t,r){if(t&&(a=t.loaded,e=t.total),r)clearTimeout(n),c();else{if(n)return;n=setTimeout(c,o.options.ProgressInterval)}}},getFileSize:function(e,r,n){var o;if("sliceUploadFile"===e)return r.FilePath?(t.stat(r.FilePath,function(e,t){if(e){if(void 0===r.ContentLength)return n(e),void 0;o=r.ContentLength}else r.FileStat=t,r.FileStat.FilePath=r.FilePath,o=t.isDirectory()?0:t.size;r.ContentLength=o=o||0,n(null,o)}),void 0):(n({error:"missing param FilePath"}),void 0);if(void 0===r.Body)return n({error:"missing param Body"}),void 0;if("string"==typeof r.Body&&(r.Body=global.Buffer.from(r.Body)),r.Body instanceof global.Buffer)o=r.Body.length;else{if("function"!=typeof r.Body.pipe)return n({error:"params Body format error, Only allow Buffer|Stream|String."}),void 0;o=void 0===r.ContentLength?void 0:r.ContentLength}r.ContentLength=o,n(null,o)},getSkewTime:m,getAuth:function(e){var t,n=(e=e||{}).SecretId,o=e.SecretKey,i=e.KeyTime,a=(e.method||e.Method||"get").toLowerCase(),c=f(e.Query||e.params||{}),u=f(e.Headers||e.headers||{}),d=e.Key||"";if(e.UseRawKey?t=e.Pathname||e.pathname||"/"+d:0!==(t=e.Pathname||e.pathname||d).indexOf("/")&&(t="/"+t),!n)return console.error("missing param SecretId");if(!o)return console.error("missing param SecretKey");var p=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(r);return t.sort(function(e,t){return(e=e.toLowerCase())===(t=t.toLowerCase())?0:e>t?1:-1})},l=function(e){var t,r,n,o=[],i=p(e);for(t=0;t<i.length;t++)n=void 0===e[r=i[t]]||null===e[r]?"":""+e[r],r=s(r=r.toLowerCase()),n=s(n)||"",o.push(r+"="+n);return o.join("&")},h=Math.round(m(e.SystemClockOffset)/1e3)-1,g=h,y=e.Expires||e.expires;g+=void 0===y?900:1*y||0;var v=n,x=i||h+";"+g,S=i||h+";"+g,C=p(u).join(";").toLowerCase(),I=p(c).join(";").toLowerCase(),B=r.createHmac("sha1",o).update(S).digest("hex"),k=[a,t,l(c),l(u),""].join("\n");k=Buffer.from(k,"utf8");var M=["sha1",x,r.createHash("sha1").update(k).digest("hex"),""].join("\n");return["q-sign-algorithm=sha1","q-ak="+v,"q-sign-time="+x,"q-key-time="+S,"q-header-list="+C,"q-url-param-list="+I,"q-signature="+r.createHmac("sha1",B).update(M).digest("hex")].join("&")},getV4Auth:function(e){if(!e.SecretId)return console.error("missing param SecretId");if(!e.SecretKey)return console.error("missing param SecretKey");if(!e.Bucket)return console.error("missing param Bucket");var t=e.Bucket,n=t.substr(0,t.lastIndexOf("-")),o=t.substr(t.lastIndexOf("-")+1),i=Math.round(Math.random()*Math.pow(2,32)),a=Math.round(Date.now()/1e3),s=a+(void 0===e.Expires?900:e.Expires),c="/"+o+"/"+n+"/"+encodeURIComponent((e.Key||"").replace(/(^\/*)/g,"")).replace(/%2F/g,"/"),u="a="+o+"&b="+n+"&k="+e.SecretId+"&t="+a+"&e="+s+"&r="+i+"&f="+c,f=r.createHmac("sha1",e.SecretKey).update(u).digest();return Buffer.concat([f,Buffer.from(u)]).toString("base64")},isBrowser:!1};(function(){try{e=new n("cos-nodejs-sdk-v5-storage")}catch(e){}var t={},r=function(r,n){t.hasOwnProperty(r)?t[r]=n:(t[r]=n,setTimeout(function(){e&&(void 0===t[r]?e.delete(r):e.set(r,t[r]),delete t[r])},300))};y.localStorage={getItem:function(t){return e&&e.get(t)},setItem:r,removeItem:r}})(),y.fileSlice=function(e,r,n,o){if(e){var i=t.createReadStream(e,{start:r,end:n-1});i.isSdkCreated=!0,o(i)}else o(null)},y.getFileUUID=function(e,t){return e&&e.FilePath&&e.size&&e.ctime&&e.mtime&&t?y.md5([e.FilePath].join("::"))+"-"+y.md5([e.size,e.ctime,e.mtime,t].join("::")):null},y.getBodyMd5=function(e,t,r){r=r||c,e&&(t instanceof Buffer||"string"==typeof t)?r(y.md5(t)):r()},module.exports=y;