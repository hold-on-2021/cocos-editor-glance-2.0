"use strict";const t=require("buffer").Buffer,e=require("../binary"),n=require("./utils").normalizedFunctionString,u=require("../constants");function l(t,e,n){let u=5;if(Array.isArray(t))for(let l=0;l<t.length;l++)u+=o(l.toString(),t[l],e,!0,n);else{t.toBSON&&(t=t.toBSON());for(let l in t)u+=o(l,t[l],e,!1,n)}return u}function o(o,r,b,f,i){switch(r&&r.toBSON&&(r=r.toBSON()),typeof r){case"string":return 1+t.byteLength(o,"utf8")+1+4+t.byteLength(r,"utf8")+1;case"number":return Math.floor(r)===r&&r>=u.JS_INT_MIN&&r<=u.JS_INT_MAX&&r>=u.BSON_INT32_MIN&&r<=u.BSON_INT32_MAX?(null!=o?t.byteLength(o,"utf8")+1:0)+5:(null!=o?t.byteLength(o,"utf8")+1:0)+9;case"undefined":return f||!i?(null!=o?t.byteLength(o,"utf8")+1:0)+1:0;case"boolean":return(null!=o?t.byteLength(o,"utf8")+1:0)+2;case"object":if(null==r||"MinKey"===r._bsontype||"MaxKey"===r._bsontype)return(null!=o?t.byteLength(o,"utf8")+1:0)+1;if("ObjectId"===r._bsontype||"ObjectID"===r._bsontype)return(null!=o?t.byteLength(o,"utf8")+1:0)+13;if(r instanceof Date||function(t){return"object"==typeof t&&"[object Date]"===Object.prototype.toString.call(t)}(r))return(null!=o?t.byteLength(o,"utf8")+1:0)+9;if(void 0!==t&&t.isBuffer(r))return(null!=o?t.byteLength(o,"utf8")+1:0)+6+r.length;if("Long"===r._bsontype||"Double"===r._bsontype||"Timestamp"===r._bsontype)return(null!=o?t.byteLength(o,"utf8")+1:0)+9;if("Decimal128"===r._bsontype)return(null!=o?t.byteLength(o,"utf8")+1:0)+17;if("Code"===r._bsontype)return null!=r.scope&&Object.keys(r.scope).length>0?(null!=o?t.byteLength(o,"utf8")+1:0)+1+4+4+t.byteLength(r.code.toString(),"utf8")+1+l(r.scope,b,i):(null!=o?t.byteLength(o,"utf8")+1:0)+1+4+t.byteLength(r.code.toString(),"utf8")+1;if("Binary"===r._bsontype)return r.sub_type===e.SUBTYPE_BYTE_ARRAY?(null!=o?t.byteLength(o,"utf8")+1:0)+(r.position+1+4+1+4):(null!=o?t.byteLength(o,"utf8")+1:0)+(r.position+1+4+1);if("Symbol"===r._bsontype)return(null!=o?t.byteLength(o,"utf8")+1:0)+t.byteLength(r.value,"utf8")+4+1+1;if("DBRef"===r._bsontype){const e=Object.assign({$ref:r.collection,$id:r.oid},r.fields);return null!=r.db&&(e.$db=r.db),(null!=o?t.byteLength(o,"utf8")+1:0)+1+l(e,b,i)}return r instanceof RegExp||"[object RegExp]"===Object.prototype.toString.call(r)?(null!=o?t.byteLength(o,"utf8")+1:0)+1+t.byteLength(r.source,"utf8")+1+(r.global?1:0)+(r.ignoreCase?1:0)+(r.multiline?1:0)+1:"BSONRegExp"===r._bsontype?(null!=o?t.byteLength(o,"utf8")+1:0)+1+t.byteLength(r.pattern,"utf8")+1+t.byteLength(r.options,"utf8")+1:(null!=o?t.byteLength(o,"utf8")+1:0)+l(r,b,i)+1;case"function":if(r instanceof RegExp||"[object RegExp]"===Object.prototype.toString.call(r)||"[object RegExp]"===String.call(r))return(null!=o?t.byteLength(o,"utf8")+1:0)+1+t.byteLength(r.source,"utf8")+1+(r.global?1:0)+(r.ignoreCase?1:0)+(r.multiline?1:0)+1;if(b&&null!=r.scope&&Object.keys(r.scope).length>0)return(null!=o?t.byteLength(o,"utf8")+1:0)+1+4+4+t.byteLength(n(r),"utf8")+1+l(r.scope,b,i);if(b)return(null!=o?t.byteLength(o,"utf8")+1:0)+1+4+t.byteLength(n(r),"utf8")+1}return 0}module.exports=l;