var e=require("assert-plus"),r=(require("util"),require("extsprintf")),t=require("verror"),o=require("json-schema");function n(r,t){return e.equal(typeof t,"string"),Object.prototype.hasOwnProperty.call(r,t)}exports.deepCopy=function e(r){var t,o;var n="__deepCopy";if(r&&r[n])throw new Error("attempted deep copy of cyclic object");if(r&&r.constructor==Object){for(o in t={},r[n]=!0,r)o!=n&&(t[o]=e(r[o]));return delete r[n],t}if(r&&r.constructor==Array){for(t=[],r[n]=!0,o=0;o<r.length;o++)t.push(e(r[o]));return delete r[n],t}return r},exports.deepEqual=function e(r,t){if(typeof r!=typeof t)return!1;if(null===r||null===t||"object"!=typeof r)return r===t;if(r.constructor!=t.constructor)return!1;var o;for(o in r){if(!t.hasOwnProperty(o))return!1;if(!e(r[o],t[o]))return!1}for(o in t)if(!r.hasOwnProperty(o))return!1;return!0},exports.isEmpty=function(e){var r;for(r in e)return!1;return!0},exports.hasKey=n,exports.forEachKey=function(e,r){for(var t in e)n(e,t)&&r(t,e[t])},exports.pluck=function(r,t){return e.equal(typeof t,"string"),function e(r,t){if(null!==r&&"object"==typeof r){if(r.hasOwnProperty(t))return r[t];var o=t.indexOf(".");if(-1!=o){var n=t.substr(0,o);if(r.hasOwnProperty(n))return e(r[n],t.substr(o+1))}}}(r,t)},exports.flattenObject=function r(t,o){if(0===o)return[t];e.ok(null!==t);e.equal(typeof t,"object");e.equal(typeof o,"number");e.ok(o>=0);var n=[];var i;for(i in t)r(t[i],o-1).forEach(function(e){n.push([i].concat(e))});return n},exports.flattenIter=function(r,t,o){(function r(t,o,n,i){var a;var s;if(0===o)return(a=n.slice(0)).push(t),i(a),void 0;e.ok(null!==t);e.equal(typeof t,"object");e.equal(typeof o,"number");e.ok(o>=0);for(s in t)(a=n.slice(0)).push(s),r(t[s],o-1,a,i)})(r,t,[],o)},exports.validateJsonObject=A,exports.validateJsonObjectJS=A,exports.randElt=function(r){return e.ok(Array.isArray(r)&&r.length>0,"randElt argument must be a non-empty array"),r[Math.floor(Math.random()*r.length)]},exports.extraProperties=function(r,t){e.ok("object"==typeof r&&null!==r,"obj argument must be a non-null object"),e.ok(Array.isArray(t),"allowed argument must be an array of strings");for(var o=0;o<t.length;o++)e.ok("string"==typeof t[o],"allowed argument must be an array of strings");return Object.keys(r).filter(function(e){return-1===t.indexOf(e)})},exports.mergeObjects=q,exports.startsWith=function(e,r){return e.substr(0,r.length)==r},exports.endsWith=function(e,r){return e.substr(e.length-r.length,r.length)==r},exports.parseInteger=function(r,t){e.string(r,"str"),e.optionalObject(t,"options");var o,i=!1,a=l;t&&(i=n(t,"base"),a=q(a,t),e.number(a.base,"options.base"),e.ok(a.base>=2,"options.base >= 2"),e.ok(a.base<=36,"options.base <= 36"),e.bool(a.allowSign,"options.allowSign"),e.bool(a.allowPrefix,"options.allowPrefix"),e.bool(a.allowTrailing,"options.allowTrailing"),e.bool(a.allowImprecise,"options.allowImprecise"),e.bool(a.trimWhitespace,"options.trimWhitespace"),e.bool(a.leadingZeroIsOctal,"options.leadingZeroIsOctal"),a.leadingZeroIsOctal&&e.ok(!i,'"base" and "leadingZeroIsOctal" are mutually exclusive'));var f,c=-1,p=a.base,m=1,y=0,T=0,C=r.length;if(a.trimWhitespace)for(;T<C&&E(r.charCodeAt(T));)++T;a.allowSign&&("-"===r[T]?(T+=1,m=-1):"+"===r[T]&&(T+=1));"0"===r[T]&&(a.allowPrefix&&(-1===(c=function(e){return e===w||e===d?2:e===x||e===g?8:e===v||e===h?10:e===O||e===b?16:-1}(r.charCodeAt(T+1)))||i&&c!==p||(p=c,T+=2)),-1===c&&a.leadingZeroIsOctal&&(p=8));for(f=T;T<C&&(-1!==(o=k(r.charCodeAt(T)))&&o<p);++T)y*=p,y+=o;if(f===T)return new Error("invalid number: "+JSON.stringify(r));if(a.trimWhitespace)for(;T<C&&E(r.charCodeAt(T));)++T;if(T<C&&!a.allowTrailing)return new Error("trailing characters after number: "+JSON.stringify(r.slice(T)));if(0===y)return 0;var j=y*m;if(!a.allowImprecise&&(y>s||j<u))return new Error("number is outside of the supported range: "+JSON.stringify(r.slice(f,T)));return j},exports.iso8601=function(t){"number"==typeof t&&(t=new Date(t));return e.ok(t.constructor===Date),r.sprintf("%4d-%02d-%02dT%02d:%02d:%02d.%03dZ",t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.getUTCMilliseconds())},exports.rfc1123=function(e){return r.sprintf("%s, %02d %s %04d %02d:%02d:%02d GMT",a[e.getUTCDay()],e.getUTCDate(),i[e.getUTCMonth()],e.getUTCFullYear(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())},exports.parseDateTime=function(e){var r=+e;return isNaN(r)?new Date(e):new Date(r)},exports.hrtimediff=S,exports.hrtimeDiff=S,exports.hrtimeAccum=U,exports.hrtimeAdd=function(e,r){return I(e),U([e[0],e[1]],r)},exports.hrtimeNanosec=function(e){return I(e),Math.floor(1e9*e[0]+e[1])},exports.hrtimeMicrosec=function(e){return I(e),Math.floor(1e6*e[0]+e[1]/1e3)},exports.hrtimeMillisec=function(e){return I(e),Math.floor(1e3*e[0]+e[1]/1e6)};var i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var s=Number.MAX_SAFE_INTEGER||9007199254740991,u=Number.MIN_SAFE_INTEGER||-9007199254740991,l={base:10,allowSign:!0,allowPrefix:!1,allowTrailing:!1,allowImprecise:!1,trimWhitespace:!1,leadingZeroIsOctal:!1},f=48,c=57,p=65,d=66,g=79,h=84,b=88,m=90,y=97,w=98,x=111,v=116,O=120,T=122,C=48,j=55,M=87;function k(e){return e>=f&&e<=c?e-C:e>=p&&e<=m?e-j:e>=y&&e<=T?e-M:-1}function E(e){return 32===e||e>=9&&e<=13||160===e||5760===e||6158===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e||65279===e}function A(e,r){var n=o.validate(r,e);if(0===n.errors.length)return null;var i,a,s=n.errors[0],u=s.property,l=s.message.toLowerCase();-1!=(i=l.indexOf("the property "))&&-1!=(a=l.indexOf(" is not defined in the schema and the schema does not allow additional properties"))&&(i+="the property ".length,u=""===u?l.substr(i,a-i):u+"."+l.substr(i,a-i),l="unsupported property");var f=new t.VError('property "%s": %s',u,l);return f.jsv_details=s,f}function I(r){e.ok(r[0]>=0&&r[1]>=0,"negative numbers not allowed in hrtimes"),e.ok(r[1]<1e9,"nanoseconds column overflow")}function S(r,t){I(r),I(t),e.ok(r[0]>t[0]||r[0]==t[0]&&r[1]>=t[1],"negative differences not allowed");var o=[r[0]-t[0],0];return r[1]>=t[1]?o[1]=r[1]-t[1]:(o[0]--,o[1]=1e9-(t[1]-r[1])),o}function U(e,r){return I(e),I(r),e[1]+=r[1],e[1]>=1e9&&(e[0]++,e[1]-=1e9),e[0]+=r[0],e}function q(e,r,t){var o,n;if(o={},t)for(n in t)o[n]=t[n];if(e)for(n in e)o[n]=e[n];if(r)for(n in r)o[n]=r[n];return o}