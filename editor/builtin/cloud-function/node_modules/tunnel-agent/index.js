"use strict";require("net");var e,t=require("tls"),o=require("http"),r=require("https"),s=require("events"),n=require("assert"),i=require("util"),c=require("safe-buffer").Buffer;function u(e){var t=this;t.options=e||{},t.proxyOptions=t.options.proxy||{},t.maxSockets=t.options.maxSockets||o.Agent.defaultMaxSockets,t.requests=[],t.sockets=[],t.on("free",function(e,o,r){for(var s=0,n=t.requests.length;s<n;++s){var i=t.requests[s];if(i.host===o&&i.port===r)return t.requests.splice(s,1),i.request.onSocket(e),void 0}e.destroy(),t.removeSocket(e)})}function a(e,o){var r=this;u.prototype.createSocket.call(r,e,function(s){var n=t.connect(0,p({},r.options,{servername:e.host,socket:s}));r.sockets[r.sockets.indexOf(s)]=n,o(n)})}function p(e){for(var t=1,o=arguments.length;t<o;++t){var r=arguments[t];if("object"==typeof r)for(var s=Object.keys(r),n=0,i=s.length;n<i;++n){var c=s[n];void 0!==r[c]&&(e[c]=r[c])}}return e}exports.httpOverHttp=function(e){var t=new u(e);return t.request=o.request,t},exports.httpsOverHttp=function(e){var t=new u(e);return t.request=o.request,t.createSocket=a,t.defaultPort=443,t},exports.httpOverHttps=function(e){var t=new u(e);return t.request=r.request,t},exports.httpsOverHttps=function(e){var t=new u(e);return t.request=r.request,t.createSocket=a,t.defaultPort=443,t},i.inherits(u,s.EventEmitter),u.prototype.addRequest=function(e,t){if("string"==typeof t&&(t={host:t,port:arguments[2],path:arguments[3]}),this.sockets.length>=this.maxSockets)return this.requests.push({host:t.host,port:t.port,request:e}),void 0;this.createConnection({host:t.host,port:t.port,request:e})},u.prototype.createConnection=function(e){var t=this;t.createSocket(e,function(o){function r(){t.emit("free",o,e.host,e.port)}function s(e){t.removeSocket(o),o.removeListener("free",r),o.removeListener("close",s),o.removeListener("agentRemove",s)}o.on("free",r),o.on("close",s),o.on("agentRemove",s),e.request.onSocket(o)})},u.prototype.createSocket=function(t,o){var r=this,s={};r.sockets.push(s);var i=p({},r.proxyOptions,{method:"CONNECT",path:t.host+":"+t.port,agent:!1});i.proxyAuth&&(i.headers=i.headers||{},i.headers["Proxy-Authorization"]="Basic "+c.from(i.proxyAuth).toString("base64")),e("making CONNECT request");var u=r.request(i);function a(i,c,a){if(u.removeAllListeners(),c.removeAllListeners(),200===i.statusCode)n.equal(a.length,0),e("tunneling connection has established"),r.sockets[r.sockets.indexOf(s)]=c,o(c);else{e("tunneling socket could not be established, statusCode=%d",i.statusCode);var p=new Error("tunneling socket could not be established, statusCode="+i.statusCode);p.code="ECONNRESET",t.request.emit("error",p),r.removeSocket(s)}}u.useChunkedEncodingByDefault=!1,u.once("response",function(e){e.upgrade=!0}),u.once("upgrade",function(e,t,o){process.nextTick(function(){a(e,t,o)})}),u.once("connect",a),u.once("error",function(o){u.removeAllListeners(),e("tunneling socket could not be established, cause=%s\n",o.message,o.stack);var n=new Error("tunneling socket could not be established, cause="+o.message);n.code="ECONNRESET",t.request.emit("error",n),r.removeSocket(s)}),u.end()},u.prototype.removeSocket=function(e){var t=this.sockets.indexOf(e);if(-1!==t){this.sockets.splice(t,1);var o=this.requests.shift();o&&this.createConnection(o)}},e=process.env.NODE_DEBUG&&/\btunnel\b/.test(process.env.NODE_DEBUG)?function(){var e=Array.prototype.slice.call(arguments);"string"==typeof e[0]?e[0]="TUNNEL: "+e[0]:e.unshift("TUNNEL:"),console.error.apply(console,e)}:function(){},exports.debug=e;