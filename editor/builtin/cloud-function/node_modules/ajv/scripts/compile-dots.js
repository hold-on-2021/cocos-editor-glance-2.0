"use strict";var e=require("glob"),r=require("fs"),n=require("path"),a=require("dot"),o=require("js-beautify").js_beautify,i=process.argv[2]||n.join(__dirname,"../lib"),s={};e.sync("./dot/**/*.def",{cwd:i}).forEach(function(e){var a=n.basename(e,".def");s[a]=r.readFileSync(n.join(i,e))});var t=process.argv[3]||n.join(__dirname,"../lib"),c=e.sync("./dot/**/*.jst",{cwd:t}),l=n.join(t,"./dotjs");try{r.mkdirSync(l)}catch(e){}console.log("\n\nCompiling:");var d=/function\s+anonymous\s*\(it[^)]*\)\s*{/,u=/out\s*\+=\s*'\s*';/g,g=/'(istanbul[^']+)';/g,$=/\$errorKeyword/g,p=/\$errorKeyword\s+\|\|/g,f=["$errs","$valid","$lvl","$data","$dataLvl","$errorKeyword","$closingBraces","$schemaPath","$validate"];c.forEach(function(e){var i=n.basename(e,".jst"),c=n.join(l,i+".js"),v=r.readFileSync(n.join(t,e)),y=a.compile(v,s);function j(e){return(y.match(e)||[]).length}y=y.toString().replace(u,"").replace(d,"function generate_"+i+"(it, $keyword, $ruleType) {").replace(g,"/* $1 */"),function(){var e=j($),r=j(p);e==r+1&&(y=y.replace(p,""))}(),f.forEach(function(e){e=e.replace(/\$/g,"\\$$");var r=new RegExp(e+"[^A-Za-z0-9_$]","g");1==j(r)&&(r=new RegExp("var\\s+"+e+"\\s*=[^;]+;|var\\s+"+e+";"),y=y.replace(r,""))}),y=o(y="'use strict';\nmodule.exports = "+y,{indent_size:2})+"\n",r.writeFileSync(c,y),console.log("compiled",i)});