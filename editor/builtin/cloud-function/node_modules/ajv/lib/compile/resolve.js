"use strict";var e=require("uri-js"),r=require("fast-deep-equal"),t=require("./util"),i=require("./schema_obj"),s=require("json-schema-traverse");function a(e,r,t){var s=this._refs[t];if("string"==typeof s){if(!this._refs[s])return a.call(this,e,r,s);s=this._refs[s]}if((s=s||this._schemas[t])instanceof i)return h(s.schema,this._opts.inlineRefs)?s.schema:s.validate||this._compile(s);var o,f,c,u=n.call(this,r,t);return u&&(o=u.schema,r=u.root,c=u.baseId),o instanceof i?f=o.validate||e.call(this,o.schema,r,void 0,c):void 0!==o&&(f=h(o,this._opts.inlineRefs)?o:e.call(this,o,r,void 0,c)),f}function n(r,t){var s=e.parse(t),a=l(s),o=u(this._getId(r.schema));if(0===Object.keys(r.schema).length||a!==o){var c=v(a),h=this._refs[c];if("string"==typeof h)return function(e,r,t){var i=n.call(this,e,r);if(i){var s=i.schema,a=i.baseId;e=i.root;var o=this._getId(s);return o&&(a=d(a,o)),f.call(this,t,a,s,e)}}.call(this,r,h,s);if(h instanceof i)h.validate||this._compile(h),r=h;else{if(!((h=this._schemas[c])instanceof i))return;if(h.validate||this._compile(h),c==v(t))return{schema:h,root:r,baseId:o};r=h}if(!r.schema)return;o=u(this._getId(r.schema))}return f.call(this,s,o,r.schema,r)}module.exports=a,a.normalizeId=v,a.fullPath=u,a.url=d,a.ids=function(i){var a=v(this._getId(i)),n={"":a},o={"":u(a,!1)},f={},c=this;return s(i,{allKeys:!0},function(i,s,a,h,u,l,m){if(""!==s){var d=c._getId(i),p=n[h],g=o[h]+"/"+u;if(void 0!==m&&(g+="/"+("number"==typeof m?m:t.escapeFragment(m))),"string"==typeof d){d=p=v(p?e.resolve(p,d):d);var _=c._refs[d];if("string"==typeof _&&(_=c._refs[_]),_&&_.schema){if(!r(i,_.schema))throw new Error('id "'+d+'" resolves to more than one schema')}else if(d!=v(g))if("#"==d[0]){if(f[d]&&!r(i,f[d]))throw new Error('id "'+d+'" resolves to more than one schema');f[d]=i}else c._refs[d]=g}n[s]=p,o[s]=g}}),f},a.inlineRef=h,a.schema=n;var o=t.toHash(["properties","patternProperties","enum","dependencies","definitions"]);function f(e,r,i,s){if(e.fragment=e.fragment||"","/"==e.fragment.slice(0,1)){for(var a=e.fragment.split("/"),f=1;f<a.length;f++){var c=a[f];if(c){if(void 0===(i=i[c=t.unescapeFragment(c)]))break;var h;if(!o[c]&&((h=this._getId(i))&&(r=d(r,h)),i.$ref)){var u=d(r,i.$ref),l=n.call(this,s,u);l&&(i=l.schema,s=l.root,r=l.baseId)}}}return void 0!==i&&i!==s.schema?{schema:i,root:s,baseId:r}:void 0}}var c=t.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]);function h(e,r){return!1!==r&&(void 0===r||!0===r?function e(r){var t;if(Array.isArray(r)){for(var i=0;i<r.length;i++)if("object"==typeof(t=r[i])&&!e(t))return!1}else for(var s in r){if("$ref"==s)return!1;if("object"==typeof(t=r[s])&&!e(t))return!1}return!0}(e):r?function e(r){var t,i=0;if(Array.isArray(r)){for(var s=0;s<r.length;s++)if("object"==typeof(t=r[s])&&(i+=e(t)),i==1/0)return 1/0}else for(var a in r){if("$ref"==a)return 1/0;if(c[a])i++;else if("object"==typeof(t=r[a])&&(i+=e(t)+1),i==1/0)return 1/0}return i}(e)<=r:void 0)}function u(r,t){return!1!==t&&(r=v(r)),l(e.parse(r))}function l(r){return e.serialize(r).split("#")[0]+"#"}var m=/#\/?$/;function v(e){return e?e.replace(m,""):""}function d(r,t){return t=v(t),e.resolve(r,t)}