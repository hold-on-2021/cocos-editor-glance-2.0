"use strict";var e=require("./resolve"),r=require("./util"),t=require("./error_classes"),i=require("fast-json-stable-stringify"),a=require("../dotjs/validate"),o=r.ucs2length,n=require("fast-deep-equal"),s=t.Validation;function l(e,r,t){for(var i=0;i<this._compilations.length;i++){var a=this._compilations[i];if(a.schema==e&&a.root==r&&a.baseId==t)return i}return-1}function c(e,t){return"var pattern"+e+" = new RegExp("+r.toQuotedString(t[e])+");"}function u(e){return"var default"+e+" = defaults["+e+"];"}function f(e,r){return void 0===r[e]?"":"var refVal"+e+" = refVal["+e+"];"}function d(e){return"var customRule"+e+" = customRules["+e+"];"}function v(e,r){if(!e.length)return"";for(var t="",i=0;i<e.length;i++)t+=r(i,e);return t}module.exports=function h(m,p,g,y){var w=this,R=this._opts,V=[void 0],S={},_=[],b={},E=[],q={},j=[];p=p||{schema:m,refVal:V,refs:S};var x=function(e,r,t){var i=l.call(this,e,r,t);return i>=0?{index:i,compiling:!0}:(i=this._compilations.length,this._compilations[i]={schema:e,root:r,baseId:t},{index:i,compiling:!1})}.call(this,m,p,y);var $=this._compilations[x.index];if(x.compiling)return $.callValidate=function e(){var r=$.validate;var t=r.apply(this,arguments);e.errors=r.errors;return t};var k=this._formats;var C=this.RULES;try{var P=L(m,p,g,y);$.validate=P;var I=$.callValidate;return I&&(I.schema=P.schema,I.errors=null,I.refs=P.refs,I.refVal=P.refVal,I.root=P.root,I.$async=P.$async,R.sourceCode&&(I.source=P.source)),P}finally{(function(e,r,t){var i=l.call(this,e,r,t);i>=0&&this._compilations.splice(i,1)}).call(this,m,p,y)}function L(i,l,m,g){var y=!l||l&&l.schema==i;if(l.schema!=p.schema)return h.call(w,i,l,m,g);var b,q=!0===i.$async,x=a({isTop:!0,schema:i,isRoot:y,baseId:g,root:l,schemaPath:"",errSchemaPath:"#",errorPath:'""',MissingRefError:t.MissingRef,RULES:C,validate:a,util:r,resolve:e,resolveRef:U,usePattern:Q,useDefault:T,useCustomRule:D,opts:R,formats:k,logger:w.logger,self:w});x=v(V,f)+v(_,c)+v(E,u)+v(j,d)+x,R.processCode&&(x=R.processCode(x));try{var $=new Function("self","RULES","formats","root","refVal","defaults","customRules","equal","ucs2length","ValidationError",x);b=$(w,C,k,p,V,E,j,n,o,s),V[0]=b}catch(e){throw w.logger.error("Error compiling schema, function code:",x),e}return b.schema=i,b.errors=null,b.refs=S,b.refVal=V,b.root=y?b:l,q&&(b.$async=!0),!0===R.sourceCode&&(b.source={code:x,patterns:_,defaults:E}),b}function U(r,t,i){t=e.url(r,t);var a,o,n=S[t];if(void 0!==n)return O(a=V[n],o="refVal["+n+"]");if(!i&&p.refs){var s=p.refs[t];if(void 0!==s)return a=p.refVal[s],o=M(t,a),O(a,o)}o=M(t);var l=e.call(w,L,p,t);if(void 0===l){var c=g&&g[t];c&&(l=e.inlineRef(c,R.inlineRefs)?c:h.call(w,c,p,g,r))}if(void 0!==l)return function(e,r){var t=S[e];V[t]=r}(t,l),O(l,o);(function(e){delete S[e]})(t)}function M(e,r){var t=V.length;return V[t]=r,S[e]=t,"refVal"+t}function O(e,r){return"object"==typeof e||"boolean"==typeof e?{code:r,schema:e,inline:!0}:{code:r,$async:e&&!!e.$async}}function Q(e){var r=b[e];return void 0===r&&(r=b[e]=_.length,_[r]=e),"pattern"+r}function T(e){switch(typeof e){case"boolean":case"number":return""+e;case"string":return r.toQuotedString(e);case"object":if(null===e)return"null";var t=i(e),a=q[t];return void 0===a&&(a=q[t]=E.length,E[a]=e),"default"+a}}function D(e,r,t,i){if(!1!==w._opts.validateSchema){var a=e.definition.dependencies;if(a&&!a.every(function(e){return Object.prototype.hasOwnProperty.call(t,e)}))throw new Error("parent schema must have all required keywords: "+a.join(","));var o=e.definition.validateSchema;if(o){var n=o(r);if(!n){var s="keyword schema is invalid: "+w.errorsText(o.errors);if("log"!=w._opts.validateSchema)throw new Error(s);w.logger.error(s)}}}var l,c=e.definition.compile,u=e.definition.inline,f=e.definition.macro;if(c)l=c.call(w,r,t,i);else if(f)l=f.call(w,r,t,i),!1!==R.validateSchema&&w.validateSchema(l,!0);else if(u)l=u.call(w,i,e.keyword,r,t);else if(!(l=e.definition.validate))return;if(void 0===l)throw new Error('custom keyword "'+e.keyword+'"failed to compile');var d=j.length;return j[d]=l,{code:"customRule"+d,validate:l}}};