"use strict";const e=require("./utils"),{CHAR_ASTERISK:s,CHAR_AT:i,CHAR_BACKWARD_SLASH:t,CHAR_COMMA:l,CHAR_DOT:a,CHAR_EXCLAMATION_MARK:o,CHAR_FORWARD_SLASH:n,CHAR_LEFT_CURLY_BRACE:r,CHAR_LEFT_PARENTHESES:c,CHAR_LEFT_SQUARE_BRACKET:f,CHAR_PLUS:A,CHAR_QUESTION_MARK:b,CHAR_RIGHT_CURLY_BRACE:R,CHAR_RIGHT_PARENTHESES:h,CHAR_RIGHT_SQUARE_BRACKET:u}=require("./constants"),_=e=>e===n||e===t,C=e=>{!0!==e.isPrefix&&(e.depth=e.isGlobstar?1/0:1)};module.exports=((k,H)=>{const p=H||{},E=k.length-1,G=!0===p.parts||!0===p.scanToEnd,T=[],S=[],g=[];let B,d,x=k,L=-1,v=0,m=0,D=!1,I=!1,K=!1,U=!1,M=!1,O=!1,P=!1,F=!1,N=!1,Q=0,q={value:"",depth:0,isGlob:!1};const W=()=>L>=E,Y=()=>(B=d,x.charCodeAt(++L));for(;L<E;){let e;if((d=Y())!==t){if(!0===O||d===r){for(Q++;!0!==W()&&(d=Y());)if(d!==t)if(d!==r){if(!0!==O&&d===a&&(d=Y())===a){if(D=q.isBrace=!0,K=q.isGlob=!0,N=!0,!0===G)continue;break}if(!0!==O&&d===l){if(D=q.isBrace=!0,K=q.isGlob=!0,N=!0,!0===G)continue;break}if(d===R&&0==--Q){O=!1,D=q.isBrace=!0,N=!0;break}}else Q++;else P=q.backslashes=!0,Y();if(!0===G)continue;break}if(d!==n){if(!0!==p.noext&&!0==(d===A||d===i||d===s||d===b||d===o)&&x.charCodeAt(L+1)===c){if(K=q.isGlob=!0,U=q.isExtglob=!0,N=!0,!0===G){for(;!0!==W()&&(d=Y());)if(d!==t){if(d===h){K=q.isGlob=!0,N=!0;break}}else P=q.backslashes=!0,d=Y();continue}break}if(d===s){if(B===s&&(M=q.isGlobstar=!0),K=q.isGlob=!0,N=!0,!0===G)continue;break}if(d===b){if(K=q.isGlob=!0,N=!0,!0===G)continue;break}if(d===f)for(;!0!==W()&&(e=Y());)if(e!==t){if(e===u){if(I=q.isBracket=!0,K=q.isGlob=!0,N=!0,!0===G)continue;break}}else P=q.backslashes=!0,Y();if(!0===p.nonegate||d!==o||L!==v){if(!0!==p.noparen&&d===c)for(;!0!==W()&&(d=Y());)if(d!==t){if(d===h){if(K=q.isGlob=!0,N=!0,!0===G)continue;break}}else P=q.backslashes=!0,d=Y();if(!0===K){if(N=!0,!0===G)continue;break}}else F=q.negated=!0,v++}else{if(T.push(L),S.push(q),q={value:"",depth:0,isGlob:!1},!0===N)continue;if(B===a&&L===v+1){v+=2;continue}m=L+1}}else P=q.backslashes=!0,(d=Y())===r&&(O=!0)}!0===p.noext&&(U=!1,K=!1);let X=x,j="",w="";v>0&&(j=x.slice(0,v),x=x.slice(v),m-=v),X&&!0===K&&m>0?(X=x.slice(0,m),w=x.slice(m)):!0===K?(X="",w=x):X=x,X&&""!==X&&"/"!==X&&X!==x&&_(X.charCodeAt(X.length-1))&&(X=X.slice(0,-1)),!0===p.unescape&&(w&&(w=e.removeBackslashes(w)),X&&!0===P&&(X=e.removeBackslashes(X)));const y={prefix:j,input:k,start:v,base:X,glob:w,isBrace:D,isBracket:I,isGlob:K,isExtglob:U,isGlobstar:M,negated:F};if(!0===p.tokens&&(y.maxDepth=0,_(d)||S.push(q),y.tokens=S),!0===p.parts||!0===p.tokens){let e;for(let s=0;s<T.length;s++){const i=e?e+1:v,t=T[s],l=k.slice(i,t);p.tokens&&(0===s&&0!==v?(S[s].isPrefix=!0,S[s].value=j):S[s].value=l,C(S[s]),y.maxDepth+=S[s].depth),0===s&&""===l||g.push(l),e=t}if(e&&e+1<k.length){const s=k.slice(e+1);g.push(s),p.tokens&&(S[S.length-1].value=s,C(S[S.length-1]),y.maxDepth+=S[S.length-1].depth)}y.slashes=T,y.parts=g}return y});