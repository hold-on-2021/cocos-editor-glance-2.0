var e=require("fs-constants"),t=require("end-of-stream"),i=require("inherits"),r=Buffer.alloc,n=require("readable-stream").Readable,s=require("readable-stream").Writable,o=require("string_decoder").StringDecoder,a=require("./headers"),d=parseInt("755",8),h=parseInt("644",8),u=r(1024),c=function(){},f=function(e,t){(t&=511)&&e.push(u.slice(0,512-t))};var l=function(e){s.call(this),this.written=0,this._to=e,this._destroyed=!1};i(l,s),l.prototype._write=function(e,t,i){if(this.written+=e.length,this._to.push(e))return i();this._to._drain=i},l.prototype.destroy=function(){this._destroyed||(this._destroyed=!0,this.emit("close"))};var m=function(){s.call(this),this.linkname="",this._decoder=new o("utf-8"),this._destroyed=!1};i(m,s),m.prototype._write=function(e,t,i){this.linkname+=this._decoder.write(e),i()},m.prototype.destroy=function(){this._destroyed||(this._destroyed=!0,this.emit("close"))};var p=function(){s.call(this),this._destroyed=!1};i(p,s),p.prototype._write=function(e,t,i){i(new Error("No body allowed for this entry"))},p.prototype.destroy=function(){this._destroyed||(this._destroyed=!0,this.emit("close"))};var y=function(e){if(!(this instanceof y))return new y(e);n.call(this,e),this._drain=c,this._finalized=!1,this._finalizing=!1,this._destroyed=!1,this._stream=null};i(y,n),y.prototype.entry=function(i,r,n){if(this._stream)throw new Error("already piping an entry");if(!this._finalized&&!this._destroyed){"function"==typeof r&&(n=r,r=null),n||(n=c);var s=this;if(i.size&&"symlink"!==i.type||(i.size=0),i.type||(i.type=function(t){switch(t&e.S_IFMT){case e.S_IFBLK:return"block-device";case e.S_IFCHR:return"character-device";case e.S_IFDIR:return"directory";case e.S_IFIFO:return"fifo";case e.S_IFLNK:return"symlink"}return"file"}(i.mode)),i.mode||(i.mode="directory"===i.type?d:h),i.uid||(i.uid=0),i.gid||(i.gid=0),i.mtime||(i.mtime=new Date),"string"==typeof r&&(r=Buffer.from(r)),Buffer.isBuffer(r)){i.size=r.length,this._encode(i);var o=this.push(r);return f(s,i.size),o?process.nextTick(n):this._drain=n,new p}if("symlink"===i.type&&!i.linkname){var a=new m;return t(a,function(e){if(e)return s.destroy(),n(e);i.linkname=a.linkname,s._encode(i),n()}),a}if(this._encode(i),"file"!==i.type&&"contiguous-file"!==i.type)return process.nextTick(n),new p;var u=new l(this);return this._stream=u,t(u,function(e){return s._stream=null,e?(s.destroy(),n(e)):u.written!==i.size?(s.destroy(),n(new Error("size mismatch"))):(f(s,i.size),s._finalizing&&s.finalize(),n(),void 0)}),u}},y.prototype.finalize=function(){if(this._stream)return this._finalizing=!0,void 0;this._finalized||(this._finalized=!0,this.push(u),this.push(null))},y.prototype.destroy=function(e){this._destroyed||(this._destroyed=!0,e&&this.emit("error",e),this.emit("close"),this._stream&&this._stream.destroy&&this._stream.destroy())},y.prototype._encode=function(e){if(!e.pax){var t=a.encode(e);if(t)return this.push(t),void 0}this._encodePax(e)},y.prototype._encodePax=function(e){var t=a.encodePax({name:e.name,linkname:e.linkname,pax:e.pax}),i={name:"PaxHeader",mode:e.mode,uid:e.uid,gid:e.gid,size:t.length,mtime:e.mtime,type:"pax-header",linkname:e.linkname&&"PaxHeader",uname:e.uname,gname:e.gname,devmajor:e.devmajor,devminor:e.devminor};this.push(a.encode(i)),this.push(t),f(this,t.length),i.size=e.size,i.type=e.type,this.push(a.encode(i))},y.prototype._read=function(e){var t=this._drain;this._drain=c,t()},module.exports=y;