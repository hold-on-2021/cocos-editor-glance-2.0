var e=require("util"),t=require("bl"),i=require("./headers"),n=require("readable-stream").Writable,s=require("readable-stream").PassThrough,r=function(){},a=function(e){return(e&=511)&&512-e},o=function(e,t){this._parent=e,this.offset=t,s.call(this)};e.inherits(o,s),o.prototype.destroy=function(e){this._parent.destroy(e)};var h=function(e){if(!(this instanceof h))return new h(e);n.call(this,e),e=e||{},this._offset=0,this._buffer=t(),this._missing=0,this._partial=!1,this._onparse=r,this._header=null,this._stream=null,this._overflow=null,this._cb=null,this._locked=!1,this._destroyed=!1,this._pax=null,this._paxGlobal=null,this._gnuLongPath=null,this._gnuLongLinkPath=null;var s=this,_=s._buffer,l=function(){s._continue()},u=function(e){if(s._locked=!1,e)return s.destroy(e);s._stream||l()},d=function(){s._stream=null;var e=a(s._header.size);e?s._parse(e,p):s._parse(512,v),s._locked||l()},p=function(){s._buffer.consume(a(s._header.size)),s._parse(512,v),l()},c=function(){var e=s._header.size;s._paxGlobal=i.decodePax(_.slice(0,e)),_.consume(e),d()},f=function(){var e=s._header.size;s._pax=i.decodePax(_.slice(0,e)),s._paxGlobal&&(s._pax=Object.assign({},s._paxGlobal,s._pax)),_.consume(e),d()},g=function(){var t=s._header.size;this._gnuLongPath=i.decodeLongPath(_.slice(0,t),e.filenameEncoding),_.consume(t),d()},m=function(){var t=s._header.size;this._gnuLongLinkPath=i.decodeLongPath(_.slice(0,t),e.filenameEncoding),_.consume(t),d()},v=function(){var t,n=s._offset;try{t=s._header=i.decode(_.slice(0,512),e.filenameEncoding)}catch(e){s.emit("error",e)}return _.consume(512),t?"gnu-long-path"===t.type?(s._parse(t.size,g),l(),void 0):"gnu-long-link-path"===t.type?(s._parse(t.size,m),l(),void 0):"pax-global-header"===t.type?(s._parse(t.size,c),l(),void 0):"pax-header"===t.type?(s._parse(t.size,f),l(),void 0):(s._gnuLongPath&&(t.name=s._gnuLongPath,s._gnuLongPath=null),s._gnuLongLinkPath&&(t.linkname=s._gnuLongLinkPath,s._gnuLongLinkPath=null),s._pax&&(s._header=t=function(e,t){return t.path&&(e.name=t.path),t.linkpath&&(e.linkname=t.linkpath),t.size&&(e.size=parseInt(t.size,10)),e.pax=t,e}(t,s._pax),s._pax=null),s._locked=!0,t.size&&"directory"!==t.type?(s._stream=new o(s,n),s.emit("entry",t,s._stream,u),s._parse(t.size,d),l(),void 0):(s._parse(512,v),s.emit("entry",t,function(e,t){var i=new o(e,t);return i.end(),i}(s,n),u),void 0)):(s._parse(512,v),l(),void 0)};this._onheader=v,this._parse(512,v)};e.inherits(h,n),h.prototype.destroy=function(e){this._destroyed||(this._destroyed=!0,e&&this.emit("error",e),this.emit("close"),this._stream&&this._stream.emit("close"))},h.prototype._parse=function(e,t){this._destroyed||(this._offset+=e,this._missing=e,t===this._onheader&&(this._partial=!1),this._onparse=t)},h.prototype._continue=function(){if(!this._destroyed){var e=this._cb;this._cb=r,this._overflow?this._write(this._overflow,void 0,e):e()}},h.prototype._write=function(e,t,i){if(!this._destroyed){var n=this._stream,s=this._buffer,r=this._missing;if(e.length&&(this._partial=!0),e.length<r)return this._missing-=e.length,this._overflow=null,n?n.write(e,i):(s.append(e),i());this._cb=i,this._missing=0;var a=null;e.length>r&&(a=e.slice(r),e=e.slice(0,r)),n?n.end(e):s.append(e),this._overflow=a,this._onparse()}},h.prototype._final=function(e){if(this._partial)return this.destroy(new Error("Unexpected end of data"));e()},module.exports=h;