var e=Buffer.alloc,r="0".charCodeAt(0),n=Buffer.from("ustar\0","binary"),t=Buffer.from("00","binary"),i=Buffer.from("ustar ","binary"),a=Buffer.from(" \0","binary"),u=parseInt("7777",8),o=function(e,r,n,t){for(;n<t;n++)if(e[n]===r)return n;return t},f=function(e){for(var r=256,n=0;n<148;n++)r+=e[n];for(var t=156;t<512;t++)r+=e[t];return r},c=function(e,r){return(e=e.toString(8)).length>r?"7777777777777777777".slice(0,r)+" ":"0000000000000000000".slice(0,r-e.length)+e+" "};var l=function(e,r,n){if(128&(e=e.slice(r,r+n))[r=0])return function(e){var r;if(128===e[0])r=!0;else{if(255!==e[0])return null;r=!1}for(var n=[],t=e.length-1;t>0;t--){var i=e[t];r?n.push(i):n.push(255-i)}var a=0,u=n.length;for(t=0;t<u;t++)a+=n[t]*Math.pow(256,t);return r?a:-1*a}(e);for(;r<e.length&&32===e[r];)r++;for(var t=function(e,r,n){return"number"!=typeof e?n:(e=~~e)>=r?r:e>=0?e:(e+=r)>=0?e:0}(o(e,32,r,e.length),e.length,e.length);r<t&&0===e[r];)r++;return t===r?0:parseInt(e.slice(r,t).toString(),8)},s=function(e,r,n,t){return e.slice(r,o(e,0,r,r+n)).toString(t)},h=function(e){var r=Buffer.byteLength(e),n=Math.floor(Math.log(r)/Math.log(10))+1;return r+n>=Math.pow(10,n)&&n++,r+n+e};exports.decodeLongPath=function(e,r){return s(e,0,e.length,r)},exports.encodePax=function(e){var r="";e.name&&(r+=h(" path="+e.name+"\n")),e.linkname&&(r+=h(" linkpath="+e.linkname+"\n"));var n=e.pax;if(n)for(var t in n)r+=h(" "+t+"="+n[t]+"\n");return Buffer.from(r)},exports.decodePax=function(e){for(var r={};e.length;){for(var n=0;n<e.length&&32!==e[n];)n++;var t=parseInt(e.slice(0,n).toString(),10);if(!t)return r;var i=e.slice(n+1,t-1).toString(),a=i.indexOf("=");if(-1===a)return r;r[i.slice(0,a)]=i.slice(a+1),e=e.slice(t)}return r},exports.encode=function(i){var a=e(512),o=i.name,l="";if(5===i.typeflag&&"/"!==o[o.length-1]&&(o+="/"),Buffer.byteLength(o)!==o.length)return null;for(;Buffer.byteLength(o)>100;){var s=o.indexOf("/");if(-1===s)return null;l+=l?"/"+o.slice(0,s):o.slice(0,s),o=o.slice(s+1)}return Buffer.byteLength(o)>100||Buffer.byteLength(l)>155?null:i.linkname&&Buffer.byteLength(i.linkname)>100?null:(a.write(o),a.write(c(i.mode&u,6),100),a.write(c(i.uid,6),108),a.write(c(i.gid,6),116),a.write(c(i.size,11),124),a.write(c(i.mtime.getTime()/1e3|0,11),136),a[156]=r+function(e){switch(e){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72}return 0}(i.type),i.linkname&&a.write(i.linkname,157),n.copy(a,257),t.copy(a,263),i.uname&&a.write(i.uname,265),i.gname&&a.write(i.gname,297),a.write(c(i.devmajor||0,6),329),a.write(c(i.devminor||0,6),337),l&&a.write(l,345),a.write(c(f(a),6),148),a)},exports.decode=function(e,t){var u=0===e[156]?0:e[156]-r,o=s(e,0,100,t),c=l(e,100,8),h=l(e,108,8),g=l(e,116,8),m=l(e,124,12),d=l(e,136,12),p=function(e){switch(e){case 0:return"file";case 1:return"link";case 2:return"symlink";case 3:return"character-device";case 4:return"block-device";case 5:return"directory";case 6:return"fifo";case 7:return"contiguous-file";case 72:return"pax-header";case 55:return"pax-global-header";case 27:return"gnu-long-link-path";case 28:case 30:return"gnu-long-path"}return null}(u),v=0===e[157]?null:s(e,157,100,t),w=s(e,265,32),y=s(e,297,32),b=l(e,329,8),k=l(e,337,8),x=f(e);if(256===x)return null;if(x!==l(e,148,8))throw new Error("Invalid tar header. Maybe the tar is corrupted or it needs to be gunzipped?");if(0===n.compare(e,257,263))e[345]&&(o=s(e,345,155,t)+"/"+o);else if(0!==i.compare(e,257,263)||0!==a.compare(e,263,265))throw new Error("Invalid tar header: unknown format.");return 0===u&&o&&"/"===o[o.length-1]&&(u=5),{name:o,mode:c,uid:h,gid:g,size:m,mtime:new Date(1e3*d),type:p,linkname:v,uname:w,gname:y,devmajor:b,devminor:k}};