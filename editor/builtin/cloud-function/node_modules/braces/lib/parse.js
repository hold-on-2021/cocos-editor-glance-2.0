"use strict";const e=require("./stringify"),{MAX_LENGTH:t,CHAR_BACKSLASH:n,CHAR_BACKTICK:l,CHAR_COMMA:s,CHAR_DOT:o,CHAR_LEFT_PARENTHESES:p,CHAR_RIGHT_PARENTHESES:a,CHAR_LEFT_CURLY_BRACE:i,CHAR_RIGHT_CURLY_BRACE:r,CHAR_LEFT_SQUARE_BRACKET:u,CHAR_RIGHT_SQUARE_BRACKET:y,CHAR_DOUBLE_QUOTE:f,CHAR_SINGLE_QUOTE:_,CHAR_NO_BREAK_SPACE:A,CHAR_ZERO_WIDTH_NOBREAK_SPACE:E}=require("./constants");module.exports=((R,d={})=>{if("string"!=typeof R)throw new TypeError("Expected a string");let g=d||{},c="number"==typeof g.maxLength?Math.min(t,g.maxLength):t;if(R.length>c)throw new SyntaxError(`Input length (${R.length}), exceeds max characters (${c})`);let C,h={type:"root",input:R,nodes:[]},v=[h],x=h,H=h,T=0,m=R.length,S=0,L=0;const O=()=>R[S++],B=e=>("text"===e.type&&"dot"===H.type&&(H.type="text"),H&&"text"===H.type&&"text"===e.type?(H.value+=e.value,void 0):(x.nodes.push(e),e.parent=x,e.prev=H,H=e,e));for(B({type:"bos"});S<m;)if(x=v[v.length-1],(C=O())!==E&&C!==A)if(C!==n)if(C!==y)if(C!==u)if(C!==p)if(C!==a)if(C!==f&&C!==_&&C!==l)if(C!==i)if(C!==r)if(C===s&&L>0){if(x.ranges>0){x.ranges=0;let t=x.nodes.shift();x.nodes=[t,{type:"text",value:e(x)}]}B({type:"comma",value:C}),x.commas++}else if(C===o&&L>0&&0===x.commas){let e=x.nodes;if(0===L||0===e.length){B({type:"text",value:C});continue}if("dot"===H.type){if(x.range=[],H.value+=C,H.type="range",3!==x.nodes.length&&5!==x.nodes.length){x.invalid=!0,x.ranges=0,H.type="text";continue}x.ranges++,x.args=[];continue}if("range"===H.type){e.pop();let t=e[e.length-1];t.value+=H.value+C,H=t,x.ranges--;continue}B({type:"dot",value:C})}else B({type:"text",value:C});else{if("brace"!==x.type){B({type:"text",value:C});continue}let e="close";(x=v.pop()).close=!0,B({type:e,value:C}),L--,x=v[v.length-1]}else{L++;let e=H.value&&"$"===H.value.slice(-1)||!0===x.dollar;x=B({type:"brace",open:!0,close:!1,dollar:e,depth:L,commas:0,ranges:0,nodes:[]}),v.push(x),B({type:"open",value:C})}else{let e,t=C;for(!0!==d.keepQuotes&&(C="");S<m&&(e=O());)if(e!==n){if(e===t){!0===d.keepQuotes&&(C+=e);break}C+=e}else C+=e+O();B({type:"text",value:C})}else{if("paren"!==x.type){B({type:"text",value:C});continue}x=v.pop(),B({type:"text",value:C}),x=v[v.length-1]}else x=B({type:"paren",nodes:[]}),v.push(x),B({type:"text",value:C});else{let e;for(T++;S<m&&(e=O());)if(C+=e,e!==u)if(e!==n){if(e===y&&0==--T)break}else C+=O();else T++;B({type:"text",value:C})}else B({type:"text",value:"\\"+C});else B({type:"text",value:(d.keepEscaping?C:"")+O()});do{if("root"!==(x=v.pop()).type){x.nodes.forEach(e=>{e.nodes||("open"===e.type&&(e.isOpen=!0),"close"===e.type&&(e.isClose=!0),e.nodes||(e.type="text"),e.invalid=!0)});let e=v[v.length-1],t=e.nodes.indexOf(x);e.nodes.splice(t,1,...x.nodes)}}while(v.length>0);return B({type:"eos"}),h});