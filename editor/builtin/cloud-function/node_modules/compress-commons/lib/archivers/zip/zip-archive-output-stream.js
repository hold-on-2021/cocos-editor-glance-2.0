var t=require("util").inherits,e=require("buffer-crc32"),{CRC32Stream:i}=require("crc32-stream"),{DeflateCRC32Stream:r}=require("crc32-stream"),s=require("../archive-output-stream"),o=(require("./zip-archive-entry"),require("./general-purpose-bit"),require("./constants")),h=(require("../../util"),require("./util")),n=module.exports=function(t){if(!(this instanceof n))return new n(t);t=this.options=this._defaults(t),s.call(this,t),this._entry=null,this._entries=[],this._archive={centralLength:0,centralOffset:0,comment:"",finish:!1,finished:!1,processing:!1,forceZip64:t.forceZip64,forceLocalTime:t.forceLocalTime}};t(n,s),n.prototype._afterAppend=function(t){this._entries.push(t),t.getGeneralPurposeBit().usesDataDescriptor()&&this._writeDataDescriptor(t),this._archive.processing=!1,this._entry=null,this._archive.finish&&!this._archive.finished&&this._finish()},n.prototype._appendBuffer=function(t,i,r){0===i.length&&t.setMethod(o.METHOD_STORED);var s=t.getMethod();return s===o.METHOD_STORED&&(t.setSize(i.length),t.setCompressedSize(i.length),t.setCrc(e.unsigned(i))),this._writeLocalFileHeader(t),s===o.METHOD_STORED?(this.write(i),this._afterAppend(t),r(null,t),void 0):s===o.METHOD_DEFLATED?(this._smartStream(t,r).end(i),void 0):(r(new Error("compression method "+s+" not implemented")),void 0)},n.prototype._appendStream=function(t,e,i){t.getGeneralPurposeBit().useDataDescriptor(!0),t.setVersionNeededToExtract(o.MIN_VERSION_DATA_DESCRIPTOR),this._writeLocalFileHeader(t);var r=this._smartStream(t,i);e.once("error",function(t){r.emit("error",t),r.end()}),e.pipe(r)},n.prototype._defaults=function(t){return"object"!=typeof t&&(t={}),"object"!=typeof t.zlib&&(t.zlib={}),"number"!=typeof t.zlib.level&&(t.zlib.level=o.ZLIB_BEST_SPEED),t.forceZip64=!!t.forceZip64,t.forceLocalTime=!!t.forceLocalTime,t},n.prototype._finish=function(){this._archive.centralOffset=this.offset,this._entries.forEach(function(t){this._writeCentralFileHeader(t)}.bind(this)),this._archive.centralLength=this.offset-this._archive.centralOffset,this.isZip64()&&this._writeCentralDirectoryZip64(),this._writeCentralDirectoryEnd(),this._archive.processing=!1,this._archive.finish=!0,this._archive.finished=!0,this.end()},n.prototype._normalizeEntry=function(t){-1===t.getMethod()&&t.setMethod(o.METHOD_DEFLATED),t.getMethod()===o.METHOD_DEFLATED&&(t.getGeneralPurposeBit().useDataDescriptor(!0),t.setVersionNeededToExtract(o.MIN_VERSION_DATA_DESCRIPTOR)),-1===t.getTime()&&t.setTime(new Date,this._archive.forceLocalTime),t._offsets={file:0,data:0,contents:0}},n.prototype._smartStream=function(t,e){var s=t.getMethod()===o.METHOD_DEFLATED?new r(this.options.zlib):new i,h=null;return s.once("end",function(){var i=s.digest().readUInt32BE(0);t.setCrc(i),t.setSize(s.size()),t.setCompressedSize(s.size(!0)),this._afterAppend(t),e(h,t)}.bind(this)),s.once("error",function(t){h=t}),s.pipe(this,{end:!1}),s},n.prototype._writeCentralDirectoryEnd=function(){var t=this._entries.length,e=this._archive.centralLength,i=this._archive.centralOffset;this.isZip64()&&(t=o.ZIP64_MAGIC_SHORT,e=o.ZIP64_MAGIC,i=o.ZIP64_MAGIC),this.write(h.getLongBytes(o.SIG_EOCD)),this.write(o.SHORT_ZERO),this.write(o.SHORT_ZERO),this.write(h.getShortBytes(t)),this.write(h.getShortBytes(t)),this.write(h.getLongBytes(e)),this.write(h.getLongBytes(i));var r=this.getComment(),s=Buffer.byteLength(r);this.write(h.getShortBytes(s)),this.write(r)},n.prototype._writeCentralDirectoryZip64=function(){this.write(h.getLongBytes(o.SIG_ZIP64_EOCD)),this.write(h.getEightBytes(44)),this.write(h.getShortBytes(o.MIN_VERSION_ZIP64)),this.write(h.getShortBytes(o.MIN_VERSION_ZIP64)),this.write(o.LONG_ZERO),this.write(o.LONG_ZERO),this.write(h.getEightBytes(this._entries.length)),this.write(h.getEightBytes(this._entries.length)),this.write(h.getEightBytes(this._archive.centralLength)),this.write(h.getEightBytes(this._archive.centralOffset)),this.write(h.getLongBytes(o.SIG_ZIP64_EOCD_LOC)),this.write(o.LONG_ZERO),this.write(h.getEightBytes(this._archive.centralOffset+this._archive.centralLength)),this.write(h.getLongBytes(1))},n.prototype._writeCentralFileHeader=function(t){var e=t.getGeneralPurposeBit(),i=t.getMethod(),r=t._offsets,s=t.getSize(),n=t.getCompressedSize();if(t.isZip64()||r.file>o.ZIP64_MAGIC){s=o.ZIP64_MAGIC,n=o.ZIP64_MAGIC,t.setVersionNeededToExtract(o.MIN_VERSION_ZIP64);var g=Buffer.concat([h.getShortBytes(o.ZIP64_EXTRA_ID),h.getShortBytes(24),h.getEightBytes(t.getSize()),h.getEightBytes(t.getCompressedSize()),h.getEightBytes(r.file)],28);t.setExtra(g)}this.write(h.getLongBytes(o.SIG_CFH)),this.write(h.getShortBytes(t.getPlatform()<<8|o.VERSION_MADEBY)),this.write(h.getShortBytes(t.getVersionNeededToExtract())),this.write(e.encode()),this.write(h.getShortBytes(i)),this.write(h.getLongBytes(t.getTimeDos())),this.write(h.getLongBytes(t.getCrc())),this.write(h.getLongBytes(n)),this.write(h.getLongBytes(s));var a=t.getName(),c=t.getComment(),_=t.getCentralDirectoryExtra();e.usesUTF8ForNames()&&(a=Buffer.from(a),c=Buffer.from(c)),this.write(h.getShortBytes(a.length)),this.write(h.getShortBytes(_.length)),this.write(h.getShortBytes(c.length)),this.write(o.SHORT_ZERO),this.write(h.getShortBytes(t.getInternalAttributes())),this.write(h.getLongBytes(t.getExternalAttributes())),r.file>o.ZIP64_MAGIC?this.write(h.getLongBytes(o.ZIP64_MAGIC)):this.write(h.getLongBytes(r.file)),this.write(a),this.write(_),this.write(c)},n.prototype._writeDataDescriptor=function(t){this.write(h.getLongBytes(o.SIG_DD)),this.write(h.getLongBytes(t.getCrc())),t.isZip64()?(this.write(h.getEightBytes(t.getCompressedSize())),this.write(h.getEightBytes(t.getSize()))):(this.write(h.getLongBytes(t.getCompressedSize())),this.write(h.getLongBytes(t.getSize())))},n.prototype._writeLocalFileHeader=function(t){var e=t.getGeneralPurposeBit(),i=t.getMethod(),r=t.getName(),s=t.getLocalFileDataExtra();t.isZip64()&&(e.useDataDescriptor(!0),t.setVersionNeededToExtract(o.MIN_VERSION_ZIP64)),e.usesUTF8ForNames()&&(r=Buffer.from(r)),t._offsets.file=this.offset,this.write(h.getLongBytes(o.SIG_LFH)),this.write(h.getShortBytes(t.getVersionNeededToExtract())),this.write(e.encode()),this.write(h.getShortBytes(i)),this.write(h.getLongBytes(t.getTimeDos())),t._offsets.data=this.offset,e.usesDataDescriptor()?(this.write(o.LONG_ZERO),this.write(o.LONG_ZERO),this.write(o.LONG_ZERO)):(this.write(h.getLongBytes(t.getCrc())),this.write(h.getLongBytes(t.getCompressedSize())),this.write(h.getLongBytes(t.getSize()))),this.write(h.getShortBytes(r.length)),this.write(h.getShortBytes(s.length)),this.write(r),this.write(s),t._offsets.contents=this.offset},n.prototype.getComment=function(t){return null!==this._archive.comment?this._archive.comment:""},n.prototype.isZip64=function(){return this._archive.forceZip64||this._entries.length>o.ZIP64_MAGIC_SHORT||this._archive.centralLength>o.ZIP64_MAGIC||this._archive.centralOffset>o.ZIP64_MAGIC},n.prototype.setComment=function(t){this._archive.comment=t};