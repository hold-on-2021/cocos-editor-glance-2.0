"use strict";var f=require("tape"),e=require("buffer"),r=require("./"),o=require("./safer"),u=require("./dangerous");f("Default is Safer",function(f){f.equal(r,o),f.notEqual(o,u),f.notEqual(r,u),f.end()}),f("Is not a function",function(f){[r,o,u].forEach(function(e){f.equal(typeof e,"object"),f.equal(typeof e.Buffer,"object")}),[e].forEach(function(e){f.equal(typeof e,"object"),f.equal(typeof e.Buffer,"function")}),f.end()}),f("Constructor throws",function(f){[r,o,u].forEach(function(e){f.throws(function(){e.Buffer()}),f.throws(function(){e.Buffer(0)}),f.throws(function(){e.Buffer("a")}),f.throws(function(){e.Buffer("a","utf-8")}),f.throws(function(){return new e.Buffer}),f.throws(function(){return new e.Buffer(0)}),f.throws(function(){return new e.Buffer("a")}),f.throws(function(){return new e.Buffer("a","utf-8")})}),f.end()}),f("Safe methods exist",function(f){[r,o,u].forEach(function(e){f.equal(typeof e.Buffer.alloc,"function","alloc"),f.equal(typeof e.Buffer.from,"function","from")}),f.end()}),f("Unsafe methods exist only in Dangerous",function(f){[r,o].forEach(function(e){f.equal(typeof e.Buffer.allocUnsafe,"undefined"),f.equal(typeof e.Buffer.allocUnsafeSlow,"undefined")}),[u].forEach(function(e){f.equal(typeof e.Buffer.allocUnsafe,"function"),f.equal(typeof e.Buffer.allocUnsafeSlow,"function")}),f.end()}),f("Generic methods/properties are defined and equal",function(f){["poolSize","isBuffer","concat","byteLength"].forEach(function(n){[r,o,u].forEach(function(r){f.equal(r.Buffer[n],e.Buffer[n],n),f.notEqual(typeof r.Buffer[n],"undefined",n)})}),f.end()}),f("Built-in buffer static methods/properties are inherited",function(f){Object.keys(e).forEach(function(n){"SlowBuffer"!==n&&"Buffer"!==n&&[r,o,u].forEach(function(r){f.equal(r[n],e[n],n),f.notEqual(typeof r[n],"undefined",n)})}),f.end()}),f("Built-in Buffer static methods/properties are inherited",function(f){Object.keys(e.Buffer).forEach(function(n){"allocUnsafe"!==n&&"allocUnsafeSlow"!==n&&[r,o,u].forEach(function(r){f.equal(r.Buffer[n],e.Buffer[n],n),f.notEqual(typeof r.Buffer[n],"undefined",n)})}),f.end()}),f(".prototype property of Buffer is inherited",function(f){[r,o,u].forEach(function(r){f.equal(r.Buffer.prototype,e.Buffer.prototype,"prototype"),f.notEqual(typeof r.Buffer.prototype,"undefined","prototype")}),f.end()}),f("All Safer methods are present in Dangerous",function(f){Object.keys(o).forEach(function(e){"Buffer"!==e&&[r,o,u].forEach(function(r){f.equal(r[e],o[e],e),"kStringMaxLength"!==e&&f.notEqual(typeof r[e],"undefined",e)})}),Object.keys(o.Buffer).forEach(function(e){[r,o,u].forEach(function(r){f.equal(r.Buffer[e],o.Buffer[e],e),f.notEqual(typeof r.Buffer[e],"undefined",e)})}),f.end()}),f("Safe methods from Dangerous methods are present in Safer",function(f){Object.keys(u).forEach(function(e){"Buffer"!==e&&[r,o,u].forEach(function(r){f.equal(r[e],u[e],e),"kStringMaxLength"!==e&&f.notEqual(typeof r[e],"undefined",e)})}),Object.keys(u.Buffer).forEach(function(e){"allocUnsafe"!==e&&"allocUnsafeSlow"!==e&&[r,o,u].forEach(function(r){f.equal(r.Buffer[e],u.Buffer[e],e),f.notEqual(typeof r.Buffer[e],"undefined",e)})}),f.end()}),f("Methods return Buffers",function(f){[r,o,u].forEach(function(r){f.ok(e.Buffer.isBuffer(r.Buffer.alloc(0))),f.ok(e.Buffer.isBuffer(r.Buffer.alloc(0,10))),f.ok(e.Buffer.isBuffer(r.Buffer.alloc(0,"a"))),f.ok(e.Buffer.isBuffer(r.Buffer.alloc(10))),f.ok(e.Buffer.isBuffer(r.Buffer.alloc(10,"x"))),f.ok(e.Buffer.isBuffer(r.Buffer.alloc(9,"ab"))),f.ok(e.Buffer.isBuffer(r.Buffer.from(""))),f.ok(e.Buffer.isBuffer(r.Buffer.from("string"))),f.ok(e.Buffer.isBuffer(r.Buffer.from("string","utf-8"))),f.ok(e.Buffer.isBuffer(r.Buffer.from("b25ldHdvdGhyZWU=","base64"))),f.ok(e.Buffer.isBuffer(r.Buffer.from([0,42,3]))),f.ok(e.Buffer.isBuffer(r.Buffer.from(new Uint8Array([0,42,3])))),f.ok(e.Buffer.isBuffer(r.Buffer.from([])))}),["allocUnsafe","allocUnsafeSlow"].forEach(function(r){f.ok(e.Buffer.isBuffer(u.Buffer[r](0))),f.ok(e.Buffer.isBuffer(u.Buffer[r](10)))}),f.end()}),f("Constructor is buffer.Buffer",function(f){[r,o,u].forEach(function(r){f.equal(r.Buffer.alloc(0).constructor,e.Buffer),f.equal(r.Buffer.alloc(0,10).constructor,e.Buffer),f.equal(r.Buffer.alloc(0,"a").constructor,e.Buffer),f.equal(r.Buffer.alloc(10).constructor,e.Buffer),f.equal(r.Buffer.alloc(10,"x").constructor,e.Buffer),f.equal(r.Buffer.alloc(9,"ab").constructor,e.Buffer),f.equal(r.Buffer.from("").constructor,e.Buffer),f.equal(r.Buffer.from("string").constructor,e.Buffer),f.equal(r.Buffer.from("string","utf-8").constructor,e.Buffer),f.equal(r.Buffer.from("b25ldHdvdGhyZWU=","base64").constructor,e.Buffer),f.equal(r.Buffer.from([0,42,3]).constructor,e.Buffer),f.equal(r.Buffer.from(new Uint8Array([0,42,3])).constructor,e.Buffer),f.equal(r.Buffer.from([]).constructor,e.Buffer)}),[0,10,100].forEach(function(r){f.equal(u.Buffer.allocUnsafe(r).constructor,e.Buffer),f.equal(u.Buffer.allocUnsafeSlow(r).constructor,e.SlowBuffer(0).constructor)}),f.end()}),f("Invalid calls throw",function(f){[r,o,u].forEach(function(e){f.throws(function(){e.Buffer.from(0)}),f.throws(function(){e.Buffer.from(10)}),f.throws(function(){e.Buffer.from(10,"utf-8")}),f.throws(function(){e.Buffer.from("string","invalid encoding")}),f.throws(function(){e.Buffer.from(-10)}),f.throws(function(){e.Buffer.from(1e90)}),f.throws(function(){e.Buffer.from(1/0)}),f.throws(function(){e.Buffer.from(-1/0)}),f.throws(function(){e.Buffer.from(NaN)}),f.throws(function(){e.Buffer.from(null)}),f.throws(function(){e.Buffer.from(void 0)}),f.throws(function(){e.Buffer.from()}),f.throws(function(){e.Buffer.from({})}),f.throws(function(){e.Buffer.alloc("")}),f.throws(function(){e.Buffer.alloc("string")}),f.throws(function(){e.Buffer.alloc("string","utf-8")}),f.throws(function(){e.Buffer.alloc("b25ldHdvdGhyZWU=","base64")}),f.throws(function(){e.Buffer.alloc(-10)}),f.throws(function(){e.Buffer.alloc(1e90)}),f.throws(function(){e.Buffer.alloc(2*(1<<30))}),f.throws(function(){e.Buffer.alloc(1/0)}),f.throws(function(){e.Buffer.alloc(-1/0)}),f.throws(function(){e.Buffer.alloc(null)}),f.throws(function(){e.Buffer.alloc(void 0)}),f.throws(function(){e.Buffer.alloc()}),f.throws(function(){e.Buffer.alloc([])}),f.throws(function(){e.Buffer.alloc([0,42,3])}),f.throws(function(){e.Buffer.alloc({})})}),["allocUnsafe","allocUnsafeSlow"].forEach(function(r){f.throws(function(){u.Buffer[r]("")}),f.throws(function(){u.Buffer[r]("string")}),f.throws(function(){u.Buffer[r]("string","utf-8")}),f.throws(function(){u.Buffer[r](2*(1<<30))}),f.throws(function(){u.Buffer[r](1/0)}),u.Buffer[r]===e.Buffer.allocUnsafe?f.skip("Skipping, older impl of allocUnsafe coerced negative sizes to 0"):(f.throws(function(){u.Buffer[r](-10)}),f.throws(function(){u.Buffer[r](-1e90)}),f.throws(function(){u.Buffer[r](-1/0)})),f.throws(function(){u.Buffer[r](null)}),f.throws(function(){u.Buffer[r](void 0)}),f.throws(function(){u.Buffer[r]()}),f.throws(function(){u.Buffer[r]([])}),f.throws(function(){u.Buffer[r]([0,42,3])}),f.throws(function(){u.Buffer[r]({})})}),f.end()}),f("Buffers have appropriate lengths",function(f){[r,o,u].forEach(function(e){f.equal(e.Buffer.alloc(0).length,0),f.equal(e.Buffer.alloc(10).length,10),f.equal(e.Buffer.from("").length,0),f.equal(e.Buffer.from("string").length,6),f.equal(e.Buffer.from("string","utf-8").length,6),f.equal(e.Buffer.from("b25ldHdvdGhyZWU=","base64").length,11),f.equal(e.Buffer.from([0,42,3]).length,3),f.equal(e.Buffer.from(new Uint8Array([0,42,3])).length,3),f.equal(e.Buffer.from([]).length,0)}),["allocUnsafe","allocUnsafeSlow"].forEach(function(e){f.equal(u.Buffer[e](0).length,0),f.equal(u.Buffer[e](10).length,10)}),f.end()}),f("Buffers have appropriate lengths (2)",function(f){f.equal(r.Buffer.alloc,o.Buffer.alloc),f.equal(r.Buffer.alloc,u.Buffer.alloc);var n=!0;[o.Buffer.alloc,u.Buffer.allocUnsafe,u.Buffer.allocUnsafeSlow].forEach(function(f){for(var r=0;r<100;r++){var o=Math.round(1e5*Math.random()),u=f(o);e.Buffer.isBuffer(u)||(n=!1),u.length!==o&&(n=!1)}}),f.ok(n),f.end()}),f(".alloc(size) is zero-filled and has correct length",function(f){f.equal(r.Buffer.alloc,o.Buffer.alloc),f.equal(r.Buffer.alloc,u.Buffer.alloc);for(var n=!0,t=0;t<100;t++){var l,a=Math.round(2e6*Math.random()),c=r.Buffer.alloc(a);for(e.Buffer.isBuffer(c)||(n=!1),c.length!==a&&(n=!1),l=0;l<a;l++)0!==c[l]&&(n=!1);for(c.fill(1),l=0;l<a;l++)1!==c[l]&&(n=!1)}f.ok(n),f.end()}),f(".allocUnsafe / .allocUnsafeSlow are fillable and have correct lengths",function(f){["allocUnsafe","allocUnsafeSlow"].forEach(function(r){for(var o=!0,n=0;n<100;n++){var t,l=Math.round(2e6*Math.random()),a=u.Buffer[r](l);for(e.Buffer.isBuffer(a)||(o=!1),a.length!==l&&(o=!1),a.fill(0,0,l),t=0;t<l;t++)0!==a[t]&&(o=!1);for(a.fill(1,0,l),t=0;t<l;t++)1!==a[t]&&(o=!1)}f.ok(o,r)}),f.end()}),f(".alloc(size, fill) is `fill`-filled",function(f){f.equal(r.Buffer.alloc,o.Buffer.alloc),f.equal(r.Buffer.alloc,u.Buffer.alloc);for(var n=!0,t=0;t<100;t++){var l=Math.round(2e6*Math.random()),a=Math.round(255*Math.random()),c=r.Buffer.alloc(l,a);e.Buffer.isBuffer(c)||(n=!1),c.length!==l&&(n=!1);for(var B=0;B<l;B++)c[B]!==a&&(n=!1)}f.ok(n),f.end()}),f(".alloc(size, fill) is `fill`-filled",function(f){f.equal(r.Buffer.alloc,o.Buffer.alloc),f.equal(r.Buffer.alloc,u.Buffer.alloc);for(var n=!0,t=0;t<100;t++){var l=Math.round(2e6*Math.random()),a=Math.round(255*Math.random()),c=r.Buffer.alloc(l,a);e.Buffer.isBuffer(c)||(n=!1),c.length!==l&&(n=!1);for(var B=0;B<l;B++)c[B]!==a&&(n=!1)}f.ok(n),f.deepEqual(r.Buffer.alloc(9,"a"),r.Buffer.alloc(9,97)),f.notDeepEqual(r.Buffer.alloc(9,"a"),r.Buffer.alloc(9,98));var i=new e.Buffer(2);i.fill("ok"),i[1]===i[0]?f.deepEqual(r.Buffer.alloc(5,"ok"),r.Buffer.from("ooooo")):f.deepEqual(r.Buffer.alloc(5,"ok"),r.Buffer.from("okoko")),f.notDeepEqual(r.Buffer.alloc(5,"ok"),r.Buffer.from("kokok")),f.end()}),f("safer.Buffer.from returns results same as Buffer constructor",function(f){[r,o,u].forEach(function(r){f.deepEqual(r.Buffer.from(""),new e.Buffer("")),f.deepEqual(r.Buffer.from("string"),new e.Buffer("string")),f.deepEqual(r.Buffer.from("string","utf-8"),new e.Buffer("string","utf-8")),f.deepEqual(r.Buffer.from("b25ldHdvdGhyZWU=","base64"),new e.Buffer("b25ldHdvdGhyZWU=","base64")),f.deepEqual(r.Buffer.from([0,42,3]),new e.Buffer([0,42,3])),f.deepEqual(r.Buffer.from(new Uint8Array([0,42,3])),new e.Buffer(new Uint8Array([0,42,3]))),f.deepEqual(r.Buffer.from([]),new e.Buffer([]))}),f.end()}),f("safer.Buffer.from returns consistent results",function(f){[r,o,u].forEach(function(e){f.deepEqual(e.Buffer.from(""),e.Buffer.alloc(0)),f.deepEqual(e.Buffer.from([]),e.Buffer.alloc(0)),f.deepEqual(e.Buffer.from(new Uint8Array([])),e.Buffer.alloc(0)),f.deepEqual(e.Buffer.from("string","utf-8"),e.Buffer.from("string")),f.deepEqual(e.Buffer.from("string"),e.Buffer.from([115,116,114,105,110,103])),f.deepEqual(e.Buffer.from("string"),e.Buffer.from(e.Buffer.from("string"))),f.deepEqual(e.Buffer.from("b25ldHdvdGhyZWU=","base64"),e.Buffer.from("onetwothree")),f.notDeepEqual(e.Buffer.from("b25ldHdvdGhyZWU="),e.Buffer.from("onetwothree"))}),f.end()});