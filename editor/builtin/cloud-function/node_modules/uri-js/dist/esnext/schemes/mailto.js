import{pctEncChar as e,pctDecChars as t,unescapeComponent as o}from"../uri";import r from"punycode";import{merge as n,subexp as a,toUpperCase as c,toArray as s}from"../util";const i={},p="[A-Za-z0-9\\-\\.\\_\\~\\xA0-\\u200D\\u2010-\\u2029\\u202F-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]",l="[0-9A-Fa-f]",u=a(a("%[EFef][0-9A-Fa-f]%"+l+l+"%"+l+l)+"|"+a("%[89A-Fa-f][0-9A-Fa-f]%"+l+l)+"|"+a("%"+l+l)),d="[A-Za-z0-9\\!\\$\\%\\'\\*\\+\\-\\^\\_\\`\\{\\|\\}\\~]",f="[\\!\\$\\%\\'\\(\\)\\*\\+\\,\\-\\.0-9\\<\\>A-Z\\x5E-\\x7E]",x=n(f,'[\\"\\\\]'),g=a(d+"+"+a("\\."+d+"+")+"*"),h=a('\\"'+a(f+"|"+a("\\\\"+x))+'*\\"'),E=a(p+"|"+u+"|[\\!\\$\\'\\(\\)\\*\\+\\,\\;\\:\\@]"),m=a(g+"|\\[[\\x21-\\x5A\\x5E-\\x7E]*\\]"),F=a(a(g+"|"+h)+"\\@"+m),b=a(F+a("\\,"+F)+"*"),y=a(E+"*"),A=a(y+"\\="+y),w=a(A+a("\\&"+A)+"*"),I=a("\\?"+w),j=(new RegExp("^mailto\\:"+b+"?"+I+"?$"),new RegExp(p,"g")),C=new RegExp(u,"g"),R=new RegExp(n("[^]",d,"[\\.]",'[\\"]',x),"g"),$=(new RegExp(n("[^]",d,"[\\.]","[\\[]","[\\x21-\\x5A\\x5E-\\x7E]","[\\]]"),"g"),new RegExp(n("[^]",p,"[\\!\\$\\'\\(\\)\\*\\+\\,\\;\\:\\@]"),"g")),v=$;new RegExp("^"+b+"$"),new RegExp("^"+w+"$");function S(e){const o=t(e);return o.match(j)?o:e}export default{scheme:"mailto",parse:function(e,t){const n=e,a=n.to=n.path?n.path.split(","):[];if(n.path=void 0,n.query){let e=!1;const r={},c=n.query.split("&");for(let s=0,i=c.length;s<i;++s){const i=c[s].split("=");switch(i[0]){case"to":const c=i[1].split(",");for(let e=0,t=c.length;e<t;++e)a.push(c[e]);break;case"subject":n.subject=o(i[1],t);break;case"body":n.body=o(i[1],t);break;default:e=!0,r[o(i[0],t)]=o(i[1],t)}}e&&(n.headers=r)}n.query=void 0;for(let e=0,c=a.length;e<c;++e){const c=a[e].split("@");if(c[0]=o(c[0]),t.unicodeSupport)c[1]=o(c[1],t).toLowerCase();else try{c[1]=r.toASCII(o(c[1],t).toLowerCase())}catch(e){n.error=n.error||"Email address's domain name can not be converted to ASCII via punycode: "+e}a[e]=c.join("@")}return n},serialize:function(t,n){const a=t,p=s(t.to);if(p){for(let t=0,s=p.length;t<s;++t){const s=String(p[t]),i=s.lastIndexOf("@"),l=s.slice(0,i).replace(C,S).replace(C,c).replace(R,e);let u=s.slice(i+1);try{u=n.iri?r.toUnicode(u):r.toASCII(o(u,n).toLowerCase())}catch(e){a.error=a.error||"Email address's domain name can not be converted to "+(n.iri?"Unicode":"ASCII")+" via punycode: "+e}p[t]=l+"@"+u}a.path=p.join(",")}const l=t.headers=t.headers||{};t.subject&&(l.subject=t.subject),t.body&&(l.body=t.body);const u=[];for(const t in l)l[t]!==i[t]&&u.push(t.replace(C,S).replace(C,c).replace($,e)+"="+l[t].replace(C,S).replace(C,c).replace(v,e));return u.length&&(a.query=u.join("&")),a}};