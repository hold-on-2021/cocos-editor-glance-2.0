import e from"./regexps-uri";import t from"./regexps-iri";import r from"punycode";import{toUpperCase as o,typeOf as n,assign as s}from"./util";export const SCHEMES={};export function pctEncChar(e){const t=e.charCodeAt(0);let r;return r=t<16?"%0"+t.toString(16).toUpperCase():t<128?"%"+t.toString(16).toUpperCase():t<2048?"%"+(t>>6|192).toString(16).toUpperCase()+"%"+(63&t|128).toString(16).toUpperCase():"%"+(t>>12|224).toString(16).toUpperCase()+"%"+(t>>6&63|128).toString(16).toUpperCase()+"%"+(63&t|128).toString(16).toUpperCase()};export function pctDecChars(e){let t="",r=0;const o=e.length;for(;r<o;){const n=parseInt(e.substr(r+1,2),16);if(n<128)t+=String.fromCharCode(n),r+=3;else if(n>=194&&n<224){if(o-r>=6){const o=parseInt(e.substr(r+4,2),16);t+=String.fromCharCode((31&n)<<6|63&o)}else t+=e.substr(r,6);r+=6}else if(n>=224){if(o-r>=9){const o=parseInt(e.substr(r+4,2),16),s=parseInt(e.substr(r+7,2),16);t+=String.fromCharCode((15&n)<<12|(63&o)<<6|63&s)}else t+=e.substr(r,9);r+=9}else t+=e.substr(r,3),r+=3}return t};function i(e,t){function r(e){const r=pctDecChars(e);return r.match(t.UNRESERVED)?r:e}return e.scheme&&(e.scheme=String(e.scheme).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_SCHEME,"")),void 0!==e.userinfo&&(e.userinfo=String(e.userinfo).replace(t.PCT_ENCODED,r).replace(t.NOT_USERINFO,pctEncChar).replace(t.PCT_ENCODED,o)),void 0!==e.host&&(e.host=String(e.host).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_HOST,pctEncChar).replace(t.PCT_ENCODED,o)),void 0!==e.path&&(e.path=String(e.path).replace(t.PCT_ENCODED,r).replace(e.scheme?t.NOT_PATH:t.NOT_PATH_NOSCHEME,pctEncChar).replace(t.PCT_ENCODED,o)),void 0!==e.query&&(e.query=String(e.query).replace(t.PCT_ENCODED,r).replace(t.NOT_QUERY,pctEncChar).replace(t.PCT_ENCODED,o)),void 0!==e.fragment&&(e.fragment=String(e.fragment).replace(t.PCT_ENCODED,r).replace(t.NOT_FRAGMENT,pctEncChar).replace(t.PCT_ENCODED,o)),e}function p(e){return e.replace(/^0*(.*)/,"$1")||"0"}function a(e,t){const r=e.match(t.IPV4ADDRESS)||[],[,o]=r;return o?o.split(".").map(p).join("."):e}function c(e,t){const r=e.match(t.IPV6ADDRESS)||[],[,o,n]=r;if(o){const[e,r]=o.toLowerCase().split("::").reverse(),s=r?r.split(":").map(p):[],i=e.split(":").map(p),c=t.IPV4ADDRESS.test(i[i.length-1]),h=c?7:8,u=i.length-h,f=Array(h);for(let e=0;e<h;++e)f[e]=s[e]||i[u+e]||"";c&&(f[h-1]=a(f[h-1],t));const l=f.reduce((e,t,r)=>{if(!t||"0"===t){const t=e[e.length-1];t&&t.index+t.length===r?t.length++:e.push({index:r,length:1})}return e},[]).sort((e,t)=>t.length-e.length)[0];let m;if(l&&l.length>1){const e=f.slice(0,l.index),t=f.slice(l.index+l.length);m=e.join(":")+"::"+t.join(":")}else m=f.join(":");return n&&(m+="%"+n),m}return e}const h=/^(?:([^:\/?#]+):)?(?:\/\/((?:([^\/?#@]*)@)?(\[[^\/?#\]]+\]|[^\/?#:]*)(?:\:(\d*))?))?([^?#]*)(?:\?([^#]*))?(?:#((?:.|\n|\r)*))?/i,u=void 0==="".match(/(){0}/)[1];export function parse(o,n={}){const s={},p=!1!==n.iri?t:e;"suffix"===n.reference&&(o=(n.scheme?n.scheme+":":"")+"//"+o);const f=o.match(h);if(f){u?(s.scheme=f[1],s.userinfo=f[3],s.host=f[4],s.port=parseInt(f[5],10),s.path=f[6]||"",s.query=f[7],s.fragment=f[8],isNaN(s.port)&&(s.port=f[5])):(s.scheme=f[1]||void 0,s.userinfo=-1!==o.indexOf("@")?f[3]:void 0,s.host=-1!==o.indexOf("//")?f[4]:void 0,s.port=parseInt(f[5],10),s.path=f[6]||"",s.query=-1!==o.indexOf("?")?f[7]:void 0,s.fragment=-1!==o.indexOf("#")?f[8]:void 0,isNaN(s.port)&&(s.port=o.match(/\/\/(?:.|\n)*\:(?:\/|\?|\#|$)/)?f[4]:void 0)),s.host&&(s.host=c(a(s.host,p),p)),void 0!==s.scheme||void 0!==s.userinfo||void 0!==s.host||void 0!==s.port||s.path||void 0!==s.query?void 0===s.scheme?s.reference="relative":void 0===s.fragment?s.reference="absolute":s.reference="uri":s.reference="same-document",n.reference&&"suffix"!==n.reference&&n.reference!==s.reference&&(s.error=s.error||"URI is not a "+n.reference+" reference.");const t=SCHEMES[(n.scheme||s.scheme||"").toLowerCase()];if(n.unicodeSupport||t&&t.unicodeSupport)i(s,p);else{if(s.host&&(n.domainHost||t&&t.domainHost))try{s.host=r.toASCII(s.host.replace(p.PCT_ENCODED,pctDecChars).toLowerCase())}catch(e){s.error=s.error||"Host's domain name can not be converted to ASCII via punycode: "+e}i(s,e)}t&&t.parse&&t.parse(s,n)}else s.error=s.error||"URI can not be parsed.";return s};const f=/^\.\.?\//,l=/^\/\.(\/|$)/,m=/^\/\.\.(\/|$)/,C=/^\/?(?:.|\n)*?(?=\/|$)/;export function removeDotSegments(e){const t=[];for(;e.length;)if(e.match(f))e=e.replace(f,"");else if(e.match(l))e=e.replace(l,"/");else if(e.match(m))e=e.replace(m,"/"),t.pop();else if("."===e||".."===e)e="";else{const r=e.match(C);if(!r)throw new Error("Unexpected dot segment condition");{const o=r[0];e=e.slice(o.length),t.push(o)}}return t.join("")};export function serialize(o,n={}){const s=n.iri?t:e,p=[],h=SCHEMES[(n.scheme||o.scheme||"").toLowerCase()];if(h&&h.serialize&&h.serialize(o,n),o.host)if(s.IPV6ADDRESS.test(o.host));else if(n.domainHost||h&&h.domainHost)try{o.host=n.iri?r.toUnicode(o.host):r.toASCII(o.host.replace(s.PCT_ENCODED,pctDecChars).toLowerCase())}catch(e){o.error=o.error||"Host's domain name can not be converted to "+(n.iri?"Unicode":"ASCII")+" via punycode: "+e}i(o,s),"suffix"!==n.reference&&o.scheme&&(p.push(o.scheme),p.push(":"));const u=function(r,o){const n=!1!==o.iri?t:e,s=[];return void 0!==r.userinfo&&(s.push(r.userinfo),s.push("@")),void 0!==r.host&&s.push(c(a(String(r.host),n),n).replace(n.IPV6ADDRESS,(e,t,r)=>"["+t+(r?"%25"+r:"")+"]")),"number"==typeof r.port&&(s.push(":"),s.push(r.port.toString(10))),s.length?s.join(""):void 0}(o,n);if(void 0!==u&&("suffix"!==n.reference&&p.push("//"),p.push(u),o.path&&"/"!==o.path.charAt(0)&&p.push("/")),void 0!==o.path){let e=o.path;n.absolutePath||h&&h.absolutePath||(e=removeDotSegments(e)),void 0===u&&(e=e.replace(/^\/\//,"/%2F")),p.push(e)}return void 0!==o.query&&(p.push("?"),p.push(o.query)),void 0!==o.fragment&&(p.push("#"),p.push(o.fragment)),p.join("")};export function resolveComponents(e,t,r={},o){const n={};return o||(e=parse(serialize(e,r),r),t=parse(serialize(t,r),r)),!(r=r||{}).tolerant&&t.scheme?(n.scheme=t.scheme,n.userinfo=t.userinfo,n.host=t.host,n.port=t.port,n.path=removeDotSegments(t.path||""),n.query=t.query):(void 0!==t.userinfo||void 0!==t.host||void 0!==t.port?(n.userinfo=t.userinfo,n.host=t.host,n.port=t.port,n.path=removeDotSegments(t.path||""),n.query=t.query):(t.path?("/"===t.path.charAt(0)?n.path=removeDotSegments(t.path):(void 0===e.userinfo&&void 0===e.host&&void 0===e.port||e.path?e.path?n.path=e.path.slice(0,e.path.lastIndexOf("/")+1)+t.path:n.path=t.path:n.path="/"+t.path,n.path=removeDotSegments(n.path)),n.query=t.query):(n.path=e.path,void 0!==t.query?n.query=t.query:n.query=e.query),n.userinfo=e.userinfo,n.host=e.host,n.port=e.port),n.scheme=e.scheme),n.fragment=t.fragment,n};export function resolve(e,t,r){const o=s({scheme:"null"},r);return serialize(resolveComponents(parse(e,o),parse(t,o),o,!0),o)};export function normalize(e,t){return"string"==typeof e?e=serialize(parse(e,t),t):"object"===n(e)&&(e=parse(serialize(e,t),t)),e};export function equal(e,t,r){return"string"==typeof e?e=serialize(parse(e,r),r):"object"===n(e)&&(e=serialize(e,r)),"string"==typeof t?t=serialize(parse(t,r),r):"object"===n(t)&&(t=serialize(t,r)),e===t};export function escapeComponent(r,o){return r&&r.toString().replace(o&&o.iri?t.ESCAPE:e.ESCAPE,pctEncChar)};export function unescapeComponent(r,o){return r&&r.toString().replace(o&&o.iri?t.PCT_ENCODED:e.PCT_ENCODED,pctDecChars)};