"use strict";var e=require("safer-buffer").Buffer;exports._dbcs=h;for(var t=-1,o=-2,i=-1e3,r=new Array(256),a=0;a<256;a++)r[a]=t;function h(e,a){if(this.encodingName=e.encodingName,!e)throw new Error("DBCS codec is called without the data.");if(!e.table)throw new Error("Encoding '"+this.encodingName+"' has no data.");var h=e.table();this.decodeTables=[],this.decodeTables[0]=r.slice(0),this.decodeTableSeq=[];for(var d=0;d<h.length;d++)this._addDecodeChunk(h[d]);this.defaultCharUnicode=a.defaultCharUnicode,this.encodeTable=[],this.encodeTableSeq=[];var n={};if(e.encodeSkipVals)for(d=0;d<e.encodeSkipVals.length;d++){var s=e.encodeSkipVals[d];if("number"==typeof s)n[s]=!0;else for(var c=s.from;c<=s.to;c++)n[c]=!0}if(this._fillEncodeTable(0,0,n),e.encodeAdd)for(var l in e.encodeAdd)Object.prototype.hasOwnProperty.call(e.encodeAdd,l)&&this._setEncodeChar(l.charCodeAt(0),e.encodeAdd[l]);if(this.defCharSB=this.encodeTable[0][a.defaultCharSingleByte.charCodeAt(0)],this.defCharSB===t&&(this.defCharSB=this.encodeTable[0]["?"]),this.defCharSB===t&&(this.defCharSB="?".charCodeAt(0)),"function"==typeof e.gb18030){this.gb18030=e.gb18030();var f=this.decodeTables.length,u=this.decodeTables[f]=r.slice(0),b=this.decodeTables.length,g=this.decodeTables[b]=r.slice(0);for(d=129;d<=254;d++){var v=i-this.decodeTables[0][d],p=this.decodeTables[v];for(c=48;c<=57;c++)p[c]=i-f}for(d=129;d<=254;d++)u[d]=i-b;for(d=48;d<=57;d++)g[d]=o}}function d(e,t){this.leadSurrogate=-1,this.seqObj=void 0,this.encodeTable=t.encodeTable,this.encodeTableSeq=t.encodeTableSeq,this.defaultCharSingleByte=t.defCharSB,this.gb18030=t.gb18030}function n(t,o){this.nodeIdx=0,this.prevBuf=e.alloc(0),this.decodeTables=o.decodeTables,this.decodeTableSeq=o.decodeTableSeq,this.defaultCharUnicode=o.defaultCharUnicode,this.gb18030=o.gb18030}function s(e,t){if(e[0]>t)return-1;for(var o=0,i=e.length;o<i-1;){var r=o+Math.floor((i-o+1)/2);e[r]<=t?o=r:i=r}return o}h.prototype.encoder=d,h.prototype.decoder=n,h.prototype._getDecodeTrieNode=function(e){for(var o=[];e>0;e>>=8)o.push(255&e);0==o.length&&o.push(0);for(var a=this.decodeTables[0],h=o.length-1;h>0;h--){var d=a[o[h]];if(d==t)a[o[h]]=i-this.decodeTables.length,this.decodeTables.push(a=r.slice(0));else{if(!(d<=i))throw new Error("Overwrite byte in "+this.encodingName+", addr: "+e.toString(16));a=this.decodeTables[i-d]}}return a},h.prototype._addDecodeChunk=function(e){var t=parseInt(e[0],16),o=this._getDecodeTrieNode(t);t&=255;for(var i=1;i<e.length;i++){var r=e[i];if("string"==typeof r)for(var a=0;a<r.length;){var h=r.charCodeAt(a++);if(55296<=h&&h<56320){var d=r.charCodeAt(a++);if(!(56320<=d&&d<57344))throw new Error("Incorrect surrogate pair in "+this.encodingName+" at chunk "+e[0]);o[t++]=65536+1024*(h-55296)+(d-56320)}else if(4080<h&&h<=4095){for(var n=4095-h+2,s=[],c=0;c<n;c++)s.push(r.charCodeAt(a++));o[t++]=-10-this.decodeTableSeq.length,this.decodeTableSeq.push(s)}else o[t++]=h}else{if("number"!=typeof r)throw new Error("Incorrect type '"+typeof r+"' given in "+this.encodingName+" at chunk "+e[0]);var l=o[t-1]+1;for(a=0;a<r;a++)o[t++]=l++}}if(t>255)throw new Error("Incorrect chunk in "+this.encodingName+" at addr "+e[0]+": too long"+t)},h.prototype._getEncodeBucket=function(e){var t=e>>8;return void 0===this.encodeTable[t]&&(this.encodeTable[t]=r.slice(0)),this.encodeTable[t]},h.prototype._setEncodeChar=function(e,o){var i=this._getEncodeBucket(e),r=255&e;i[r]<=-10?this.encodeTableSeq[-10-i[r]][-1]=o:i[r]==t&&(i[r]=o)},h.prototype._setEncodeSequence=function(e,o){var i,r=e[0],a=this._getEncodeBucket(r),h=255&r;a[h]<=-10?i=this.encodeTableSeq[-10-a[h]]:(i={},a[h]!==t&&(i[-1]=a[h]),a[h]=-10-this.encodeTableSeq.length,this.encodeTableSeq.push(i));for(var d=1;d<e.length-1;d++){var n=i[r];"object"==typeof n?i=n:(i=i[r]={},void 0!==n&&(i[-1]=n))}i[r=e[e.length-1]]=o},h.prototype._fillEncodeTable=function(e,t,o){for(var r=this.decodeTables[e],a=0;a<256;a++){var h=r[a],d=t+a;o[d]||(h>=0?this._setEncodeChar(h,d):h<=i?this._fillEncodeTable(i-h,d<<8,o):h<=-10&&this._setEncodeSequence(this.decodeTableSeq[-10-h],d))}},d.prototype.write=function(o){for(var i=e.alloc(o.length*(this.gb18030?4:3)),r=this.leadSurrogate,a=this.seqObj,h=-1,d=0,n=0;;){if(-1===h){if(d==o.length)break;var c=o.charCodeAt(d++)}else{c=h;h=-1}if(55296<=c&&c<57344)if(c<56320){if(-1===r){r=c;continue}r=c,c=t}else-1!==r?(c=65536+1024*(r-55296)+(c-56320),r=-1):c=t;else-1!==r&&(h=c,c=t,r=-1);var l=t;if(void 0!==a&&c!=t){var f=a[c];if("object"==typeof f){a=f;continue}"number"==typeof f?l=f:void 0==f&&void 0!==(f=a[-1])&&(l=f,h=c),a=void 0}else if(c>=0){var u=this.encodeTable[c>>8];if(void 0!==u&&(l=u[255&c]),l<=-10){a=this.encodeTableSeq[-10-l];continue}if(l==t&&this.gb18030){var b=s(this.gb18030.uChars,c);if(-1!=b){l=this.gb18030.gbChars[b]+(c-this.gb18030.uChars[b]);i[n++]=129+Math.floor(l/12600),l%=12600,i[n++]=48+Math.floor(l/1260),l%=1260,i[n++]=129+Math.floor(l/10),l%=10,i[n++]=48+l;continue}}}l===t&&(l=this.defaultCharSingleByte),l<256?i[n++]=l:l<65536?(i[n++]=l>>8,i[n++]=255&l):(i[n++]=l>>16,i[n++]=l>>8&255,i[n++]=255&l)}return this.seqObj=a,this.leadSurrogate=r,i.slice(0,n)},d.prototype.end=function(){if(-1!==this.leadSurrogate||void 0!==this.seqObj){var t=e.alloc(10),o=0;if(this.seqObj){var i=this.seqObj[-1];void 0!==i&&(i<256?t[o++]=i:(t[o++]=i>>8,t[o++]=255&i)),this.seqObj=void 0}return-1!==this.leadSurrogate&&(t[o++]=this.defaultCharSingleByte,this.leadSurrogate=-1),t.slice(0,o)}},d.prototype.findIdx=s,n.prototype.write=function(r){var a=e.alloc(2*r.length),h=this.nodeIdx,d=this.prevBuf,n=this.prevBuf.length,c=-this.prevBuf.length;n>0&&(d=e.concat([d,r.slice(0,10)]));for(var l=0,f=0;l<r.length;l++){var u,b=l>=0?r[l]:d[l+n];if((u=this.decodeTables[h][b])>=0);else if(u===t)l=c,u=this.defaultCharUnicode.charCodeAt(0);else if(u===o){var g=c>=0?r.slice(c,l+1):d.slice(c+n,l+1+n),v=12600*(g[0]-129)+1260*(g[1]-48)+10*(g[2]-129)+(g[3]-48),p=s(this.gb18030.gbChars,v);u=this.gb18030.uChars[p]+v-this.gb18030.gbChars[p]}else{if(u<=i){h=i-u;continue}if(!(u<=-10))throw new Error("iconv-lite internal error: invalid decoding table value "+u+" at "+h+"/"+b);for(var T=this.decodeTableSeq[-10-u],S=0;S<T.length-1;S++)u=T[S],a[f++]=255&u,a[f++]=u>>8;u=T[T.length-1]}if(u>65535){u-=65536;var C=55296+Math.floor(u/1024);a[f++]=255&C,a[f++]=C>>8,u=56320+u%1024}a[f++]=255&u,a[f++]=u>>8,h=0,c=l+1}return this.nodeIdx=h,this.prevBuf=c>=0?r.slice(c):d.slice(c+n),a.slice(0,f).toString("ucs2")},n.prototype.end=function(){for(var t="";this.prevBuf.length>0;){t+=this.defaultCharUnicode;var o=this.prevBuf.slice(1);this.prevBuf=e.alloc(0),this.nodeIdx=0,o.length>0&&(t+=this.write(o))}return this.nodeIdx=0,t};