var e=require("events").EventEmitter,r=require("fs"),n=require("path"),i=n.sep||"/";function t(t,o,f){"function"==typeof o&&(f=o),void 0===(o=o||{}).find_links&&(o.find_links=!0);var c=o.fs||r,a=new e,s=[],u=o.return_object?{}:[],l=!1,d={},v=0,y=null,h=0,p=0,m=function(e){p+=e,e<1&&!k&&(k=1,process.nextTick(function(){k=0,p<=0&&!h&&(h=1,a.emit("end"))}))},k=0;a.ignore=function(e){return Array.isArray(e)?s.push.apply(s,e):s.push(e),this};var g=[["isFile","file"],["isDirectory","directory"],["isSymbolicLink","link"],["isSocket","socket"],["isFIFO","fifo"],["isBlockDevice","blockdevice"],["isCharacterDevice","characterdevice"]],_=function(e,r,i){m(1);var t=function(t,f,c){if(m(-1),!v){if(t||!f)return a.emit("fail",e,t),void 0;var s=n.basename(e),u=f.dev+"-"+f.ino+"-"+s;if(!1!==o.track_inodes){if(d[u]&&f.ino)return;d[u]=1}if(r&&f.isDirectory())return a.emit("targetdirectory",e,f,i),void 0;a.emit("path",e,f,i);for(var l=0,y=g.length;l<y;l++)if(f[g[l][0]]()){a.emit(g[l][1],e,f,i);break}}};if(o.sync){var f,s;try{f=c[o.find_links?"lstatSync":"statSync"](e)}catch(e){s=e}t(s,f)}else c[o.find_links?"lstat":"stat"](e,t)},b=function(e,r,t){if(l||(e=n.resolve(e),l=1),o.max_depth&&t>=o.max_depth)return a.emit("maxdepth",e,r,t),void 0;if(s.length)for(var f=0;f<s.length;++f)if(s[f]==e)return s.splice(f,1),void 0;m(1);var u=function(n,f){if(m(-1),n||!f)return a.emit("fail",e,n),void 0;if(!f.length)return a.emit("empty",e,r,t),void 0;if(e==i&&(e=""),o.filter){var c=o.filter(e,f);if(!c)throw new Error("option.filter function must return a array of strings or a promise");if(c.then)return m(1),c.then(r=>{m(-1);for(var n=0,o=r.length;n<o;n++)_(e+i+r[n],!1,(t||0)+1)}),void 0;f=c}for(var s=0,u=f.length;s<u;s++)_(e+i+f[s],!1,(t||0)+1)};if(o.sync){var d,v;try{v=c.readdirSync(e)}catch(e){d=e}u(d,v)}else c.readdir(e,u)};if(o.follow_symlinks){var w=function(e,r,n){m(-1),_(r,!1,n)};a.on("link",function(e,r,i){if(m(1),o.sync){var t;try{t=c.readlinkSync(e)}catch(e){e}w(0,n.resolve(n.dirname(e),t),i)}else c.readlink(e,function(r,t){w(0,n.resolve(n.dirname(e),t),i)})})}if(f&&a.on("path",f),o.sync&&(o.no_return||a.on("path",function(e,r){o.return_object?u[e]=r:u.push(e)})),o.no_recurse||a.on("directory",b),a.once("targetdirectory",b),a.once("fail",function(e,r){t==e&&a.emit("error",new Error("error reading first path in the walk "+t+"\n"+r),r)}),_(t,1),o.sync)return u;a.end=a.stop=function(){v=1};var S=[];return a.pause=function(){m(1),y=!0,a.emit=function(){S.push(arguments)}},a.resume=function(){if(y){y=!1,m(-1),a.emit=e.prototype.emit;var r=S;for(S=[];r.length;)a.emit.apply(a,r.shift())}},a}module.exports=t,t.find=t.walk=t,t.sync=function(e,r,n){return"function"==typeof r&&(cb=r),(r=r||{}).sync=!0,t(e,r,n)},t.async=function(e,r,n){return new Promise((i,o)=>{"function"==typeof r&&(cb=r);let f=t(e,r=r||{},n);f.on("error",o),f.on("fail",(e,r)=>{r.message='Error walking": '+e+" "+r.message,r&&o(r)});let c={};f.on("path",(e,n)=>{!0!==r.no_return&&(c[e]=n)}),f.on("end",()=>{if(!0!==r.no_return)return i(r.return_object?c:Object.keys(c));i()})})};