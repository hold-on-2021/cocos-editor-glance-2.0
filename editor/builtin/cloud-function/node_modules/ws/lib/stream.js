"use strict";const{Duplex:e}=require("stream");function t(e){e.emit("close")}function n(){!this.destroyed&&this._writableState.finished&&this.destroy()}function r(e){this.removeListener("error",r),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}module.exports=function(o,i){let s=!0;function c(){s&&o._socket.resume()}o.readyState===o.CONNECTING?o.once("open",function(){o._receiver.removeAllListeners("drain"),o._receiver.on("drain",c)}):(o._receiver.removeAllListeners("drain"),o._receiver.on("drain",c));const d=new e({...i,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return o.on("message",function(e){d.push(e)||(s=!1,o._socket.pause())}),o.once("error",function(e){d.destroyed||d.destroy(e)}),o.once("close",function(){d.destroyed||d.push(null)}),d._destroy=function(e,n){if(o.readyState===o.CLOSED)return n(e),process.nextTick(t,d),void 0;let r=!1;o.once("error",function(e){r=!0,n(e)}),o.once("close",function(){r||n(e),process.nextTick(t,d)}),o.terminate()},d._final=function(e){if(o.readyState===o.CONNECTING)return o.once("open",function(){d._final(e)}),void 0;null!==o._socket&&(o._socket._writableState.finished?(d._readableState.endEmitted&&d.destroy(),e()):(o._socket.once("finish",function(){e()}),o.close()))},d._read=function(){o.readyState!==o.OPEN||s||(s=!0,o._receiver._writableState.needDrain||o._socket.resume())},d._write=function(e,t,n){if(o.readyState===o.CONNECTING)return o.once("open",function(){d._write(e,t,n)}),void 0;o.send(e,n)},d.on("end",n),d.on("error",r),d};