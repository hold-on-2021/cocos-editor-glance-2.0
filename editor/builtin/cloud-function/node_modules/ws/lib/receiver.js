"use strict";const{Writable:t}=require("stream"),e=require("./permessage-deflate"),{BINARY_TYPES:s,EMPTY_BUFFER:i,kStatusCode:h,kWebSocket:r}=require("./constants"),{concat:o,toArrayBuffer:a,unmask:n}=require("./buffer-util"),{isValidStatusCode:_,isValidUTF8:d}=require("./validation"),l=0,f=1,g=2,u=3,p=4,c=5;function m(t,e,s,i){const r=new t(s?`Invalid WebSocket frame: ${e}`:e);return Error.captureStackTrace(r,m),r[h]=i,r}module.exports=class extends t{constructor(t,e,i,h){super(),this._binaryType=t||s[0],this[r]=void 0,this._extensions=e||{},this._isServer=!!i,this._maxPayload=0|h,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=l,this._loop=!1}_write(t,e,s){if(8===this._opcode&&this._state==l)return s();this._bufferedBytes+=t.length,this._buffers.push(t),this.startLoop(s)}consume(t){if(this._bufferedBytes-=t,t===this._buffers[0].length)return this._buffers.shift();if(t<this._buffers[0].length){const e=this._buffers[0];return this._buffers[0]=e.slice(t),e.slice(0,t)}const e=Buffer.allocUnsafe(t);do{const s=this._buffers[0],i=e.length-t;t>=s.length?e.set(this._buffers.shift(),i):(e.set(new Uint8Array(s.buffer,s.byteOffset,t),i),this._buffers[0]=s.slice(t)),t-=s.length}while(t>0);return e}startLoop(t){let e;this._loop=!0;do{switch(this._state){case l:e=this.getInfo();break;case f:e=this.getPayloadLength16();break;case g:e=this.getPayloadLength64();break;case u:this.getMask();break;case p:e=this.getData(t);break;default:return this._loop=!1,void 0}}while(this._loop);t(e)}getInfo(){if(this._bufferedBytes<2)return this._loop=!1,void 0;const t=this.consume(2);if(0!=(48&t[0]))return this._loop=!1,m(RangeError,"RSV2 and RSV3 must be clear",!0,1002);const s=64==(64&t[0]);if(s&&!this._extensions[e.extensionName])return this._loop=!1,m(RangeError,"RSV1 must be clear",!0,1002);if(this._fin=128==(128&t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(s)return this._loop=!1,m(RangeError,"RSV1 must be clear",!0,1002);if(!this._fragmented)return this._loop=!1,m(RangeError,"invalid opcode 0",!0,1002);this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,m(RangeError,`invalid opcode ${this._opcode}`,!0,1002);this._compressed=s}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,m(RangeError,`invalid opcode ${this._opcode}`,!0,1002);if(!this._fin)return this._loop=!1,m(RangeError,"FIN must be set",!0,1002);if(s)return this._loop=!1,m(RangeError,"RSV1 must be clear",!0,1002);if(this._payloadLength>125)return this._loop=!1,m(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002)}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&t[1]),this._isServer){if(!this._masked)return this._loop=!1,m(RangeError,"MASK must be set",!0,1002)}else if(this._masked)return this._loop=!1,m(RangeError,"MASK must be clear",!0,1002);if(126===this._payloadLength)this._state=f;else{if(127!==this._payloadLength)return this.haveLength();this._state=g}}getPayloadLength16(){return this._bufferedBytes<2?(this._loop=!1,void 0):(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength())}getPayloadLength64(){if(this._bufferedBytes<8)return this._loop=!1,void 0;const t=this.consume(8),e=t.readUInt32BE(0);return e>Math.pow(2,21)-1?(this._loop=!1,m(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009)):(this._payloadLength=e*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,m(RangeError,"Max payload size exceeded",!1,1009);this._masked?this._state=u:this._state=p}getMask(){if(this._bufferedBytes<4)return this._loop=!1,void 0;this._mask=this.consume(4),this._state=p}getData(t){let e=i;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return this._loop=!1,void 0;e=this.consume(this._payloadLength),this._masked&&n(e,this._mask)}return this._opcode>7?this.controlMessage(e):this._compressed?(this._state=c,this.decompress(e,t),void 0):(e.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(e)),this.dataMessage())}decompress(t,s){this._extensions[e.extensionName].decompress(t,this._fin,(t,e)=>{if(t)return s(t);if(e.length){if(this._messageLength+=e.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return s(m(RangeError,"Max payload size exceeded",!1,1009));this._fragments.push(e)}const i=this.dataMessage();if(i)return s(i);this.startLoop(s)})}dataMessage(){if(this._fin){const t=this._messageLength,e=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?o(e,t):"arraybuffer"===this._binaryType?a(o(e,t)):e,this.emit("message",s)}else{const s=o(e,t);if(!d(s))return this._loop=!1,m(Error,"invalid UTF-8 sequence",!0,1007);this.emit("message",s.toString())}}this._state=l}controlMessage(t){if(8===this._opcode)if(this._loop=!1,0===t.length)this.emit("conclude",1005,""),this.end();else{if(1===t.length)return m(RangeError,"invalid payload length 1",!0,1002);{const e=t.readUInt16BE(0);if(!_(e))return m(RangeError,`invalid status code ${e}`,!0,1002);const s=t.slice(2);if(!d(s))return m(Error,"invalid UTF-8 sequence",!0,1007);this.emit("conclude",e,s.toString()),this.end()}}else 9===this._opcode?this.emit("ping",t):this.emit("pong",t);this._state=l}};