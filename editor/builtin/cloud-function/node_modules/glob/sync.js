module.exports=f,f.GlobSync=u;var t=require("fs"),r=require("fs.realpath"),i=require("minimatch"),s=(i.Minimatch,require("./glob.js").Glob,require("util"),require("path")),e=require("assert"),a=require("path-is-absolute"),h=require("./common.js"),c=(h.alphasort,h.alphasorti,h.setopts),o=h.ownProp,n=h.childrenIgnored,l=h.isIgnored;function f(t,r){if("function"==typeof r||3===arguments.length)throw new TypeError("callback provided to sync glob\nSee: https://github.com/isaacs/node-glob/issues/167");return new u(t,r).found}function u(t,r){if(!t)throw new Error("must provide pattern");if("function"==typeof r||3===arguments.length)throw new TypeError("callback provided to sync glob\nSee: https://github.com/isaacs/node-glob/issues/167");if(!(this instanceof u))return new u(t,r);if(c(this,t,r),this.noprocess)return this;var i=this.minimatch.set.length;this.matches=new Array(i);for(var s=0;s<i;s++)this._process(this.minimatch.set[s],s,!1);this._finish()}u.prototype._finish=function(){if(e(this instanceof u),this.realpath){var t=this;this.matches.forEach(function(i,s){var e=t.matches[s]=Object.create(null);for(var a in i)try{a=t._makeAbs(a),e[r.realpathSync(a,t.realpathCache)]=!0}catch(r){if("stat"!==r.syscall)throw r;e[t._makeAbs(a)]=!0}})}h.finish(this)},u.prototype._process=function(t,r,s){e(this instanceof u);for(var h,c=0;"string"==typeof t[c];)c++;switch(c){case t.length:return this._processSimple(t.join("/"),r),void 0;case 0:h=null;break;default:h=t.slice(0,c).join("/")}var o,l=t.slice(c);null===h?o=".":a(h)||a(t.join("/"))?(h&&a(h)||(h="/"+h),o=h):o=h;var f=this._makeAbs(o);n(this,o)||(l[0]===i.GLOBSTAR?this._processGlobStar(h,o,f,l,r,s):this._processReaddir(h,o,f,l,r,s))},u.prototype._processReaddir=function(t,r,i,e,a,h){var c=this._readdir(i,h);if(c){for(var o=e[0],n=!!this.minimatch.negate,l=o._glob,f=this.dot||"."===l.charAt(0),u=[],p=0;p<c.length;p++){if("."!==(y=c[p]).charAt(0)||f)(n&&!t?!y.match(o):y.match(o))&&u.push(y)}var d=u.length;if(0!==d)if(1!==e.length||this.mark||this.stat){e.shift();for(p=0;p<d;p++){var m;y=u[p];m=t?[t,y]:[y],this._process(m.concat(e),a,h)}}else{this.matches[a]||(this.matches[a]=Object.create(null));for(var p=0;p<d;p++){var y=u[p];t&&(y="/"!==t.slice(-1)?t+"/"+y:t+y),"/"!==y.charAt(0)||this.nomount||(y=s.join(this.root,y)),this._emitMatch(a,y)}}}},u.prototype._emitMatch=function(t,r){if(!l(this,r)){var i=this._makeAbs(r);if(this.mark&&(r=this._mark(r)),this.absolute&&(r=i),!this.matches[t][r]){if(this.nodir){var s=this.cache[i];if("DIR"===s||Array.isArray(s))return}this.matches[t][r]=!0,this.stat&&this._stat(r)}}},u.prototype._readdirInGlobStar=function(r){if(this.follow)return this._readdir(r,!1);var i,s;try{s=t.lstatSync(r)}catch(t){if("ENOENT"===t.code)return null}var e=s&&s.isSymbolicLink();return this.symlinks[r]=e,e||!s||s.isDirectory()?i=this._readdir(r,!1):this.cache[r]="FILE",i},u.prototype._readdir=function(r,i){if(i&&!o(this.symlinks,r))return this._readdirInGlobStar(r);if(o(this.cache,r)){var s=this.cache[r];if(!s||"FILE"===s)return null;if(Array.isArray(s))return s}try{return this._readdirEntries(r,t.readdirSync(r))}catch(t){return this._readdirError(r,t),null}},u.prototype._readdirEntries=function(t,r){if(!this.mark&&!this.stat)for(var i=0;i<r.length;i++){var s=r[i];s="/"===t?t+s:t+"/"+s,this.cache[s]=!0}return this.cache[t]=r,r},u.prototype._readdirError=function(t,r){switch(r.code){case"ENOTSUP":case"ENOTDIR":var i=this._makeAbs(t);if(this.cache[i]="FILE",i===this.cwdAbs){var s=new Error(r.code+" invalid cwd "+this.cwd);throw s.path=this.cwd,s.code=r.code,s}break;case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[this._makeAbs(t)]=!1;break;default:if(this.cache[this._makeAbs(t)]=!1,this.strict)throw r;this.silent||console.error("glob error",r)}},u.prototype._processGlobStar=function(t,r,i,s,e,a){var h=this._readdir(i,a);if(h){var c=s.slice(1),o=t?[t]:[],n=o.concat(c);this._process(n,e,!1);var l=h.length;if(!this.symlinks[i]||!a)for(var f=0;f<l;f++){if("."!==h[f].charAt(0)||this.dot){var u=o.concat(h[f],c);this._process(u,e,!0);var p=o.concat(h[f],s);this._process(p,e,!0)}}}},u.prototype._processSimple=function(t,r){var i=this._stat(t);if(this.matches[r]||(this.matches[r]=Object.create(null)),i){if(t&&a(t)&&!this.nomount){var e=/[\/\\]$/.test(t);"/"===t.charAt(0)?t=s.join(this.root,t):(t=s.resolve(this.root,t),e&&(t+="/"))}"win32"===process.platform&&(t=t.replace(/\\/g,"/")),this._emitMatch(r,t)}},u.prototype._stat=function(r){var i=this._makeAbs(r),s="/"===r.slice(-1);if(r.length>this.maxLength)return!1;if(!this.stat&&o(this.cache,i)){var e=this.cache[i];if(Array.isArray(e)&&(e="DIR"),!s||"DIR"===e)return e;if(s&&"FILE"===e)return!1}var a=this.statCache[i];if(!a){var h;try{h=t.lstatSync(i)}catch(t){if(t&&("ENOENT"===t.code||"ENOTDIR"===t.code))return this.statCache[i]=!1,!1}if(h&&h.isSymbolicLink())try{a=t.statSync(i)}catch(t){a=h}else a=h}this.statCache[i]=a;e=!0;return a&&(e=a.isDirectory()?"DIR":"FILE"),this.cache[i]=this.cache[i]||e,(!s||"FILE"!==e)&&e},u.prototype._mark=function(t){return h.mark(this,t)},u.prototype._makeAbs=function(t){return h.makeAbs(this,t)};