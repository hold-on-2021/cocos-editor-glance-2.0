module.exports=m;var t=require("fs"),i=require("fs.realpath"),r=require("minimatch"),e=(r.Minimatch,require("inherits")),s=require("events").EventEmitter,n=require("path"),a=require("assert"),h=require("path-is-absolute"),o=require("./sync.js"),c=require("./common.js"),u=(c.alphasort,c.alphasorti,c.setopts),f=c.ownProp,p=require("inflight"),l=(require("util"),c.childrenIgnored),d=c.isIgnored,_=require("once");function m(t,i,r){if("function"==typeof i&&(r=i,i={}),i||(i={}),i.sync){if(r)throw new TypeError("callback provided to sync glob");return o(t,i)}return new y(t,i,r)}m.sync=o;var v=m.GlobSync=o.GlobSync;function y(t,i,r){if("function"==typeof i&&(r=i,i=null),i&&i.sync){if(r)throw new TypeError("callback provided to sync glob");return new v(t,i)}if(!(this instanceof y))return new y(t,i,r);u(this,t,i),this._didRealPath=!1;var e=this.minimatch.set.length;this.matches=new Array(e),"function"==typeof r&&(r=_(r),this.on("error",r),this.on("end",function(t){r(null,t)}));var s=this;if(this._processing=0,this._emitQueue=[],this._processQueue=[],this.paused=!1,this.noprocess)return this;if(0===e)return h();for(var n=!0,a=0;a<e;a++)this._process(this.minimatch.set[a],a,!1,h);function h(){--s._processing,s._processing<=0&&(n?process.nextTick(function(){s._finish()}):s._finish())}n=!1}m.glob=m,m.hasMagic=function(t,i){var r=function(t,i){if(null===i||"object"!=typeof i)return t;for(var r=Object.keys(i),e=r.length;e--;)t[r[e]]=i[r[e]];return t}({},i);r.noprocess=!0;var e=new y(t,r).minimatch.set;if(!t)return!1;if(e.length>1)return!0;for(var s=0;s<e[0].length;s++)if("string"!=typeof e[0][s])return!0;return!1},m.Glob=y,e(y,s),y.prototype._finish=function(){if(a(this instanceof y),!this.aborted){if(this.realpath&&!this._didRealpath)return this._realpath();c.finish(this),this.emit("end",this.found)}},y.prototype._realpath=function(){if(!this._didRealpath){this._didRealpath=!0;var t=this.matches.length;if(0===t)return this._finish();for(var i=this,r=0;r<this.matches.length;r++)this._realpathSet(r,e)}function e(){0==--t&&i._finish()}},y.prototype._realpathSet=function(t,r){var e=this.matches[t];if(!e)return r();var s=Object.keys(e),n=this,a=s.length;if(0===a)return r();var h=this.matches[t]=Object.create(null);s.forEach(function(e,s){e=n._makeAbs(e),i.realpath(e,n.realpathCache,function(i,s){i?"stat"===i.syscall?h[e]=!0:n.emit("error",i):h[s]=!0,0==--a&&(n.matches[t]=h,r())})})},y.prototype._mark=function(t){return c.mark(this,t)},y.prototype._makeAbs=function(t){return c.makeAbs(this,t)},y.prototype.abort=function(){this.aborted=!0,this.emit("abort")},y.prototype.pause=function(){this.paused||(this.paused=!0,this.emit("pause"))},y.prototype.resume=function(){if(this.paused){if(this.emit("resume"),this.paused=!1,this._emitQueue.length){var t=this._emitQueue.slice(0);this._emitQueue.length=0;for(var i=0;i<t.length;i++){var r=t[i];this._emitMatch(r[0],r[1])}}if(this._processQueue.length){var e=this._processQueue.slice(0);this._processQueue.length=0;for(i=0;i<e.length;i++){var s=e[i];this._processing--,this._process(s[0],s[1],s[2],s[3])}}}},y.prototype._process=function(t,i,e,s){if(a(this instanceof y),a("function"==typeof s),!this.aborted){if(this._processing++,this.paused)return this._processQueue.push([t,i,e,s]),void 0;for(var n,o=0;"string"==typeof t[o];)o++;switch(o){case t.length:return this._processSimple(t.join("/"),i,s),void 0;case 0:n=null;break;default:n=t.slice(0,o).join("/")}var c,u=t.slice(o);null===n?c=".":h(n)||h(t.join("/"))?(n&&h(n)||(n="/"+n),c=n):c=n;var f=this._makeAbs(c);if(l(this,c))return s();u[0]===r.GLOBSTAR?this._processGlobStar(n,c,f,u,i,e,s):this._processReaddir(n,c,f,u,i,e,s)}},y.prototype._processReaddir=function(t,i,r,e,s,n,a){var h=this;this._readdir(r,n,function(o,c){return h._processReaddir2(t,i,r,e,s,n,c,a)})},y.prototype._processReaddir2=function(t,i,r,e,s,a,h,o){if(!h)return o();for(var c=e[0],u=!!this.minimatch.negate,f=c._glob,p=this.dot||"."===f.charAt(0),l=[],d=0;d<h.length;d++){if("."!==(m=h[d]).charAt(0)||p)(u&&!t?!m.match(c):m.match(c))&&l.push(m)}var _=l.length;if(0===_)return o();if(1===e.length&&!this.mark&&!this.stat){this.matches[s]||(this.matches[s]=Object.create(null));for(d=0;d<_;d++){var m=l[d];t&&(m="/"!==t?t+"/"+m:t+m),"/"!==m.charAt(0)||this.nomount||(m=n.join(this.root,m)),this._emitMatch(s,m)}return o()}e.shift();for(d=0;d<_;d++){m=l[d];t&&(m="/"!==t?t+"/"+m:t+m),this._process([m].concat(e),s,a,o)}o()},y.prototype._emitMatch=function(t,i){if(!this.aborted&&!d(this,i)){if(this.paused)return this._emitQueue.push([t,i]),void 0;var r=h(i)?i:this._makeAbs(i);if(this.mark&&(i=this._mark(i)),this.absolute&&(i=r),!this.matches[t][i]){if(this.nodir){var e=this.cache[r];if("DIR"===e||Array.isArray(e))return}this.matches[t][i]=!0;var s=this.statCache[r];s&&this.emit("stat",i,s),this.emit("match",i)}}},y.prototype._readdirInGlobStar=function(i,r){if(!this.aborted){if(this.follow)return this._readdir(i,!1,r);var e=this,s=p("lstat\0"+i,function(t,s){if(t&&"ENOENT"===t.code)return r();var n=s&&s.isSymbolicLink();e.symlinks[i]=n,n||!s||s.isDirectory()?e._readdir(i,!1,r):(e.cache[i]="FILE",r())});s&&t.lstat(i,s)}},y.prototype._readdir=function(i,r,e){if(!this.aborted&&(e=p("readdir\0"+i+"\0"+r,e))){if(r&&!f(this.symlinks,i))return this._readdirInGlobStar(i,e);if(f(this.cache,i)){var s=this.cache[i];if(!s||"FILE"===s)return e();if(Array.isArray(s))return e(null,s)}t.readdir(i,function(t,i,r){return function(e,s){e?t._readdirError(i,e,r):t._readdirEntries(i,s,r)}}(this,i,e))}},y.prototype._readdirEntries=function(t,i,r){if(!this.aborted){if(!this.mark&&!this.stat)for(var e=0;e<i.length;e++){var s=i[e];s="/"===t?t+s:t+"/"+s,this.cache[s]=!0}return this.cache[t]=i,r(null,i)}},y.prototype._readdirError=function(t,i,r){if(!this.aborted){switch(i.code){case"ENOTSUP":case"ENOTDIR":var e=this._makeAbs(t);if(this.cache[e]="FILE",e===this.cwdAbs){var s=new Error(i.code+" invalid cwd "+this.cwd);s.path=this.cwd,s.code=i.code,this.emit("error",s),this.abort()}break;case"ENOENT":case"ELOOP":case"ENAMETOOLONG":case"UNKNOWN":this.cache[this._makeAbs(t)]=!1;break;default:this.cache[this._makeAbs(t)]=!1,this.strict&&(this.emit("error",i),this.abort()),this.silent||console.error("glob error",i)}return r()}},y.prototype._processGlobStar=function(t,i,r,e,s,n,a){var h=this;this._readdir(r,n,function(o,c){h._processGlobStar2(t,i,r,e,s,n,c,a)})},y.prototype._processGlobStar2=function(t,i,r,e,s,n,a,h){if(!a)return h();var o=e.slice(1),c=t?[t]:[],u=c.concat(o);this._process(u,s,!1,h);var f=this.symlinks[r],p=a.length;if(f&&n)return h();for(var l=0;l<p;l++){if("."!==a[l].charAt(0)||this.dot){var d=c.concat(a[l],o);this._process(d,s,!0,h);var _=c.concat(a[l],e);this._process(_,s,!0,h)}}h()},y.prototype._processSimple=function(t,i,r){var e=this;this._stat(t,function(s,n){e._processSimple2(t,i,s,n,r)})},y.prototype._processSimple2=function(t,i,r,e,s){if(this.matches[i]||(this.matches[i]=Object.create(null)),!e)return s();if(t&&h(t)&&!this.nomount){var a=/[\/\\]$/.test(t);"/"===t.charAt(0)?t=n.join(this.root,t):(t=n.resolve(this.root,t),a&&(t+="/"))}"win32"===process.platform&&(t=t.replace(/\\/g,"/")),this._emitMatch(i,t),s()},y.prototype._stat=function(i,r){var e=this._makeAbs(i),s="/"===i.slice(-1);if(i.length>this.maxLength)return r();if(!this.stat&&f(this.cache,e)){var n=this.cache[e];if(Array.isArray(n)&&(n="DIR"),!s||"DIR"===n)return r(null,n);if(s&&"FILE"===n)return r()}var a=this.statCache[e];if(void 0!==a){if(!1===a)return r(null,a);var h=a.isDirectory()?"DIR":"FILE";return s&&"FILE"===h?r():r(null,h,a)}var o=this,c=p("stat\0"+e,function(s,n){if(n&&n.isSymbolicLink())return t.stat(e,function(t,s){t?o._stat2(i,e,null,n,r):o._stat2(i,e,t,s,r)});o._stat2(i,e,s,n,r)});c&&t.lstat(e,c)},y.prototype._stat2=function(t,i,r,e,s){if(r&&("ENOENT"===r.code||"ENOTDIR"===r.code))return this.statCache[i]=!1,s();var n="/"===t.slice(-1);if(this.statCache[i]=e,"/"===i.slice(-1)&&e&&!e.isDirectory())return s(null,!1,e);var a=!0;return e&&(a=e.isDirectory()?"DIR":"FILE"),this.cache[i]=this.cache[i]||a,n&&"FILE"===a?s():s(null,a,e)};