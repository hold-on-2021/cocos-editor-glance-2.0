var t=require("combined-stream"),e=require("util"),r=require("path"),n=require("http"),o=require("https"),a=require("url").parse,i=require("fs"),s=require("mime-types"),h=require("asynckit"),p=require("./populate.js");function u(e){if(!(this instanceof u))return new u;for(var r in this._overheadLength=0,this._valueLength=0,this._valuesToMeasure=[],t.call(this),e=e||{})this[r]=e[r]}module.exports=u,e.inherits(u,t),u.LINE_BREAK="\r\n",u.DEFAULT_CONTENT_TYPE="application/octet-stream",u.prototype.append=function(r,n,o){"string"==typeof(o=o||{})&&(o={filename:o});var a=t.prototype.append.bind(this);if("number"==typeof n&&(n=""+n),e.isArray(n))return this._error(new Error("Arrays are not supported.")),void 0;var i=this._multiPartHeader(r,n,o),s=this._multiPartFooter();a(i),a(n),a(s),this._trackLength(i,n,o)},u.prototype._trackLength=function(t,e,r){var n=0;null!=r.knownLength?n+=+r.knownLength:Buffer.isBuffer(e)?n=e.length:"string"==typeof e&&(n=Buffer.byteLength(e)),this._valueLength+=n,this._overheadLength+=Buffer.byteLength(t)+u.LINE_BREAK.length,e&&(e.path||e.readable&&e.hasOwnProperty("httpVersion"))&&(r.knownLength||this._valuesToMeasure.push(e))},u.prototype._lengthRetriever=function(t,e){t.hasOwnProperty("fd")?void 0!=t.end&&t.end!=1/0&&void 0!=t.start?e(null,t.end+1-(t.start?t.start:0)):i.stat(t.path,function(r,n){var o;if(r)return e(r),void 0;o=n.size-(t.start?t.start:0),e(null,o)}):t.hasOwnProperty("httpVersion")?e(null,+t.headers["content-length"]):t.hasOwnProperty("httpModule")?(t.on("response",function(r){t.pause(),e(null,+r.headers["content-length"])}),t.resume()):e("Unknown stream")},u.prototype._multiPartHeader=function(t,e,r){if("string"==typeof r.header)return r.header;var n,o=this._getContentDisposition(e,r),a=this._getContentType(e,r),i="",s={"Content-Disposition":["form-data",'name="'+t+'"'].concat(o||[]),"Content-Type":[].concat(a||[])};for(var h in"object"==typeof r.header&&p(s,r.header),s)s.hasOwnProperty(h)&&null!=(n=s[h])&&(Array.isArray(n)||(n=[n]),n.length&&(i+=h+": "+n.join("; ")+u.LINE_BREAK));return"--"+this.getBoundary()+u.LINE_BREAK+i+u.LINE_BREAK},u.prototype._getContentDisposition=function(t,e){var n,o;return"string"==typeof e.filepath?n=r.normalize(e.filepath).replace(/\\/g,"/"):e.filename||t.name||t.path?n=r.basename(e.filename||t.name||t.path):t.readable&&t.hasOwnProperty("httpVersion")&&(n=r.basename(t.client._httpMessage.path)),n&&(o='filename="'+n+'"'),o},u.prototype._getContentType=function(t,e){var r=e.contentType;return!r&&t.name&&(r=s.lookup(t.name)),!r&&t.path&&(r=s.lookup(t.path)),!r&&t.readable&&t.hasOwnProperty("httpVersion")&&(r=t.headers["content-type"]),r||!e.filepath&&!e.filename||(r=s.lookup(e.filepath||e.filename)),r||"object"!=typeof t||(r=u.DEFAULT_CONTENT_TYPE),r},u.prototype._multiPartFooter=function(){return function(t){var e=u.LINE_BREAK;0===this._streams.length&&(e+=this._lastBoundary()),t(e)}.bind(this)},u.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"+u.LINE_BREAK},u.prototype.getHeaders=function(t){var e,r={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(e in t)t.hasOwnProperty(e)&&(r[e.toLowerCase()]=t[e]);return r},u.prototype.getBoundary=function(){return this._boundary||this._generateBoundary(),this._boundary},u.prototype._generateBoundary=function(){for(var t="--------------------------",e=0;e<24;e++)t+=Math.floor(10*Math.random()).toString(16);this._boundary=t},u.prototype.getLengthSync=function(){var t=this._overheadLength+this._valueLength;return this._streams.length&&(t+=this._lastBoundary().length),this.hasKnownLength()||this._error(new Error("Cannot calculate proper length in synchronous way.")),t},u.prototype.hasKnownLength=function(){var t=!0;return this._valuesToMeasure.length&&(t=!1),t},u.prototype.getLength=function(t){var e=this._overheadLength+this._valueLength;if(this._streams.length&&(e+=this._lastBoundary().length),!this._valuesToMeasure.length)return process.nextTick(t.bind(this,null,e)),void 0;h.parallel(this._valuesToMeasure,this._lengthRetriever,function(r,n){if(r)return t(r),void 0;n.forEach(function(t){e+=t}),t(null,e)})},u.prototype.submit=function(t,e){var r,i,s={method:"post"};return"string"==typeof t?(t=a(t),i=p({port:t.port,path:t.pathname,host:t.hostname,protocol:t.protocol},s)):(i=p(t,s)).port||(i.port="https:"==i.protocol?443:80),i.headers=this.getHeaders(t.headers),r="https:"==i.protocol?o.request(i):n.request(i),this.getLength(function(t,n){if(t)return this._error(t),void 0;r.setHeader("Content-Length",n),this.pipe(r),e&&(r.on("error",e),r.on("response",e.bind(this,null)))}.bind(this)),r},u.prototype._error=function(t){this.error||(this.error=t,this.pause(),this.emit("error",t))},u.prototype.toString=function(){return"[object FormData]"};