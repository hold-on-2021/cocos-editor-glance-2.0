var t=require("fs"),e=require("glob"),i=require("async"),s=require("path"),n=require("archiver-utils"),r=require("util").inherits,o=require("./error"),a=require("readable-stream").Transform,u="win32"===process.platform,h=function(t,e){if(!(this instanceof h))return new h(t,e);"string"!=typeof t&&(e=t,t="zip"),e=this.options=n.defaults(e,{highWaterMark:1048576,statConcurrency:4}),a.call(this,e),this._format=!1,this._module=!1,this._pending=0,this._pointer=0,this._entriesCount=0,this._entriesProcessedCount=0,this._fsEntriesTotalBytes=0,this._fsEntriesProcessedBytes=0,this._queue=i.queue(this._onQueueTask.bind(this),1),this._queue.drain=this._onQueueDrain.bind(this),this._statQueue=i.queue(this._onStatQueueTask.bind(this),e.statConcurrency),this._state={aborted:!1,finalize:!1,finalizing:!1,finalized:!1,modulePiped:!1},this._streams=[]};r(h,a),h.prototype._abort=function(){this._state.aborted=!0,this._queue.kill(),this._statQueue.kill(),this._queue.idle()&&this._shutdown()},h.prototype._append=function(e,i){var s={source:null,filepath:e};(i=i||{}).name||(i.name=e),i.sourcePath=e,s.data=i,this._entriesCount++,i.stats&&i.stats instanceof t.Stats?(s=this._updateQueueTaskWithStats(s,i.stats))&&(i.stats.size&&(this._fsEntriesTotalBytes+=i.stats.size),this._queue.push(s)):this._statQueue.push(s)},h.prototype._finalize=function(){this._state.finalizing||this._state.finalized||this._state.aborted||(this._state.finalizing=!0,this._moduleFinalize(),this._state.finalizing=!1,this._state.finalized=!0)},h.prototype._maybeFinalize=function(){return!(this._state.finalizing||this._state.finalized||this._state.aborted)&&(!!(this._state.finalize&&0===this._pending&&this._queue.idle()&&this._statQueue.idle())&&(this._finalize(),!0))},h.prototype._moduleAppend=function(t,e,i){if(this._state.aborted)return i(),void 0;this._module.append(t,e,function(t){return this._task=null,this._state.aborted?(this._shutdown(),void 0):t?(this.emit("error",t),setImmediate(i),void 0):(this.emit("entry",e),this._entriesProcessedCount++,e.stats&&e.stats.size&&(this._fsEntriesProcessedBytes+=e.stats.size),this.emit("progress",{entries:{total:this._entriesCount,processed:this._entriesProcessedCount},fs:{totalBytes:this._fsEntriesTotalBytes,processedBytes:this._fsEntriesProcessedBytes}}),setImmediate(i),void 0)}.bind(this))},h.prototype._moduleFinalize=function(){"function"==typeof this._module.finalize?this._module.finalize():"function"==typeof this._module.end?this._module.end():this.emit("error",new o("NOENDMETHOD"))},h.prototype._modulePipe=function(){this._module.on("error",this._onModuleError.bind(this)),this._module.pipe(this),this._state.modulePiped=!0},h.prototype._moduleSupports=function(t){return!(!this._module.supports||!this._module.supports[t])&&this._module.supports[t]},h.prototype._moduleUnpipe=function(){this._module.unpipe(this),this._state.modulePiped=!1},h.prototype._normalizeEntryData=function(t,e){t=n.defaults(t,{type:"file",name:null,date:null,mode:null,prefix:null,sourcePath:null,stats:!1}),e&&!1===t.stats&&(t.stats=e);var i="directory"===t.type;return t.name&&("string"==typeof t.prefix&&""!==t.prefix&&(t.name=t.prefix+"/"+t.name,t.prefix=null),t.name=n.sanitizePath(t.name),"symlink"!==t.type&&"/"===t.name.slice(-1)?(i=!0,t.type="directory"):i&&(t.name+="/")),"number"==typeof t.mode?t.mode&=u?511:4095:t.stats&&null===t.mode?(t.mode=u?511&t.stats.mode:4095&t.stats.mode,u&&i&&(t.mode=493)):null===t.mode&&(t.mode=i?493:420),t.stats&&null===t.date?t.date=t.stats.mtime:t.date=n.dateify(t.date),t},h.prototype._onModuleError=function(t){this.emit("error",t)},h.prototype._onQueueDrain=function(){this._state.finalizing||this._state.finalized||this._state.aborted||this._state.finalize&&0===this._pending&&this._queue.idle()&&this._statQueue.idle()&&this._finalize()},h.prototype._onQueueTask=function(t,e){if(this._state.finalizing||this._state.finalized||this._state.aborted)return e(),void 0;this._task=t,this._moduleAppend(t.source,t.data,e)},h.prototype._onStatQueueTask=function(e,i){if(this._state.finalizing||this._state.finalized||this._state.aborted)return i(),void 0;t.lstat(e.filepath,function(t,s){return this._state.aborted?(setImmediate(i),void 0):t?(this._entriesCount--,this.emit("warning",t),setImmediate(i),void 0):((e=this._updateQueueTaskWithStats(e,s))&&(s.size&&(this._fsEntriesTotalBytes+=s.size),this._queue.push(e)),setImmediate(i),void 0)}.bind(this))},h.prototype._shutdown=function(){this._moduleUnpipe(),this.end()},h.prototype._transform=function(t,e,i){t&&(this._pointer+=t.length),i(null,t)},h.prototype._updateQueueTaskWithStats=function(e,i){if(i.isFile())e.data.type="file",e.data.sourceType="stream",e.source=n.lazyReadStream(e.filepath);else if(i.isDirectory()&&this._moduleSupports("directory"))e.data.name=n.trailingSlashIt(e.data.name),e.data.type="directory",e.data.sourcePath=n.trailingSlashIt(e.filepath),e.data.sourceType="buffer",e.source=Buffer.concat([]);else{if(!i.isSymbolicLink()||!this._moduleSupports("symlink"))return i.isDirectory()?this.emit("warning",new o("DIRECTORYNOTSUPPORTED",e.data)):i.isSymbolicLink()?this.emit("warning",new o("SYMLINKNOTSUPPORTED",e.data)):this.emit("warning",new o("ENTRYNOTSUPPORTED",e.data)),null;var r=t.readlinkSync(e.filepath),a=s.dirname(e.filepath);e.data.type="symlink",e.data.linkname=s.relative(a,s.resolve(a,r)),e.data.sourceType="buffer",e.source=Buffer.concat([])}return e.data=this._normalizeEntryData(e.data,i),e},h.prototype.abort=function(){return this._state.aborted||this._state.finalized?this:(this._abort(),this)},h.prototype.append=function(t,e){if(this._state.finalize||this._state.aborted)return this.emit("error",new o("QUEUECLOSED")),this;if("string"!=typeof(e=this._normalizeEntryData(e)).name||0===e.name.length)return this.emit("error",new o("ENTRYNAMEREQUIRED")),this;if("directory"===e.type&&!this._moduleSupports("directory"))return this.emit("error",new o("DIRECTORYNOTSUPPORTED",{name:e.name})),this;if(t=n.normalizeInputSource(t),Buffer.isBuffer(t))e.sourceType="buffer";else{if(!n.isStream(t))return this.emit("error",new o("INPUTSTEAMBUFFERREQUIRED",{name:e.name})),this;e.sourceType="stream"}return this._entriesCount++,this._queue.push({data:e,source:t}),this},h.prototype.directory=function(t,i,s){if(this._state.finalize||this._state.aborted)return this.emit("error",new o("QUEUECLOSED")),this;if("string"!=typeof t||0===t.length)return this.emit("error",new o("DIRECTORYDIRPATHREQUIRED")),this;this._pending++,!1===i?i="":"string"!=typeof i&&(i=t);var n=!1;"function"==typeof s?(n=s,s={}):"object"!=typeof s&&(s={});var r=e("**",{stat:!1,dot:!0,cwd:t});return r.on("error",function(t){this.emit("error",t)}.bind(this)),r.on("match",function(e){var a=!1,u=Object.assign({},s);u.name=e,u.prefix=i,e=r._makeAbs(e);try{if(n)if(!1===(u=n(u)))a=!0;else if("object"!=typeof u)throw new o("DIRECTORYFUNCTIONINVALIDDATA",{dirpath:t})}catch(t){return this.emit("error",t),void 0}a||this._append(e,u)}.bind(this)),r.on("end",function(){this._pending--,this._maybeFinalize()}.bind(this)),this},h.prototype.file=function(t,e){return this._state.finalize||this._state.aborted?(this.emit("error",new o("QUEUECLOSED")),this):"string"!=typeof t||0===t.length?(this.emit("error",new o("FILEFILEPATHREQUIRED")),this):(this._append(t,e),this)},h.prototype.glob=function(t,i,s){this._pending++,i=n.defaults(i,{stat:!1});var r=e(t,i);return r.on("error",function(t){this.emit("error",t)}.bind(this)),r.on("match",function(t){var e=Object.assign({},s);i.cwd&&(e.name=t,t=r._makeAbs(t)),this._append(t,e)}.bind(this)),r.on("end",function(){this._pending--,this._maybeFinalize()}.bind(this)),this},h.prototype.finalize=function(){if(this._state.aborted)return this.emit("error",new o("ABORTED")),this;if(this._state.finalize)return this.emit("error",new o("FINALIZING")),this;this._state.finalize=!0,0===this._pending&&this._queue.idle()&&this._statQueue.idle()&&this._finalize();var t=this;return new Promise(function(e,i){var s;t._module.on("end",function(){s||e()}),t._module.on("error",function(t){s=!0,i(t)})})},h.prototype.setFormat=function(t){return this._format?(this.emit("error",new o("FORMATSET")),this):(this._format=t,this)},h.prototype.setModule=function(t){return this._state.aborted?(this.emit("error",new o("ABORTED")),this):this._state.module?(this.emit("error",new o("MODULESET")),this):(this._module=t,this._modulePipe(),this)},h.prototype.symlink=function(t,e){if(this._state.finalize||this._state.aborted)return this.emit("error",new o("QUEUECLOSED")),this;if("string"!=typeof t||0===t.length)return this.emit("error",new o("SYMLINKFILEPATHREQUIRED")),this;if("string"!=typeof e||0===e.length)return this.emit("error",new o("SYMLINKTARGETREQUIRED",{filepath:t})),this;if(!this._moduleSupports("symlink"))return this.emit("error",new o("SYMLINKNOTSUPPORTED",{filepath:t})),this;var i={type:"symlink"};return i.name=t.replace(/\\/g,"/"),i.linkname=e.replace(/\\/g,"/"),i.sourceType="buffer",this._entriesCount++,this._queue.push({data:i,source:Buffer.concat([])}),this},h.prototype.pointer=function(){return this._pointer},h.prototype.use=function(t){return this._streams.push(t),this},module.exports=h;