(function(){var t,i,s,e,h,n,r,l,a,o,u=function(t,i){if(!(t instanceof i))throw new Error("Bound instance method accessed before binding")},d=[].indexOf;i=require("lodash/assignIn"),s=require("lodash/isArray"),r=require("lodash/isString"),e=require("lodash/isFunction"),h=require("lodash/isNumber"),n=require("lodash/isObject"),l=require("lodash/size"),a=require("lodash/template"),o=require("clone"),t=require("events").EventEmitter,module.exports=function(){class c extends t{constructor(t={}){super(),this.get=this.get.bind(this),this.mget=this.mget.bind(this),this.set=this.set.bind(this),this.del=this.del.bind(this),this.ttl=this.ttl.bind(this),this.getTtl=this.getTtl.bind(this),this.keys=this.keys.bind(this),this.getStats=this.getStats.bind(this),this.flushAll=this.flushAll.bind(this),this.close=this.close.bind(this),this._checkData=this._checkData.bind(this),this._check=this._check.bind(this),this._isInvalidKey=this._isInvalidKey.bind(this),this._wrap=this._wrap.bind(this),this._getValLength=this._getValLength.bind(this),this._error=this._error.bind(this),this._initErrors=this._initErrors.bind(this),this.options=t,this._initErrors(),this.data={},this.options=i({forceString:!1,objectValueSize:80,promiseValueSize:80,arrayValueSize:40,stdTTL:0,checkperiod:600,useClones:!0,errorOnMissing:!1,deleteOnExpire:!0},this.options),this.stats={hits:0,misses:0,keys:0,ksize:0,vsize:0},this.validKeyTypes=["string","number"],this._checkData()}get(t,i,s){var e,h,n;if(u(this,c),"boolean"==typeof i&&2===arguments.length&&(s=i,i=void 0),null!=(n=this._isInvalidKey(t))){if(null!=i)return i(n),void 0;throw n}if(null!=this.data[t]&&this._check(t,this.data[t]))return this.stats.hits++,h=this._unwrap(this.data[t]),null!=i&&i(null,h),h;if(this.stats.misses++,!this.options.errorOnMissing&&!s)return null!=i&&i(null,void 0),void 0;if(null!=(e=this._error("ENOTFOUND",{key:t},i)))throw e}mget(t,i){var e,h,n,r,l,a;if(u(this,c),!s(t))return e=this._error("EKEYSTYPE"),null!=i&&i(e),e;for(a={},n=0,l=t.length;n<l;n++){if(r=t[n],null!=(h=this._isInvalidKey(r))){if(null!=i)return i(h),void 0;throw h}null!=this.data[r]&&this._check(r,this.data[r])?(this.stats.hits++,a[r]=this._unwrap(this.data[r])):this.stats.misses++}return null!=i&&i(null,a),a}set(t,i,s,h){var n,l;if(u(this,c),this.options.forceString&&!r(i)&&(i=JSON.stringify(i)),3===arguments.length&&e(s)&&(h=s,s=this.options.stdTTL),null!=(n=this._isInvalidKey(t))){if(null!=h)return h(n),void 0;throw n}return l=!1,this.data[t]&&(l=!0,this.stats.vsize-=this._getValLength(this._unwrap(this.data[t],!1))),this.data[t]=this._wrap(i,s),this.stats.vsize+=this._getValLength(i),l||(this.stats.ksize+=this._getKeyLength(t),this.stats.keys++),this.emit("set",t,i),null!=h&&h(null,!0),!0}del(t,i){var e,h,n,r,l,a;for(u(this,c),s(t)||(t=[t]),e=0,n=0,l=t.length;n<l;n++){if(r=t[n],null!=(h=this._isInvalidKey(r))){if(null!=i)return i(h),void 0;throw h}null!=this.data[r]?(this.stats.vsize-=this._getValLength(this._unwrap(this.data[r],!1)),this.stats.ksize-=this._getKeyLength(r),this.stats.keys--,e++,a=this.data[r],delete this.data[r],this.emit("del",r,a.v)):this.stats.misses++}return null!=i&&i(null,e),e}ttl(){var t,i,s,e,h,n,r,l;for(u(this,c),[n,...i]=arguments,h=0,r=i.length;h<r;h++)switch(typeof(t=i[h])){case"number":l=t;break;case"function":s=t}if(l||(l=this.options.stdTTL),!n)return null!=s&&s(null,!1),!1;if(null!=(e=this._isInvalidKey(n))){if(null!=s)return s(e),void 0;throw e}return null!=this.data[n]&&this._check(n,this.data[n])?(l>=0?this.data[n]=this._wrap(this.data[n].v,l,!1):this.del(n),null!=s&&s(null,!0),!0):(null!=s&&s(null,!1),!1)}getTtl(t,i){var s,e;if(u(this,c),!t)return null!=i&&i(null,void 0),void 0;if(null!=(e=this._isInvalidKey(t))){if(null!=i)return i(e),void 0;throw e}return null!=this.data[t]&&this._check(t,this.data[t])?(s=this.data[t].t,null!=i&&i(null,s),s):(null!=i&&i(null,void 0),void 0)}keys(t){var i;return u(this,c),i=Object.keys(this.data),null!=t&&t(null,i),i}getStats(){return u(this,c),this.stats}flushAll(t=!0){u(this,c),this.data={},this.stats={hits:0,misses:0,keys:0,ksize:0,vsize:0},this._killCheckPeriod(),this._checkData(t),this.emit("flush")}close(){u(this,c),this._killCheckPeriod()}_checkData(t=!0){var i,s,e;for(i in u(this,c),s=this.data)e=s[i],this._check(i,e);t&&this.options.checkperiod>0&&(this.checkTimeout=setTimeout(this._checkData,1e3*this.options.checkperiod,t),null!=this.checkTimeout.unref&&this.checkTimeout.unref())}_killCheckPeriod(){if(null!=this.checkTimeout)return clearTimeout(this.checkTimeout)}_check(t,i){var s;return u(this,c),s=!0,0!==i.t&&i.t<Date.now()&&(this.options.deleteOnExpire&&(s=!1,this.del(t)),this.emit("expired",t,this._unwrap(i))),s}_isInvalidKey(t){var i;if(u(this,c),i=typeof t,d.call(this.validKeyTypes,i)<0)return this._error("EKEYTYPE",{type:typeof t})}_wrap(t,i,s=!0){var e;return u(this,c),this.options.useClones||(s=!1),e=Date.now(),0,1e3,{t:0===i?0:i?e+1e3*i:0===this.options.stdTTL?this.options.stdTTL:e+1e3*this.options.stdTTL,v:s?o(t):t}}_unwrap(t,i=!0){return this.options.useClones||(i=!1),null!=t.v?i?o(t.v):t.v:null}_getKeyLength(t){return t.length}_getValLength(t){return u(this,c),r(t)?t.length:this.options.forceString?JSON.stringify(t).length:s(t)?this.options.arrayValueSize*t.length:h(t)?8:"function"==typeof(null!=t?t.then:void 0)?this.options.promiseValueSize:n(t)?this.options.objectValueSize*l(t):0}_error(t,i={},s){var h;if(u(this,c),(h=new Error).name=t,h.errorcode=t,h.message=null!=this.ERRORS[t]?this.ERRORS[t](i):"-",h.data=i,!s||!e(s))return h;s(h,null)}_initErrors(){var t,i,s;for(i in u(this,c),this.ERRORS={},s=this._ERRORS)t=s[i],this.ERRORS[i]=a(t)}}return c.prototype._ERRORS={ENOTFOUND:"Key `<%= key %>` not found",EKEYTYPE:"The key argument has to be of type `string` or `number`. Found: `<%= type %>`",EKEYSTYPE:"The keys argument has to be an array."},c}.call(this)}).call(this);