var e=require("once"),r=function(){},n=function(o,t,i){if("function"==typeof t)return n(o,null,t);t||(t={}),i=e(i||r);var l=o._writableState,s=o._readableState,c=t.readable||!1!==t.readable&&o.readable,a=t.writable||!1!==t.writable&&o.writable,u=!1,d=function(){o.writable||f()},f=function(){a=!1,c||i.call(o)},m=function(){c=!1,a||i.call(o)},v=function(e){i.call(o,e?new Error("exited with error code: "+e):null)},b=function(e){i.call(o,e)},L=function(){process.nextTick(w)},w=function(){if(!u)return(!c||s&&s.ended&&!s.destroyed)&&(!a||l&&l.ended&&!l.destroyed)?void 0:i.call(o,new Error("premature close"))},p=function(){o.req.on("finish",f)};return!function(e){return e.setHeader&&"function"==typeof e.abort}(o)?a&&!l&&(o.on("end",d),o.on("close",d)):(o.on("complete",f),o.on("abort",L),o.req?p():o.on("request",p)),function(e){return e.stdio&&Array.isArray(e.stdio)&&3===e.stdio.length}(o)&&o.on("exit",v),o.on("end",m),o.on("finish",f),!1!==t.error&&o.on("error",b),o.on("close",L),function(){u=!0,o.removeListener("complete",f),o.removeListener("abort",L),o.removeListener("request",p),o.req&&o.req.removeListener("finish",f),o.removeListener("end",d),o.removeListener("close",d),o.removeListener("finish",f),o.removeListener("exit",v),o.removeListener("end",m),o.removeListener("error",b),o.removeListener("close",L)}};module.exports=n;