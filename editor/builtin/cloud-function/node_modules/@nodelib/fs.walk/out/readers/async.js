"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t=require("events"),e=require("@nodelib/fs.scandir"),r=require("fastq"),i=require("./common"),s=require("./reader");exports.default=class extends s.default{constructor(i,s){super(i,s),this._settings=s,this._scandir=e.scandir,this._emitter=new t.EventEmitter,this._queue=r(this._worker.bind(this),this._settings.concurrency),this._isFatalError=!1,this._isDestroyed=!1,this._queue.drain=(()=>{this._isFatalError||this._emitter.emit("end")})}read(){return this._isFatalError=!1,this._isDestroyed=!1,setImmediate(()=>{this._pushToQueue(this._root,this._settings.basePath)}),this._emitter}destroy(){if(this._isDestroyed)throw new Error("The reader is already destroyed");this._isDestroyed=!0,this._queue.killAndDrain()}onEntry(t){this._emitter.on("entry",t)}onError(t){this._emitter.once("error",t)}onEnd(t){this._emitter.once("end",t)}_pushToQueue(t,e){const r={directory:t,base:e};this._queue.push(r,t=>{null!==t&&this._handleError(t)})}_worker(t,e){this._scandir(t.directory,this._settings.fsScandirSettings,(r,i)=>{if(null!==r)return e(r,void 0);for(const e of i)this._handleEntry(e,t.base);e(null,void 0)})}_handleError(t){i.isFatalError(this._settings,t)&&(this._isFatalError=!0,this._isDestroyed=!0,this._emitter.emit("error",t))}_handleEntry(t,e){if(this._isDestroyed||this._isFatalError)return;const r=t.path;void 0!==e&&(t.path=i.joinPathSegments(e,t.name,this._settings.pathSegmentSeparator)),i.isAppliedFilter(this._settings.entryFilter,t)&&this._emitEntry(t),t.dirent.isDirectory()&&i.isAppliedFilter(this._settings.deepFilter,t)&&this._pushToQueue(r,t.path)}_emitEntry(t){this._emitter.emit("entry",t)}};