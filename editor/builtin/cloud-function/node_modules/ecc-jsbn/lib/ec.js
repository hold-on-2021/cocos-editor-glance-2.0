var t=require("jsbn").BigInteger,i=t.prototype.Barrett;function e(t,i){this.x=i,this.q=t}function r(i,e,r,s){this.curve=i,this.x=e,this.y=r,this.z=null==s?t.ONE:s,this.zinv=null}function s(t,e,s){this.q=t,this.a=this.fromBigInteger(e),this.b=this.fromBigInteger(s),this.infinity=new r(this,null,null),this.reducer=new i(this.q)}e.prototype.equals=function(t){return t==this||this.q.equals(t.q)&&this.x.equals(t.x)},e.prototype.toBigInteger=function(){return this.x},e.prototype.negate=function(){return new e(this.q,this.x.negate().mod(this.q))},e.prototype.add=function(t){return new e(this.q,this.x.add(t.toBigInteger()).mod(this.q))},e.prototype.subtract=function(t){return new e(this.q,this.x.subtract(t.toBigInteger()).mod(this.q))},e.prototype.multiply=function(t){return new e(this.q,this.x.multiply(t.toBigInteger()).mod(this.q))},e.prototype.square=function(){return new e(this.q,this.x.square().mod(this.q))},e.prototype.divide=function(t){return new e(this.q,this.x.multiply(t.toBigInteger().modInverse(this.q)).mod(this.q))},r.prototype.getX=function(){null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q));var t=this.x.toBigInteger().multiply(this.zinv);return this.curve.reduce(t),this.curve.fromBigInteger(t)},r.prototype.getY=function(){null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q));var t=this.y.toBigInteger().multiply(this.zinv);return this.curve.reduce(t),this.curve.fromBigInteger(t)},r.prototype.equals=function(i){return i==this||(this.isInfinity()?i.isInfinity():i.isInfinity()?this.isInfinity():!!i.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(i.z)).mod(this.curve.q).equals(t.ZERO)&&i.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(i.z)).mod(this.curve.q).equals(t.ZERO))},r.prototype.isInfinity=function(){return null==this.x&&null==this.y||this.z.equals(t.ZERO)&&!this.y.toBigInteger().equals(t.ZERO)},r.prototype.negate=function(){return new r(this.curve,this.x,this.y.negate(),this.z)},r.prototype.add=function(i){if(this.isInfinity())return i;if(i.isInfinity())return this;var e=i.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(i.z)).mod(this.curve.q),s=i.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(i.z)).mod(this.curve.q);if(t.ZERO.equals(s))return t.ZERO.equals(e)?this.twice():this.curve.getInfinity();var n=new t("3"),u=this.x.toBigInteger(),o=this.y.toBigInteger(),h=(i.x.toBigInteger(),i.y.toBigInteger(),s.square()),l=h.multiply(s),g=u.multiply(h),p=e.square().multiply(this.z),c=p.subtract(g.shiftLeft(1)).multiply(i.z).subtract(l).multiply(s).mod(this.curve.q),a=g.multiply(n).multiply(e).subtract(o.multiply(l)).subtract(p.multiply(e)).multiply(i.z).add(e.multiply(l)).mod(this.curve.q),m=l.multiply(this.z).multiply(i.z).mod(this.curve.q);return new r(this.curve,this.curve.fromBigInteger(c),this.curve.fromBigInteger(a),m)},r.prototype.twice=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var i=new t("3"),e=this.x.toBigInteger(),s=this.y.toBigInteger(),n=s.multiply(this.z),u=n.multiply(s).mod(this.curve.q),o=this.curve.a.toBigInteger(),h=e.square().multiply(i);t.ZERO.equals(o)||(h=h.add(this.z.square().multiply(o)));var l=(h=h.mod(this.curve.q)).square().subtract(e.shiftLeft(3).multiply(u)).shiftLeft(1).multiply(n).mod(this.curve.q),g=h.multiply(i).multiply(e).subtract(u.shiftLeft(1)).shiftLeft(2).multiply(u).subtract(h.square().multiply(h)).mod(this.curve.q),p=n.square().multiply(n).shiftLeft(3).mod(this.curve.q);return new r(this.curve,this.curve.fromBigInteger(l),this.curve.fromBigInteger(g),p)},r.prototype.multiply=function(i){if(this.isInfinity())return this;if(0==i.signum())return this.curve.getInfinity();var e,r=i,s=r.multiply(new t("3")),n=this.negate(),u=this;for(e=s.bitLength()-2;e>0;--e){u=u.twice();var o=s.testBit(e);o!=r.testBit(e)&&(u=u.add(o?this:n))}return u},r.prototype.multiplyTwo=function(t,i,e){var r;r=t.bitLength()>e.bitLength()?t.bitLength()-1:e.bitLength()-1;for(var s=this.curve.getInfinity(),n=this.add(i);r>=0;)s=s.twice(),t.testBit(r)?s=e.testBit(r)?s.add(n):s.add(this):e.testBit(r)&&(s=s.add(i)),--r;return s},s.prototype.getQ=function(){return this.q},s.prototype.getA=function(){return this.a},s.prototype.getB=function(){return this.b},s.prototype.equals=function(t){return t==this||this.q.equals(t.q)&&this.a.equals(t.a)&&this.b.equals(t.b)},s.prototype.getInfinity=function(){return this.infinity},s.prototype.fromBigInteger=function(t){return new e(this.q,t)},s.prototype.reduce=function(t){this.reducer.reduce(t)},s.prototype.encodePointHex=function(t){if(t.isInfinity())return"00";var i=t.getX().toBigInteger().toString(16),e=t.getY().toBigInteger().toString(16),r=this.getQ().toString(16).length;for(r%2!=0&&r++;i.length<r;)i="0"+i;for(;e.length<r;)e="0"+e;return"04"+i+e},s.prototype.decodePointHex=function(i){var e;switch(parseInt(i.substr(0,2),16)){case 0:return this.infinity;case 2:e=!1;case 3:void 0==e&&(e=!0);var s=i.length-2,n=i.substr(2,s),u=this.fromBigInteger(new t(n,16)),o=u.multiply(u.square().add(this.getA())).add(this.getB()).sqrt();if(null==o)throw"Invalid point compression";var h=o.toBigInteger();return h.testBit(0)!=e&&(o=this.fromBigInteger(this.getQ().subtract(h))),new r(this,u,o);case 4:case 6:case 7:s=(i.length-2)/2,n=i.substr(2,s);var l=i.substr(s+2,s);return new r(this,this.fromBigInteger(new t(n,16)),this.fromBigInteger(new t(l,16)));default:return null}},s.prototype.encodeCompressedPointHex=function(t){if(t.isInfinity())return"00";var i=t.getX().toBigInteger().toString(16),e=this.getQ().toString(16).length;for(e%2!=0&&e++;i.length<e;)i="0"+i;return(t.getY().toBigInteger().isEven()?"02":"03")+i},e.prototype.getR=function(){if(void 0!=this.r)return this.r;this.r=null;var i=this.q.bitLength();i>128&&(-1==this.q.shiftRight(i-64).intValue()&&(this.r=t.ONE.shiftLeft(i).subtract(this.q)));return this.r},e.prototype.modMult=function(t,i){return this.modReduce(t.multiply(i))},e.prototype.modReduce=function(i){if(null!=this.getR()){for(var e=q.bitLength();i.bitLength()>e+1;){var r=i.shiftRight(e),s=i.subtract(r.shiftLeft(e));this.getR().equals(t.ONE)||(r=r.multiply(this.getR())),i=r.add(s)}for(;i.compareTo(q)>=0;)i=i.subtract(q)}else i=i.mod(q);return i},e.prototype.sqrt=function(){if(!this.q.testBit(0))throw"unsupported";if(this.q.testBit(1)){var i=new e(this.q,this.x.modPow(this.q.shiftRight(2).add(t.ONE),this.q));return i.square().equals(this)?i:null}var r=this.q.subtract(t.ONE),s=r.shiftRight(1);if(!this.x.modPow(s,this.q).equals(t.ONE))return null;var n,u,o=r.shiftRight(2).shiftLeft(1).add(t.ONE),h=this.x,l=modDouble(modDouble(h));do{var g;do{g=new t(this.q.bitLength(),new SecureRandom)}while(g.compareTo(this.q)>=0||!g.multiply(g).subtract(l).modPow(s,this.q).equals(r));var p=this.lucasSequence(g,h,o);if(n=p[0],u=p[1],this.modMult(u,u).equals(l))return u.testBit(0)&&(u=u.add(q)),u=u.shiftRight(1),new e(q,u)}while(n.equals(t.ONE)||n.equals(r));return null},e.prototype.lucasSequence=function(i,e,r){for(var s=r.bitLength(),n=r.getLowestSetBit(),u=t.ONE,o=t.TWO,h=i,l=t.ONE,g=t.ONE,p=s-1;p>=n+1;--p)l=this.modMult(l,g),r.testBit(p)?(g=this.modMult(l,e),u=this.modMult(u,h),o=this.modReduce(h.multiply(o).subtract(i.multiply(l))),h=this.modReduce(h.multiply(h).subtract(g.shiftLeft(1)))):(g=l,u=this.modReduce(u.multiply(o).subtract(l)),h=this.modReduce(h.multiply(o).subtract(i.multiply(l))),o=this.modReduce(o.multiply(o).subtract(l.shiftLeft(1))));l=this.modMult(l,g),g=this.modMult(l,e),u=this.modReduce(u.multiply(o).subtract(l)),o=this.modReduce(h.multiply(o).subtract(i.multiply(l))),l=this.modMult(l,g);for(p=1;p<=n;++p)u=this.modMult(u,o),o=this.modReduce(o.multiply(o).subtract(l.shiftLeft(1))),l=this.modMult(l,l);return[u,o]};var n={ECCurveFp:s,ECPointFp:r,ECFieldElementFp:e};module.exports=n;