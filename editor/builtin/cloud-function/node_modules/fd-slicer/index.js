var t=require("fs"),e=require("util"),r=require("stream"),n=r.Readable,o=r.Writable,i=r.PassThrough,s=require("pend"),f=require("events").EventEmitter;function u(t,e){e=e||{},f.call(this),this.fd=t,this.pend=new s,this.pend.max=1,this.refCount=0,this.autoClose=!!e.autoClose}function d(t,e){e=e||{},n.call(this,e),this.context=t,this.context.ref(),this.start=e.start||0,this.endOffset=e.end,this.pos=this.start,this.destroyed=!1}function h(t,e){e=e||{},o.call(this,e),this.context=t,this.context.ref(),this.start=e.start||0,this.endOffset=null==e.end?1/0:+e.end,this.bytesWritten=0,this.pos=this.start,this.destroyed=!1,this.on("finish",this.destroy.bind(this))}function a(t,e){f.call(this),e=e||{},this.refCount=0,this.buffer=t,this.maxChunkSize=e.maxChunkSize||Number.MAX_SAFE_INTEGER}exports.createFromBuffer=function(t,e){return new a(t,e)},exports.createFromFd=function(t,e){return new u(t,e)},exports.BufferSlicer=a,exports.FdSlicer=u,e.inherits(u,f),u.prototype.read=function(e,r,n,o,i){var s=this;s.pend.go(function(f){t.read(s.fd,e,r,n,o,function(t,e,r){f(),i(t,e,r)})})},u.prototype.write=function(e,r,n,o,i){var s=this;s.pend.go(function(f){t.write(s.fd,e,r,n,o,function(t,e,r){f(),i(t,e,r)})})},u.prototype.createReadStream=function(t){return new d(this,t)},u.prototype.createWriteStream=function(t){return new h(this,t)},u.prototype.ref=function(){this.refCount+=1},u.prototype.unref=function(){var e=this;if(e.refCount-=1,!(e.refCount>0)){if(e.refCount<0)throw new Error("invalid unref");e.autoClose&&t.close(e.fd,function(t){t?e.emit("error",t):e.emit("close")})}},e.inherits(d,n),d.prototype._read=function(e){var r=this;if(!r.destroyed){var n=Math.min(r._readableState.highWaterMark,e);if(null!=r.endOffset&&(n=Math.min(n,r.endOffset-r.pos)),n<=0)return r.destroyed=!0,r.push(null),r.context.unref(),void 0;r.context.pend.go(function(e){if(r.destroyed)return e();var o=new Buffer(n);t.read(r.context.fd,o,0,n,r.pos,function(t,n){t?r.destroy(t):0===n?(r.destroyed=!0,r.push(null),r.context.unref()):(r.pos+=n,r.push(o.slice(0,n))),e()})})}},d.prototype.destroy=function(t){this.destroyed||(t=t||new Error("stream destroyed"),this.destroyed=!0,this.emit("error",t),this.context.unref())},e.inherits(h,o),h.prototype._write=function(e,r,n){var o=this;if(!o.destroyed){if(o.pos+e.length>o.endOffset){var i=new Error("maximum file length exceeded");return i.code="ETOOBIG",o.destroy(),n(i),void 0}o.context.pend.go(function(r){if(o.destroyed)return r();t.write(o.context.fd,e,0,e.length,o.pos,function(t,e){t?(o.destroy(),r(),n(t)):(o.bytesWritten+=e,o.pos+=e,o.emit("progress"),r(),n())})})}},h.prototype.destroy=function(){this.destroyed||(this.destroyed=!0,this.context.unref())},e.inherits(a,f),a.prototype.read=function(t,e,r,n,o){var i=n+r,s=i-this.buffer.length,f=s>0?s:r;this.buffer.copy(t,e,n,i),setImmediate(function(){o(null,f)})},a.prototype.write=function(t,e,r,n,o){t.copy(this.buffer,n,e,e+r),setImmediate(function(){o(null,r,t)})},a.prototype.createReadStream=function(t){var e=new i(t=t||{});e.destroyed=!1,e.start=t.start||0,e.endOffset=t.end,e.pos=e.endOffset||this.buffer.length;for(var r=this.buffer.slice(e.start,e.pos),n=0;;){var o=n+this.maxChunkSize;if(o>=r.length){n<r.length&&e.write(r.slice(n,r.length));break}e.write(r.slice(n,o)),n=o}return e.end(),e.destroy=function(){e.destroyed=!0},e},a.prototype.createWriteStream=function(t){var e=this,r=new o(t=t||{});return r.start=t.start||0,r.endOffset=null==t.end?this.buffer.length:+t.end,r.bytesWritten=0,r.pos=r.start,r.destroyed=!1,r._write=function(t,n,o){if(!r.destroyed){var i=r.pos+t.length;if(i>r.endOffset){var s=new Error("maximum file length exceeded");return s.code="ETOOBIG",r.destroyed=!0,o(s),void 0}t.copy(e.buffer,r.pos,0,t.length),r.bytesWritten+=t.length,r.pos=i,r.emit("progress"),o()}},r.destroy=function(){r.destroyed=!0},r},a.prototype.ref=function(){this.refCount+=1},a.prototype.unref=function(){if(this.refCount-=1,this.refCount<0)throw new Error("invalid unref")};