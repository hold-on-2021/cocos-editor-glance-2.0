var e=require("util").inherits,t=require("compress-commons").ZipArchiveOutputStream,n=require("compress-commons").ZipArchiveEntry,i=require("archiver-utils"),r=module.exports=function(e){if(!(this instanceof r))return new r(e);(e=this.options=e||{}).zlib=e.zlib||{},t.call(this,e),"number"==typeof e.level&&e.level>=0&&(e.zlib.level=e.level,delete e.level),e.forceZip64||"number"!=typeof e.zlib.level||0!==e.zlib.level||(e.store=!0),e.comment&&e.comment.length>0&&this.setComment(e.comment)};e(r,t),r.prototype._normalizeFileData=function(e){var t="directory"===(e=i.defaults(e,{type:"file",name:null,linkname:null,date:null,mode:null,store:this.options.store,comment:""})).type,n="symlink"===e.type;return e.name&&(e.name=i.sanitizePath(e.name),n||"/"!==e.name.slice(-1)?t&&(e.name+="/"):(t=!0,e.type="directory")),(t||n)&&(e.store=!0),e.date=i.dateify(e.date),e},r.prototype.entry=function(e,i,r){if("function"!=typeof r&&(r=this._emitErrorCallback.bind(this)),"file"!==(i=this._normalizeFileData(i)).type&&"directory"!==i.type&&"symlink"!==i.type)return r(new Error(i.type+" entries not currently supported")),void 0;if("string"!=typeof i.name||0===i.name.length)return r(new Error("entry name must be a non-empty string value")),void 0;if("symlink"===i.type&&"string"!=typeof i.linkname)return r(new Error("entry linkname must be a non-empty string value when type equals symlink")),void 0;var o=new n(i.name);return o.setTime(i.date,this.options.forceLocalTime),i.store&&o.setMethod(0),i.comment.length>0&&o.setComment(i.comment),"symlink"===i.type&&"number"!=typeof i.mode&&(i.mode=40960),"number"==typeof i.mode&&("symlink"===i.type&&(i.mode|=40960),o.setUnixMode(i.mode)),"symlink"===i.type&&"string"==typeof i.linkname&&(e=Buffer.from(i.linkname)),t.prototype.entry.call(this,o,e,r)},r.prototype.finalize=function(){this.finish()};