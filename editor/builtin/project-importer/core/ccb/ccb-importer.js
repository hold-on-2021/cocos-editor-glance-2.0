"use strict";const e=require("async"),t=require("path"),r=require("fire-fs"),i=require("plist"),a=require("fire-url"),n="db://internal/image/default_sprite_splash.png/default_sprite_splash",o="db://internal/image/default_btn_normal.png/default_btn_normal",c="db://internal/image/default_btn_pressed.png/default_btn_pressed",l="db://internal/image/default_btn_disabled.png/default_btn_disabled",s="db://internal/image/default_scrollbar_vertical.png/default_scrollbar_vertical",d="db://internal/image/default_scrollbar.png/default_scrollbar",u="_action",f=30,p=["cubic","elastic","bounce","back"],v=["In","Out","InOut"],m={CCBFile:function(e,t,r){V(M(_(e),"ccbFile",""),r)},CCScrollView:function(t,r,i){var a=new cc.Node,n=_(t);P(a,n,r);var o=a.addComponent(cc.ScrollView);if(!o)return i(a);o.inertia=M(n,"bounces",!0);var c=M(n,"direction",2);if(o.vertical=1===c||2===c,o.horizontal=0===c||2===c,M(n,"clipsToBounds",!0)){var l=a.addComponent(cc.Mask);l.enabled=!0}var s=M(n,"container",""),d=null;e.waterfall([function(e){V(s,function(t){(d=t).setName("container"),e()})},function(e){if(a.addChild(d),o.content=d,o.vertical){var t=R(cc.Scrollbar.Direction.VERTICAL,"vScrollBar",a.getContentSize());a.addChild(t),o.verticalScrollBar=t.getComponent(cc.Scrollbar)}if(o.horizontal){var r=R(cc.Scrollbar.Direction.HORIZONTAL,"hScrollBar",a.getContentSize());a.addChild(r),o.horizontalScrollBar=r.getComponent(cc.Scrollbar)}e()}],function(){i(d,a)})}},h={CCSprite:function(e,t,r){x(e,t,"displayFrame",cc.Sprite.SizeMode.RAW,r)},CCScale9Sprite:function(t,r,i){e.waterfall([function(e){x(t,r,"spriteFrame",cc.Sprite.SizeMode.CUSTOM,e)},function(e){var i=t.getComponent(cc.Sprite);if(!i)return e(),void 0;var a=t.getContentSize(),n=M(r,"preferedSize",[a.width,a.height,0]);if(t.setContentSize(n[0],n[1]),i.spriteFrame){i.type=cc.Sprite.Type.SLICED;var o=i.spriteFrame._uuid;(function(e,t,r){Editor.assetdb.queryMetaInfoByUuid(t,function(i,a){if(!a)return r();var n=JSON.parse(a.json);n.trimThreshold=-1,n.borderTop=M(e,"insetTop",0),n.borderBottom=M(e,"insetBottom",0),n.borderLeft=M(e,"insetLeft",0),n.borderRight=M(e,"insetRight",0);var o=JSON.stringify(n);Editor.assetdb.saveMeta(t,o,function(){r()})})})(r,o,e)}else e()}],i)},CCLayerColor:function(e,t,r){var i=e.addComponent(cc.Sprite);if(!i)return r();i.sizeMode=cc.Sprite.SizeMode.CUSTOM,i.trim=!1,i.spriteFrame=new cc.SpriteFrame,i.spriteFrame._uuid=Editor.assetdb.remote.urlToUuid(n),r()},CCLabelTTF:B,CCLabelBMFont:B,CCMenuItemImage:function(e,t,r){var i=e.addComponent(cc.Button),a=e.addComponent(cc.Sprite);if(!i)return r();a.sizeMode=cc.Sprite.SizeMode.CUSTOM,a.trim=!1,i.interactable=M(t,"isEnabled",!0),i.transition=cc.Button.Transition.SPRITE;var n=M(t,"normalSpriteFrame",null);a.spriteFrame=k(n,o),i.normalSprite=k(n,o),i.hoverSprite=k(n,o);var s=M(t,"selectedSpriteFrame",null);i.pressedSprite=k(s,c);var d=M(t,"disabledSpriteFrame",null);i.disabledSprite=k(d,l),r()},CCControlButton:function(e,r,i){var a=e.addComponent(cc.Button),n=e.addComponent(cc.Sprite);if(!a)return i();var s=M(r,"preferedSize",[0,0,0]);e.setContentSize(s[0],s[1]),n.sizeMode=cc.Sprite.SizeMode.CUSTOM,n.type=cc.Sprite.Type.SLICED,n.trim=!1,a.interactable=M(r,"enabled",!0),a.transition=cc.Button.Transition.SPRITE;var d=M(r,"backgroundSpriteFrame|1",null);n.spriteFrame=k(d,o),a.normalSprite=k(d,o),a.hoverSprite=k(d,o);var u=M(r,"backgroundSpriteFrame|2",null);a.pressedSprite=k(u,c);var f=M(r,"backgroundSpriteFrame|3",null);a.disabledSprite=k(f,l);var p=M(r,"title|1","");if(p){var v=new cc.Node("title"),m=M(r,"labelAnchorPoint",[0,0]);v.setAnchorPoint(m[0],m[1]),e.addChild(v),D(v,cc.v2(e.getContentSize().width/2,e.getContentSize().height/2));var h=v.addComponent(cc.Label),S=M(r,"titleTTFSize|1",[-1,0]),b=M(r,"titleColor|1",[255,255,255]),C=new cc.Color(b[0],b[1],b[2]);v.color=C,h.string=p,h.lineHeight=0,S[0]>=0&&(h._fontSize=S[0]);var g=M(r,"titleTTF|1","");g&&".ttf"===t.extname(g)&&L(h,g)}i()},CCParticleSystemQuad:function(e,t,r){var i=e.addComponent(cc.ParticleSystem);if(!i)return r();i.custom=!0,i.emitterMode=M(t,"emitterMode",cc.ParticleSystem.EmitterMode.GRAVITY),i.emissionRate=M(t,"emissionRate",10),i.duration=M(t,"duration",-1),i.totalParticles=M(t,"totalParticles",250);var n=M(t,"life",[3,.25]);i.life=n[0],i.lifeVar=n[1];var o=M(t,"startSize",[0,0]);i.startSize=o[0],i.startSizeVar=o[1];var c=M(t,"endSize",[0,0]);i.endSize=c[0],i.endSizeVar=c[1];var l=M(t,"startSpin",[0,0]);i.startSpin=l[0],i.startSpinVar=l[1];var s=M(t,"endSpin",[0,0]);i.endSpin=s[0],i.endSpinVar=s[1];var d=M(t,"angle",[0,0]);i.angle=d[0],i.angleVar=d[1];var u=M(t,"startColor",[[255,255,255,255],[0,0,0,0]]);i.startColor=new cc.Color(O(u[0][0]),O(u[0][1]),O(u[0][2]),O(u[0][3])),i.startColorVar=new cc.Color(O(u[1][0]),O(u[1][1]),O(u[1][2]),O(u[1][3]));var f=M(t,"endColor",[[255,255,255,255],[0,0,0,0]]);i.endColor=new cc.Color(O(f[0][0]),O(f[0][1]),O(f[0][2]),O(f[0][3])),i.endColorVar=new cc.Color(O(f[1][0]),O(f[1][1]),O(f[1][2]),O(f[1][3]));var p=M(t,"blendFunc",[770,771]);i.srcBlendFactor=p[0],i.dstBlendFactor=p[1];var v=M(t,"posVar",[0,0]);if(i.posVar=cc.v2(v[0],v[1]),i.emitterMode===cc.ParticleSystem.EmitterMode.GRAVITY){var m=M(t,"gravity",[0,0]);i.gravity=cc.v2(m[0],m[1]);var h=M(t,"speed",[0,0]);i.speed=h[0],i.speedVar=h[1];var S=M(t,"tangentialAccel",[0,0]);i.tangentialAccel=S[0],i.tangentialAccelVar=S[1];var C=M(t,"radialAccel",[0,0]);i.radialAccel=C[0],i.radialAccelVar=C[1]}else{var g=M(t,"startRadius",[0,0]);i.startRadius=g[0],i.startRadiusVar=g[1];var y=M(t,"endRadius",[0,0]);i.endRadius=y[0],i.endRadiusVar=y[1];var w=M(t,"rotatePerSecond",[0,0]);i.rotatePerS=w[0],i.rotatePerSVar=w[1]}var z=M(t,"texture",null),F=!1;if(!z)return r();var A=a.join(b,z),E=Editor.assetdb.remote.urlToUuid(A);if(!Editor.assetdb.remote.existsByUuid(E))return r();Editor.assetdb.queryMetaInfoByUuid(E,function(e,t){if(e)return Editor.warn(e),r();var n=JSON.parse(t.json);if("raw"===n.type)return Editor.info("The sprite component only supports the texture which imports as sprite type."),r();var o=a.basenameNoExt(t.assetPath),c=n.subMetas[o].uuid;cc.AssetLibrary.loadAsset(c,function(e,t){if(e)return Editor.warn(e),r();i.spriteFrame=t,F=!0,i.enabled=F,r()})})}},S={position:function(e,t,r){r.props.position=[];for(var i=0,a=e.keyframes.length;i<a;i++){var n=e.keyframes[i],o={};o.frame=n.time;var c=D(t,cc.v2(n.value[0],n.value[1]));o.value=[c.x,c.y];var l=T(n);l&&(o.curve=l),r.props.position.push(o)}},rotation:function(e,t,r){r.props.rotation=[];for(var i=0,a=e.keyframes.length;i<a;i++){var n=e.keyframes[i],o={frame:n.time,value:n.value},c=T(n);c&&(o.curve=c),r.props.rotation.push(o)}},scale:function(e,t,r){r.props.scaleX=[],r.props.scaleY=[];for(var i=0,a=e.keyframes.length;i<a;i++){var n=e.keyframes[i],o={frame:n.time,value:n.value[0]},c={frame:n.time,value:n.value[1]},l=T(n);l&&(o.curve=l,c.curve=l),r.props.scaleX.push(o),r.props.scaleY.push(c)}},visible:function(e,t,r){r.props.active=[];for(var i=0,a=e.keyframes.length;i<a;i++){var n=e.keyframes[i];0===i&&n.time>0&&r.props.active.push({frame:0,value:!1});var o={frame:n.time,value:i%2==0};r.props.active.push(o)}},color:function(e,t,r){r.props.color=[];for(var i=0,a=e.keyframes.length;i<a;i++){var n=e.keyframes[i],o={frame:n.time,value:new cc.Color(n.value[0],n.value[1],n.value[2])},c=T(n);c&&(o.curve=c),r.props.color.push(o)}},opacity:function(e,t,r){r.props.opacity=[];for(var i=0,a=e.keyframes.length;i<a;i++){var n=e.keyframes[i],o={frame:n.time,value:n.value},c=T(n);c&&(o.curve=c),r.props.opacity.push(o)}},displayFrame:function(e,t,r){if(!t)return;if(t.getComponent(cc.Sprite)){r.comps["cc.Sprite"]||(r.comps["cc.Sprite"]={});for(var i=[],a=0,n=e.keyframes.length;a<n;a++){var o=e.keyframes[a],c=[o.value[1],o.value[0]],l=k(c,"");if(l){var s={frame:o.time,value:l};i.push(s)}}r.comps["cc.Sprite"].spriteFrame=i}}};var b="",C="",g="",y=[],w={},z=[];function F(n,o){if(y.indexOf(n)>=0)return o();if(Editor.log("Importing ccb file : ",n),!r.existsSync(n))return Editor.warn("%s is not existed!",n),o();var c=t.basename(n,t.extname(n)),l=t.relative(g,t.dirname(n)),s=t.join(C,l,c+".prefab");e.waterfall([function(o){(function(n,o,c){var l=new cc.Node,s=i.parse(r.readFileSync(n,"utf8"));e.waterfall([function(t){w={},z=s.sequences;var r=s.currentResolution,i=s.resolutions,a=new cc.Size(0,0);i&&i[r]&&(a.width=i[r].width,a.height=i[r].height),function t(r,i,a,n,o){var c=r;e.waterfall([function(e){if(r)e();else{var t=i.baseClass,a=m[t];a?a(i,n,function(t,i){r=t,c=i||r,e()}):(r=new cc.Node,c=r,e())}},function(e){i.animatedProperties&&(a?(w.childrenData||(w.childrenData={}),w.childrenData[a]=i.animatedProperties,w.childrenData[a].theNode=r):(w.selfData=i.animatedProperties,w.selfData.theNode=r)),a||r.setName(i.displayName),function(e,t,r,i){var a=t.baseClass,n=_(t);"CCScrollView"!==a&&P(e,n,r);a&&h[a]?h[a](e,n,i):i()}(r,i,n,e)},function(n){var o=i.children;if(!o||0===o.length)return n(),void 0;var c=r.getContentSize(),l=[],s=0;a&&(a+="/"),e.whilst(function(e){e(null,s<o.length)},function(e){var i=function(e,t){var r=e.displayName,i=r.replace("/","_"),a=1;for(;t.indexOf(i)>=0;)i=r+"_"+a,a++;r!==i&&Editor.warn('The name of node "%s" was renamed to "%s".',r,i);return i}(o[s],l),n=a+i;t(null,o[s],n,c,function(t){t.setName(i),l.push(i),r.addChild(t),t.setPosition(D(t)),s++,e()})},function(){n()})}],function(){o(c)})}(l,s.nodeGraph,"",a,function(){t()})},function(i){(function(i,n,o){if(!w.selfData&&!w.childrenData)return o();var c,l,s=[],d=-1;for(c=0,l=z.length;c<l;c++){var p=z[c];s[c]={name:p.name,duration:p.length,sample:f,loop:0===p.chainedSequenceId},p.autoPlay&&(d=c)}w.selfData&&A(w.selfData,"",s);if(w.childrenData)for(var v in w.childrenData)w.childrenData.hasOwnProperty(v)&&A(w.childrenData[v],v,s);var m=function(e){var r=t.dirname(e),i=t.relative(C,r),n=t.basename(e,t.extname(e))+u;a.join(b,i,n);return t.join(C,i,n)}(n);r.existsSync(m)||r.mkdirsSync(m);var h=t.dirname(m),S=t.relative(C,h),g=a.join(b,S),y=[];for(c=0,l=s.length;c<l;c++){var F=s[c],E=F.name+".anim",T=t.join(m,E),_=new cc.AnimationClip;_.sample=F.sample,_._name=F.name,_._duration=F.duration,_.curveData=F.curveData,_.wrapMode=F.loop?cc.WrapMode.Loop:cc.WrapMode.Normal;var M=Editor.serialize(_);r.writeFileSync(T,M),y.push(a.join(g,t.basename(m),E))}e.waterfall([function(e){Editor.assetdb.import([m],g,!1,function(){e()})},function(e){var t=i.addComponent(cc.Animation);if(t){for(c=0,l=y.length;c<l;c++){var r=y[c],n=Editor.assetdb.remote.urlToUuid(r);if(n){var o=new cc.AnimationClip;o._uuid=n,o._name=a.basenameNoExt(r),t.addClip(o),d===c&&(t.defaultClip=o,t.playOnLoad=!0)}}e()}else Editor.warn("Add Animation component failed."),e()}],o)})(l,o,i)},function(e){let i=Editor.require("scene://utils/prefab");var a=i.createPrefabFrom(l),n=Editor.serialize(a),c=t.dirname(o);r.existsSync(c)||r.mkdirsSync(c),r.writeFileSync(o,n),e()}],c)})(n,s,o)},function(e){if(!r.existsSync(s))return e();var t=a.join(b,l);Editor.assetdb.import([s],t,!1,function(){y.push(n),e()})}],o)}function A(e,t,r){for(var i=e.theNode,a=0,n=r.length;a<n;a++){var o=e[""+a];o&&(r[a].curveData||(r[a].curveData={}),t?(r[a].curveData.paths||(r[a].curveData.paths={}),r[a].curveData.paths[t]||(r[a].curveData.paths[t]={}),E(o,i,r[a].curveData.paths[t])):E(o,i,r[a].curveData))}}function E(e,t,r){for(var i in r.props||(r.props={}),r.comps||(r.comps={}),e)if(e.hasOwnProperty(i)){var a=S[i];a?a(e[i],t,r):Editor.log('Action for property "%s" is not supported.',i)}}function T(e){if(!e.easing)return null;var t=e.easing.type;if(t<0||t>13)return null;var r=null;if(0===t)r="constant";else if(1===t)r="linear";else{var i=t-2,a=Math.floor((i-1)/3),n=(i-1)%3;r=p[a]+v[n]}return r}function _(e){for(var t=e.properties,r={},i=0,a=t.length;i<a;i++){var n=t[i];r[n.name]={type:n.type,value:n.value}}return r}function M(e,t,r){return e[t]?e[t].value:r}function D(e,t){t||(t=e.getPosition());var r=e.getParent();if(!r)return t;var i=r.getAnchorPoint(),a=r.getContentSize(),n=t.x-a.width*i.x,o=t.y-a.height*i.y;return cc.v2(n,o)}function P(e,t,r){e.active=M(t,"visible",!0);var i=M(t,"anchorPoint",[0,0]);M(t,"ignoreAnchorPointForPosition",!1)?e.setAnchorPoint(0,0):e.setAnchorPoint(i[0],i[1]),function(e,t,r){var i=M(t,"position",[0,0,0]),a=null,n=(a=t.preferedSize?M(t,"preferedSize"):t.dimensions?M(t,"dimensions"):M(t,"contentSize",[0,0,0]))[2],o=a[0],c=a[1];switch(n){case 1:o=r.width*o/100,c=r.height*c/100;break;case 2:o=r.width-o,c=r.height-c;break;case 3:o=r.width*o/100;break;case 4:c=r.height*c/100}e.setContentSize(o,c);var l=i[2],s=i[0],d=i[1];switch(l){case 1:d=r.height-d;break;case 2:s=r.width-s,d=r.height-d;break;case 3:s=r.width-s;break;case 4:s=r.width*s/100,d=r.height*d/100}e.setPosition(s,d)}(e,t,r),e.angle=M(t,"rotation",0);var a=M(t,"flip",[!1,!1]),n=M(t,"scale",[1,1,!1,0]),o=a[0]?-1*n[0]:n[0],c=a[1]?-1*n[1]:n[1];e.setScale(o,c);var l=M(t,"color",[255,255,255]);e.color=new cc.Color(l[0],l[1],l[2]);var s=M(t,"opacity",255);e.opacity=s}function N(e,t){var r="";if(!e||e.length<2||!e[0]&&!e[1])r=t;else if(e[0]){var i=a.join(b,e[0]);r=a.join(i,e[1])}else r=a.join(b,e[1]),r=a.join(r,a.basenameNoExt(r));if(!r)return null;var n=Editor.assetdb.remote.urlToUuid(r);return Editor.assetdb.remote.existsByUuid(n)?n:null}function k(e,t){let r=N(e,t);if(!r)return Editor.warn("Failed to import spriteframe asset, asset info: "+e+", defaultUrl: "+t),null;var i=new cc.SpriteFrame;return i._uuid=r,i}function x(e,t,r,i,a){var n=e.addComponent(cc.Sprite);if(!n)return a();var o=M(t,"blendFunc",[770,771]);n.srcBlendFactor=1===o[0]?770:o[0],n.dstBlendFactor=o[1];var c=M(t,r,null);n.sizeMode=i,n.trim=!1;let l=N(c,"");cc.AssetLibrary.loadAsset(l,function(e,t){n.spriteFrame=t,a()})}function B(r,i,a){var n=r.addComponent(cc.Label);if(!n)return a();var o=M(i,"dimensions",[0,0,0]);0===o[0]||0===o[1]?n.overflow=cc.Label.Overflow.NONE:(n.overflow=cc.Label.Overflow.CLAMP,n._useOriginalSize=!1,r.setContentSize(o[0],o[1])),n.string=M(i,"string",""),n.lineHeight=0,n.horizontalAlign=M(i,"horizontalAlignment",0),n.verticalAlign=M(i,"verticalAlignment",0);var c=M(i,"fontName",""),l=M(i,"fntFile","");e.waterfall([function(e){l?L(n,l,e):c&&".ttf"===t.extname(c)?L(n,c,e):e()},function(e){var r=M(i,"fontSize",[-1,0]);r[0]>=0?(n._fontSize=r[0],e()):l?cc.loader.load(t.join(C,l),function(t,r){if(t)return e();n._fontSize=r.fontSize,n.lineHeight=r.commonHeight,e()}):e()}],a)}function L(e,t,r){if(!e||!t)return r();var i=a.join(b,t),n=!1;if(i){var o=Editor.assetdb.remote.urlToUuid(i);Editor.assetdb.remote.existsByUuid(o)&&(n=!0)}n?cc.AssetLibrary.loadAsset(o,function(t,i){if(t)return r();e.font=i,r()}):r()}function O(e){return e>1?e:Math.round(255*e)}function V(i,n){var o=t.join(g,i),c=null,l=!1;i&&r.existsSync(o)&&(l=!0),e.waterfall([function(e){if(!l)return e();F(o,e)},function(e){if(!l)return e();var r=t.dirname(o),i=t.relative(g,r),n=t.basename(o,t.extname(o)),s=a.join(b,i,n+".prefab"),d=Editor.assetdb.remote.urlToUuid(s);cc.AssetLibrary.loadAsset(d,function(t,r){t?e():(c=cc.instantiate(r),e())})}],function(){c||(c=new cc.Node),n(c)})}function R(e,t,r){var i=new cc.Node(t),a=i.addComponent(cc.Scrollbar);a.direction=e;var n=i.addComponent(cc.StudioWidget);n.isAlignRight=!0,n.isAlignBottom=!0,n.isAlignTop=e===cc.Scrollbar.Direction.VERTICAL,n.isAlignLeft=e===cc.Scrollbar.Direction.HORIZONTAL;var o=new cc.Node("bar");i.addChild(o);var c=o.addComponent(cc.Sprite);return c.type=cc.Sprite.Type.SLICED,c.trim=!1,c.sizeMode=cc.Sprite.SizeMode.CUSTOM,c.spriteFrame=new cc.SpriteFrame,e===cc.Scrollbar.Direction.HORIZONTAL?(i.setContentSize(r.width,15),o.setContentSize(.7*r.width,15),c.spriteFrame._uuid=Editor.assetdb.remote.urlToUuid(d)):(i.setContentSize(15,r.height),o.setContentSize(15,.7*r.height),c.spriteFrame._uuid=Editor.assetdb.remote.urlToUuid(s)),a.handle=c,i}module.exports={importCCBFiles:function(t,r,i,a,n){C=r,g=i,b=a;var o=0;e.whilst(function(e){e(null,o<t.length)},function(e){F(t[o],function(){o++,e()})},function(){n()})}};