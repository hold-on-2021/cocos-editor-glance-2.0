const e=Editor.require("app://editor/share/adapters-build-utils"),i=require(Editor.url("packages://xiaomi-runtime/lib/utils")),t=require("fire-path"),n=require("fire-fs"),o=require("del"),{promisify:a}=require("util"),r=Editor.require("app://editor/share/build-utils"),s=Editor.require("app://editor/share/3d-physics-build-utils");var u,l,d,m,c,g;const p="project://xiaomi-runtime.json";const f={"certificate.pem":function(e,i){let t=Editor.Profile.load(p);t.get("useDebugKey")||(e.contents=n.readFileSync(t.get("certificatePath"))),e.basename=`sign/${i.debug?"debug":"release"}/certificate.pem`},"private.pem":function(e,i){let t=Editor.Profile.load(p);t.get("useDebugKey")||(e.contents=n.readFileSync(t.get("privatePath"))),e.basename=`sign/${i.debug?"debug":"release"}/private.pem`},"manifest.json":function(e,i){let n=Editor.Profile.load(p),o=JSON.parse(e.contents.toString());r.combineDestJson(i,o,t.basename(e.path)),o.package=n.get("package"),o.name=n.get("name"),o.icon=`/image/${t.parse(u).base}`,o.versionName=n.get("versionName"),o.versionCode=n.get("versionCode"),o.minPlatformVersion=n.get("minPlatformVersion"),o.orientation=n.get("deviceOrientation"),o.config.logLevel=n.get("logLevel");let a=i.buildResults._subpackages;if(a&&Object.keys(a).length>0){o.subpackages=[];for(let e in a){let i=a[e];o.subpackages.push({name:i.name,root:i.path})}}r.combineBuildTemplateJson(i,o,t.basename(e.path)),o=JSON.stringify(o,null,4),e.contents=new Buffer(o)},"main.js":function(e,i){let t=Editor.Profile.load(p).get("tinyPackageServer"),n=e.contents.toString(),o=`REMOTE_SERVER_ROOT = "${t}"`;n=n.replace(/REMOTE_SERVER_ROOT = ""/g,o);let a=i.debug?"require('adapter.js')":"require('adapter-min.js')";n=n.replace("require('adapter-js-path')",a),n=s.updateMinigameRequire(i,n,"require(window._CCSettings.debug ? 'physics.js' : 'physics-min.js');"),e.contents=new Buffer(n)}};module.exports={name:Editor.T("xiaomi-runtime.platform_name"),platform:"xiaomi",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build,Editor.Builder.DefaultButtons.Play],compileFlags:function(e){return{support_jit:!1,minigame:!0}},delPattern:function(e,i){let n=e.dest;return[t.join(n,"**/*"),`!${t.join(n,"node_modules")}`,`!${t.join(n,"node_modules","**/*")}`,`!${t.join(n,"manifest.json")}`,`!${t.join(n,"sign")}`,`!${t.join(n,"sign","**/*")}`]},md5:{globalIgnore:function(){return[/.*/]}},messages:{"script-build-finished":async function(i,r){let s=null;try{(function(e){let i=Editor.Profile.load(p);if(!i)throw new Error("config file not found");var t=i.get("package"),o=i.get("name"),a=i.get("icon"),r=i.get("versionName"),s=i.get("versionCode"),f=i.get("minPlatformVersion");c=e.debug,g=e.sourceMaps,u=a||"",u=a.trim(),l=i.get("privatePath")||"",d=i.get("certificatePath")||"",m=i.get("useDebugKey");var E=!0,y=[],b="";if([{name:Editor.T("xiaomi-runtime.package"),value:t},{name:Editor.T("xiaomi-runtime.name"),value:o},{name:Editor.T("xiaomi-runtime.desktop_icon"),value:a},{name:Editor.T("xiaomi-runtime.version_name"),value:r},{name:Editor.T("xiaomi-runtime.version_number"),value:s},{name:Editor.T("xiaomi-runtime.support_min_platform"),value:f}].forEach(function(e){e.value||(E=!1,y.push(e.name))}),E||(b+=y.join("、")+Editor.T("xiaomi-runtime.not_empty")),a&&(n.existsSync(u)||(E=!1,b+=a+Editor.T("xiaomi-runtime.icon_not_exist"))),m||(""===l?(E=!1,b+=Editor.T("xiaomi-runtime.select_private_pem_path")):n.existsSync(l)||(E=!1,b+=`${l} `+Editor.T("xiaomi-runtime.signature_not_exist")),""===d?(E=!1,b+=Editor.T("xiaomi-runtime.select_certificate_pem_path")):n.existsSync(d)||(E=!1,b+=`${d}`+Editor.T("xiaomi-runtime.signature_not_exist"))),!E)throw new Error(b)})(r),async function(e){let i=Editor.url("packages://adapters/platforms/xiaomi/res/node_modules"),r=t.join(e.dest,"node_modules");try{let e=JSON.parse(n.readFileSync(t.join(i,"quickgame-cli/package.json"),"utf8")),a=JSON.parse(n.readFileSync(t.join(r,"quickgame-cli/package.json"),"utf8"));if(e.version===a.version)return;Editor.log("Removing old node_modules..."),await o(t.join(r,"**/*"),{force:!0})}catch(e){}Editor.log("Copying node_modules, please wait ...");let s=a(n.copy);try{await s(i,r)}catch(e){Editor.error("Copy node_module failed",e)}}(r),function(e){let i=Editor.Profile.load(p).get("icon");n.copySync(i,t.join(e.dest,"image",t.parse(i).base))}(r),await e.buildAdapter(r,null),await e.copyRes(r,["./node_modules","./node_modules/**/*","./openSSLWin64","./openSSLWin64/**/*"],f),function(){let e=Editor.Profile.load(p);e.get("useDebugKey")||e.get("package").indexOf("test")||e.get("name").indexOf("test")||c||g||Editor.Metrics.trackEvent("Project","BetaPlatforms","xiaomi-runtime",{packageName:e.get("package"),appName:e.get("name"),version:e.get("versionName"),orientation:e.get("deviceOrientation")})}()}catch(e){s=e}i.reply(s)},"build-finished":async function(e,o){let a=null;try{(function(e){let i=e.buildResults._subpackages;if(i)for(let o in i){let a=i[o],r=t.join(e.dest,a.path,"index.js");n.existsSync(r)&&n.renameSync(r,t.join(e.dest,a.path,"main.js"))}})(o),await async function(e){let t=Editor.Profile.load(p),n=e.debug,o=e.dest;Editor.log("Build rpk");let a=["quickgame",n?"build":"release","--cocos-wx-game"];t.get("tinyPackageServer")&&a.push("--ignore","res"),await i.execCmd("win32"===process.platform?"npx.cmd":"npx",a,o)}(o),function(e){let i=Editor.Profile.load(p),t={packageName:i.get("package"),resUrl:i.get("tinyPackageServer"),orientation:i.get("deviceOrientation"),projectName:i.get("name")};Editor.Ipc.sendToMain("builder:notify-build-result",e,t)}(o)}catch(e){a=e}e.reply(a)},play:(e,i)=>{Editor.Panel.open("xiaomi-runtime.qrcode",i)}},settings:Editor.url("packages://xiaomi-runtime/build-runtime-ui.js")};