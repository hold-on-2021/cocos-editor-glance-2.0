const e=Editor.require("app://editor/share/adapters-build-utils"),t=require("fire-path"),i=require("fire-fs"),n=require("globby"),o=require("del"),r="project://wechatgame-opendata.json",s=Editor.require("app://editor/share/3d-physics-build-utils");let a=null;const d={"game.js":function(e,i){Editor.Profile.load(r);e.path=t.join(t.dirname(e.path),"index.js");let n=e.contents.toString(),o='SUBCONTEXT_ROOT = "'+i.projectName+'"';n=n.replace(/SUBCONTEXT_ROOT = ""/g,o);let a=i.debug?"require('cocos/cocos2d-js.js')":"require('cocos/cocos2d-js-min.js')";n=n.replace("require('cocos2d-js-path')",a);let d=i.debug?"require('adapter.js')":"require('adapter-min.js')";n=n.replace("require('adapter-js-path')",d),n=s.updateMinigameRequire(i,n),e.contents=new Buffer(n)}};module.exports={name:Editor.T("wechatgame-opendata.platform_name"),platform:"wechatgame-subcontext",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build],buildConfig:{pack:!1},compileFlags:function(e){return{support_jit:!1,minigame:!0}},engineBuildPath:function(e){return t.join(e.dest,"cocos")},md5:{globalIgnore:function(){return[/.*/]}},buildStart:function(e){e.dest=t.join(t.dirname(e.dest),e.projectName);let i=e.excludedModules,n=i.indexOf("Canvas Renderer");-1!==n&&i.splice(n,1)},beforeFinish:function(e,r){a=function(e){const r=Editor.require("app://editor/share/engine-extends/json-packer");let s=Editor.Utils.UuidUtils.compressUuid,a=n.sync(t.join(e.dest,"res","import/**"),{nodir:!0}),d=new r;for(let e=0;e<a.length;++e){let n=a[e],r=t.extname(n);if(".json"!==r)continue;let c=i.readJsonSync(n),u=s(t.basename(n,r),!0);d.add(u,c),o.sync(n,{force:!0})}return d.pack()}(e),r.packedAssets={SUBDOMAIN_DATA:a.indices};let s=`module.exports = ${a.data};\n`;i.writeFileSync(t.join(t.join(e.dest,"src"),"subdomain.json.js"),s)},messages:{"script-build-finished":async function(t,i){let n=null;try{(function(){if(!Editor.Profile.load(r))throw new Error("config file not found")})(),await e.buildAdapter(i,null),await e.copyRes(i,["./game.json","./project.config.json","./cocos/*"],d)}catch(e){n=e}t.reply(n)},"build-finished":function(e,n){let o=n.buildResults._subpackages;if(o){for(let e in o){let r=o[e],s=t.join(n.dest,r.path,"index.js");i.existsSync(s)&&i.renameSync(s,t.join(n.dest,r.path,"game.js"))}(function(e){let t={orientation:Editor.Profile.load(r).get("orientation")};Editor.Ipc.sendToMain("builder:notify-build-result",e,t)})(n),e.reply()}}},settings:Editor.url("packages://wechatgame-opendata/build-ui.js")};