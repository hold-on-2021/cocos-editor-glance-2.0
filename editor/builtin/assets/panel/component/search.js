"use strict";const t=require("fs"),e=require("fire-path"),s=require("async"),i=require("../utils/cache"),r=require("../utils/operation"),o=require("../utils/event"),h=require("../utils/utils");exports.template=t.readFileSync(e.join(__dirname,"../template/search.html"),"utf-8"),exports.components={node:require("./node")},exports.props=["filter","length"],exports.data=function(){return{nodes:i.queryNodes(),filterNodes:[],type:null,text:"",uuids:[],uh:{height:0},showList:[],start:0}},exports.watch={start(){this.reset()},length(){this.reset()},filterNodes(){this.reset()},nodes(){this.filter&&h.emptyFilter()},filter(){let t=this.filter;if(!t)return;let i=[],h="",l="",n=t.split(" ");t="";for(let e=0,s=n.length;e<s;e++){let s=n[e];if(s)if(/^t:.*/.test(s)){let t=s.substring(2).split(",").map(t=>t.trim());i=i.concat(t)}else/^u:.*/.test(s)?h=s.substring(2):/^used:.*/.test(s)?l=s.substring(5):t=s}clearTimeout(this._searchID),o.emit("start-loading",100),this.uuids=[],this._searchID=null;let u=setTimeout(()=>{o.emit("finish-loading"),u===this._searchID&&Editor.assetdb.queryAssets(null,i,(i,o)=>{if(u!==this._searchID)return;this.text=t.toLowerCase(),h=h.toLowerCase(),l=l.toLowerCase();s.waterfall([t=>{if(!l||!Editor.Utils.UuidUtils.isUuid(l))return t(),void 0;Editor.assetdb.queryInfoByUuid(l,(e,s)=>{if(e)return t(),void 0;s&&this.isScript(s.type)&&(l=Editor.Utils.UuidUtils.compressUuid(l)),t()})},t=>{o.forEach(t=>{if(t.hidden)return;let s=e.basenameNoExt(t.path);e.extname(t.path);this.validate(s,this.text)&&this.validate(t.uuid,h)&&this.findUsages(t,l)&&this.uuids.push(t.uuid)}),t()},t=>{this.filterNodes=this.nodes.filter(t=>{if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(this.text){let e=t.name.toLowerCase();if(this.text=this.text.toLowerCase(),-1===e.indexOf(this.text))return!1}return!0}),t()}],()=>{Editor.Selection.curSelection("asset").forEach(t=>{r.select(t,!0)})})})},200);this._searchID=u}},exports.methods={isScript:t=>"javascript"===t||"coffeescript"===t||"typescript"===t,reset(){this._updateLock||(this._updateLock=!0,requestAnimationFrame(()=>{this._updateLock=!1,this.showNodeFilter()}))},sortShowNode(){i.sortAssetsTree(this.showList)},showNodeFilter:function(){this.uh.height=0,this.showList=[];let t=this.filterNodes,e=this.start+Math.ceil(this.length);e=e>t.length?t.length:e;for(let s=this.start;s<e;s++)this.showList.push(t[s]);i.sortAssetsTree(this.showList),this.uh.height=t.length*i.lineHeight+4},scrollIfNeeded(t){let e=i.queryNode(t);if(!e)return;let s=this.filterNodes.indexOf(e);if(-1===s)return;let r=s*i.lineHeight,o=this.$el.scrollTop+this.$el.clientHeight-i.lineHeight-2;r<this.$el.scrollTop-2?this.$el.scrollTop-=this.$el.scrollTop-2-r:r>=o&&(this.$el.scrollTop+=r-o)},validate:(t,e)=>t.toLowerCase().indexOf(e.toLowerCase())>-1,addShowList(t){-1===this.showList.indexOf(t)&&this.showList.push(t)},removeShowList(t){let e=this.showList.indexOf(t);-1!==e&&this.showList.splice(e,1)},findUsages(e,s){if(!s)return!0;if(s===e.uuid)return!1;if(!e.destPath)return!1;return t.readFileSync(e.destPath).indexOf(s)>=0},onUpdateFilter(t,e){if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(e){let s=t.name.toLowerCase();e=e.toLowerCase();let i=-1!==s.indexOf(e);return i?this.addShowList(t):this.removeShowList(t),i}return this.addShowList(t),!0},onScroll(t){let e=t.target.scrollTop;this.start=e/i.lineHeight|0},onDragStart:h.onDragStart,onDragOver:h.onDragOver,onDragEnd:h.onDragEnd},exports.created=function(){o.on("search:sort",this.sortShowNode)};