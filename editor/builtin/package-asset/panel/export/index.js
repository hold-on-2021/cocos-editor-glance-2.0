const e=require("electron"),t=require("fire-fs"),s=Editor.require("packages://package-asset/utils.js"),r=Editor.require("packages://package-asset/parse/export.js"),i=Editor.require("packages://package-asset/lib/jszip.min.js");let a=Editor.require("packages://package-asset/panel/export/asset-item.js");Vue.component("package-export-asset-item",a),Editor.Panel.extend({style:t.readFileSync(Editor.url("packages://package-asset/panel/style.css"))+"",template:t.readFileSync(Editor.url("packages://package-asset/panel/export/panel.html"))+"",ready(){s.init(this.profiles),this._vm=new window.Vue({el:this.shadowRoot,created(){this.foldedAll=s.getDataByKey("folded-all")||!0},data:{assetUuid:"",assetTree:null,foldedAll:!0},watch:{assetUuid:{handler(e){if(!e)return this.assetTree=null,void 0;this._queryDependAsset(e)}}},methods:{T:Editor.T,_showLoadBar(){return this.assetUuid&&!this.assetTree},_showContent(){return this.assetUuid&&this.assetTree},_isDisabled(){return""===this.assetUuid||this.assetTree&&0===this.assetTree.children.length},_isExportDisabled(){return this._isDisabled()||this.assetTree&&this.assetTree.children.every(e=>!e.selected)},_setAssetTreeFolded(e,t){void 0!==e.folded&&(e.folded=t),e.children&&e.children.forEach(e=>{"directory"===e.type&&this._setAssetTreeFolded(e,t)})},_getAssetTreeFolded(e,t){if(void 0!==e.folded&&!e.folded)return t.foldedAll=!1,void 0;e.children&&e.children.forEach(e=>{"directory"===e.type&&this._getAssetTreeFolded(e,t)})},_changedAssetTreeFoldedState(e){if(void 0===e)return this.foldedAll=!0,this._getAssetTreeFolded(this.assetTree,this),void 0;this._setAssetTreeFolded(this.assetTree,e),this.foldedAll=e},onChooseScene(){s.showExportResDialog((e,t)=>{if(e)return Editor.error(e),void 0;this.assetUuid=t.uuid,s.save("current-scene-uuid",this.assetUuid)})},_queryDependAsset(e){Editor.Scene.callSceneScript("package-asset","query-depend-asset",e,(e,t)=>{if(e)return Editor.error(e),void 0;r.queryAssetTreeByUuidList(t,(e,t)=>{if(e)return Editor.error(e),void 0;this.assetTree=t,this._setAssetTreeFolded(t,this.foldedAll)})},3e4)},onRefresh(){this._queryDependAsset(this.assetUuid)},onAssetChanged(e){this.assetUuid=e.detail.value},onClearAll(){this.assetUuid=""},onFoldedAll(e){let t=e.detail.value;this._changedAssetTreeFoldedState(t),s.save("folded-all",t)},onExport(){let r=new i;function a(e,s,i,d){if(!e.selected)return d();if("directory"===e.type){let l;if("Assets"!==e.name&&(l=function(e,s){let i;return s?(i=s.folder(e.name)).file(e.name+".meta",t.readFileSync(e.url+".meta")):(i=r.folder(e.name),r.file(e.name+".meta",t.readFileSync(e.url+".meta"))),i}(e,s)),e.children.length<1)return d();let o=0;for(let t=0,s=e.children.length;t<s;++t){a(e.children[t],l,i,()=>{++o>=s&&d()})}}else(function(e,s){s?(s.file(e.name,t.readFileSync(e.url)),s.file(e.name+".meta",t.readFileSync(e.url+".meta"))):(r.file(e.name,t.readFileSync(e.url)),r.file(e.name+".meta",t.readFileSync(e.url+".meta")))})(e,s),i[e.name]=e.type,d()}s.showExportOutPathDialog((s,i)=>{if(s)return Editor.error(s),void 0;let d={};a(this.assetTree,null,d,function(){r.file("&asset&type&.json",JSON.stringify(d)),r.generateNodeStream({type:"nodebuffer"}).pipe(t.createWriteStream(i)).on("finish",function(){let e=Editor.T("EXPORT_ASSET.export_tips",{outPath:i});Editor.log(e)}),e.shell.showItemInFolder(i)})})}}})},messages:{"asset-db:asset-changed"(e,t){this._vm.onRefresh()}}});