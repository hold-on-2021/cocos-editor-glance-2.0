var e,i="minigame.config.js",n="game.js",r="manifest.json",t="qgame-adapter.js",o=require("path"),a=require("fs-extra"),s=require("child_process").spawn;let c;var d,l,u,p,m,v,f,g,j="src",y="sign",S="cocos-library",E="7d8bb580016b6a2fb89d902deda0d3a4",_="",b=require(Editor.url("packages://vivo-runtime/lib/cli"));function k(e){let i=Editor.url("packages://vivo-adapter");return void 0===e||""===e?i:o.join(i,e)}function P(e,i,n,r){a.readdirSync(e).forEach(function(t){let s=o.join(e,t),c=a.statSync(s);if(c&&c.isDirectory())P(s,i,n,r);else{let e=o.extname(s),t=!0;if(void 0!==r&&r instanceof Array)for(let i=0;i<r.length;i++)if(t=!1,e===r[i]){t=!0;break}if(!0===t){let e=s.slice(i.length+1,s.length),r=o.basename(s),t=!0;if(void 0!==n&&n instanceof Array)for(let e=0;e<n.length;e++)if(t=!0,r===n[e]){t=!1;break}if(!0===t){e=e.replace(/\\/g,"/");let i={};i.module_name=e,i.module_path=e,i.module_from=e,_+=JSON.stringify(i)+",\n"}}}})}function x(e){let i=o.join(d,"src");a.existsSync(i)||a.ensureDirSync(i);var n=o.join(d,"src",r),t=c.package,s=c.name,u=c.versionName,p=c.versionCode,m=c.minPlatformVersion,v=c.deviceOrientation,f=c.logLevel,g={package:t,name:s,icon:`/image/${o.parse(l).base}`,versionName:u,versionCode:p,minPlatformVersion:m,deviceOrientation:v,type:"game",config:{logLevel:f},display:{}};!0===c.separateEngineMode&&(g.plugins={"cocos-library":{provider:E,version:CocosEngine,path:"cocos-library"}});let j=function(e){var i=e.buildResults._subpackages;if("{}"==JSON.stringify(i))return;var n=[];for(var r in i){var t=i[r].path,a=o.extname(t),s=o.basename(t,a),c={name:r,root:s+"/"};n.push(c)}return n}(e);void 0!==j&&(g.subpackages=j),a.writeJSONSync(n,g)}function h(e,i){b.isLatestVersion(function(n,r){if(!0===n)return T(e,i),void 0;(function(e,i){Editor.log(Editor.T("vivo-runtime.download_qgame_adater")),b.installQGameAdapter(function(n){if(n)return Editor.log(Editor.T("vivo-runtime.download_qgame_adater_fail")),T(e,i),void 0;Editor.log(Editor.T("vivo-runtime.download_qgame_adater_success")),T(e,i)})})(e,i)})}function T(r,f){Editor.log("Checking config file ",f.dest);var E=b.getEnvirommentPath();if(Editor.log("Building game "+f.platform+" to "+d),!0===c.separateEngineMode&&!b.isSupportSeparateEngine())return r.reply(new Error(Editor.T("vivo-runtime.separate_engine_dont_support"))),void 0;x(f);var h=o.join(e,"res"),T=b.getQGameAdapterPath();a.existsSync(T)||(T=k(t)),a.copySync(T,o.join(d,"src","adapter",t)),function(){a.copySync(o.join(e,"src"),o.join(d,"src"));var i=o.join(d,j);a.writeFileSync(o.join(i,n),'require("src/index.js");');var r=o.join(i,"image");a.emptyDirSync(r),a.writeFileSync(o.join(r,o.parse(l).base),a.readFileSync(l))}(),function(){var e=o.join(d,y);if(a.emptyDirSync(e),!m){var i=o.join(e,"release");a.existsSync(i)||a.mkdirSync(i),a.existsSync(u)&&a.writeFileSync(o.join(i,"private.pem"),a.readFileSync(u)),a.existsSync(p)&&a.writeFileSync(o.join(i,"certificate.pem"),a.readFileSync(p))}var n=o.join(e,"debug");a.mkdirSync(n);var r=k("certificate.pem");a.writeFileSync(o.join(n,"certificate.pem"),a.readFileSync(r)),r=k("private.pem"),a.writeFileSync(o.join(n,"private.pem"),a.readFileSync(r))}(),function(){var i=o.join(e,"main.js"),n=a.readFileSync(i,"utf8"),r=(n=n.replace("window.jsb","window.qg")).indexOf("require('src/settings");n=(n=(n=(n=n.slice(0,r)+"require('src/adapter/rename-adapter.js');\n\t\trequire('src/adapter/qgame-adapter.js');\n\t\t"+n.slice(r)).replace("var isRuntime = (typeof loadRuntime === 'function');","")).replace("if (isRuntime)","if (true)")).replace("jsb-adapter/engine/index.js","src/adapter/index.js"),a.writeFileSync(o.join(d,"src","index.js"),n)}(),function(){if(!c.separateEngineMode)return;var e=o.join(d,S),i=o.join(d,"src","cocos2d-runtime.js"),n=o.join(e,"cocos2d-runtime.js"),r=o.join(d,"src","index.js"),t=o.join(e,"plugin.json");Editor.info(Editor.T("vivo-runtime.separate_engine_begin_hint")),a.emptyDirSync(e),a.copySync(i,n);let s={main:"cocos2d-runtime.js"};a.writeJSONSync(t,s);let l=a.readFileSync(r,"utf-8");if(l.indexOf("require('src/cocos2d-runtime.js');")>-1){let e="if (typeof qg.requirePlugin === 'function') {\n\t\t\tqg.requirePlugin('cocos-library');\n\t\t} else {\n\t\t\trequire('cocos-library/cocos2d-runtime.js');\n\t\t}";l=l.replace("require('src/cocos2d-runtime.js');",e),a.writeFileSync(r,l)}Editor.info(Editor.T("vivo-runtime.separate_engine_end_hint"))}(),function(i){var n=i.buildResults._subpackages;if("{}"!=JSON.stringify(n))for(var r in n){let i=o.join(e,"subpackages",r),n=o.join(e,"subpackages",r,"index.js"),t=o.join(e,"subpackages",r,"game.js");a.existsSync(n)&&a.renameSync(n,t);let s=o.join(d,"src",r);a.copySync(i,s)}}(f);var w="win32"===process.platform?"npm.cmd":"npm";function q(){Editor.log(Editor.T("vivo-runtime.rpk_installing"));var i=["run"];m?i.push("build"):i.push("release");var n=s(w,i,{env:E,cwd:d});n.stderr.on("data",e=>{Editor.error(`${e}`)}),n.on("close",i=>{(function(){var i=o.join(e,"res"),n=o.join(d,"res");a.existsSync(i)&&!a.existsSync(n)&&(!0===c.tinyPackageMode&&a.copySync(i,n),a.existsSync(e)&&a.removeSync(e))})();var n=o.join(d,"dist",c.package+(m?".":".signed.")+"rpk");if(!a.existsSync(n))return r.reply(new Error(Editor.T("vivo-runtime.rpk_install_fail"))),void 0;Editor.log(Editor.T("vivo-runtime.rpk_install_success")+n),r.reply(),function(){var e=CocosEngine,i=parseInt("2.2.1".replace(/[^\d]/g,""));if(parseInt(e.slice(0,6).replace(/[^\d]/g,""))>=i==!0){var n;let e={resUrl:(n=void 0!==Editor.Profile.load.getSelfData?Editor.Profile.load("project://vivo-runtime.json").getSelfData():Editor.Profile.load("profile://project/vivo-runtime.json").data).tinyPackageServer,orientation:n.deviceOrientation,projectName:n.name};Editor.Ipc.sendToMain("builder:notify-build-result",g,e)}if(!0===c.useDebugKey||c.package.indexOf("test")>-1||c.name.indexOf("test")>-1||!0===v)return;Editor.Metrics.trackEvent("Project","BetaPlatforms","vivo-runtime",{packageName:c.package,appName:c.name,version:c.versionName,orientation:c.deviceOrientation})}()})}(async function(){let n=require("./build-jsb-adapter"),r=o.join(k(),"engine","index.js"),t=o.join(d,"src","adapter","index.js");await n.build({rootPath:r,dstPath:t,isDebug:g.debug}),function(e){var i=c.tinyPackageServer;let n=o.join(e,"src","adapter","index.js");var r=a.readFileSync(n,"utf8");!1===c.tinyPackageMode?(a.copySync(h,o.join(e,"src","res")),r=r.replace("REMOTE_SERVER_ROOT_PLACE_HOLDER","")):r=r.replace("REMOTE_SERVER_ROOT_PLACE_HOLDER",i);a.writeFileSync(n,r)}(g.dest),function(i){if(!0===i.buildScriptsOnly)return;if(!c.tinyPackageMode)return;if(!c.packFirstScreenRes)return;a.emptyDirSync(o.join(d,"src","res"));let n=i.buildResults;var r=n.getDependencies(i.startScene),t=o.join(e,"res","import");a.copySync(t,o.join(i.dest,"src","res","import")),a.removeSync(t);for(var s=0;s<r.length;++s){var l=r[s],u=n.getNativeAssetPath(l);if(!u||0===u.length)continue;let t=o.join(i.dest,"src",u.replace(i.dest,""));if(t.indexOf("\\subpackages")>-1){Editor.log(Editor.T("vivo-runtime.pack_res_to_first_pack_contain_subpack_res_error"));continue}let c=o.join(e,u.replace(i.dest,""));a.copySync(c,t);var p=o.dirname(c);a.existsSync(p)&&0===a.readdirSync(p).length&&a.removeSync(p)}}(g),function(){a.copySync(k(o.join("engine","rename-adapter.js")),o.join(d,"src","adapter","rename-adapter.js")),_="",!0===c.separateEngineMode?(P(o.join(d,j),d,["game.js","cocos2d-runtime.js"],[".js"]),P(o.join(d,S),o.join(d),void 0,[".js"])):P(o.join(d,j),d,["game.js"],[".js"]);(function(){var e=k(i),n=a.readFileSync(e,"utf8");n=n.replace("EXTERNALS_PLACEHOLDER",_),a.writeFileSync(o.join(d,i),n)})(),q()}()})()}function w(e,i){a.existsSync(e)&&(a.copySync(e,i),a.removeSync(e))}module.exports={name:Editor.T("vivo-runtime.platform_name"),platform:"qgame",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"build-finished":function(i,n){var r;g=n,void 0!==Editor.Profile.load.getSelfData?(r=Editor.Profile.load("project://vivo-runtime.json"),c=r.getSelfData()):(r=Editor.Profile.load("profile://project/vivo-runtime.json"),c=r.data);var t=(c=r.data).package,s=c.name,j=c.icon,y=c.versionName,S=c.versionCode,E=c.minPlatformVersion;f=c.showNpmPath,v=n.debug,sendStatisticsSourceMaps=n.sourceMaps,l=j||"",l=j.trim(),u=c.privatePath||"",p=c.certificatePath||"",m=c.useDebugKey;var _=!0,k=[],P="";if([{name:Editor.T("vivo-runtime.package"),value:t},{name:Editor.T("vivo-runtime.name"),value:s},{name:Editor.T("vivo-runtime.desktop_icon"),value:j},{name:Editor.T("vivo-runtime.version_name"),value:y},{name:Editor.T("vivo-runtime.version_number"),value:S},{name:Editor.T("vivo-runtime.support_min_platform"),value:E}].forEach(function(e){e.value||(_=!1,k.push(e.name))}),_||(P+=k.join("、")+Editor.T("vivo-runtime.not_empty")),j&&(a.existsSync(l)||(_=!1,P+=j+Editor.T("vivo-runtime.icon_not_exist"))),m||(""===u?(_=!1,P+=Editor.T("vivo-runtime.select_private_pem_path")):a.existsSync(u)||(_=!1,P+=`${u} `+Editor.T("vivo-runtime.signature_not_exist")),""===p?(_=!1,P+=Editor.T("vivo-runtime.select_certificate_pem_path")):a.existsSync(p)||(_=!1,P+=`${p}`+Editor.T("vivo-runtime.signature_not_exist"))),!0===c.tinyPackageMode&&""===c.tinyPackageServer&&(_=!1,P+="please enter remote server root"),!_)return i.reply(new Error(P)),void 0;(function(i,n){if(b.init(n,c.npmPath,f),e=o.resolve(n.dest,"..","tempBuildDir"),d=n.dest,w(o.join(d,"main.js"),o.join(e,"main.js")),w(o.join(d,"src"),o.join(e,"src")),w(o.join(d,"res"),o.join(e,"res")),w(o.join(d,"subpackages"),o.join(e,"subpackages")),!1===b.isInstallNodeJs(i,c.npmPath))return;if(!1===b.isInstallVivoMinigameTool())return i.reply(new Error("please install tools: npm install -g @vivo-minigame/cli@latest")),void 0;let r=b.isCliProject();if(!1===b.isInitVivoProject()||!1===r)return!1===r&&a.emptyDirSync(n.dest),b.initVivoProject(function(e){if(e)return Editor.log("init  game project failed"),void 0;a.emptyDirSync(o.join(n.dest,"src")),h(i,n)}),void 0;h(i,n)})(i,n)},play:(e,i)=>{Editor.Panel.open("vivo-runtime.qrcode",i)}},delPattern:function(e){let i=e.dest;return[o.join(i,"**/*"),`!${o.join(i,".eslintrc.json")}`,`!${o.join(i,".npmignore")}`,`!${o.join(i,"babel.config.js")}`,`!${o.join(i,"minigame.config.js")}`,`!${o.join(i,"package.json")}`,`!${o.join(i,"package-lock.json")}`,`!${o.join(i,"node_modules")}`,`!${o.join(i,"node_modules","**/*")}`,`!${o.join(i,"src","res")}`,`!${o.join(i,"src","res","**/*")}`]},md5:{globalIgnore:function(){return[/.*/]}},settings:Editor.url("packages://vivo-runtime/build-ui.js")};