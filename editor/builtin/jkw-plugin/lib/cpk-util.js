let e=require("./jszip.min.js"),i=require("path"),t=require("fs-extra"),a=require("./worker-util.js"),r=require("./adapter-util.js"),n=require("./tinypack-util.js"),o=require("./separate-engine-util.js"),s={};e.prototype.directory=function(e,a){if(!t.statSync(e).isDirectory())return Editor.error(e+" is not a folder!"),void 0;t.readdirSync(e).forEach(function(e){let a=this.zip,r=i.join(this.srcPath,e),n=t.statSync(r);n.isDirectory()?a.directory(r,e):n.isFile()?a.file(e,t.readFileSync(r)):Editor.error(r+" was not added to zip!")}.bind({srcPath:e,zip:this.folder(a)}))},e.prototype.append=function(e,i){if(!t.statSync(e).isFile())return Editor.error(e+" is not a file!"),void 0;this.file(i,t.readFileSync(e))},module.exports={async gatherInfo(c){void 0!==Editor.Profile.load.getSelfData?s.customConfig=Editor.Profile.load("project://cpk-publish.json").getSelfData():s.customConfig=Editor.Profile.load("profile://project/cpk-publish.json").data,s.md5Cache=c.md5Cache;let d=s.customConfig;s.isTinyPackage=!!d.tinyPackageMode,s.projectPath=c.project,s.buildPath=c.dest,s.subpackages=c.buildResults._subpackages,s.title=c.title,s.cpkName=c.title+".cpk";let l=d.outputCpkPath,p=d.useCustomCpkPath;s.buildResults=c.buildResults,s.startScene=c.startScene,!0===p?""!==l&&t.existsSync(l)?s.cpkPath=i.join(l,s.cpkName):(Editor.log(Editor.T("cpk-publish.out_cpk_path_error")),s.cpkPath=i.join(s.buildPath,s.cpkName)):s.cpkPath=i.join(s.buildPath,s.cpkName),s.gameConfig={deviceOrientation:d.deviceOrientation,showStatusBar:d.showStatusBar,runtimeVersion:d.runtimeVersion},s.JsZip=e,s.cpk=new e,await a.gatherInfo(s),await r.gatherInfo(s),await n.gatherInfo(s),await o.gatherInfo(s)},async organizeResources(e){let n=s.buildPath;return await a.organizeResources(),!1!==await r.organizeResources(e)&&(await o.organizeResources(),t.writeFileSync(i.join(n,"game.config.json"),JSON.stringify(s.gameConfig)),this.handleDeviceOrientation(),!0)},handleDeviceOrientation(){if("landscape"===s.customConfig.deviceOrientation){var e=i.join(s.buildPath,"main.js"),a=t.readFileSync(e,"utf8"),r="require('jsb-adapter/engine/index.js');",n=a.indexOf(r)+r.length;a=a.slice(0,n)+"\n\t\tloadRuntime().callCustomCommand({}, 'setOrientation', '{\"orientation\":0}');\n\t\twindow.orientation = 90;"+a.slice(n),t.writeFileSync(e,a)}},async pack(){let e=s.cpk,c=s.cpkPath,d=s.buildPath;t.existsSync(c)&&t.unlinkSync(c);let l=t.createWriteStream(c);await a.pack(),await r.pack(),await n.pack(),await o.pack(),e.directory(i.join(d,"src"),"src"),e.append(i.join(d,"main.js"),"main.js"),e.append(i.join(d,"game.config.json"),"game.config.json"),e.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(l).on("finish",function(){n.packFinished()})}};