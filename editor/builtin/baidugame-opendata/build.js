const e=Editor.require("app://editor/share/adapters-build-utils"),i=require("fire-path"),t=require("fire-fs"),r=require("globby"),n=require("del"),o="project://baidugame-opendata.json",a=Editor.require("app://editor/share/3d-physics-build-utils");let s=null;const d={"game.js":function(e,t){e.path=i.join(i.dirname(e.path),"index.js");let r=e.contents.toString(),n='SUBCONTEXT_ROOT = "'+t.projectName+'"';r=r.replace(/SUBCONTEXT_ROOT = ""/g,n);let o=t.debug?"require('cocos2d-js.js')":"require('cocos2d-js-min.js')";r=r.replace("require('cocos2d-js-path')",o);let s=t.debug?"require('adapter.js')":"require('adapter-min.js')";r=r.replace("require('adapter-js-path')",s),r=a.updateMinigameRequire(t,r),e.contents=new Buffer(r)}};module.exports={name:Editor.T("baidugame-opendata.platform_name"),platform:"baidugame-subcontext",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build],buildConfig:{pack:!1},compileFlags:function(e){return{support_jit:!1,minigame:!0}},md5:{globalIgnore:function(){return[/.*/]}},buildStart:function(e){e.dest=i.join(i.dirname(e.dest),e.projectName);let t=e.excludedModules,r=t.indexOf("Canvas Renderer");-1!==r&&t.splice(r,1)},beforeFinish:function(e,o){s=function(e){const o=Editor.require("app://editor/share/engine-extends/json-packer");let a=Editor.Utils.UuidUtils.compressUuid,s=r.sync(i.join(e.dest,"res","import/**"),{nodir:!0}),d=new o;for(let e=0;e<s.length;++e){let r=s[e],o=i.extname(r);if(".json"!==o)continue;let u=t.readJsonSync(r),l=a(i.basename(r,o),!0);d.add(l,u),n.sync(r,{force:!0})}return d.pack()}(e),o.packedAssets={SUBDOMAIN_DATA:s.indices};let a=`module.exports = ${s.data};\n`;t.writeFileSync(i.join(i.join(e.dest,"src"),"subdomain.json.js"),a)},messages:{"script-build-finished":async function(i,t){let r=null;try{(function(){if(!Editor.Profile.load(o))throw new Error("config file not found")})(),await e.buildAdapter(t,null),await e.copyRes(t,["./game.json","./project.swan.json"],d)}catch(e){r=e}i.reply(r)},"build-finished":function(e,i){try{let e={orientation:Editor.Profile.load(o).get("orientation")};Editor.Ipc.sendToMain("builder:notify-build-result",i,e)}catch(e){}e.reply()}},settings:Editor.url("packages://baidugame-opendata/build-ui.js")};