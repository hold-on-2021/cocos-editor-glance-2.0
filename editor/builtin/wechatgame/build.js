const e=Editor.require("app://editor/share/adapters-build-utils"),t=require("fire-path"),n=require("fire-fs"),i=require(Editor.url("packages://wechatgame/utils/wechat-game")),o=require("crypto"),r=Editor.require("app://editor/share/build-utils"),a="project://wechatgame.json",s=Editor.require("app://editor/share/3d-physics-build-utils"),u={"2.2.1":"2.2.2","2.2.2":"2.2.3"};const l={"game.js":function(e,t){let n=Editor.Profile.load(a),i=!t.debug&&n.get("separate_engine"),o=e.contents.toString(),r=`REMOTE_SERVER_ROOT = "${n.get("REMOTE_SERVER_ROOT")}"`;o=o.replace(/REMOTE_SERVER_ROOT = ""/g,r);let u=t.debug?"require('cocos/cocos2d-js.js')":"require('cocos/cocos2d-js-min.js')";i&&(u="requirePlugin('cocos')"),o=o.replace("require('cocos2d-js-path')",u);let l=t.debug?"require('adapter.js')":"require('adapter-min.js')";o=o.replace("require('adapter-js-path')",l),o=s.updateMinigameRequire(t,o),e.contents=new Buffer(o)},"game.json":function(e,n){let i=Editor.Profile.load(a),o=!n.debug&&i.get("separate_engine"),s=JSON.parse(e.contents.toString());if(r.combineDestJson(n,s,t.basename(e.path)),s.deviceOrientation=i.get("orientation"),i.get("subContext")?s.openDataContext=i.get("subContext"):delete s.openDataContext,o){let e=s.plugins.cocos,t=Editor.versions.CocosCreator;e.version=u[t]||t}else delete s.plugins;if(n.buildResults._subpackages){s.subpackages=[];for(let e in n.buildResults._subpackages)s.subpackages.push({name:e,root:n.buildResults._subpackages[e].path})}r.combineBuildTemplateJson(n,s,t.basename(e.path)),e.contents=new Buffer(JSON.stringify(s,null,4))},"project.config.json":function(e,n){let i=Editor.Profile.load(a),o=JSON.parse(e.contents.toString());r.combineDestJson(n,o,t.basename(e.path)),o.appid=i.get("appid")||"wx6ac3f5090a6b99c5",o.projectname=n.projectName,r.combineBuildTemplateJson(n,o,t.basename(e.path)),e.contents=new Buffer(JSON.stringify(o,null,4))},"signature.json":function(e,i){let r=Editor.Profile.load(a);if(!(!i.debug&&r.get("separate_engine")))return e.contents=null,void 0;let s=JSON.parse(e.contents.toString());const u=n.readFileSync(t.join(i.dest,"cocos/cocos2d-js-min.js"));s.signature[0].md5=o.createHash("md5").update(u).digest("hex"),e.contents=new Buffer(JSON.stringify(s,null,4))},"plugin.json":function(e,t){let n=Editor.Profile.load(a);!t.debug&&n.get("separate_engine")||(e.contents=null)}};module.exports={name:Editor.T("wechatgame.platform_name"),platform:"wechatgame",extends:"mini-game",buttons:[Editor.Builder.DefaultButtons.Build,Editor.Builder.DefaultButtons.Play],buildStart:function(e){let t=e.excludedModules,n=t.indexOf("WechatSubContext");-1!==n&&t.splice(n,1)},compileFlags:function(e){return{support_jit:!1,minigame:!0}},delPattern:function(e){let n=Editor.Profile.load(a).get("subContext"),i=e.dest,o=[t.join(i,"**/*"),`!${t.join(i,"game.json")}`,`!${t.join(i,"project.config.json")}`];return n&&o.push(`!${t.join(i,n)}`,`!${t.join(i,n,"**/*")}`),o},engineBuildPath:function(e){return t.join(e.dest,"cocos")},md5:{globalIgnore:function(){return[/.*/]}},messages:{"script-build-finished":async function(t,n){let i=null;try{(function(){let e=Editor.Profile.load(a);if(!e)throw new Error("config file not found");e.get("appid")||Editor.warn("appid is empty, use 'wx6ac3f5090a6b99c5' by default")})(),await e.buildAdapter(n,"./platforms/wechat/wrapper/sub-context-adapter.js"),await e.copyRes(n,null,l)}catch(e){i=e}t.reply(i)},"build-finished":function(e,i){let o=null;try{(function(e){let i=e.buildResults._subpackages;if(i)for(let o in i){let r=i[o],a=t.join(e.dest,r.path,"index.js");n.existsSync(a)&&n.renameSync(a,t.join(e.dest,r.path,"game.js"))}})(i),function(e){let t=Editor.Profile.load(a),n={id:t.get("appid"),resUrl:t.get("REMOTE_SERVER_ROOT"),orientation:t.get("orientation")};Editor.Ipc.sendToMain("builder:notify-build-result",e,n)}(i)}catch(e){o=e}e.reply(o)},play:function(e,t){i.run(t)}},settings:Editor.url("packages://wechatgame/build-ui.js")};