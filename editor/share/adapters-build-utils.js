const e={},r=require("browserify"),t=require("babelify"),a=require("@babel/core"),o=require("vinyl-source-stream"),i=require("vinyl-buffer"),n=require("gulp-uglify"),s=require("event-stream"),u=require("path"),p=require("gulp"),l=Editor.require("packages://adapters/modules.json"),c=[require("@babel/preset-env")],d=[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")],[require("@babel/plugin-proposal-export-default-from")]];let f={wechatgame:"wechat","wechatgame-subcontext":"wechat",baidugame:"baidu","baidugame-subcontext":"baidu"};function g(e){return e=f[e]||e,Editor.url(`packages://adapters/platforms/${e}`)}e.buildAdapter=function({actualPlatform:e,debug:a,excludedModules:s,dest:f},b){return new Promise((h,m)=>{let q=u.join(g(e),"index.js"),j=r(q);if(function(e){let r=[];if(e&&e.length>0){let t=Editor.url("packages://adapters");e.forEach(e=>{let a=l[e];a&&a.forEach(e=>{r.push(u.join(t,e))})})}return r}(s).forEach(e=>{j.ignore(e)}),b){let e=Editor.url("packages://adapters");b instanceof Array||(b=[b]),b.forEach(r=>{j.ignore(u.join(e,r))})}let y=j.transform(t,{presets:c,plugins:d}).bundle().pipe(o(a?"adapter.js":"adapter-min.js")).pipe(i());a||(y=y.pipe(n())),y.pipe(p.dest(f)),y.on("end",()=>{h()}),y.once("error",e=>{m(e)})})},e.copyRes=async function(e,r,t,o){return new Promise(async function(o,i){let{platform:n,actualPlatform:l,dest:f}=e,b=g(l),h=[u.join(b,"res/**/*")];r&&(r instanceof Array||(r=[r]),r.forEach(e=>{h.push(`!${u.join(b,"res",e)}`)}));let m=await new Promise((e,r)=>{Editor.Ipc.sendToMain("app:query-plugin-scripts",n,(t,a)=>{if(t)return r(t);let o=[];a.forEach(e=>{let r=u.relative(Editor.Project.path,e);r=r.replace(/\\/g,"/"),o.push(r)}),e(o)})});p.src(h).pipe(s.through(function(r){try{let o=u.basename(r.path);if("object"==typeof t){let a=t[o];"function"==typeof a&&a(r,e)}if("ccRequire.js"===o){let t=r.contents.toString(),a="";m&&m.forEach(e=>{a+=`'src/${e}': ()=>{require('src/${e}')},\n`});let o=e.debug?"project.dev.js":"project.js";a+=`'src/${o}': ()=>{require('src/${o}')},\n`,t=t.replace("// build modules",a),r.contents=new Buffer(t)}if(".js"===u.extname(o)){let e=a.transform(r.contents.toString(),{ast:!1,highlightCode:!1,sourceMaps:!1,compact:!1,filename:r.path,presets:c,plugins:d});r.contents=new Buffer(e.code)}}catch(e){return this.emit("error",e)}this.emit("data",r)})).once("error",e=>{i(e)}).pipe(p.dest(f)).on("end",()=>{o()})})},module.exports=e;