var i=require("../editor-utils/uuid-utils").compressUuid,e=cc.Object,r=cc.Asset,t=cc._BaseNode,s=cc.Node,n=cc.Component,a=e.Flags,_=a.PersistentMask,o=a.DontSave,l=a.EditorOnly,u=(CC_TEST?cc._Test.IntantiateJit:Editor.require("unpack://engine-dev/cocos2d/core/platform/instantiate-jit")).equalsToDefault,f=require("./serialize-nicify"),c=["_objFlags","_parent","_id","_prefab"].concat("_name","_active","_trs","_eulerAngles","_localZOrder","_globalZOrder");function d(i,r){r=r||{},this._exporting=r.exporting,this._discardInvalid=!("discardInvalid"in r)||r.discardInvalid,this._dontStripDefault=!this._exporting||!("dontStripDefault"in r)||r.dontStripDefault,this._missingClassReporter=r.missingClassReporter,this._missingObjectReporter=r.missingObjectReporter,this._assetExists=this._missingObjectReporter&&{},this.serializedList=[],this._parsingObjs=[],this._parsingData=[],this._objsToResetId=[],this._discardContentsForSyncablePrefab=!(r.reserveContentsForSyncablePrefab||i instanceof cc.Prefab),function(i,r){if(r instanceof e||cc.Class._isCCClass(r.constructor))E(i,r);else if(ArrayBuffer.isView(r))i.serializedList=E(i,r);else if("object"==typeof r&&r){var t;if(Array.isArray(r))t=[];else{t={};var s=cc.js._getClassId(r,!1);if(s&&(t.__type__=s),r._serialize)return t.content=r._serialize(i._exporting),i.serializedList.push(t),void 0}r.__id__=0,i._objsToResetId.push(r),i.serializedList.push(t),z(i,r,t)}else i.serializedList.push(r||null)}(this,i);for(var t=0;t<this._objsToResetId.length;++t)this._objsToResetId[t].__id__=void 0;this._parsingObjs=null,this._parsingData=null,this._objsToResetId=null}function p(i,e,r){if(i._missingObjectReporter){var t=i._assetExists[r];void 0===t&&(t=i._assetExists[r]=!!Editor.assetdb.remote.uuidToFspath(r)),t||i._missingObjectReporter(e)}}var g=cc.Class.Attr,y=g.DELIMETER+"editorOnly",v=g.DELIMETER+"serializable",h=g.DELIMETER+"default",b=g.DELIMETER+"saveUrlAsAsset",j=g.DELIMETER+"formerlySerializedAs";function A(e,a,_,o,l){function f(t){if(t){var s;if("string"==typeof t)s=Editor.Utils.UuidCache.urlToUuid(t);else if(t instanceof r&&!(s=t._uuid))return cc.error('The url must be "string" type'),void 0;return s?(p(e,t,s),e._exporting&&(s=i(s,!0)),{__uuid__:s}):void 0}}for(var c=g.getClassAttrs(o),d=l||o.__props__,A=0;A<d.length;A++){var z=d[A];if(!1!==c[z+v]){var m=a[z];if(e._exporting){if(c[z+y])if(!(s&&s.isNode(a)&&l&&"_prefab"===z))continue;if(!e._dontStripDefault&&u(c[z+h],m))continue}c[z+b]?Array.isArray(m)?_[z]=m.map(f):_[z]=f(m):_[z]=C(e,m);var E=c[z+j];E&&(_[E]=_[z])}}if(t&&a instanceof t||n&&a instanceof n){if(e._exporting){if(!(a instanceof t&&a._parent instanceof cc.Scene))return;if(!e._dontStripDefault&&!a._id)return}_._id=a._id}}function z(i,e,r){if(Array.isArray(e))for(var t=0;t<e.length;++t){var n=C(i,e[t]);void 0!==n&&r.push(n)}else{var a=e.constructor;if(s&&s.isNode(e))return function(i,e,r,t){m(i,e)?e._prefab.root===e&&(A(i,e,r,t,c),function(i){let e=i._trs.array;e[7]=1,e[8]=1,e[9]=1}(r)):A(i,e,r,t)}(i,e,r,a),void 0;var _,o=a&&a.__props__;if(o){if(o.length>0)if("_$erialized"!==o[o.length-1])e._onBeforeSerialize&&(_=e._onBeforeSerialize(o)),A(i,e,r,a,_);else e._$erialized&&(r.__type__=e._$erialized.__type__,z(i,e._$erialized,r),i._missingClassReporter&&i._missingClassReporter(e,r.__type__))}else for(var l in e)e.hasOwnProperty&&!e.hasOwnProperty(l)||95===l.charCodeAt(0)&&95===l.charCodeAt(1)||(r[l]=C(i,e[l]))}}function m(i,e){var r=e._prefab;return i._discardContentsForSyncablePrefab&&r&&r.root&&r.root._prefab.sync}function C(t,n){var a=typeof n;if("object"===a){if(!n)return null;var _=n.__id__;if(void 0!==_)return{__id__:_};if(n instanceof e){var u=n._objFlags;if(u&o)return;if(n instanceof r){var f=n._uuid;return f?(p(t,n,f),t._exporting&&(f=i(f,!0)),{__uuid__:f}):null}if(t._exporting&&u&l)return;if(t._discardInvalid){if(!n.isValid)return t._missingObjectReporter&&t._missingObjectReporter(n),null}else if(!n.isRealValid)return null;if(s&&s.isNode(n))if(m(t,n)&&n!==n._prefab.root)return null}return E(t,n)}return"function"!==a?n:null}function E(i,r){var t,s=r instanceof e,n=r.constructor,a=cc.js._getClassId(r,!1);if(s||cc.Class._isCCClass(n)){t=i.serializedList.length,r.__id__=t,i._objsToResetId.push(r);var o={};return i.serializedList.push(o),a&&(o.__type__=a),r._serialize?o.content=r._serialize(i._exporting):(z(i,r,o),s&&r._objFlags>0&&(o._objFlags&=_)),{__id__:t}}return ArrayBuffer.isView(r)?{__type__:"TypedArray",ctor:r.constructor.name,array:Array.from(r)}:!n||n===Object||Array.isArray(r)||a?r._serialize?a?{content:r._serialize(i._exporting),__type__:a}:{content:r._serialize(i._exporting)}:function(i,e){var r=i._parsingObjs.indexOf(e);if(-1!==r){var t=i.serializedList.length;e.__id__=t,i._objsToResetId.push(e);var s=i._parsingData[r];if(!1===Array.isArray(e)){var n=cc.js._getClassId(e,!1);n&&(s.__type__=n)}return i.serializedList.push(s),s}}(i,r)?{__id__:t=r.__id__}:function(i,e){var r;if(Array.isArray(e))r=[];else{r={};var t=cc.js._getClassId(e,!1);t&&(r.__type__=t)}var s=i.serializedList.length;if(i._parsingObjs.push(e),i._parsingData.push(r),z(i,e,r),i._parsingObjs.pop(),i._parsingData.pop(),i.serializedList.length>s){var n=i.serializedList.indexOf(r,s);if(-1!==n)return{__id__:n}}return r}(i,r):null}function R(i,e){var r,t=!("stringify"in(e=e||{}))||e.stringify,s=e.minify,n=s||e.nicify,a=new d(i,e).serializedList;return n&&f(a),r=1!==a.length||Array.isArray(a[0])?a:a[0],!1===t?r:JSON.stringify(r,null,s?0:2)}R.asAsset=function(i){if(!i)return cc.error("[Editor.serialize.asAsset] The uuid must be non-nil!"),null;var e=new r;return e._uuid=i,e},R.setName=function(i,e){Array.isArray(i)?i[0]._name=e:i._name=e},R.findRootObject=function(i,e){if(Array.isArray(i))for(var r=0;r<i.length;r++){var t=i[r];if(t.__type__===e)return t}return null},Editor.serialize=module.exports=R;