"use strict";var e=require("fire-fs"),i=require("fire-path"),t=require("./custom-asset"),r=require("semver");const a=["totalParticles","duration","emissionRate","life","lifeVar","angle","angleVar","startSize","startSizeVar","endSize","endSizeVar","startSpin","startSpinVar","endSpin","endSpinVar","sourcePos","posVar","gravity","speed","speedVar","tangentialAccel","tangentialAccelVar","radialAccel","radialAccelVar","rotationIsDir","startRadius","startRadiusVar","endRadius","endRadiusVar","rotatePerS","rotatePerSVar"],o=["premultipliedAlpha"];async function s(e,i){for(var t=JSON.stringify(e),r=0,a=i.length;r<a;++r)t=t.replace(new RegExp("_"+i[r],"g"),i[r]);return JSON.parse(t)}async function n(e,i){try{if(!Array.isArray(e))return e;const i=Editor.require("unpack://engine-dev/cocos2d/core/components/CCWidget");let t=cc.js._getClassId(i,!1);e=await async function(e,i,t,r){try{let a=await r();a=Editor.serialize(a,{stringify:!1});let o=[];for(let t=0;t<e.length;++t){let r=e[t];if(r.__type__===i){let e=r.node.__id__;o.includes(e)||o.push(e)}}for(let i=0;i<o.length;++i,a=JSON.parse(JSON.stringify(a))){let r=o[i],s=e[r];if(!s||!Array.isArray(s._components))continue;let n=!1;for(let i=0;i<s._components.length;++i){let r=s._components[i];if(!r)continue;let a=e[r.__id__];if(a&&a.__type__===t){n=!0;break}}n||(a.node={__id__:r},e.push(a),s._components.push({__id__:e.length-1}))}}catch(e){Editor.error(e)}return e}(e,"cc.Canvas",t,()=>{let e=new i;return"_alignFlags"in e||Editor.error("Internal: The '_alignFlags' property does not exist in cc.Widget"),e._alignFlags=45,e})}catch(e){Editor.error(e)}return e}class l extends t{constructor(e){super(e),this.asyncLoadAssets=!1,this.autoReleaseAssets=!1}static version(){return"1.2.7"}async import(t,r){e.readJson(t,async(e,a)=>{if(e)return r&&r(e),void 0;if(a){a=await l.verify(t,a),a=await l.migrate(t,a,this.uuid);var o=Editor.serialize.findRootObject(a,"cc.SceneAsset");o?o.asyncLoadAssets=this.asyncLoadAssets:Editor.warn(`Can not find scene assset in the scene file "${t}", it maybe corrupted!`);var s=Editor.serialize.findRootObject(a,"cc.Scene");s?(s.autoReleaseAssets=this.autoReleaseAssets,s._scale&&(s._scale.z=1)):Editor.warn(`Can not find scene in the scene file "${t}", it maybe corrupted!`),Editor.serialize.setName(a,i.basenameNoExt(t)),this._assetdb.saveAssetToLibrary(this.uuid,a)}r&&r(e)})}static defaultType(){return"scene"}static async verify(i,t){let r=!1;if(Array.isArray(t))for(var a=0;a<t.length;++a){var o=t[a];"cc.Node"!==o.__type__||void 0===o._components||Array.isArray(o._components)||(o._components=[],r=!0,Editor.warn(Editor.T("MESSAGE.scene.verify_compoents_warn",{name:o._name})))}return r&&e.writeFileSync(i,JSON.stringify(t,null,2)),t}static async migrate(i,t,c){let _=l.version();try{var d=e.readJsonSync(i+".meta");d&&(_=d.ver)}catch(e){return t}let u=!1;return r.satisfies(_,"< 1.0.1",{includePrerelease:!0})&&(t=await async function(e){if(Array.isArray(e))for(var i=0;i<e.length;i++){var t=e[i];"cc.ParticleSystem"===t.__type__?e[i]=await s(t,a):"sp.Skeleton"===t.__type__&&(e[i]=await s(t,o))}return e}(t),u=!0),r.satisfies(_,"< 1.0.2",{includePrerelease:!0})&&(t=await async function(e){if(Array.isArray(e))for(var i=0;i<e.length;i++){var t=e[i];"cc.LightComponent"===t.__type__&&(t.__type__="cc.Light")}return e}(t),u=!0),r.satisfies(_,"< 1.1.0",{includePrerelease:!0})&&(t=await async function(e,i){if(Array.isArray(e))for(var t=0;t<e.length;t++){var r=e[t];"cc.ParticleSystem"===r.__type__?0===r.positionType&&(r.positionType=1,Editor.warn(Editor.T("IMPORT_ASSET.parse_particle_positionType",{url:Editor.assetdb.uuidToUrl(i),nodeName:e[r.node.__id__]._name}))):"cc.Mask"===r.__type__&&0===r._N$alphaThreshold&&(r._N$alphaThreshold=.1)}return e}(t,c),u=!0),r.satisfies(_,"< 1.2.1",{includePrerelease:!0})&&(t=await async function(e,i){if(Array.isArray(e))for(var t=0;t<e.length;t++){var r=e[t];if("cc.Node"===r.__type__)if(void 0!==r._rotationX||void 0!==r._rotationY){if(0!==r._rotationX||0!==r._rotationY){let e=cc.v3();r._rotationX===r._rotationY?e.z=-r._rotationX:(e.x=r._rotationX,e.y=r._rotationY),r._eulerAngles=Editor.serialize(e,{stringify:!1})}r._rotationX=r._rotationY=void 0}else if(void 0!==r._quat){if(r._is3DNode)r._eulerAngles=Editor.serialize(cc.Quat.toEuler(cc.v3(),r._quat),{stringify:!1});else{const e=Math.PI/180;let i=cc.v3(0,0,Math.asin(r._quat.z)/e*2);r._eulerAngles=Editor.serialize(i,{stringify:!1})}r._quat=void 0}}return e}(t),u=!0),r.satisfies(_,"< 1.2.3",{includePrerelease:!0})?(t=await async function(e,i){if(Array.isArray(e))for(var t=0;t<e.length;t++){var r=e[t],a=r.__type__;if("cc.Node"===a||"cc.Scene"===a){let e=new Float64Array(10);if(void 0!==r._trs){let i=r._trs.array;12===i.length&&(r._skewX=i[10],r._skewY=i[11]),e.set(i.slice(0,10))}else e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=1,e[7]=1,e[8]=1,e[9]=1;void 0!==r._position&&(e[0]=r._position.x,e[1]=r._position.y,e[2]=r._position.z||0,r._position=void 0),void 0!==r._scaleX||void 0!==r._scaleY?(void 0!==r._scaleX&&(e[7]=r._scaleX,r._scaleX=void 0),void 0!==r._scaleY&&(e[8]=r._scaleY,r._scaleY=void 0),e[9]=1):void 0!==r._scale&&(e[7]=r._scale.x,e[8]=r._scale.y,e[9]=r._scale.z,r._scale=void 0),r._trs=Editor.serialize(e,{stringify:!1})}}return e}(t),u=!0):r.satisfies(_,"< 1.2.4",{includePrerelease:!0})&&(t=await async function(e,i){if(Array.isArray(e))for(var t=0;t<e.length;t++){var r=e[t],a=r.__type__;if("cc.Node"===a||"cc.Scene"===a){let e=Float64Array.from(r._trs.array);r._trs=Editor.serialize(e,{stringify:!1})}}return e}(t),u=!0),r.satisfies(_,"< 1.2.5",{includePrerelease:!0})&&(t=await async function(e,i){if(Array.isArray(e))for(var t=0;t<e.length;t++){var r=e[t];if("cc.Camera"===r.__type__){if(!r.node)continue;var a=e[r.node.__id__];if(!a)continue;a._is3DNode&&(r._alignWithScreen=!1)}}return e}(t)),r.satisfies(_,"< 1.2.6",{includePrerelease:!0})&&(t=await n(t),u=!0),r.satisfies(_,"< 1.2.7",{includePrerelease:!0})&&(t=await async function(e,i){try{if(Array.isArray(e))for(var t=0;t<e.length;t++){var r=e[t];"cc.ParticleSystem3D"===r.__type__&&(r.shapeModule&&(r._shapeModule=r.shapeModule),r.colorOverLifetimeModule&&(r._colorOverLifetimeModule=r.colorOverLifetimeModule),r.sizeOvertimeModule&&(r._sizeOvertimeModule=r.sizeOvertimeModule),r.velocityOvertimeModule&&(r._velocityOvertimeModule=r.velocityOvertimeModule),r.forceOvertimeModule&&(r._forceOvertimeModule=r.forceOvertimeModule),r.limitVelocityOvertimeModule&&(r._limitVelocityOvertimeModule=r.limitVelocityOvertimeModule),r.rotationOvertimeModule&&(r._rotationOvertimeModule=r.rotationOvertimeModule),r.textureAnimationModule&&(r._textureAnimationModule=r.textureAnimationModule),r.trailModule&&(r._trailModule=r.trailModule),r.shapeModule=void 0,r.colorOverLifetimeModule=void 0,r.sizeOvertimeModule=void 0,r.velocityOvertimeModule=void 0,r.forceOvertimeModule=void 0,r.limitVelocityOvertimeModule=void 0,r.rotationOvertimeModule=void 0,r.textureAnimationModule=void 0,r.trailModule=void 0)}}catch(e){Editor.error(e)}return e}(t),u=!0),u&&e.writeFileSync(i,JSON.stringify(t,null,2)),t}}module.exports=l;