"use strict";const t=Editor.require("scene://utils/node"),{SegmentTool:e,CurveTool:i}=require("./trajectory-tool");let o,n=require("./utils"),s=n.Segment;try{o=Editor.require("unpack://engine-dev/cocos/animation/motion-path-helper").sampleMotionPaths}catch(t){o=Editor.require("unpack://engine-dev/cocos2d/animation/motion-path-helper").sampleMotionPaths}let l=cc.v2,r=1e-6;function a(t,e){return Math.abs(t-e)<r}class p extends Editor.Gizmo{init(){this._selectedSegTool=null,this._selectedCurveTool=null,this._animationState=null,this._sampledCurve=null,this._clip=null,this._childPath="",this._lastMapping=null,this._curParentMatrix=cc.mat4(),this._lastParentMatrix=cc.mat4(),this._segments=[],this._processing=!1,this._clipChanging=!1}}p.prototype.show=function(t,e,i){if(!t)return;let o=t.getComponent(cc.Animation);if(!o)return;let n=o.getAnimationState(e.name);if(!n)return Editor.error(`Cant't find animation state with clip name [${e.name}]`),void 0;Editor.Gizmo.prototype.show.call(this),this._animationState=n,this._clip=e,this._childPath=i,this._initSampledCurve(),this._initSegments()},p.prototype.onCreateRoot=function(){let t=this._root;this._sampledCurveGroup=t.group(),this._curveGroup=t.group(),this._segmentGroup=t.group()},p.prototype._viewDirty=function(){let e=cc.director.getScene(),i=t.getWorldPosition(e),o=this._view.worldToPixel(i),n=!1;return this._lastMapping&&a(this._lastMapping.x,o.x)&&a(this._lastMapping.y,o.y)||(n=!0),this._lastMapping=o,n},p.prototype._parentDirty=function(){let t=this.target.parent.getWorldMatrix(this._curParentMatrix),e=this._lastParentMatrix,i=!1;return e&&a(e.m[0],t.m[0])&&a(e.m[1],t.m[1])&&a(e.m[4],t.m[4])&&a(e.m[5],t.m[5])&&a(e.m[12],t.m[12])&&a(e.m[13],t.m[13])||(i=!0),cc.Mat4.copy(e,t),i},p.prototype.visible=function(){return!this._hidden&&(this._viewDirty()||this._parentDirty())},p.prototype.update=function(){this.targetValid()&&this.visible()&&this._updateSegments()},p.prototype._pixelVecToArray=function(t){let e=this._view,i=this.target.parent.convertToNodeSpaceAR(e.pixelToWorld(t));return[i.x,i.y]},p.prototype._segToArray=function(t){let e=this._pixelVecToArray(t.pos),i=this._pixelVecToArray(t.inControl),o=this._pixelVecToArray(t.outControl);return e.concat(i).concat(o)},p.prototype._initSegments=function(){let t=this._clip.getProperty("position","",this._childPath)||[],e=[];for(let i=0,o=t.length;i<o;i++){let o=t[i],n=new s;n.originValue=o.value,n.keyframe=o,e.push(n);let l=o.motionPath||[];for(let t=0;t<l.length;t++){let i=l[t],o=new s;o.originValue=i,e.push(o)}}this._segments=e,this.initCurveTools(),this._updateSegments()},p.prototype._updateSegments=function(){let t=this.target.parent,e=this._view;function i(i,o){let n=cc.v2(i,o);return n=t.convertToWorldSpaceAR(n),e.worldToPixel(n)}let o=this._segments;for(let t=0,e=o.length;t<e;t++){let e=o[t],n=e.originValue;2===n.length||3===n.length?(e.pos=i(n[0],n[1]),e.inControl=e.pos.clone(),e.outControl=e.pos.clone()):6===n.length&&(e.pos=i(n[0],n[1]),e.inControl=i(n[2],n[3]),e.outControl=i(n[4],n[5])),e.tool.plot(),e.keyframe&&e.tool.curveTools[0].plot()}},p.prototype._createSegmentTool=function(t){let i=this._segmentGroup,o=this,n=!1,s=new e(i,t,{beforeSelected:function(t){-1===t.curveTools.indexOf(o._selectedCurveTool)&&t.curveTools[0].select(),o._selectedSegTool&&o._selectedSegTool.unselect(),o._selectedSegTool=t},onDelete:function(t){o._removeSegment(t)},start:function(){o._processing=!0,o._initSampledCurve(),n=!1},update:function(t){n=!0,t.curveTools.forEach(function(t){t.plot()}),o._updateSampledCurves(),o._animationState.sample(),cc.engine.repaintInEditMode()},end:function(){o._processing=!1,n&&o._clipChanged()}});return t.tool=s,s},p.prototype.initCurveTools=function(){let t=this._segments,e=this._curveGroup,o=this._segmentGroup;e.clear(),o.clear();let n=this,s={beforeSelected:function(t){n._selectedCurveTool&&n._selectedCurveTool.unselect(),n._selectedCurveTool=t},addSegment:function(t,e){let i=l(t,e);n._addSegment(i)}},r=i(e,"",s);for(let o=0,n=t.length;o<n;o++){let l=t[o],a=this._createSegmentTool(l);a.curveTools.push(r),r.segmentTools.push(a),o>0&&l.keyframe&&(r.plot(),o<n-1&&((r=i(e,"",s)).segmentTools.push(a),a.curveTools.push(r)))}},p.prototype._addSegment=function(t){let e=this._selectedCurveTool;if(!e)return;let i,o,s=e.segmentTools;for(let e=0,l=s.length-1;e<l;e++){o=s[e];let l=s[e+1],r=n.getNearestParameter(o.segment,l.segment,t);(!i||r.dist<i.dist)&&((i=r).seg1=o,i.seg2=l)}let l=n.createSegmentWithNearset(i);l.originValue=this._segToArray(l);let r=this._segments,a=r.indexOf(i.seg2.segment);r.splice(a,0,l),o=this._createSegmentTool(l);let p=e.segmentTools.indexOf(i.seg2);e.segmentTools.splice(p,0,o),o.curveTools.push(e),o.show(),o.select(),e.plot(),this._updateSampledCurves(),this._clipChanged()},p.prototype._addKeySegment=function(t,e,i){let o,n;if(0===i.length||e<i[0].frame)o=0;else for(o=0,n=i.length;o<n&&!(i[o].frame>e);o++);let s={frame:e,value:[t.x,t.y],motionPath:[]};return i.splice(o,0,s),o},p.prototype._removeSegment=function(t){let e=this._segments,i=t.segment,o=t.curveTools[0],n=o.segmentTools;t.hide(),e.splice(e.indexOf(i),1),n.splice(n.indexOf(t),1),o.plot(),this._updateSampledCurves(),this._clipChanged(),this._selectedSegTool===t&&(this._selectedSegTool=null)},p.prototype._clipChanged=function(){this._clipChanging=!0,Editor.Ipc.sendToWins("scene:animation-clip-changed",{uuid:this._clip._uuid,data:this._clip.serialize(),clip:this._clip.name})},p.prototype._initSampledCurve=function(){let t,e=this._animationState.curves;for(let i=0,o=e.length;i<o;i++){let o=e[i];if(o.target===this.target&&"position"===o.prop){t=o;break}}this._sampledCurve=t},p.prototype._updateSampledCurves=function(){let t,e,i,n=this._segments,s=[],l=this._clip,r=this._sampledCurve;if(!r)return;let a=Editor.Math.numOfDecimalsF(1/this._view.scale);function p(t){for(let e=0,i=t.length;e<i;e++)t[e]=Editor.Math.toPrecision(t[e],a);return t}for(e=0,i=n.length;e<i;e++){let i=n[e];if(i.keyframe){t=i.keyframe,i.originValue=t.value=p(this._pixelVecToArray(i.pos)),t.motionPath=[],s.push(t);continue}let o=i.originValue=p(this._segToArray(i));t.motionPath.push(o)}let u=[];for(r.ratios=[],r.types=[],r.values=[],e=0,i=s.length;e<i;e++){let i=(t=s[e]).frame/l.duration;r.ratios.push(i),r.values.push(t.value),r.types.push(t.curve),t.motionPath&&t.motionPath.length>0?u.push(t.motionPath):u.push(null)}o(u,r,l.duration,l.sample)},p.prototype.assetChanged=function(t){let e=this._clip;e&&e._uuid===t&&!this._hidden&&cc.AssetLibrary.loadAsset(t,function(t,e){this.updateClip(e)}.bind(this))},p.prototype.updateClip=function(t){if(this._clipChanging)return this._clipChanging=!1,void 0;this._clip._uuid!==t._uuid||this._hidden||(this._clip=t,this._initSampledCurve(),this._initSegments())},p.animationChanged=!1,p.state="segment",module.exports=p;