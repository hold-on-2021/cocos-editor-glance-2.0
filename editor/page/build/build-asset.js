"use strict";var e=cc.Font;const t=!1,s=require("path"),i=require("fire-fs"),r=require("../../share/build-platforms"),a=require("../scene-utils/missing-class-reporter").MissingClass,l=Editor.require("app://editor/page/build/texture-compress");class o{constructor(e,t,s,i){this.writer=e,this.library=t,this.assetdb=s;var a=Editor.remote.Builder.actualPlatform2Platform(i),l=r[a];this.actualPlatform=i,this.isJSB=l.isNative,this.exportSimpleFormat=!l.stripDefaultValues||l.exportSimpleProject,this.shouldExportScript=!l.exportSimpleProject,this.deserializeDetails=new cc.deserialize.Details,this.existsCache={},this._bindedGetAssetRef=this._getAssetRef.bind(this),this.uuid2meta=Editor.remote.assetdb._uuid2meta}build(e,t){this.assetdb.queryInfoByUuid(e,(s,i)=>{if(!i)return this.existsCache[e]=!1,t(new Error(o.AssetMissing));this.existsCache[e]=!0;var r=i.type;return r?"folder"===r?(console.warn("Should not build folder"),t()):(this._buildAsset(e,t),void 0):t(new Error("Asset type not specified "+i.url))})}_exportNativeAsset(e,t){let r=e.nativeUrl,a=s.relative(this.library,r),o=s.join(this.writer.dest,"..","raw-assets",a);if(e instanceof cc.Texture2D){let i=this.uuid2meta[e._uuid];l({src:r,dst:o,actualPlatform:this.actualPlatform,compressOption:i.platformSettings},(i,r,a)=>{i&&Editor.error(i),r&&r.length>0?e._exportedExts=r:e._exportedExts=[s.extname(o)],t(null,a)})}else{try{i.copySync(r,o)}catch(e){return Editor.error("Failed to copy native asset file %s to %s,",r,o,e),t(null,"")}t(null,[o])}}_getAssetRef(e){var t=this.existsCache[e];return void 0===t&&(t=this.existsCache[e]=!!Editor.assetdb.remote.uuidToFspath(e)),t?Editor.serialize.asAsset(e):null}_buildAsset(r,l){var o=s.join(this.library,r.slice(0,2),r+".json"),d=i.readFileSync(o);t&&console.log("building "+o),this.deserializeDetails.reset();var n=cc.deserialize(d,this.deserializeDetails,{ignoreEditorOnly:!0,classFinder:a.classFinder});n._uuid=r,this.shouldExportScript&&a.reportMissingClass(n),a.reset(),this.deserializeDetails.assignAssetsBy(this._bindedGetAssetRef);var u,h=this.deserializeDetails.uuidList.slice();h.length>0&&(u=this.deserializeDetails.uuidObjList.slice()),n._native&&(this.isJSB||!n.constructor.preventPreloadNativeObject||n instanceof e)?this._exportNativeAsset(n,(e,t)=>{this._doBuildJson(n,h,u,t,l)}):this._doBuildJson(n,h,u,void 0,l)}_doBuildJson(e,t,s,i,r){var a=Editor.serialize(e,{exporting:!0,nicify:!this.exportSimpleFormat,stringify:!1,dontStripDefault:this.exportSimpleFormat});this.writer.writeJsonByUuid(e._uuid,a,e=>e?r(e):r(null,{dependUuids:t,ownersForDependUuids:s,nativePaths:i}))}}o.AssetMissing="asset missing",module.exports=o;