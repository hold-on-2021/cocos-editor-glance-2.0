"use strict";var e=require("lodash"),r=require("async");class t{constructor(){this.groupManager=null}init(e){this.groupManager=e}shouldPack(e){return!1}transformGroups(e,r){r(null,e=e.map(e=>({uuids:e,name:"",type:"normal"})))}mergeSmallFiles(e,r){r(null,e)}}module.exports={GroupStrategyBase:t,Balanced:class extends t{shouldPack(e){return"scene"===e.type||!!Editor.assetdb.remote.containsSubAssetsByUuid(e.uuid)}},SizeMinimized:class extends t{shouldPack(e){return!e.isSubAsset}transformGroups(e,r){r(null,e=(e=this.splitGroups(e)).map(e=>({uuids:e,name:"",type:"normal"})))}splitGroups(r,t){if(t=void 0!==t&&t,r.length<2)return r;var n=[r[0]];e:for(var s=1;s<r.length;s++){for(var i=r[s],a=n.length,u=0;u<a;u++){var l=n[u],o=e.intersection(l,i),d=l.length,c=i.length,f=o.length;if(0!==f)if(f===d){if(d===c)continue e;i=e.difference(i,o)}else{if(f===c){d!==c&&(l=e.difference(l,o),n[u]=l,n.push(o));continue e}i=e.difference(i,o),l=e.difference(l,o),n[u]=l,n.push(o)}}n.push(i)}if(t){var m=e.flatten(n),p=e.uniq(m);if(p.length<m.length)return Editor.warn("Internal error: SizeMinimized.transformGroups: res not unique, transform canceled"),r;var h=e.flatten(r);if(e.difference(h,p).length>0)return Editor.warn("Internal error: SizeMinimized.transformGroups: not have the same members, transform canceled"),r}return n}},ForHotUpdate:class extends t{mergeSmallFiles(e,t){this.groupManager.queryAssetInfosInBuild(cc.SpriteFrame,(n,s)=>{var i=new Editor.Utils.MultipleValueDict,a=this.groupManager.writer;r.each(s,(e,r)=>{let t=e.uuid;a.readJsonByUuid(t,(e,n)=>{let s=n&&n.content&&n.content.texture;s&&i.add(s,t),r()})},()=>{i=i.multiple();for(let r in i){let t=i[r];this.groupManager.removeFromGroups(e,t),e.push({name:"",uuids:t})}t(null,e)})})}}};