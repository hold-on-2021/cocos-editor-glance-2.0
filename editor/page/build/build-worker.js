(()=>{"use strict";0;const e=require("electron").ipcRenderer;var t,r,i,n,o,a;window.onerror=function(e,t,r,i,n){window.onerror=null;var o=n.stack||n;Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&(Editor.Ipc.sendToMain("app:build-project-abort",o),Editor.Ipc.sendToMain("metrics:track-exception",o))},window.addEventListener("unhandledrejection",function e(t){window.removeEventListener("unhandledrejection",e),window.onerror(void 0,void 0,void 0,void 0,t.reason)}),e.on("app:init-build-worker",function(e,s,d){t=require("path"),r=require("fire-fs"),require("gulp"),require("event-stream"),i=require("async"),n=require("lodash"),o=require("../../share/build-platforms"),Editor.isBuilder=!0,window.CC_TEST=!1,window.CC_EDITOR=!0,window.CC_PREVIEW=!1,window.CC_DEV=!1,window.CC_DEBUG=!0,window.CC_BUILD=!1,window.CC_JSB=!1,Editor.require("app://editor/share/editor-utils"),Editor.require("unpack://engine-dev"),Editor.require("app://editor/share/engine-extends/init"),Editor.require("app://editor/share/engine-extends/serialize"),Editor.require("app://editor/page/asset-db"),Editor.require("app://editor/share/register-builtin-assets");const l=require(Editor.url("app://editor/page/project-scripts"));a=Editor.remote.importPath;var u=Editor.remote.Builder.actualPlatform2Platform(s),c=!o[u].exportSimpleProject;i.waterfall([function(e){cc.AssetLibrary.init({libraryPath:a});var t=document.createElement("canvas");document.body.appendChild(t),t.id="engine-canvas",cc.game.run({width:800,height:600,id:"engine-canvas",jsList:[],debugMode:cc.debug.DebugMode.INFO},e)},Editor.Utils.asyncif(c,l.load.bind(l))],t=>{e.reply(t||null)})}),e.on("app:build-assets",function(e,s,d,l,u){var c,p,f=4,E=Editor.remote.Builder.actualPlatform2Platform(d),m=o[E],w=u.hasOwnProperty("pack")?u.pack:m.pack,h=t.join(s,"import"),g=require("./file-writer"),b=require("./asset-crawler"),k=require("./build-asset"),q=require("./group-manager"),v=require("./group-strategies"),y=require("./texture-packer"),x=require("./building-assetdb"),P=new g(h,l),C=new x(Editor.assetdb),U=new y;if(m.isNative){if(u.mergeStartScene=!1,u.optimizeHotUpdate)u.inlineSpriteFrames=!1;else{u.inlineSpriteFrames&&Editor.info('Enable "%s" in native platform will increase the package size used in hot update.',Editor.T("BUILDER.merge_asset.inline_SpriteFrames"))}w=w&&(u.optimizeHotUpdate||u.inlineSpriteFrames)}w&&(p=m.isNative?u.optimizeHotUpdate?new v.ForHotUpdate:new v.GroupStrategyBase:new v.SizeMinimized,console.log("group strategy:",cc.js.getClassName(p)),c=new q(P,l,p,C,n.pick(u,"inlineSpriteFrames","mergeStartScene")));var S,j,T,I=new k(P,a,C,d),_=new b(I,f,U);var A=[e=>{console.time("queryResources"),e(null)},function(e){var t=[],i=!1,n=!1;Editor.assetdb.queryAssets("db://assets/resources/**/*",null,function(r,o){t=t.concat(o),n?e(r,t):i=!0});const o=Editor.url("unpack://engine/modules.json");let a=[];try{let e=r.readJsonSync(o);const t=Editor.Profile.load("project://project.json").get("excluded-modules")||[];t.length>0&&e.forEach(e=>{let r=e["internal/resources"];t.includes(e.name)&&r&&(a=a.concat(r))})}catch(e){Editor.warn(e)}console.log("excluded assetsï¼š"+JSON.stringify(a)),Editor.assetdb.queryAssets("db://internal/resources/**/*",null,function(r,o){if(a.length>0){const e=require("fire-url");o=o.filter(t=>{let r=e.basenameNoExt(t.url);return!a.includes(r)})}t=t.concat(o),i?e(r,t):n=!0})},(e,t)=>{console.timeEnd("queryResources"),console.time("startAssetCrawler"),t(null,e)},function(e,t){var r=e.filter(e=>"folder"!==e.type&&"javascript"!==e.type&&"typescript"!==e.type).map(e=>e.uuid),i=u.scenes;S=n.uniq(i.concat(r)),_.start(S,t)},(e,t)=>{console.timeEnd("startAssetCrawler"),t(null,e)},function(e,t){j=e,t(null)}];1,A=[].concat(function(e){Editor.assetdb.queryAssets("db://assets/**/*.pac",null,e)},function(e,t){U.init({files:e,writer:P,actualPlatform:d}).then(t).catch(t)},A,function(e){Editor.Ipc.sendToMain("builder:state-changed","pack-textures",.7),console.time("pack textures"),U.pack(j).then(t=>{let{unpackedTextures:r,packedSpriteFrames:i,packedTextures:o}=t,a=r.map(e=>e.textureUuid),s=n.pullAll(U.textureUuids,a);for(let e in i)j[e]={dependUuids:[i[e]]};for(let e in o){let t=o[e];j[e]={nativePath:t[0],nativePaths:t},C.addGeneratedAsset(e,t[0],"texture",!1)}let d=[],l=U.texture2pac;if(s.length>0)for(let e in j){let t=j[e];if("object"!=typeof t)continue;let r=t.dependUuids;if(r)for(let t=0,i=r.length;t<i;t++){let i=r[t];if(-1!==s.indexOf(i)&&-1===d.indexOf(i)){d.push(i);let t=Editor.assetdb.remote.uuidToUrl(i),r=l[i].relativePath,n=Editor.assetdb.remote.uuidToUrl(e);Editor.warn(Editor.T("BUILDER.error.keep_raw_texture_of_atlas",{texturePath:t,pacPath:r,assetPath:n}))}}}if(n.pullAll(S,U.textureUuids),r.length>0||d.length>0){let t=r.map(e=>{let t=Editor.assetdb.remote.uuidToUrl(e.textureUuid);return Editor.warn(`${t} has not been packed into AutoAtlas.`),e.uuid}).concat(d);new b(I,f).start(t,(t,r)=>{if(t)return e(t);Object.assign(j,r),e()}),S=n.uniq(S.concat(t))}else e();console.timeEnd("pack textures"),w?Editor.Ipc.sendToMain("builder:state-changed","pack-assets",.8):Editor.Ipc.sendToMain("builder:state-changed","build-assets",.8)}).catch(t=>e(t))}),w&&A.push(function(e){console.time("init packs"),c.initPacks(S,j,u.scenes[0],e)},function(e){console.timeEnd("init packs"),console.time("build packs"),c.buildPacks(e)},function(e,t){console.timeEnd("build packs"),T=e.packedAssets,t()}),A.push(function(e){P.flush(e)}),i.waterfall(A,function(t){if(t)(t=t&&t.stack)instanceof Error||(t=new Error(t)),e.reply(t);else{console.log("finished build-worker"),S.forEach(e=>{var t=j[e];"object"!=typeof t?j[e]={isRoot:!0}:t.isRoot=!0});e.reply(null,j,T)}})})})();