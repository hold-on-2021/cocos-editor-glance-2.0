"use strict";var e=require("async"),t=require("lodash");const{promisify:s}=require("util");var i=Editor.require("app://editor/share/engine-extends/json-packer"),r=Editor.require("app://editor/share/engine-extends/texture-asset-packer"),n=require("./hash-uuid");const l=8,u=500;var o=!0;function a(t,s,i){return new Promise((r,n)=>{e.eachLimit(t,i,s,e=>{e?n(e):r()})})}module.exports=class{constructor(e,t,s,i,r){this.writer=e,this.strategy=s,this.assetdb=i,this.minify=!t,s.init(this),this.inlineSpriteFrames=!!r.inlineSpriteFrames,this.mergeStartScene=!!r.mergeStartScene,this.packers=[],this.rootUuids=null,this.packableGroupRootUuids=null,this.buildAssets=null,this.startSceneUuid=""}_isPackable(e){var t=e.type;if(!t)return!1;var s=Editor.assets[t];return!(!s||cc.RawAsset.isRawAssetType(s))}_queryPackableByUuid(e,t){this.assetdb.queryInfoByUuid(e,(e,s)=>e?t(e):s?s.type?(t(null,this._isPackable(s)),void 0):t(new Error("Asset type not specified "+s.url)):t(null,!1))}_queryPackableDepends(e,s){var i=Editor.Utils.getDependsRecursively(this.buildAssets,e,"dependUuids");if(!Array.isArray(i)||0===i.length)return s(null,null);var r=t([e]).concat(i).uniq().value();Editor.Utils.filterAsync(r,this._queryPackableByUuid.bind(this),s)}_groupInRoot(e){var t=[];a(this.rootUuids,(e,s)=>{this.assetdb.queryInfoByUuid(e,(i,r)=>i?s(i):r?r.type?this.strategy.shouldPack(r)?(this.packableGroupRootUuids.push(e),this._queryPackableDepends(e,(e,i)=>{if(e)return s(e);i&&i.length>1&&t.push(i),s()}),void 0):s():s(new Error("Asset type not specified "+r.url)):s(new Error("Can not get asset info of "+e)))},u).then(()=>{e(null,t)},s=>{e(s,t)})}removeFromGroups(e,s){for(let i=0;i<e.length;i++){let r=e[i].uuids;t.pullAll(r,s),0===r.length&&(cc.js.array.fastRemoveAt(e,i),--i)}}_mergeStartScene(e,t){console.time("init packs: merge start scene"),this._queryPackableDepends(this.startSceneUuid,(s,i)=>{if(s)return t(s);i&&(this.removeFromGroups(e,i),e.push({name:"",uuids:i})),console.timeEnd("init packs: merge start scene"),t(null,e)})}getAllUuidsInBuild(){return t(this.buildAssets).values().filter(e=>"object"==typeof e&&e.dependUuids).map(e=>e.dependUuids).push(this.rootUuids).flatten().uniq().value()}async queryAssetInfosInBuild(e,s){var i=t.findKey(Editor.assets,t=>t===e);if(!i)return Editor.error("can not find asset type for "+cc.js.getClassName(e)),s([]);var r=this.getAllUuidsInBuild(),n=[];await a(r,(e,t)=>{this.assetdb.queryInfoByUuid(e,(e,s)=>{s&&s.type===i&&n.push(s),t()})},u),s(null,n)}_inlineToDependsGroup(e,t){let s=Object.create(null);for(let e in this.buildAssets){let t=this.buildAssets[e];if("object"!=typeof t)continue;let i=t.dependUuids;if(i)for(let t=0;t<i.length;t++){let r=s[i[t]];r?r.push(e):s[i[t]]=[e]}}let i=Object.create(null),r=[];for(let n=0;n<t.length;n++){let l=t[n],u=0,o=s[l];if(o){for(let t=0;t<o.length;t++){let s=o[t],r=i[s];if(!r){r=[];for(let t=0;t<e.length;t++){let i=e[t].uuids;-1!==i.indexOf(s)&&r.push(i)}i[s]=r}if(r.length>0)for(let e=0;e<r.length;e++){let t=r[e];-1===t.indexOf(l)&&(t.push(l),++u)}else{let t=[s,l];e.push({name:"",uuids:t}),r.push(t),++u}}u>0&&r.push(l)}}return r}_inlineSpriteFrames(e,t){console.time("inline single SpriteFrames: queryAssetInfosInBuild"),this.queryAssetInfosInBuild(cc.SpriteFrame,(s,i)=>{console.timeEnd("inline single SpriteFrames: queryAssetInfosInBuild"),console.time("inline single SpriteFrames: 1");var r=i.map(e=>e.uuid);if(console.timeEnd("inline single SpriteFrames: 1"),console.time("inline single SpriteFrames: 2"),o)this.removeFromGroups(e,r);else{let t=new Set;for(let s=0;s<e.length;s++){let i=e[s].uuids;if(i.length>1)for(let e=0;e<i.length;e++)t.add(i[e])}r=r.filter(e=>!t.has(e))}console.timeEnd("inline single SpriteFrames: 2"),console.time("inline single SpriteFrames: 3");let n=this._inlineToDependsGroup(e,r);console.timeEnd("inline single SpriteFrames: 3"),console.time("inline single SpriteFrames: 4");for(let t=0;t<n.length;t++){let s=n[t];-1!==this.packableGroupRootUuids.indexOf(s)&&(e.push({name:"",uuids:[s],isPlaceholder:!0}),console.log(`add dummy group to allow download ${s} individually`))}console.timeEnd("inline single SpriteFrames: 4"),t(null,e)})}_packAllTextures(e,t){this.queryAssetInfosInBuild(cc.Texture2D,(s,i)=>{var r=i.map(e=>e.uuid);this.removeFromGroups(e,r),e.push({name:"",uuids:r,type:"texture"}),t(null,e)})}_mergeSmallFiles(t,s){var i=[e=>e(null,t)];this.inlineSpriteFrames&&i.push(this._inlineSpriteFrames.bind(this)),i.push(this._packAllTextures.bind(this)),this.mergeStartScene&&i.push(this._mergeStartScene.bind(this)),e.waterfall(i,s)}_computeGroup(t){console.time("init packs: computeGroup"),console.time("computeGroup: _groupInRoot"),e.waterfall([this._groupInRoot.bind(this),(e,t)=>{console.timeEnd("computeGroup: _groupInRoot"),console.time("computeGroup: strategy.transformGroups"),t(null,e)},this.strategy.transformGroups.bind(this.strategy),(e,t)=>{console.timeEnd("computeGroup: strategy.transformGroups"),t(null,e)},this.strategy.mergeSmallFiles.bind(this.strategy),(e,t)=>{console.time("computeGroup: _mergeSmallFiles"),t(null,e)},this._mergeSmallFiles.bind(this),(e,t)=>{console.timeEnd("computeGroup: _mergeSmallFiles"),t(null,e)},(e,t)=>{t(null,e.filter(e=>e.isPlaceholder||e.uuids.length>1))},(e,t)=>{console.timeEnd("init packs: computeGroup"),t(null,e)}],t)}_packAssets(t,s,i){e.each(s,(e,s)=>{this.writer.readJsonByUuid(e,(i,r)=>{if(i)return s(i);t.add(e,r),s()})},i)}initPacks(t,s,n,u){this.rootUuids=t,this.packableGroupRootUuids=[],this.buildAssets=s,this.startSceneUuid=n,this._computeGroup((t,s)=>{if(t)return u(t);e.eachLimit(s,l,(e,t)=>{var s=e.uuids,n="texture"===e.type?new r:new i;this._packAssets(n,s,s=>{if(s)return t(s);n.name=e.name,this.packers.push(n),t()})},u)})}buildPacks(t){var s=this.packers.map(e=>e.pack(this.minify)),i=s.map(e=>e.indices),r=n.calculate(i,n.BuiltinHashType.PackedAssets);console.time("build packs: write pack");var u={};e.eachLimit(Object.keys(s),l,(e,t)=>{var i=s[e],n=r[e];u[n]=i.indices,this.writer.deleteJsonsByUuid(i.indices,e=>{if(e)return t(e);this.writer.writeJsonByUuidNoCache(n,i.data,t)})},e=>{console.timeEnd("build packs: write pack"),e?t(e):t(null,{packedAssets:u})})}};