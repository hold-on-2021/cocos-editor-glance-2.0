(()=>{"use strict";const{promisify:e}=require("util");require("electron").ipcRenderer.on("app:compile-worker-start",function(r,t){const i=require("fire-path"),o=(require("async"),require("globby")),n=require("gulp"),a=require("del"),s=require("fire-fs");Editor.isDarwin&&require("graceful-fs").gracefulify(require("fs"));var u=t.cacheDir?null:require("browserify"),l=t.cacheDir?require("persistify"):null;let c=!1;const d=require("vinyl-source-stream"),p=require("vinyl-buffer"),f=require("gulp-sourcemaps"),m=Editor.require("unpack://engine/gulp/util/utils").uglify,b=Editor.require("app://editor/page/refine-sourcemap"),g=s.readFileSync(Editor.url("unpack://static/_prelude.js"),"utf8");window.onerror=function(e,r,t,i,o){window.onerror=null;var a=o.stack||o;if(Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&Editor.Ipc.sendToMain("metrics:track-exception",a),c)return n.emit("error",o),!0;Editor&&Editor.Ipc&&Editor.Ipc.sendToMain&&Editor.Ipc.sendToMain("editor:renderer-console-error",a)},Editor.require("app://editor/share/editor-utils"),Editor.require("app://editor/page/asset-db");var h="library/imports",y="Compile error:",E="Error: ",v="Cannot find module ";t.dest=t.dest||"library/bundle.js",t.platform=t.platform||"editor",t.debug=!!t.debug,t.sourceMaps="sourceMaps"in t?t.sourceMaps:t.debug;var w={destRoot:t.destRoot,dest:t.dest,destDir:i.dirname(t.dest),proj:i.resolve(t.project),subpackages:t.subpackages};w.dest=i.resolve(w.proj,w.dest);t.platform;if(i.contains(Editor.appPath,w.proj)){return r.reply(null,new Error(`${y} Invalid project path: ${t.project}`).stack),void 0}console.log("Compiling "+w.proj);var k={},q={};function j(e){return i.basenameNoExt(e)}n.task("do-clean",async function(){var e=i.join(i.dirname(w.dest),i.basenameNoExt(w.dest))+i.extname(w.dest);try{await a(e,{force:!0})}catch(r){throw Editor.error(`Failed to delete ${e}, press [F7] to try again.`),r}}),n.task("clean",n.parallel("do-clean"),function(e){setTimeout(e,100)});let _={},x=[],$={},M={},N=[];function C(e,r,o,a,s){var h,E=w.proj,j={debug:t.sourceMaps,basedir:E,builtins:["assert","buffer","console","constants","crypto","domain","events","http","https","os","path","punycode","querystring","stream","_stream_duplex","_stream_passthrough","_stream_readable","_stream_transform","_stream_writable","string_decoder","sys","timers","tty","url","util","vm","zlib","_process"],extensions:[".ts",".coffee"],ignoreMissing:!0,externalRequireName:"window.__require",prelude:g};e.sort(),function(e,r){if(r._bresolve)r.__bresolve=r._bresolve,r._bresolve=function t(o,n,a){r.__bresolve(o,n,function(r,s,u){if(r){if(n&&n.filename){var l=q[n.filename]||q[n.filename.toLowerCase()];if(l)return n.filename=l,n.basedir=i.dirname(l),t(o,n,a);console.warn(`Failed to resolve script "${o}" in raw directory: `,n)}return a(null,s,u)}var c=k[s];return c||(c=k[s.toLowerCase()])&&console.log(`resolve "${o}" to "${c}" by ignoring case mistake`),a(null,s=!c&&e?"":c||s,u)})};else if(c){let e=new Error("Failed to patch browserify");n.emit("error",e)}}(a,h=t.cacheDir?l(j,{recreate:t.recreateCache,cacheId:t.platform+"_"+!!t.debug+"_"+!!t.sourceMaps,cacheDir:t.cacheDir}):new u(j));for(let r=0;r<e.length;++r){var _=e[r];h.add(_),h.require(_,{expose:i.basenameNoExt(_)})}for(let r=0;r<x.length;++r){let t=x[r];-1===e.indexOf(t)&&h.exclude(k[t.toLowerCase()])}var $=h.bundle().on("error",function(e){c&&(e=new Error(function(e){function r(e,r,t){if(e.startsWith(r)){if(!t)return e.slice(r.length);if(e.endsWith(t))return e.slice(r.length,-t.length)}return""}var t,o=(e.message||e.toString()).trim();if(!o)return e;if(t=r(o,"ENOENT, open '",".js'")){let e=i.basenameNoExt(t);return`${y} Cannot require '${e}', module not found, ${o}`}if(t=r(o,"ENOENT: no such file or directory, open '",".js'")){let e=i.basenameNoExt(t);return`${y} Cannot require '${e}', module not found, ${o}`}if(r(o,v)){let e=v.length+1,r=o.indexOf("'",e);if(-1===r)return o;let t=o.slice(e,r);if(i.basename(t)===t&&i.extname(t))return`${y} Cannot require '${t}', module not found, please remove file extension and retry. ( just "require('${i.basenameNoExt(t)}');"`;o=o.replace(v,"Cannot require ")+". Module not found."}return e.annotated&&(o=o+"\n"+e.annotated),y+" "+o}(e)),n.emit("error",e))}).pipe(d(o));$=$.pipe(p()),t.sourceMaps&&($=$.pipe(f.init({loadMaps:!0})));var M=Editor.require("app://editor/share/build-platforms")[t.platform].isNative,N="runtime"===t.platform;let C={jsb:M&&!N,runtime:N,minigame:"mini-game"===t.platform,debug:t.debug};t.compileFlags&&Object.assign(C,t.compileFlags),$=$.pipe(m("build",C)),t.sourceMaps&&($=$.pipe(b(k,E)).pipe(f.write("./"))),($=$.pipe(n.dest(r))).on("end",s)}n.task("query-sub-packages",function(r){Editor.remote.assetdb.queryMetas("db://assets/**","folder",async(t,o)=>{if(t)return Editor.error(t);o=o.filter(e=>e.isSubpackage);for(let t=0;t<o.length;++t){let n=o[t],a=Editor.assetdb.remote.uuidToFspath(n.uuid),s=n.subpackageName||i.basenameNoExt(a),u=Editor.remote.assetdb.uuidToUrl(n.uuid)+"/**/*",l=i.join("subpackages",s)+"/";M[s]={name:s,path:l.replace(/\\/g,"/")},$[s]||($[s]=[]);let c=null;try{c=await e(Editor.remote.assetdb.queryAssets.bind(Editor.remote.assetdb))(u,null)}catch(e){return r(e)}c=c.filter(e=>"javascript"===e.type||"typescript"===e.type);for(let e=0;e<c.length;++e){let r=c[e],t=Editor.assetdb.remote.uuidToFspath(r.uuid);$[s].push(t)}}r()})}),n.task("get-scripts",function(e){(function(e){var r=i.join(h,"**/*.js"),t=w.proj,n={cwd:t};function a(e){return i.relative(n.cwd,e)}function s(e,r,t){e[r]=t;let i=r.toLowerCase();i in e||(e[i]=t)}o(r,n,(r,o)=>{if(r)return e(r);for(var n=0;n<o.length;n++){var u=o[n],l=j(u),c=Editor.assetdb.remote.uuidToFspath(l);if(!c){Editor.warn("Can not get fspath of: "+l+" from assetdb, but script found in library.");continue}var d=i.resolve(t,u);s(q,d,c),s(k,c,d);var p=i.basenameNoExt(c),f=_[p];if(f){var m=a(c),b=a(f),g=new Error(`${y} Filename conflict, the module "${p}" both defined in "${m}" and "${b}"`);return e(g)}_[p]=c;let r=!1;for(let e in $){let t=$[e];for(let e=0;e<t.length;e++)if(i.contains(t[e],c)){r=!0;break}}r||N.push(c),x.push(c)}e()})})(e)}),n.task("browserify-main-package",function(e){console.log("Output main package : "+w.dest);let r=i.basename(w.dest);C(N,w.destDir,r,!1,function(){e()})}),n.task("browserify-sub-packages",async r=>{for(let t in $){let o=$[t],n=i.join(w.subpackages,t),a="index.js";console.log("Output sub package : "+i.join(n,a));try{await e(C)(o,n,a,!0)}catch(e){return r(e)}}r()}),n.task("compile",n.series("clean","query-sub-packages","get-scripts","browserify-main-package","browserify-sub-packages")),n.once("error",function(e){e=function(e){return e.error?"boolean"==typeof e.error.showStack?e.error.toString():e.error.stack?e.error:new Error(String(e.error)):new Error(String(e.message))}(e);let t=Editor.Utils.toString(e);if("string"==typeof e.stack){if(!(e=e.stack).startsWith(t)){let r=/^.*/.exec(t)[0];e.startsWith(r)&&(e=(e=e.slice(r.length)).trimLeft()),e=t+"\n"+e}e.startsWith(E+y)&&(e=e.slice(E.length))}else e=t;if(c){c=!1;let t=null;r.reply(t,e,M)}}),c=!0,n.task("compile")(function(){c=!1;r.reply(null,null,M),console.log("Compile Worker Finished")})})})();