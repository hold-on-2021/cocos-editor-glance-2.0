var t=cc.Class.Attr.DELIMETER,r="A$$ETprops"+t+"A$$ETprops";function e(t){this.owner=t,this.watchingInfos=Object.create(null)}const s=Object.create(null);function n(t){return t instanceof cc.Asset&&t._uuid?t._uuid:"string"==typeof t&&t?Editor.Utils.UuidCache.urlToUuid(t):""}function a(t,r){var e=function(t,r){for(;t;){var e=Object.getOwnPropertyDescriptor(t,r);if(e)return{owner:t,pd:e};t=Object.getPrototypeOf(t)}return null}(t.prototype,r);if(!e)return console.warn("Failed to get property descriptor of %s.%s",cc.js.getClassName(t),r),void 0;var n=e.pd;if(!1===n.configurable)return console.warn("Failed to register notifier for %s.%s",cc.js.getClassName(t),r),void 0;if("value"in n)return console.warn("Cannot watch instance variable of %s.%s",cc.js.getClassName(t),r),void 0;var a=n.set;n.set=function(t,e){if(a.call(this,t,e),this._watcherHandle&&this._watcherHandle!==s){let t=this[r];this._watcherHandle.changeWatchAsset(r,t)}},Object.defineProperty(e.owner,r,n)}function i(t,r,e){var s=cc.js.getPropertyDescriptor(t,r);if(s&&s.set){s.set.call(t,e,!0)}}e.initComponent=function(t){t._watcherHandle=null},e.initHandle=function(n){var i=cc.Class.Attr.getClassAttrs(n.constructor)[r];void 0===i&&(i=function(r){for(var e=null,s=r.constructor,n=cc.Class.Attr.getClassAttrs(s),i=0,c=s.__props__;i<c.length;i++){var o=c[i],l=o+t;if(n[l+"hasSetter"]&&n[l+"hasGetter"]){var u=r[o];(u instanceof cc.Asset||null==u)&&(a(s,o),e?e.push(o):e=[o])}}return e}(n),cc.Class.Attr.setClassAttr(n.constructor,"A$$ETprops","A$$ETprops",i)),n._watcherHandle=i?new e(n):s},e.start=function(t){t._watcherHandle||e.initHandle(t),t._watcherHandle!==s&&t._watcherHandle.start()},e.stop=function(t){t._watcherHandle&&t._watcherHandle!==s&&t._watcherHandle.stop()},e.prototype.start=function(){for(var t=this.owner,e=cc.Class.Attr.getClassAttrs(t.constructor)[r],s=0;s<e.length;s++){var a=e[s],i=t[a];if(Array.isArray(i)){let t=this.watchingInfos[a]=[];this._registerToArray(a,i,t)}else{var c=n(i);c&&this._register(a,c)}}},e.prototype.stop=function(){for(var t in this.watchingInfos){var r=this.watchingInfos[t];r&&cc.AssetLibrary.assetListener.off(r.uuid,r.callback)}this.watchingInfos=Object.create(null)},e.prototype._register=function(t,r){var e=i.bind(null,this.owner,t);cc.AssetLibrary.assetListener.on(r,e),this.watchingInfos[t]={uuid:r,callback:e}},e.prototype._registerToArray=function(t,r,e){var s=function(t,r,e,s){let a=n(s);for(let t=0;t<e.length;t++)n(e[t])===a&&(e[t]=s);i(t,r,e)}.bind(null,this.owner,t,r);for(let t=0;t<r.length;t++){let a=n(r[t]);a&&(cc.AssetLibrary.assetListener.on(a,s),e.push({uuid:a,callback:s}))}},e.prototype.changeWatchAsset=function(t,r){var e=this.watchingInfos[t];if(Array.isArray(e)){for(let t=0;t<e.length;t++)cc.AssetLibrary.assetListener.off(e[t].uuid,e[t].callback);if(Array.isArray(r))e.length=0,this._registerToArray(t,r,e);else{let e=n(r);e&&this._register(t,e)}}else if(Array.isArray(r))e&&cc.AssetLibrary.assetListener.off(e.uuid,e.callback),this.watchingInfos[t]=e=[],this._registerToArray(t,r,e);else{let s=n(r);if(e){if(e.uuid===s)return;this.watchingInfos[t]=null,cc.AssetLibrary.assetListener.off(e.uuid,e.callback)}s&&this._register(t,s)}},module.exports=e;