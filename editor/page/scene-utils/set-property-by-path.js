var e=cc.js;const t=require("./utils/prefab"),a=require("./utils/scene");var s=Editor.require("unpack://engine-dev/cocos2d/core/platform/CCClass").getDefault;let r=Editor.Profile.load("project://project.json");function c(){}async function o(e,t,a,s){return new Promise(r=>{cc.AssetLibrary.loadAsset(a,function(c,o){var i=e.__asyncStates[t];if(i.uuid===a){if(i.state="end",i.uuid="",c)return Editor.error("Failed to set asset",c);!s||o instanceof s||Editor.warn("The new %s must be instance of %s",t,cc.js.getClassName(s)),e[t]=o,cc.engine.repaintInEditMode(),r()}})})}async function i(e,t,a,s){return a?(e.__asyncStates=e.__asyncStates||{},e.__asyncStates[t]={state:"start",uuid:a},s&&cc.js.isChildClassOf(s,cc.Asset)?await o(e,t,a,s):(await new Promise(r=>{cc.AssetLibrary._queryAssetInfoInEditor(a,async function(c,i,n){if(!n)return await o(e,t,a,s),r();var l=e.__asyncStates[t];l.uuid===a&&(l.state="en",l.uuid="",e[t]=i,cc.engine.repaintInEditMode(),r())})}),void 0)):(e[t]=!s||cc.RawAsset.isRawAssetType(s)?"":null,void 0)}async function n(a){var s=a.obj,r=a.name,o=a.value,n=a.actualType,l=a.comp,u=a.prop,p=o.uuid,f=e._getClassById(n);if(f)if(cc.js.isChildClassOf(f,cc.RawAsset))await i(s,r,p,f);else if(cc.js.isChildClassOf(f,cc.Node)||cc.js.isChildClassOf(f,cc.Component))if(p){var y=cc.engine.getInstanceById(p);if(y){if(!t.validateSceneReference(y,l,u))throw new c;s[r]=y}}else s[r]=null;else s[r]=o;else cc.warn("Unknown type to apply: "+n)}function l(e,t,s,r){var c,o;if(void 0===(c=e.saveUrlAsAsset?"":{Boolean:!1,String:"",Float:0,Integer:0}[e.type]))switch(e.type){case"Enum":var i=e.enumList;for(c=i[0]&&i[0].value||0,o=s;o<r;o++)t[o]=c;break;case"Object":var n=e.ctor;if(a.isAnyChildClassOf(n,cc.Asset,cc.Node,cc.Component)){for(o=s;o<r;o++)t[o]=null;break}for(o=s;o<r;o++)try{t[o]=new n}catch(e){t[o]=null}}else for(o=s;o<r;o++)t[o]=c}async function u(e,t,a,s){var r;if(e instanceof cc._BaseNode?r=e:e instanceof cc.Component&&(r=e.node),-1===t.indexOf("."))s&&"string"==typeof a.uuid?await n({obj:e,name:t,value:a,actualType:s,node:r,comp:e,prop:t}):e[t]=a;else{for(var c=t.split("."),o=c[0],i=e[o],u=cc.Class.attr(e,o),p=i,f=1;f<c.length-1;f++){var y=c[f],d=cc.Class.attr(p,y);d&&(u=d),p=p[y]}var b=c[c.length-1];if(s&&"string"==typeof a.uuid)await n({obj:p,name:b,value:a,actualType:s,node:r,comp:e,prop:o});else if("length"===b&&Array.isArray(p)){var h=p.length;p.length=a,l(u,p,h,a)}else p[b]=a;e[o]=i}}function p(e,t){if(-1===t.indexOf("."))return{obj:e,propName:t,value:e[t]};for(var a,s,r,c=t.split("."),o=e,i=0;i<c.length;i++){if(null==o)return cc.warn('Failed to parse "%s", %s is nil',t,c[i]),null;o=r=(a=o)[s=c[i]]}return{obj:a,propName:s,value:r}}function f(t,a,s){var r="object"==typeof a&&!Array.isArray(a),c=a.constructor!==Object&&!(a instanceof cc.ValueType),o=s&&e._getClassById(s),i=o&&cc.js.isChildClassOf(o,cc.RawAsset);i&&("string"==typeof a?(a={uuid:a},t=t.slice(0,-".uuid".length)):"string"!=typeof a.uuid&&(i=!1));var n=o&&cc.js.isChildClassOf(o,cc.Node)||cc.js.isChildClassOf(o,cc.Component);if(n&&"string"==typeof a&&(a={uuid:a},t=t.slice(0,-".uuid".length)),o)"object"!=typeof a&&Editor.warn('Expecting object type of value for "%s", but got "%s" type.',t,typeof a);else switch(s){case"Enum":"number"!=typeof a&&Editor.warn('Expecting number type of value for "%s", but got "%s" type.',t,typeof a)}return{path:t,value:a,isPrimitiveValue:!r||i||n||c}}function y(e,t,a,s,r){if(""===t){if(e)for(var c in a){y(e,c,a[c])}return}r&&(s=function(e,t){for(var a=t.split("."),s=null,r=0;r<a.length&&null!=e;r++){var c=a[r],o=cc.Class.attr(e,c);if(!o)break;s=o,e=e[c]}return s?"Object"===s.type&&s.ctor?cc.js.getClassName(s.ctor):s.type:""}(e,t));let o=f(t,a,s);if(a=o.value,t=o.path,!o.isPrimitiveValue){let s=p(e,t),r=s&&s.value;if(r){if(Array.isArray(r)){var i=r.length,n=Object.keys(a).length;if(r.length=n,i<n)l(cc.Class.attr(s.obj,s.propName),r,i,n)}for(let e in a){y(r,e,a[e])}return u(e,t,r),void 0}}u(e,t,a,s)}function d(e,t,a){switch(t){case"name":e.name=a;break;case"active":e.active=a;break;case"opacity":e.opacity=a;break;case"color":e.color=new cc.Color(a.r,a.g,a.b,255),e.opacity=a.a;break;case"color.r":e.color=e.color.setR(a);break;case"color.g":e.color=e.color.setG(a);break;case"color.b":e.color=e.color.setB(a);break;case"color.a":e.opacity=a;break;case"anchor":e.setAnchorPoint(a);break;case"anchor.x":e.anchorX=a;break;case"anchor.y":e.anchorY=a;break;case"size":a.width=a.width<0?0:a.width,a.height=a.height<0?0:a.height,e.setContentSize(a);break;case"size.width":e.width=a;break;case"size.height":e.height=a;break;case"scale":e.setScale(a);break;case"scale.x":e.scaleX=a;break;case"scale.y":e.scaleY=a;break;case"scale.z":e.scaleZ=a;break;case"position":e.setPosition(a);break;case"position.x":e.x=a;break;case"position.y":e.y=a;break;case"position.z":e.z=a;break;case"angle":e.angle=a;break;case"eulerAngles":e.eulerAngles=a;break;case"skew":e.skewX=a.x,e.skewY=a.y;break;case"skew.x":e.skewX=a;break;case"skew.y":e.skewY=a;break;case"group":r&&(cc.game.groupList=r.get("group-list")),e.group=a;break;case"is3DNode":e.is3DNode=a}}let b=function(e,t){cc.Node.isNode(e)?d(e,t.path,t.value,t.type):y(e,t.path,t.value,t.type,t.isSubProp)};b.ProhibitedException=c;module.exports={setAsset:i,setPropertyByPath:b,getPropertyByPath:p,resetPropertyByPath:function(e,t,a){var r=p(e,t);if(r){if(Array.isArray(r.obj)){var c=r.obj,o=parseInt(r.propName);return r=p(e,t.slice(0,-r.propName.length-1)),cc.Class._isCCClass(r.obj.constructor)?l(cc.Class.attr(r.obj,r.propName),c,o,o+1):cc.error("Can't reset property by path, the object should be CCClass"),void 0}e=r.obj;var i=r.propName;if(cc.Class._isCCClass(e.constructor)){var n=cc.Class.attr(e,i);if("notifyFor"in n&&(n=cc.Class.attr(e,n.notifyFor)),n&&"default"in n){var u=s(n.default);"object"==typeof u&&u&&(u="function"==typeof u.clone?u.clone():Array.isArray(u)?[]:{}),e[i]=u}else cc.error("Unknown default value to reset")}else cc.error("Can't reset property by path, the object should be CCClass")}},setDeepPropertyByPath:y,fillDefaultValue:l,setNodePropertyByPath:d,preprocessForSetProperty:f};