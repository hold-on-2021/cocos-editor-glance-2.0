"use strict";const t=require("vm"),i=require("../settings"),e=require("./utils"),s=require("../../../share/utils"),n=require("../utils/resource-mgr"),a=require("../utils/dom-utils"),h=require("../utils/focus-mgr"),u=require("../behaviors/focusable"),l=require("../behaviors/disable"),r=require("../behaviors/readonly"),p=require("../behaviors/input-state");module.exports=e.registerElement("ui-num-input",{get type(){return this._type},set type(t){this._type!==t&&(this._type=t,"int"===this._type?(this._parseFn=parseInt,this._step=parseInt(this._step),this._step=0===this._step?i.stepInt:this._step):(this._parseFn=parseFloat,this._step=parseFloat(this._step),this._step=0===this._step?i.stepFloat:this._step))},get value(){return this._value},set value(t){null!==t&&void 0!==t||(t=0),t=this._clampValue(t),this._value!==t&&(this._value=this._parseFn(t),this._multiValues||(this.$input.value=this._formatValue(this._value)))},get values(){return this._values},set values(t){this._values=t,this._multiValues&&(this.$input.value="-")},get min(){return this._min},set min(t){if(null===t||void 0===t)return this._min=null,void 0;this._min!==t&&(this._min=this._parseFn(t),this.value=this._value)},get max(){return this._max},set max(t){if(null===t||void 0===t)return this._max=null,void 0;this._max!==t&&(this._max=this._parseFn(t),this.value=this._value)},get precision(){return this._precision},set precision(t){void 0!==t&&null!==t&&this._precision!==t&&(this._precision=parseInt(t),this.$input.value=this._formatValue(this._value))},get step(){return this._step},set step(t){void 0!==t&&null!==t&&this._step!==t&&(this._step=this._parseFn(t),"int"===this._type?this._step=0===this._step?i.stepInt:this._step:this._step=0===this._step?i.stepFloat:this._step)},get multiValues(){return this._multiValues},set multiValues(t){if((t=!(null==t||!1===t))!==this._multiValues)return t?(this.$input.value="-",this.setAttribute("multi-values","")):(this._value=this._parseFn(this._clampValue(this._value)),this.$input.value=this._formatValue(this._value),this.removeAttribute("multi-values")),this._multiValues=t},attributeChangedCallback(t,i,e){if("type"==t||"min"==t||"max"==t||"precision"==t||"step"==t||"multi-values"==t){this[t.replace(/\-(\w)/g,function(t,i){return i.toUpperCase()})]=e}},behaviors:[u,l,r,p],template:'\n    <input></input>\n    <div class="spin-wrapper" tabindex="-1">\n      <div class="spin up">\n        <i class="icon-up-dir"></i>\n      </div>\n      <div class="spin-div"></div>\n      <div class="spin down">\n        <i class="icon-down-dir"></i>\n      </div>\n    </div>\n  ',style:n.getResource("theme://elements/num-input.css"),$:{input:"input",spinWrapper:".spin-wrapper",spinUp:".spin.up",spinDown:".spin.down"},factoryImpl(t){isNaN(t)||(this.value=t)},ready(){"int"===this.getAttribute("type")?(this._type="int",this._parseFn=parseInt):(this._type="float",this._parseFn=parseFloat);let t=this.getAttribute("precision");this._precision=null!==t?parseInt(t):7;let e=this.getAttribute("min");this._min=null!==e?this._parseFn(e):null;let s=this.getAttribute("max");this._max=null!==s?this._parseFn(s):null,this.multiValues=this.getAttribute("multi-values");let n=this.getAttribute("value");this._value=null!==n?this._parseFn(n):null,this._value=this._clampValue(this._value);let u=this.getAttribute("step");this._step=null!==u?this._parseFn(u):"int"===this._type?i.stepInt:i.stepFloat,this.$input.value=this._formatValue(this._value),this.$input.placeholder="-",this.$input._initValue="",this.$spinWrapper.addEventListener("keydown",t=>{27===t.keyCode&&this._holdingID&&(a.acceptEvent(t),this.cancel(),this._curSpin.removeAttribute("pressed"),this._stopHolding())}),a.installDownUpEvent(this.$spinUp),this.$spinUp.addEventListener("down",t=>{a.acceptEvent(t),h._setFocusElement(this),this.$spinWrapper.focus(),this.$spinUp.setAttribute("pressed",""),this.readonly||(this._stepUp(),this._startHolding(this.$spinUp,this._stepUp))}),this.$spinUp.addEventListener("up",t=>{a.acceptEvent(t),this.$spinUp.removeAttribute("pressed",""),this._holdingID&&(this._stopHolding(),this.confirm())}),a.installDownUpEvent(this.$spinDown),this.$spinDown.addEventListener("down",t=>{a.acceptEvent(t),h._setFocusElement(this),this.$spinWrapper.focus(),this.$spinDown.setAttribute("pressed",""),this.readonly||(this._stepDown(),this._startHolding(this.$spinDown,this._stepDown))}),this.$spinDown.addEventListener("up",t=>{a.acceptEvent(t),this.$spinDown.removeAttribute("pressed",""),this._holdingID&&(this._stopHolding(),this.confirm())}),this._initFocusable(this,this.$input),this._initDisable(!1),this._initReadonly(!1),this._initInputState(this.$input),this.$input.readOnly=this.readonly,this._initEvents()},_setIsReadonlyAttribute(t){t?this.setAttribute("is-readonly",""):this.removeAttribute("is-readonly"),this.$input.readOnly=t},_initEvents(){this.addEventListener("mousedown",this._mouseDownHandler),this.addEventListener("keydown",this._keyDownHandler),this.addEventListener("focus-changed",this._focusChangedHandler),this.$input.addEventListener("keydown",t=>{this.readonly||(38===t.keyCode?(a.acceptEvent(t),this._stepUp()):40===t.keyCode&&(a.acceptEvent(t),this._stepDown()))}),this.$input.addEventListener("mousewheel",t=>{this.focused&&(t.stopPropagation(),t.preventDefault(),this.readonly||(t.deltaY>0?this._stepDown():this._stepUp(),a.fire(this,"confirm",{bubbles:!1,detail:{value:this._value,confirmByEnter:!1}})))})},_formatValue(t){return null===t||""===t?"":"int"===this._type?s.toFixed(t,0):0===this._precision?s.toFixed(t,this._precision):s.toFixed(t,this._precision,this._precision)},_clampValue(t){return null!==this._min&&void 0!==this._min&&(t=Math.max(this._min,t)),null!==this._max&&void 0!==this._max&&(t=Math.min(this._max,t)),t},_parseInput(){if(null===this.$input.value)return 0;if(""===this.$input.value.trim())return 0;let i={res:NaN};try{t.runInNewContext(`\n          res = ${this.$input.value};\n        `,i)}catch(t){}let e=this._parseFn(i.res);return isNaN(e)?(e=this._parseFn(this.$input._initValue),e=this._parseFn(this._formatValue(e))):e=this._parseFn(this._formatValue(e)),e},_stepUp(){var t=this._value;Array.isArray(t)&&(t=t[0]);let i=t+this._step;i=this._clampValue(i),this.$input.value=this._formatValue(i),this._onInputChange()},_stepDown(){var t=this._value;Array.isArray(t)&&(t=t[0]);let i=t-this._step;i=this._clampValue(i),this.$input.value=this._formatValue(i),this._onInputChange()},_startHolding(t,i){this._curSpin=t,this._holdingID=setTimeout(()=>{this._stepingID=setInterval(()=>{i.apply(this)},50)},500)},_stopHolding(){clearInterval(this._holdingID),this._holdingID=null,clearTimeout(this._stepingID),this._stepingID=null,this._curSpin=null},clear(){this.$input.value="",this.confirm()},confirm(){this._onInputConfirm(this.$input)},cancel(){this._onInputCancel(this.$input)},_onInputConfirm(t,i){if(!this.readonly&&this._changed){this._changed=!1;let e=this._parseInput(),s=e;e=this._clampValue(e);let n=this._formatValue(e);t.value=n,t._initValue=n,this._value=e,s!==e&&a.fire(this,"change",{bubbles:!1,detail:{value:this._value}}),a.fire(this,"confirm",{bubbles:!1,detail:{value:this._value,confirmByEnter:i}})}i&&this.focus()},_onInputCancel(t,i){if(!this.readonly&&this._changed){if(this._changed=!1,t._initValue!==t.value){t.value=t._initValue;let i=this._parseInput(),e=this._formatValue(i);t.value=e,t._initValue=e,this._value=i,a.fire(this,"change",{bubbles:!1,detail:{value:this._value}})}a.fire(this,"cancel",{bubbles:!1,detail:{value:this._value,cancelByEsc:i}})}i&&(t.blur(),this.focus())},_onInputChange(){this._changed=!0,this._value=this._parseInput(),this.multiValues=!1,a.fire(this,"change",{bubbles:!1,detail:{value:this._value}})},_mouseDownHandler(t){t.stopPropagation(),h._setFocusElement(this)},_keyDownHandler(t){this.disabled||13!==t.keyCode&&32!==t.keyCode||(a.acceptEvent(t),this.$input._initValue=this.$input.value,this.$input.focus(),this.$input.select())},_focusChangedHandler(){this.focused?this.$input._initValue=this.$input.value:this._unselect(this.$input)}});